name: build-and-test
description: Build YDB and run Tests
inputs:
  log_suffix:
    required: true
    type: string
  test_label_regexp:
    required: false
    type: string
  aws_key_id:
    required: true
    type: string
  aws_key_value: 
    required: true
    type: string
  testman_token:
     required: true
     type: string
    
runs:
  using: "composite"
  steps:
  - name: Test history run create
    id: th
    env: 
      TESTMO_TOKEN: ${{inputs.testman_token}}
    shell: bash
    run: |
      testmo automation:run:create --instance https://nebius.testmo.net --project-id 1 --name "${{ github.run_id }}" \
        --source "${{inputs.log_suffix}}${{inputs.sanitizer}}" | \
        echo "runid=$(cat)" >> $GITHUB_OUTPUT
      echo "repsdir=$(pwd)/test_reports" >> $GITHUB_OUTPUT
      rm -rf $(pwd)/test_reports/*
  - name: Test
    shell: bash
    env:
      REPSDIR: ${{steps.th.outputs.repsdir}}
    run: |
      cd ../build/ydb
      rm -rf $(pwd)/../../tmp/*
      mkdir -p ../../artifacts
      rm -rf $(pwd)/../../artifacts/*

      echo "Stdout log (gzip archive): https://storage.yandexcloud.net/ydb-tech-ci/${{ github.repository }}/${{github.workflow}}/${{ github.run_id }}/${{inputs.log_suffix}}-${{inputs.sanitizer}}-stdout.gz" >> $GITHUB_STEP_SUMMARY

      # Sed removes coloring from the output
      
      TMPDIR=$(pwd)/../../tmp GTEST_OUTPUT="xml:$REPSDIR/unittests/" Y_UNITTEST_OUTPUT="xml:$REPSDIR/unittests/" \
        ctest -j28 --timeout 1200 --force-new-ctest-process --output-on-failure \
              --output-junit $REPSDIR/suites/ctest_report.xml \
              -L '${{inputs.test_label_regexp}}' | \
        sed -e 's/\x1b\[[0-9;]*m//g' | \
        tee >(gzip --stdout > ../../artifacts/${{inputs.log_suffix}}-${{inputs.sanitizer}}-stdout.gz) | \
        grep -E '(Test\s*#.*\*\*\*|\[FAIL\])|.*tests passed,.*tests failed out of' | \
        tee -a $GITHUB_STEP_SUMMARY
  - name: Test history upload results
    shell: bash
    env: 
      TESTMO_TOKEN: ${{inputs.testman_token}}
    run: |
      testmo automation:run:submit-thread \
        --instance https://nebius.testmo.net --run-id ${{steps.th.outputs.runid}} \
        --results ${{steps.th.outputs.repsdir}}/**/*.xml 
      testmo automation:run:complete \
        --instance https://nebius.testmo.net --run-id ${{steps.th.outputs.runid}}
  - name: Upload S3
    uses: shallwefootball/s3-upload-action@master
    if: always()
    with:
      aws_key_id: ${{inputs.AWS_KEY_ID }}
      aws_secret_access_key: ${{inputs.AWS_KEY_VALUE}}
      aws_bucket: ydb-tech-ci
      source_dir: ../artifacts
      destination_dir: '${{ github.repository }}/${{github.workflow}}/${{ github.run_id }}'
      endpoint: https://storage.yandexcloud.net
