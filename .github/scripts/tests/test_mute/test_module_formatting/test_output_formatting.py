#!/usr/bin/env python3

import unittest
import os
import sys
from unittest.mock import patch, MagicMock

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–∫–æ–≤
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(__file__))))
from mock_setup import setup_mocks
setup_mocks()


class TestOutputFormatting(unittest.TestCase):
    """–¢–µ—Å—Ç—ã –¥–ª—è –ª–æ–≥–∏–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–≤–æ–¥–∞"""

    def setUp(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤"""
        self.sample_results = [
            {
                'message': "Created issue 'Test Issue 1' for TEAM:@ydb-platform/team1, url https://github.com/test/issue/1",
                'owner': 'team1'
            },
            {
                'message': "Created issue 'Test Issue 2' for TEAM:@ydb-platform/team1, url https://github.com/test/issue/2",
                'owner': 'team1'
            },
            {
                'message': "Created issue 'Test Issue 3' for TEAM:@ydb-platform/team2, url https://github.com/test/issue/3",
                'owner': 'team2'
            }
        ]

    def test_formatting_closed_issues_only(self):
        """–¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –∑–∞–∫—Ä—ã—Ç—ã—Ö issues"""
        from create_new_muted_ya import create_mute_issues
        
        closed_issues = [
            {
                'url': 'https://github.com/test/closed/1',
                'tests': ['ydb/tests/functional/tpc/test1', 'ydb/core/tx/schemeshard/test2']
            }
        ]
        
        # –ú–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        with patch('create_new_muted_ya.read_tests_from_file') as mock_read_tests, \
             patch('create_new_muted_ya.get_muted_tests_from_issues') as mock_get_muted, \
             patch('create_new_muted_ya.close_unmuted_issues') as mock_close_issues, \
             patch('builtins.print') as mock_print:
            
            mock_read_tests.return_value = []
            mock_get_muted.return_value = {}
            mock_close_issues.return_value = (closed_issues, [])
            
            create_mute_issues([], '/tmp/test.txt', close_issues=True)
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å –≤—ã–≤–æ–¥
            print_calls = [str(call) for call in mock_print.call_args_list]
            output = ' '.join(print_calls)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            self.assertIn('üîí **CLOSED ISSUES**', output)
            self.assertIn('‚úÖ **Closed**', output)
            self.assertIn('https://github.com/test/closed/1', output)
            self.assertIn('üìù **Unmuted tests:**', output)
            self.assertIn('ydb/tests/functional/tpc/test1', output)
            self.assertIn('ydb/core/tx/schemeshard/test2', output)

    def test_formatting_partially_unmuted_issues_only(self):
        """–¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–∑–º—å—é—á–µ–Ω–Ω—ã—Ö issues"""
        from create_new_muted_ya import create_mute_issues
        
        partially_unmuted_issues = [
            {
                'url': 'https://github.com/test/partial/1',
                'unmuted_tests': ['ydb/tests/functional/tpc/test1'],
                'still_muted_tests': ['ydb/core/tx/schemeshard/test2']
            }
        ]
        
        # –ú–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        with patch('create_new_muted_ya.read_tests_from_file') as mock_read_tests, \
             patch('create_new_muted_ya.get_muted_tests_from_issues') as mock_get_muted, \
             patch('create_new_muted_ya.close_unmuted_issues') as mock_close_issues, \
             patch('builtins.print') as mock_print:
            
            mock_read_tests.return_value = []
            mock_get_muted.return_value = {}
            mock_close_issues.return_value = ([], partially_unmuted_issues)
            
            create_mute_issues([], '/tmp/test.txt', close_issues=True)
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å –≤—ã–≤–æ–¥
            print_calls = [str(call) for call in mock_print.call_args_list]
            output = ' '.join(print_calls)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            self.assertIn('üîì **PARTIALLY UNMUTED ISSUES**', output)
            self.assertIn('‚ö†Ô∏è **Partially unmuted**', output)
            self.assertIn('https://github.com/test/partial/1', output)
            self.assertIn('üìù **Unmuted tests:**', output)
            self.assertIn('ydb/tests/functional/tpc/test1', output)
            self.assertIn('üîí **Still muted tests:**', output)
            self.assertIn('ydb/core/tx/schemeshard/test2', output)

    def test_formatting_created_issues_only(self):
        """–¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö issues"""
        from create_new_muted_ya import create_mute_issues
        
        # –ú–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        with patch('create_new_muted_ya.read_tests_from_file') as mock_read_tests, \
             patch('create_new_muted_ya.get_muted_tests_from_issues') as mock_get_muted, \
             patch('create_new_muted_ya.close_unmuted_issues') as mock_close_issues, \
             patch('create_new_muted_ya.create_and_add_issue_to_project') as mock_create_issue, \
             patch('create_new_muted_ya.generate_github_issue_title_and_body') as mock_generate, \
             patch('builtins.print') as mock_print:
            
            mock_read_tests.return_value = [
                {'testsuite': 'ydb/tests/functional/tpc', 'testcase': 'test1', 'full_name': 'ydb/tests/functional/tpc/test1'}
            ]
            mock_get_muted.return_value = {}
            mock_close_issues.return_value = ([], [])
            mock_generate.return_value = ('Test Issue Title', 'Test Issue Body')
            mock_create_issue.return_value = {'issue_url': 'https://github.com/test/issue/1'}
            
            # –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö —Å —Ç–µ—Å—Ç–∞–º–∏
            test_data = [
                {
                    'full_name': 'ydb/tests/functional/tpc/test1',
                    'suite_folder': 'ydb/tests/functional/tpc',
                    'test_name': 'test1',
                    'owner': 'team/test',
                    'success_rate': 45.5,
                    'days_in_state': 5,
                    'state': 'Flaky',
                    'date_window': 19723,
                    'summary': 'Test summary',
                    'fail_count': 15,
                    'pass_count': 10,
                    'branch': 'main'
                }
            ]
            
            create_mute_issues(test_data, '/tmp/test.txt', close_issues=True)
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å –≤—ã–≤–æ–¥
            print_calls = [str(call) for call in mock_print.call_args_list]
            output = ' '.join(print_calls)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            self.assertIn('üÜï **CREATED ISSUES**', output)
            self.assertIn('üë• **TEAM** @ydb-platform/test', output)
            self.assertIn('https://github.com/orgs/ydb-platform/teams/test', output)
            self.assertIn('üéØ https://github.com/test/issue/1', output)

    def test_formatting_all_sections(self):
        """–¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ"""
        from create_new_muted_ya import create_mute_issues
        
        closed_issues = [
            {
                'url': 'https://github.com/test/closed/1',
                'tests': ['ydb/tests/functional/tpc/test1']
            }
        ]
        
        partially_unmuted_issues = [
            {
                'url': 'https://github.com/test/partial/1',
                'unmuted_tests': ['ydb/tests/functional/tpc/test2'],
                'still_muted_tests': ['ydb/core/tx/schemeshard/test3']
            }
        ]
        
        # –ú–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        with patch('create_new_muted_ya.read_tests_from_file') as mock_read_tests, \
             patch('create_new_muted_ya.get_muted_tests_from_issues') as mock_get_muted, \
             patch('create_new_muted_ya.close_unmuted_issues') as mock_close_issues, \
             patch('create_new_muted_ya.create_and_add_issue_to_project') as mock_create_issue, \
             patch('create_new_muted_ya.generate_github_issue_title_and_body') as mock_generate, \
             patch('builtins.print') as mock_print:
            
            mock_read_tests.return_value = [
                {'testsuite': 'ydb/tests/functional/tpc', 'testcase': 'test4', 'full_name': 'ydb/tests/functional/tpc/test4'}
            ]
            mock_get_muted.return_value = {}
            mock_close_issues.return_value = (closed_issues, partially_unmuted_issues)
            mock_generate.return_value = ('Test Issue Title', 'Test Issue Body')
            mock_create_issue.return_value = {'issue_url': 'https://github.com/test/issue/1'}
            
            # –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö —Å —Ç–µ—Å—Ç–∞–º–∏
            test_data = [
                {
                    'full_name': 'ydb/tests/functional/tpc/test4',
                    'suite_folder': 'ydb/tests/functional/tpc',
                    'test_name': 'test4',
                    'owner': 'team/test',
                    'success_rate': 45.5,
                    'days_in_state': 5,
                    'state': 'Flaky',
                    'date_window': 19723,
                    'summary': 'Test summary',
                    'fail_count': 15,
                    'pass_count': 10,
                    'branch': 'main'
                }
            ]
            
            create_mute_issues(test_data, '/tmp/test.txt', close_issues=True)
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å –≤—ã–≤–æ–¥
            print_calls = [str(call) for call in mock_print.call_args_list]
            output = ' '.join(print_calls)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
            self.assertIn('üîí **CLOSED ISSUES**', output)
            self.assertIn('üîì **PARTIALLY UNMUTED ISSUES**', output)
            self.assertIn('üÜï **CREATED ISSUES**', output)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
            self.assertIn('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', output)

    def test_team_grouping_and_sorting(self):
        """–¢–µ—Å—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"""
        from create_new_muted_ya import create_mute_issues
        
        # –ú–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        with patch('create_new_muted_ya.read_tests_from_file') as mock_read_tests, \
             patch('create_new_muted_ya.get_muted_tests_from_issues') as mock_get_muted, \
             patch('create_new_muted_ya.close_unmuted_issues') as mock_close_issues, \
             patch('create_new_muted_ya.create_and_add_issue_to_project') as mock_create_issue, \
             patch('create_new_muted_ya.generate_github_issue_title_and_body') as mock_generate, \
             patch('builtins.print') as mock_print:
            
            mock_read_tests.return_value = [
                {'testsuite': 'ydb/tests/functional/tpc', 'testcase': 'test1', 'full_name': 'ydb/tests/functional/tpc/test1'},
                {'testsuite': 'ydb/core/tx/schemeshard', 'testcase': 'test2', 'full_name': 'ydb/core/tx/schemeshard/test2'}
            ]
            mock_get_muted.return_value = {}
            mock_close_issues.return_value = ([], [])
            mock_generate.return_value = ('Test Issue Title', 'Test Issue Body')
            
            # –ú–æ–∫–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö issues –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
            def create_issue_side_effect(title, body, state, owner):
                return {'issue_url': f'https://github.com/test/issue/{owner}'}
            
            mock_create_issue.side_effect = create_issue_side_effect
            
            # –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö —Å —Ç–µ—Å—Ç–∞–º–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
            test_data = [
                {
                    'full_name': 'ydb/tests/functional/tpc/test1',
                    'suite_folder': 'ydb/tests/functional/tpc',
                    'test_name': 'test1',
                    'owner': 'team/zteam',  # –ö–æ–º–∞–Ω–¥–∞ –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                    'success_rate': 45.5,
                    'days_in_state': 5,
                    'state': 'Flaky',
                    'date_window': 19723,
                    'summary': 'Test summary',
                    'fail_count': 15,
                    'pass_count': 10,
                    'branch': 'main'
                },
                {
                    'full_name': 'ydb/core/tx/schemeshard/test2',
                    'suite_folder': 'ydb/core/tx/schemeshard',
                    'test_name': 'test2',
                    'owner': 'team/ateam',  # –ö–æ–º–∞–Ω–¥–∞ –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–≤–æ–π –≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                    'success_rate': 30.0,
                    'days_in_state': 14,
                    'state': 'Flaky',
                    'date_window': 19723,
                    'summary': 'Another test summary',
                    'fail_count': 20,
                    'pass_count': 5,
                    'branch': 'main'
                }
            ]
            
            create_mute_issues(test_data, '/tmp/test.txt', close_issues=True)
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å –≤—ã–≤–æ–¥
            print_calls = [str(call) for call in mock_print.call_args_list]
            output = ' '.join(print_calls)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–º–∞–Ω–¥—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
            ateam_pos = output.find('ateam')
            zteam_pos = output.find('zteam')
            self.assertLess(ateam_pos, zteam_pos, "–ö–æ–º–∞–Ω–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥
            self.assertIn('üë• **TEAM** @ydb-platform/ateam', output)
            self.assertIn('üë• **TEAM** @ydb-platform/zteam', output)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
            self.assertIn('https://github.com/orgs/ydb-platform/teams/ateam', output)
            self.assertIn('https://github.com/orgs/ydb-platform/teams/zteam', output)

    def test_team_spacing_between_groups(self):
        """–¢–µ—Å—Ç –¥–≤–æ–π–Ω–æ–≥–æ –æ—Ç—Å—Ç—É–ø–∞ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ –∫–æ–º–∞–Ω–¥"""
        from create_new_muted_ya import create_mute_issues
        
        # –ú–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        with patch('create_new_muted_ya.read_tests_from_file') as mock_read_tests, \
             patch('create_new_muted_ya.get_muted_tests_from_issues') as mock_get_muted, \
             patch('create_new_muted_ya.close_unmuted_issues') as mock_close_issues, \
             patch('create_new_muted_ya.create_and_add_issue_to_project') as mock_create_issue, \
             patch('create_new_muted_ya.generate_github_issue_title_and_body') as mock_generate, \
             patch('builtins.print') as mock_print:
            
            mock_read_tests.return_value = [
                {'testsuite': 'ydb/tests/functional/tpc', 'testcase': 'test1', 'full_name': 'ydb/tests/functional/tpc/test1'},
                {'testsuite': 'ydb/core/tx/schemeshard', 'testcase': 'test2', 'full_name': 'ydb/core/tx/schemeshard/test2'}
            ]
            mock_get_muted.return_value = {}
            mock_close_issues.return_value = ([], [])
            mock_generate.return_value = ('Test Issue Title', 'Test Issue Body')
            
            # –ú–æ–∫–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö issues –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
            def create_issue_side_effect(title, body, state, owner):
                return {'issue_url': f'https://github.com/test/issue/{owner}'}
            
            mock_create_issue.side_effect = create_issue_side_effect
            
            # –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö —Å —Ç–µ—Å—Ç–∞–º–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
            test_data = [
                {
                    'full_name': 'ydb/tests/functional/tpc/test1',
                    'suite_folder': 'ydb/tests/functional/tpc',
                    'test_name': 'test1',
                    'owner': 'team/team1',
                    'success_rate': 45.5,
                    'days_in_state': 5,
                    'state': 'Flaky',
                    'date_window': 19723,
                    'summary': 'Test summary',
                    'fail_count': 15,
                    'pass_count': 10,
                    'branch': 'main'
                },
                {
                    'full_name': 'ydb/core/tx/schemeshard/test2',
                    'suite_folder': 'ydb/core/tx/schemeshard',
                    'test_name': 'test2',
                    'owner': 'team/team2',
                    'success_rate': 30.0,
                    'days_in_state': 14,
                    'state': 'Flaky',
                    'date_window': 19723,
                    'summary': 'Another test summary',
                    'fail_count': 20,
                    'pass_count': 5,
                    'branch': 'main'
                }
            ]
            
            create_mute_issues(test_data, '/tmp/test.txt', close_issues=True)
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å –≤—ã–≤–æ–¥
            print_calls = [str(call) for call in mock_print.call_args_list]
            output = ' '.join(print_calls)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏ –µ—Å—Ç—å –¥–≤–æ–π–Ω–æ–π –æ—Ç—Å—Ç—É–ø
            # –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω –≥–¥–µ –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏ –µ—Å—Ç—å –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            lines = []
            for call in mock_print.call_args_list:
                if call[0]:  # –µ—Å–ª–∏ –µ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã
                    if isinstance(call[0][0], str) and '\n' in call[0][0]:
                        lines.extend(call[0][0].split('\n'))
                    else:
                        lines.append(str(call[0][0]))
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –∫–æ–º–∞–Ω–¥–∞ -> –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ -> –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ -> –∫–æ–º–∞–Ω–¥–∞  
            team1_found = False
            team2_found = False
            double_empty_found = False
            
            for i, line in enumerate(lines):
                if 'team1' in line:
                    team1_found = True
                elif team1_found and line == '' and i+1 < len(lines) and lines[i+1] == '':
                    double_empty_found = True
                elif double_empty_found and 'team2' in line:
                    team2_found = True
                    break
            
            self.assertTrue(double_empty_found, "–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–≤–æ–π–Ω—ã–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏")


if __name__ == '__main__':
    unittest.main(verbosity=2) 