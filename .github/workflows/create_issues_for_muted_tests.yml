name: Create issues for muted tests

on:
  pull_request:
    types:
      - closed
  workflow_dispatch:
    inputs:
      pr_number: 
        description: 'The pull request number'
        required: true
        type: number

env:
  GH_TOKEN: ${{ secrets.YDBOT_TOKEN }}
  BUILD_TYPE: relwithdebinfo

jobs:
  update-ydb:
    if: |
      ((github.event_name == 'pull_request' && 
      github.event.pull_request.merged == true && 
      contains(github.event.pull_request.labels.*.name, 'mute-unmute')) || 
      github.event_name == 'workflow_dispatch')
    uses: ./.github/workflows/reusable/update_ydb_for_muted_tests.yml
    with:
      branch: ${{ github.event.pull_request.base.ref || 'main' }}
      build_type: ${{ env.BUILD_TYPE }}
    secrets:
      CI_YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS: ${{ secrets.CI_YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS }}

  process-muted-tests:
    needs: update-ydb
    if: |
      ((github.event_name == 'pull_request' && 
      github.event.pull_request.merged == true && 
      contains(github.event.pull_request.labels.*.name, 'mute-unmute')) || 
      github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ydb[yc] PyGithub requests matplotlib numpy
      
      - name: Setup ydb access
        uses: ./.github/actions/setup_ci_ydb_service_account_key_file_credentials
        with:
          ci_ydb_service_account_key_file_credentials: ${{ secrets.CI_YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS }}
      
      - name: Process muted tests after merge
        env:
          GITHUB_TOKEN: ${{ secrets.YDBOT_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_YDBOT_TOKEN }}
          TEAM_CHANNELS: ${{ vars.TG_TEAM_CHANNELS }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          python3 .github/scripts/tests/process_muted_tests_after_merge.py \
            --event_name="${{ github.event_name }}" \
            --pr_number="${{ github.event.pull_request.number || github.event.inputs.pr_number }}" \
            --merge_commit_sha="${{ github.event.pull_request.merge_commit_sha }}" \
            --base_branch="${{ github.event.pull_request.base.ref }}" \
            --build_type="${{ env.BUILD_TYPE }}"
