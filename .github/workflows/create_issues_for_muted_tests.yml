name: Create issues for muted tests

on:
  pull_request:
    types:
      - closed
    branches:
      - main
  workflow_dispatch:
    inputs:
        pr_number: 
            description: 'The pull request number'
            required: true
            type: number

env:
  GH_TOKEN: ${{ secrets.YDBOT_TOKEN }}
  MUTED_YA_FILE_PATH: .github/config/muted_ya.txt
  BUILD_TYPE: relwithdebinfo

jobs:
  create-issues-for-muted-tests:
    runs-on: ubuntu-latest
    if: |
      ((github.event_name == 'pull_request' && 
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'mute-unmute') &&
      github.event.pull_request.base.ref == 'main') || 
      github.event_name == 'workflow_dispatch')

    steps:
      - name: Set environment variables for branches
        run: |
          echo "BRANCH_FOR_PR=${{ github.event.pull_request.head.ref || github.head_ref || 'main' }}" >> $GITHUB_ENV
          echo "BASE_BRANCH=${{ github.event.pull_request.base.ref || github.base_ref || 'main' }}" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
            ref: main  # After merge, work with main branch

      - name: Install dependencies
        run: |
            python -m pip install --upgrade pip
            pip install ydb[yc] PyGithub requests matplotlib numpy

      - name: Setup ydb access
        uses: ./.github/actions/setup_ci_ydb_service_account_key_file_credentials
        with:
            ci_ydb_service_account_key_file_credentials: ${{ secrets.CI_YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS }}

      - name: Create issues for muted tests
        id: create_issues
        env:
          GITHUB_TOKEN: ${{ env.GH_TOKEN }}
        run: .github/scripts/tests/create_new_muted_ya.py create_issues --file_path=${{ github.workspace }}/${{ env.MUTED_YA_FILE_PATH }}
 
      - name: Add issues to PR
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ env.GH_TOKEN }}
        run: python .github/scripts/create_or_update_pr.py append_pr_body --pr_number=${{ github.event.pull_request.number || github.event.inputs.pr_number  }} --body=${{ steps.create_issues.outputs.created_issues_file }}
      
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.GH_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const workflowUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const filePath = '${{ steps.create_issues.outputs.created_issues_file }}';
            const bodyText = fs.readFileSync(filePath, 'utf8');
            const completeBody = `Collected in workflow [#${{ github.run_number }}](${workflowUrl})\n\n${bodyText}`;
      
            github.rest.issues.createComment({
              issue_number: ${{ github.event.pull_request.number || github.event.inputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: completeBody
            });

      # IMPORTANT: First update muted tests information in DB
      - name: Update muted tests in DB
        run: python3 .github/scripts/tests/get_muted_tests.py upload_muted_tests --branch=${{ env.BASE_BRANCH }} --build_type=${{ env.BUILD_TYPE }}

      # Then update analytics that depends on muted tests
      - name: Collect test history data
        run: python3 .github/scripts/analytics/flaky_tests_history.py --branch=${{ env.BASE_BRANCH }} --build_type=${{ env.BUILD_TYPE }}
      
      - name: Update test monitor
        run: python3 .github/scripts/analytics/tests_monitor.py --branch=${{ env.BASE_BRANCH }} --build_type=${{ env.BUILD_TYPE }}

      - name: Export GitHub issues
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ env.GH_TOKEN }}
        run: python3 .github/scripts/analytics/export_issues_to_ydb.py

      - name: Upload GitHub issue mapping table
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ env.GH_TOKEN }}
        run: python3 .github/scripts/analytics/github_issue_mapping.py

      - name: Upload MUTED test monitor data mart with GitHub issue links
        continue-on-error: true
        run: python3 .github/scripts/analytics/data_mart_executor.py --query_path .github/scripts/analytics/data_mart_queries/test_muted_monitor_mart_with_issue.sql --table_path test_results/analytics/test_muted_monitor_mart --store_type column --partition_keys date_window branch build_type owner_team suite_folder --primary_keys date_window owner_team branch build_type suite_folder full_name --ttl_min 43200 --ttl_key date_window

      - name: Send team-specific messages to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_YDBOT_TOKEN }}
          TEAM_CHANNELS: ${{ vars.TG_TEAM_CHANNELS }}
        run: |
          python .github/scripts/telegram/parse_and_send_team_issues.py \
            --on-mute-change-update \
            --file "${{ steps.create_issues.outputs.created_issues_file }}" \
            --bot-token "$TELEGRAM_BOT_TOKEN" \
            --team-channels "$TEAM_CHANNELS" \
            --include-plots \
            --delay 2
