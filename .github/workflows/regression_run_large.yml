name: Regression-run_Large

on:
  schedule:
    - cron: "30 23 * * *"  # At 23:30 every day
  workflow_dispatch:
    inputs:
      pull_request_input:
        description: 'Pull request number (overrides use_default_branches), ex: 12345'
        required: false
        default: ''
      use_default_branches:
        description: 'If true, start main and all current stable branches. If false, start only the selected branch. Ignored if pull_request_input is set.'
        type: boolean
        required: false
        default: true
jobs:
  # Compute parameters based on trigger type and inputs
  prepare:
    runs-on: ubuntu-latest
    outputs:
      branches: ${{ steps.compute.outputs.branches }}
      branches_config_path: ${{ steps.compute.outputs.branches_config_path }}
      pull_number: ${{ steps.compute.outputs.pull_number }}
    steps:
      - name: Compute regression parameters
        id: compute
        run: |
          # branches: use current branch only if workflow_dispatch with no PR and use_default_branches=false
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && \
             [[ -z "${{ github.event.inputs.pull_request_input }}" ]] && \
             [[ "${{ github.event.inputs.use_default_branches }}" == "false" ]]; then
            echo "branches=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "branches=" >> $GITHUB_OUTPUT
          fi
          
          # branches_config_path: use config if schedule OR (workflow_dispatch with no PR and use_default_branches=true)
          if [[ "${{ github.event_name }}" == "schedule" ]] || \
             ([[ "${{ github.event_name }}" == "workflow_dispatch" ]] && \
              [[ -z "${{ github.event.inputs.pull_request_input }}" ]] && \
              [[ "${{ github.event.inputs.use_default_branches }}" == "true" ]]); then
            echo "branches_config_path=.github/config/stable_tests_branches.json" >> $GITHUB_OUTPUT
          else
            echo "branches_config_path=" >> $GITHUB_OUTPUT
          fi
          
          # pull_number: use input if workflow_dispatch and PR number provided
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && \
             [[ -n "${{ github.event.inputs.pull_request_input }}" ]]; then
            echo "pull_number=${{ github.event.inputs.pull_request_input }}" >> $GITHUB_OUTPUT
          else
            echo "pull_number=" >> $GITHUB_OUTPUT
          fi

  main:
    name: Regression-run_Large
    needs: prepare
    uses: ./.github/workflows/run_tests.yml
    secrets: inherit
    strategy:
      fail-fast: false
      matrix: 
        build_preset: ["relwithdebinfo", "release-asan"]
    with:
      test_targets: ydb/
      test_size: large
      branches: ${{ needs.prepare.outputs.branches }}
      branches_config_path: ${{ needs.prepare.outputs.branches_config_path }}
      build_preset: ${{ matrix.build_preset }}
      pull_number: ${{ needs.prepare.outputs.pull_number }}
