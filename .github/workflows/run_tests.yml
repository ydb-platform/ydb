name: Run-tests

on:
  workflow_call:
    inputs:
      test_targets:
        description: 'Paths to tests for run ,example : ydb/ ydb/tests/func/suite'
        required: true
        type: string
        default: ydb/
      test_type:
        description: 'Test type (unittest,py3test,py2test,pytest)'
        required: false
        type: string
        default: unittest,py3test,py2test,pytest
      test_size:
        description: 'Test size (small,medium,large)'
        required: false
        type: string
        default: small,medium,large
      additional_ya_make_args:
        description: 'additional args for ya make'
        required: false
        type: string
        default: ''
      build_preset:
        description: 'Build preset type'
        required: true
        type: string
      branches:
        description: 'Branches to test (JSON array or single branch)'
        required: false
        type: string
        default: '["main"]'
      branches_config_path:
        description: 'Path to JSON file with branches to test'
        required: false
        type: string
        default: ''
      pull_number:
        description: 'Pull request number, ex: 12345'
        required: false
        type: string
        default: ''

  workflow_dispatch:
    inputs:
      pull_number:
        description: 'Pull request number, ex: 12345'
        required: false
        default: ''
      test_targets:
        description: 'Paths to tests for run ,example : ydb/ ydb/tests/func/suite'
        required: true
        default: ydb/
      test_type:
        description: 'Test type (unittest,py3test,py2test,pytest)'
        required: false
        default: unittest,py3test,py2test,pytest
      test_size:
        description: 'Test size (small,medium,large)'
        required: false
        type: choice
        default: small,medium,large
        options:
          - small
          - medium
          - large
          - small,medium
          - small,medium,large
      additional_ya_make_args:
        description: 'additional args for ya make'
        required: false
        default: ''
      build_preset:
        description: 'Build preset type (relwithdebinfo, release-asan, release-msan, release-tsan)'
        required: true
        type: choice
        options:
          - relwithdebinfo
          - release-asan
          - release-msan
          - release-tsan
        default: relwithdebinfo
      collect_coredumps:
        type: boolean
        default: false
        description: "Collect coredumps via ulimit -c unlimited"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      branch_array: ${{ steps.set-branches.outputs.branch_array }}
    steps:
      - name: Checkout ${{ matrix.branch }}
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/config/stable_branches.json
            .github/scripts/tests/comment-pr.py

      - name: Set branches
        id: set-branches
        env:
          PULL_NUMBER: '${{ inputs.pull_number }}'
          BRANCHES: '${{ inputs.branches }}'
          BRANCHES_CONFIG_PATH: '${{ inputs.branches_config_path }}'
          GITHUB_TOKEN: '${{ github.token }}'
        run: |
          set -e
          
          # Helper function to get merge commit SHA for PR
          get_pr_merge_sha() {
            local pr_num=$1
            local merge_sha
            merge_sha=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/ydb-platform/ydb/pulls/$pr_num" | \
              jq -r '.merge_commit_sha')
            
            if [[ -z "$merge_sha" ]] || [[ "$merge_sha" == "null" ]]; then
              echo "ERROR: Failed to get merge commit for PR $pr_num" >&2
              return 1
            fi
            echo "$merge_sha"
            return 0
          }
          
          # Priority 1: Explicit pull_number provided - convert PR to merge commit SHA
          if [[ -n "$PULL_NUMBER" ]] && [[ $PULL_NUMBER =~ ^[0-9]+$ ]]; then
            echo "Processing pull request: $PULL_NUMBER"
            MERGE_SHA=$(get_pr_merge_sha "$PULL_NUMBER")
            echo "Using merge commit SHA: $MERGE_SHA for PR $PULL_NUMBER"
            echo "branch_array=[\"$MERGE_SHA\"]" >> $GITHUB_OUTPUT
            echo "COMMIT_SHA=$MERGE_SHA" >> $GITHUB_ENV
            echo "PR_NUMBER=$PULL_NUMBER" >> $GITHUB_ENV
          
          # Priority 2: Explicit branches parameter provided - use as-is
          elif [[ -n "$BRANCHES" ]]; then
            echo "Branches parameter provided: $BRANCHES"
            
            # Normalize to JSON array format
            if [[ $BRANCHES == \[* ]]; then
              # Already a JSON array
              branch_array="$BRANCHES"
            else
              # Single branch - wrap in JSON array
              branch_array="[\"$BRANCHES\"]"
            fi
            
            echo "branch_array=$branch_array" >> $GITHUB_OUTPUT
          
          # Priority 3: Branches config file provided - read from file
          elif [[ -n "$BRANCHES_CONFIG_PATH" ]]; then
            echo "Using branches from config file: $BRANCHES_CONFIG_PATH"
            if [[ ! -f "$BRANCHES_CONFIG_PATH" ]]; then
              echo "ERROR: Config file not found: $BRANCHES_CONFIG_PATH" >&2
              exit 1
            fi
            branch_array=$(jq -c "." "$BRANCHES_CONFIG_PATH")
            echo "branch_array=$branch_array" >> $GITHUB_OUTPUT
          
          # Priority 4: Default - use current branch (for direct workflow_dispatch)
          else
            echo "No branches specified, using current branch: ${{ github.ref_name }}"
            echo "branch_array=[\"${{ github.ref_name }}\"]" >> $GITHUB_OUTPUT
          fi
          
          # Display final result
          final_branches=$(cat $GITHUB_OUTPUT | grep "^branch_array=" | cut -d= -f2-)
          echo "Final branches to use: $final_branches"

      - name: Install dependencies
        if: always()
        run: |
          # Check if COMMIT_SHA is set (means we have a PR to comment on)
          if [ -n "$COMMIT_SHA" ]; then
            pip install PyGithub
          else
            echo "No PR detected, skipping dependency installation"
          fi

      - name: Post run tests start comment
        if: always()
        shell: bash
        env:
          BUILD_PRESET: ${{ inputs.build_preset }}
          GITHUB_TOKEN: ${{ github.token }}
          TEST_SIZE: ${{ inputs.test_size }}
          BUILD_TARGET: ${{ inputs.test_targets }}
          COLLECT_COREDUMPS: ${{ inputs.collect_coredumps }}
        run: |
          # Check if COMMIT_SHA is set (means we have a PR to comment on)
          if [ -z "$COMMIT_SHA" ]; then
            echo "No PR detected (COMMIT_SHA is not set), skipping comment"
            exit 0
          fi
          commit_sha="$COMMIT_SHA"
          
          commit_short=$(echo "$commit_sha" | cut -c1-7)
          commit_url="https://github.com/${GITHUB_REPOSITORY}/commit/${commit_sha}"
          check_url="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          
          workflow_name="${{ github.workflow }}"
          
          {
            echo "### $workflow_name started"
            echo ""
            echo "- **Build Preset:** \`$BUILD_PRESET\`"
            echo "- **Test Size:** \`$TEST_SIZE\`"
            echo "- **Test Targets:** \`$BUILD_TARGET\`"
            if [ "$COLLECT_COREDUMPS" = "true" ]; then
              echo "- **Collect Coredumps:** \`true\`"
            fi
            echo "- **Commit:** [${commit_short}](${commit_url})"
            echo "- **Workflow run:** [link](${check_url})"
            echo ""
          } | .github/scripts/tests/comment-pr.py --rewrite --no-timestamp

  run_tests:
    needs: prepare
    name: ${{ matrix.branch }}:${{ inputs.build_preset }}
    timeout-minutes: 1200
    runs-on: [ self-hosted, auto-provisioned, "${{ format('build-preset-{0}', inputs.build_preset) }}" ]
    strategy:
      fail-fast: false
      matrix:
        branch: ${{ fromJson(needs.prepare.outputs.branch_array) }}
    steps:
      - name: Set variables based on build_preset
        id: set-vars
        run: |
          if [[ "${{ inputs.build_preset }}" == "relwithdebinfo" ]]; then
            echo "threads_count=52" >> $GITHUB_ENV
            echo "timeout=1200" >> $GITHUB_ENV
          elif [[ "${{ inputs.build_preset }}" == "release-asan" ]]; then
            echo "threads_count=20" >> $GITHUB_ENV
            echo "timeout=1200" >> $GITHUB_ENV
          elif [[ "${{ inputs.build_preset }}" == "release-msan" ]]; then
            echo "threads_count=5" >> $GITHUB_ENV
            echo "timeout=1200" >> $GITHUB_ENV
          elif [[ "${{ inputs.build_preset }}" == "release-tsan" ]]; then
            echo "threads_count=18" >> $GITHUB_ENV
            echo "timeout=1200" >> $GITHUB_ENV
          else
            echo "Unknown build_preset value."
            exit 1
          fi

      - name: Checkout ${{ matrix.branch }}
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}

      - name: Setup ydb access
        uses: ./.github/actions/setup_ci_ydb_service_account_key_file_credentials
        with:
          ci_ydb_service_account_key_file_credentials: ${{ secrets.CI_YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS }}

      - name: Run YDB Tests
        id: run_tests
        timeout-minutes: ${{ fromJson(env.timeout) }}
        uses: ./.github/actions/build_and_test_ya
        with:
          build_preset: ${{ inputs.build_preset }}
          increment: false
          build_target: ${{ inputs.test_targets }}
          run_build: true
          run_tests: true
          test_retry_count: 3
          test_size: ${{ inputs.test_size }}
          test_type: ${{ inputs.test_type }}
          test_threads: ${{ fromJson(env.threads_count) }}
          custom_branch_name: ${{ matrix.branch }}
          put_build_results_to_cache: true
          collect_coredumps: ${{ inputs.collect_coredumps }}
          additional_ya_make_args: -DDEBUGINFO_LINES_ONLY ${{ inputs.additional_ya_make_args }}
          pull_number: ${{ inputs.pull_number }}
          secs: ${{ format('{{"AWS_KEY_ID":"{0}","AWS_KEY_VALUE":"{1}","REMOTE_CACHE_USERNAME":"{2}","REMOTE_CACHE_PASSWORD":"{3}","TELEGRAM_YDBOT_TOKEN":"{4}"}}',
            secrets.AWS_KEY_ID, secrets.AWS_KEY_VALUE, secrets.REMOTE_CACHE_USERNAME, secrets.REMOTE_CACHE_PASSWORD, secrets.TELEGRAM_YDBOT_TOKEN ) }}
          vars: ${{ format('{{"AWS_BUCKET":"{0}","AWS_ENDPOINT":"{1}","REMOTE_CACHE_URL":"{2}","GH_ALERTS_TG_LOGINS":"{3}","GH_ALERTS_TG_CHAT":"{4}"}}',
            vars.AWS_BUCKET, vars.AWS_ENDPOINT, vars.REMOTE_CACHE_URL_YA, vars.GH_ALERTS_TG_LOGINS, vars.GH_ALERTS_TG_CHAT ) }}

