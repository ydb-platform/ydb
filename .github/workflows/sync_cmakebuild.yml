name: Sync cmakebuild with main
on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true
env:
  REPO: ${{ github.repository }}
  TOKEN: ${{ secrets.GITHUB_TOKEN }}
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - name: Sync
      run: |
        git clone -b main --shallow-exclude cmakebuild https://$TOKEN@github.com/$REPO.git ydb
        git config --global user.email "alex@ydb.tech"
        git config --global user.name "Alexander Smirnov"
        cd ydb
        git fetch --depth `expr $(git rev-list --count HEAD) + 1`
        git fetch origin cmakebuild:cmakebuild --depth 2
        mainsha=$(git rev-parse HEAD)
        git checkout cmakebuild
        prevsha=$(git rev-parse HEAD)
        git merge main --no-edit
        currsha=$(git rev-parse HEAD)
        if [ ${prevsha} == ${currsha} ];then
          echo "Merge did not bring any changes, exiting"
          exit
        fi
        ./generate_cmake -k
        echo ${mainsha} > ydb/ci/cmakegen.txt
        git add .
        git commit -m "Generate cmake for ${mainsha}"
        git push --set-upstream origin cmakebuild
