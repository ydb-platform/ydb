PNPM_ROOT=
PNPM_SCRIPT=$PNPM_ROOT/node_modules/pnpm/dist/pnpm.cjs

PM_SCRIPT=$PNPM_SCRIPT
PM_TYPE=pnpm

# combined input/outputs records as list of directives ${hide;input:<path>} ${hide;output:<path>}, used in builders
_NODE_MODULES_INOUTS=
_NODE_MODULES_BUNDLE_ARG=
_YATOOL_PREBUILDER_ARG=
_USE_LEGACY_PNPM_VIRTUAL_STORE_ARG=
_INJECT_PEERS_ARG=

macro _TS_ADD_NODE_MODULES_FOR_BUILDER() {
    # Calculate inputs and outputs of node_modules, fill `_NODE_MODULES_INOUTS` variable
    _NODE_MODULES_CONFIGURE()
}

# Not to bundle node_modules by default
_WITH_NODE_MODULES=

### @usage: WITH_NODE_MODULES()
###
### Macro configures the project to output node_modules bundle as a build-result.
###
### Documentation: https://docs.yandex-team.ru/frontend-in-arcadia/references/macros#with-node-modules
macro WITH_NODE_MODULES() {
    SET(_WITH_NODE_MODULES yes)
}

_TARBALLS_STORE=__tarballs__
_PREPARE_DEPS_INOUTS=
_PREPARE_DEPS_RESOURCES=
_PREPARE_DEPS_USE_RESOURCES_FLAG=
_PREPARE_DEPS_TS_PROTO_AUTO_FLAG=
_PREPARE_DEPS_CMD=$TOUCH_UNIT \
    && $NOTS_TOOL $NOTS_TOOL_BASE_ARGS prepare-deps \
    --tarballs-store $_TARBALLS_STORE \
    $_PREPARE_DEPS_INOUTS \
    $_PREPARE_DEPS_RESOURCES \
    $_PREPARE_DEPS_USE_RESOURCES_FLAG \
    $_PREPARE_DEPS_TS_PROTO_AUTO_FLAG \
    ${hide;kv:"pc magenta"} ${hide;kv:"p TS_DEP"}

# In case of no deps we need to create empty outputs for graph connectivity
_PREPARE_NO_DEPS_CMD=$TOUCH_UNIT \
    && $YMAKE_PYTHON3 ${input:"build/scripts/touch.py"} \
    $_PREPARE_DEPS_INOUTS \
    ${hide;kv:"pc magenta"} ${hide;kv:"p TS_NODEP"}

module _PREPARE_DEPS_BASE: _BARE_UNIT {
    .CMD=$_PREPARE_DEPS_CMD
    # TODO Can be added to .IGNORED: BUNDLE_OUTPUT LARGE_FILES FROM_SANDBOX
    .IGNORED=SRCS FILES TS_FILES COPY_FILE BUNDLE FROM_ARCHIVE RUN_JAVASCRIPT_AFTER_BUILD RUN_JAVASCRIPT
    # Propagates peers to related modules
    .PEERDIR_POLICY=as_build_from
    .NODE_TYPE=Bundle
    .INCLUDE_TAG=no

    # we have several modules in the same dir (.PEERDIRSELF=TS_PREPARE_DEPS in BUILD)
    # we need different names for module identity file
    # .fake tells builder to not materialize it in results
    SET(MODULE_SUFFIX .prepare_deps.fake)
    # .NODE_TYPE=Bundle is required for peers propagation, but it also affects
    # how merging of pic/nopic graphs. Here we can override this merging behaviour
    SET(MODULE_TYPE LIBRARY)
    # define own tag
    SET(MODULE_TAG TS_PREPARE_DEPS)
    SET(MODULE_LANG TS)
    # what modules it can PEERDIR to
    SET(PEERDIR_TAGS TS_PREPARE_DEPS)
    # do not include it into "results" of graph
    DISABLE(START_TARGET)

    # we read pnpm-lock.yaml and package.json during configuration
    SET_APPEND(_MAKEFILE_INCLUDE_LIKE_DEPS ${CURDIR}/pnpm-lock.yaml ${CURDIR}/package.json)

    _PEERDIR_TS_RESOURCE(nodejs $PM_TYPE)
    _PREPARE_DEPS_CONFIGURE()
}

macro USE_LEGACY_PNPM_VIRTUAL_STORE() {
    MESSAGE(WARN Module $MODDIR uses USE_LEGACY_PNPM_VIRTUAL_STORE(). Consider to fix your build to work without it.)
    SET(_USE_LEGACY_PNPM_VIRTUAL_STORE_ARG --use-legacy-pnpm-virtual-store yes)
}

macro INJECT_PEERS() {
    SET(_INJECT_PEERS_ARG --inject-peers yes)
}
