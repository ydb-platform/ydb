_TS_BUILD_SCRIPT=ya:build
_TS_OUTPUTS=
_TS_OUTPUTS_JOINED=
_TS_GLOB_FILES=

TS_LIBRARY_CMD=${EXTRACT_GENTAR_CMD} \
    && ${NOTS_TOOL} ${NOTS_TOOL_BASE_ARGS} build-library ${NOTS_TOOL_BASIC_BUILDER_ARGS} \
    --build-script ${_TS_BUILD_SCRIPT} \
    --outputs ${_TS_OUTPUTS} \
    --exclude-globs ${_SET_TS_INPUTS_BASE_EXCLUDES} \
    ${hide:PEERS} \
    ${_NODE_MODULES_INOUTS} \
    ${hide;input=TEXT:_TS_GLOB_FILES} \
    ${hide;input:"package.json"} \
    ${hide;output:"package.json"} \
    ${hide;kv:"pc magenta"} ${hide;kv:"p TS_LIB"}

### @usage: TS_LIBRARY([name])
###
### The TypeScript/JavaScript library module, compiles TypeScript sources to JavaScript using tsc.
### Build results are JavaScript files, typings and source mappings (depending on local tsconfig.json settings).
###
### Documentation: https://docs.yandex-team.ru/frontend-in-arcadia/references/TS_LIBRARY
###
### @example
###
###     TS_LIBRARY()
###
###     END()
###
multimodule TS_LIBRARY {
    module BUILD: _TS_BASE_UNIT {
        .CMD=$TS_LIBRARY_CMD
        .SEM=$_SEM_IGNORED
        .EPILOGUE=_TS_LIBRARY_EPILOGUE
        .PEERDIRSELF=TS_PREPARE_DEPS

        # by default multimodule overrides inherited MODULE_TAG to submodule name (BUILD in this case)
        # but we have to set it to TS for include processor to work
        SET(MODULE_TAG TS)

        DISABLE(TS_CONFIG_DEDUCE_OUT)
        DISABLE(TS_CONFIG_USE_OUTDIR)

        SET_APPEND(_MAKEFILE_INCLUDE_LIKE_DEPS ${CURDIR}/package.json)
    }

    module TS_PREPARE_DEPS: _PREPARE_DEPS_BASE {
    }
}

macro TS_BUILD_SCRIPT(SCRIPT) {
    SET(_TS_BUILD_SCRIPT ${SCRIPT})
}

macro TS_BUILD_OUTPUTS(PATHS...) {
    SET(_TS_OUTPUTS ${PATHS})
    SET(_TS_OUTPUTS_JOINED ${join=|:PATHS})
}

macro _TS_LIBRARY_EPILOGUE() {
    _SET_TS_INPUTS()
    _SETUP_BUILD_ENV()
    _TS_LIBRARY_CONFIGURE()
}

# Exclusions for TS_LIBRARY input files:
# - ya.make, a.yaml: build system files, not needed for `node --run`
# - package.json: added separately via explicit input/output directives (line 13-14), needs to be copied earlier
# - pnpm-lock.yaml: BUILD depends not on it, but on files that PREPARE_DEPS prepares
_SET_TS_INPUTS_BASE_EXCLUDES=ya.make a.yaml package.json pnpm-lock.yaml \
    ${TS_EXCLUDE_DIR_GLOB} \
    ${TS_GLOB_EXCLUDE_ADDITIONAL}

_SET_TS_INPUTS_EXCLUDES=\
    ${_SET_TS_INPUTS_BASE_EXCLUDES} \
    (${_TS_OUTPUTS_JOINED})/**/*

# tag:internal
macro _SET_TS_INPUTS() {
    _GLOB(_TS_GLOB_FILES **/* EXCLUDE ${_SET_TS_INPUTS_EXCLUDES} RESTRICTIONS MAX_MATCHES 10000 MAX_WATCH_DIRS 5000 SKIPPED_MIN_MATCHES 2000 SKIPPED_ERROR_PERCENT 90)
}


