{#- Macroses must be in parent *.jinja for place of it usage -#}
{#- Include macroses.jinja then include use_macroses.jinja not work! -#}
{#- That is why all common macroses here -#}

{%- macro PatchRootCommon(path, use_output_root) -%}
{#- Replace (export_root / curdir) => (BINDIR), (export_root) ==> (BUILD_ROOT in ymake) to baseBuildDir in Gradle - root of all build folders for modules -#}
{%-     if use_output_root -%}
{%-         set out_root = "$output_root" -%}
{%-     else -%}
{%-         set out_root = "$arcadia_root" -%}
{%-     endif -%}
"{{ path|replace(export_root + "/" + curdir, "$projectBuildDir")|replace(export_root, "$baseBuildDir")|replace(project_root, "$project_root")|replace(arcadia_root, out_root)|replace(output_root, out_root) }}"
{%- endmacro -%}

{%- macro PatchRootCodegen(path, output) -%}
"{{ path|replace(export_root + "/" + curdir, "$projectCodegenDir/" + varprefix + "." + output)|replace(export_root, "$baseBuildDir")|replace(project_root, "$project_root")|replace(arcadia_root, "$output_root")|replace(output_root, "$output_root") }}"
{%- endmacro -%}

{%- macro PatchRoots(arg, depend = false, output = "") -%}
{#- Always replace (arcadia_root) === (SOURCE_ROOT in ymake) to $arcadia_root in Gradle -#}
{%-     if depend -%}
{#- Replace (export_root) === (BUILD_ROOT in ymake) to $arcadia_root in Gradle, because prebuilt tools in arcadia, not in build_root -#}
"{{ arg|replace(export_root, "$output_root")|replace(project_root, "$project_root")|replace(arcadia_root, "$arcadia_root") }}"
{%-     elif output != "" -%}
{%-         if arg|replace(export_root + "/", "") != arg -%}
{%-             if arg[0] != '/' -%}
{#                  Complex arg of command - export_root in arg, but not at start of arg, can't use bindir logic #}
{%-                 set bindir = false -%}
{%-             else -%}
{%-                 set bindir = arg|replace(export_root + "/", "") -%}
{%-             endif -%}
{%-         elif arg[0] != '/' -%}
{#-             Relative outputs in buildDir, make relative from baseBuildDir -#}
{%-             set bindir = curdir + "/" + arg -%}
{%-         else -%}
{%-             set bindir = false -%}
{%-         endif -%}
{%-         if bindir and current_target -%}
{%-             set path = export_root + "/" + bindir -%}
{#-             "_" - don't patch output dir by codegen number -#}
{%-             if output != "_" -%}
{{ PatchRootCodegen(path, output) }}
{%-             else -%}
{{ PatchRootCommon(path, true) }}
{%-             endif -%}
{%-         else -%}
{%-             if output != "_" -%}
{{ PatchRootCodegen(arg, output) }}
{%-             else -%}
{{ PatchRootCommon(arg, true) }}
{%-             endif -%}
{%-         endif -%}
{%-     else -%}
{{ PatchRootCommon(arg, false) }}
{%-     endif -%}
{%- endmacro -%}

{%- if proto_template -%}
{%-     macro PatchGeneratedProto(arg, relative = false, output = "") -%}
{%-         if relative -%}
{%-             if output != "" and output != "_" -%}
"{{ arg|replace(export_root + "/", "")|replace(arcadia_root + "/", "")|replace(output_root + "/", "")|replace(curdir + "/", curdir + "/build/" + CODEGENS_DIRNAME + "/" + varprefix + "." + output + "/") }}"
{%-             else -%}
"{{ arg|replace(export_root + "/", "")|replace(arcadia_root + "/", "")|replace(output_root + "/", "") }}"
{%-             endif -%}
{%-         else -%}
{%-             if output != "" and output != "_" -%}
{{ PatchRootCodegen(arg, output) }}
{%-             else -%}
{{ PatchRootCommon(arg, true) }}
{%-             endif -%}
{%-         endif -%}
{%-     endmacro -%}
{%- endif -%}

{%- include "[generator]/common_dir.jinja" -%}
{%- include "[generator]/vars.jinja" -%}
{%- include "[generator]/import.jinja" -%}
{%- include "[generator]/plugins_block.jinja" -%}
{%- include "[generator]/builddir.jinja" -%}
{%- include "[generator]/java_toolchains.jinja" -%}

{%- if proto_template -%}
{%-     include "[generator]/protobuf.jinja" -%}
{%-     include "[generator]/proto_prepare.jinja" -%}
{%- endif -%}

{%- include "[generator]/kotlin_plugins.jinja" -%}
{%- include "[generator]/configuration.jinja" -%}
{%- include "[generator]/preview.jinja" -%}
{%- include "[generator]/test.jinja" -%}
{%- include "[generator]/build.gradle.kts.common.jinja" -%}
{%- include "[generator]/dependencies.jinja" -%}
{%- include "extra-tests.gradle.kts" ignore missing -%}
{%- include "[generator]/debug.jinja" ignore missing -%}
