{%- macro AnnotationProcessors(func, annotation_processors) -%}
{%-     if annotation_processors|length -%}
{%-         set first_ap = annotation_processors|first -%}
{%-         if first_ap.jar is defined -%}
{#-             Objects in list - new format -#}
{%-             set annotation_processors = annotation_processors|unique|sort -%}
{%-             set lomboks = annotation_processors|selectattr('jar', 'startsWith', LOMBOK_PATH) -%}
{%-             set nolomboks = annotation_processors|rejectattr('jar', 'startsWith', LOMBOK_PATH) -%}
{%-             if lomboks|length -%}
{%-                 for annotation_processor in lomboks -%}
{%-                     set parts = rsplit(annotation_processor.jar, "/", 4) %}
    {{ func }}("{{ parts[0]|replace("contrib/java/", "")|replace("/", ".") }}:{{ parts[1] }}:{{ parts[2] }}")
{%-                 endfor -%}
{%-             endif -%}
{%-             if nolomboks|length -%}
{%-                 for annotation_processor in nolomboks -%}
{%-                     if [annotation_processor.jar]|select('startsWith', 'contrib/java/')|length -%}
{#-                         Contrib AP, use by classpath -#}
{%-                         set parts = rsplit(annotation_processor.jar, "/", 4) %}
    {{ func }}("{{ parts[0]|replace("contrib/java/", "")|replace("/", ".") }}:{{ parts[1] }}:{{ parts[2] }}")
{%-                     else -%}
{#-                     Has handmade AP, put all APs as jars in one list #}
    {{ func }}(files(listOf(
{%-                         if annotation_processor.deps|length -%}
{%-                             for annotation_processor_dep in annotation_processor.deps %}
        {{ PatchRoots(output_root + "/" + annotation_processor_dep, false, "", true) }},
{%-                             endfor -%}
{%-                         endif %}
        {{ PatchRoots(output_root + "/" + annotation_processor.jar, false, "", true) }},
    )))
{%-                     endif %}
{%-                 endfor %}
{%-             endif -%}
{%-         else -%}
{#-             Strings in list - old format -#}
{%-             set annotation_processors = annotation_processors|unique|sort -%}
{%-             set lomboks = annotation_processors|select('startsWith', LOMBOK_PATH) -%}
{%-             set nolomboks = annotation_processors|reject('startsWith', LOMBOK_PATH) -%}
{%-             if lomboks|length -%}
{%-                 for annotation_processor in lomboks -%}
{%-                     set parts = rsplit(annotation_processor, "/", 4) %}
    {{ func }}("{{ parts[0]|replace("contrib/java/", "")|replace("/", ".") }}:{{ parts[1] }}:{{ parts[2] }}")
{%-                 endfor -%}
{%-             endif -%}
{%-             if nolomboks|length -%}
{%-                 if nolomboks|reject('startsWith', 'contrib/java/')|length -%}
{#-                     Has handmade AP, put all APs as jars in one list #}
    {{ func }}(files(listOf(
{%-                     for annotation_processor in nolomboks %}
        {{ PatchRoots(output_root + "/" + annotation_processor, false, "", true) }},
{%-                     endfor %}
    )))
{%-                 else -%}
{%-                     for annotation_processor in nolomboks -%}
{%-                         set parts = rsplit(annotation_processor, "/", 4) %}
    {{ func }}("{{ parts[0]|replace("contrib/java/", "")|replace("/", ".") }}:{{ parts[1] }}:{{ parts[2] }}")
{%-                     endfor -%}
{%-                 endif -%}
{%-             endif -%}
{%-         endif -%}
{%-     endif -%}
{%- endmacro -%}

{%- macro Kapts(func, kapts, file_jars, test_file_jars) -%}
{%-     if kapts|length -%}
{%-         set kapt_first = kapts|first -%}
{%-         if kapt_first.jar is defined -%}
{#-             Objects list, new format-#}
{%-             set kapt_jars = kapts|map(attribute='jar')|unique|sort -%}
{%-             for kapt_jar in kapt_jars -%}
{%-                 set kapt = kapts|selectattr('jar', 'eq', kapt_jar)|first -%}
{%-                 if (kapt_jar in file_jars) or (kapt_jar in test_file_jars) -%}
{#-                     found KAPT jar in depends => use kapt as jar #}
    {{ func }}(files(listOf(
{%-                    if kapt.deps|length -%}
{%-                        for kapt_dep in kapt.deps %}
        "$output_root/{{ kapt_dep }}",
{%-                        endfor -%}
{%-                    endif %}
        "$output_root/{{ kapt_jar }}",
    )))
{%-                 else -%}
{#-                     no in depends jar => use KAPT as project() -#}
{%-                     set path_and_jar = rsplit(kapt_jar, "/", 2) -%}
{%-                     set classpath = 'project(":' + path_and_jar[0]|replace("/", ":") + '")' -%}
{%-                     include "[generator]/patch_classpath.jinja" %}
    {{ func }}({{ classpath }})
{%-                 endif -%}
{%-             endfor -%}
{%-         else -%}
{#-             Strings list, old format-#}
{%-             set srt_kapts = kapts|unique|sort -%}
{%-             set jar_kapts = [] -%}
{%-             set cls_kapts = srt_kapts -%}
{%-             if file_jars|length -%}
{%-                 set jar_kapts = jar_kapts + srt_kapts|select('in', file_jars) -%}
{%-                 set cls_kapts = cls_kapts|reject('in', file_jars) -%}
{%-             endif -%}
{%-             if test_file_jars|length -%}
{%-                 set jar_kapts = jar_kapts + srt_kapts|select('in', test_file_jars) -%}
{%-                 set cls_kapts = cls_kapts|reject('in', test_file_jars) -%}
{%-             endif -%}
{%-             if jar_kapts|length %}
    {{ func }}(files(listOf(
{%-                 for kapt in jar_kapts %}
        "$output_root/{{ kapt }}",
{%-                 endfor %}
    )))
{%-             endif -%}
{%-             if cls_kapts|length -%}
{%-                 for kapt in cls_kapts -%}
{%-                     set path_and_jar = rsplit(kapt, "/", 2) -%}
{%-                     set classpath = 'project(":' + path_and_jar[0]|replace("/", ":") + '")' -%}
{%-                     include "[generator]/patch_classpath.jinja" %}
    {{ func }}({{ classpath }})
{%-                 endfor -%}
{%-             endif -%}
{%-         endif -%}
{%-     endif -%}
{%- endmacro -%}

{%- macro AddFileJars(file_jars) -%}
{%-     for file_jar in file_jars %}
        "$output_root/{{ file_jar }}",
{%-     endfor -%}
{%- endmacro -%}

{%- macro AddNonFileDeps(libraries, file_classpaths, implementationFunc, apiFunc) -%}
{%-     for library in libraries -%}
{%-         set classpath = library.classpath -%}
{%-         if library.type == "ejlibrary" or library.type == "swigdll" %}
{#-             External java library or DLL_JAVA #}
    {{ implementationFunc }}(files("$output_root/{{ library.jar }}"))
{%-         elif classpath and file_classpaths|select('eq', classpath)|length == 0 -%}
{%-             if library.type == "contrib" and library.jar and classpath|replace('project(":', '') != classpath %}
{#-                 Contrib in exported arcadia folders #}
    {{ implementationFunc }}(files("$output_root/{{ library.jar }}"))
{%-             else -%}
{%-                 if classpath|replace('"','') == classpath -%}
{%-                     set classpath = '"' + classpath + '"' -%}
{%-                 endif -%}
{%-                 include "[generator]/patch_classpath.jinja" -%}
{%-                 if library.type != "contrib" -%}
{%-                     if library.testdep -%}
{%-                         set classpath = '":' + library.testdep | replace("/", ":") + '"' -%}
{%-                         include "[generator]/patch_classpath.jinja" %}
    {{ implementationFunc }}(project(path = {{ classpath }}, configuration = "testArtifacts"))
{%-                     else %}
    {{ implementationFunc }}({{ classpath }})
{%-                     endif -%}
{%-                 else %}
    {{ apiFunc }}({{ classpath }})
{%-                 endif -%}
{%-                 if library.excludes.consumer|length and not build_contribs -%} {
{%-                     for exclude in library.excludes.consumer if exclude.classpath -%}
{%-                         set classpath = exclude.classpath|replace('"','') -%}
{%-                         set classpath_parts = split(classpath, ':') -%}
{%-                         if (classpath_parts[0] != "") and (classpath_parts[1] != "") %}
        exclude(group = "{{ classpath_parts[0] }}", module = "{{ classpath_parts[1] }}")
{%-                         endif -%}
{%-                     endfor %}
    }
{%-                 endif -%}
{%-             endif -%}
{%-         endif -%}
{%-     endfor -%}
{%- endmacro -%}

{%- set file_deps = target.consumer|selectattr('classpath')|selectattr('jar')|selectattr('prebuilt', 'eq', true) -%}
{%- if not build_contribs -%}
{%-     set file_deps = file_deps|selectattr('type', 'ne', 'contrib') -%}
{%- endif -%}
{%- set file_classpaths = file_deps|map(attribute='classpath')|unique|sort -%}
{%- set file_jars = file_deps|map(attribute='jar')|unique|sort -%}

{%- set test_file_deps = extra_targets|selectattr('consumer')|map(attribute='consumer')|sum|selectattr('classpath')|selectattr('jar')|selectattr('prebuilt', 'eq', true) -%}
{%- if not build_contribs -%}
{%-     set test_file_deps = test_file_deps|selectattr('type', 'ne', 'contrib') -%}
{%- endif -%}
{%- set test_file_classpaths = test_file_deps|map(attribute='classpath')|unique|sort -%}
{%- set test_file_jars = test_file_deps|map(attribute='jar')|reject("in", file_jars)|unique|sort -%}

dependencies {
{%- if errorprones|length -%}
{%-     for errorprone in errorprones|map(attribute='jar')|unique -%}
{%-         set errorprone_version = errorprone|replace("contrib/java/com/google/errorprone/error_prone_annotations/", "") -%}
{%-         set errorprone_parts = split(errorprone_version, '/', 2) %}
    errorprone("com.google.errorprone:error_prone_core:{{ errorprone_parts[0] }}")
{%-     endfor -%}
{%- endif -%}
{#- glue -#}
{{ AnnotationProcessors("annotationProcessor", target.use_annotation_processor) }}
{#- glue -#}
{{ AnnotationProcessors("annotationProcessor", target.use_annotation_processors) }}
{%- set test_annotation_processors = extra_targets|selectattr('use_annotation_processor')|map(attribute='use_annotation_processor')|sum -%}
{{ AnnotationProcessors("testAnnotationProcessor", test_annotation_processors) }}
{%- set test_annotation_processors = extra_targets|selectattr('use_annotation_processors')|map(attribute='use_annotation_processors')|sum -%}
{{ AnnotationProcessors("testAnnotationProcessor", test_annotation_processors) }}
{%- if with_kapt -%}
{{ Kapts("kapt", target.kapt.classpaths, file_jars, test_file_jars) }}
{#- glue -#}
{{ Kapts("kapt", target.kapt.kapts, file_jars, test_file_jars) }}
{%- endif -%}
{%- if with_test_kapt -%}
{%-     for extra_target in extra_targets -%}
{{ Kapts("kaptTest", extra_target.kapt.classpaths, file_jars, test_file_jars) }}
{#- glue -#}
{{ Kapts("kaptTest", extra_target.kapt.kapts, file_jars, test_file_jars) }}
{%-     endfor -%}
{%- endif -%}
{#- glue -#}
{{ AddNonFileDeps(target.consumer, file_classpaths, "implementation", "api") }}
{%- set target_jars = target.consumer|selectattr('jar')|map(attribute='jar') -%}
{{ AddNonFileDeps(extra_targets|selectattr('consumer')|map(attribute='consumer')|sum|rejectattr('jar', 'in', target_jars), test_file_classpaths, "testImplementation", "testImplementation") }}

{%- if file_jars|length %}
    implementation(files(listOf({#- glue -#}
{{ AddFileJars(file_jars) }}
    )))
{%- endif -%}

{%- if test_file_jars|length %}
    testImplementation(files(listOf({#- glue -#}
{{ AddFileJars(test_file_jars) }}
    )))
{%- endif %}

{%- if proto_template -%}
{%-     if prepareProtosTask %}
    protobuf(files(prepareMainProtos))
{%-     endif %}
{%-     if extractLibrariesProtosTask %}
    implementation(files(prepareMainIncludeProtos))
{%-     endif %}
{%- endif %}
}
