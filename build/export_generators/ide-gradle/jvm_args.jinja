{%- macro JvmArgs(jvm_args) -%}
{%-     if jvm_args|length -%}
{%-         set jnis_args = jvm_args|select('startsWith', 'jnis=') -%}
{%-         set other_jvm_args = jvm_args|reject('startsWith', 'jnis=') -%}
{%-         if jnis_args|length %}
    val library_path = listOf(
{%-             for jnis_arg in jnis_args -%}
{%-                 set jnis = split(jnis_arg|replace('jnis=', ''), ',') -%}
{%-                 for jni in jnis -%}
{%-                     set path_and_name = rsplit(jni, "/", 2) %}
        "$arcadia_root/{{ path_and_name[0] }}",
{%-                 endfor -%}
{%-             endfor %}
    ).joinToString(":")
{%          endif %}
    jvmArgs = mutableListOf(
{%-         if jnis_args|length -%}
{#-             Increase heap, else happened java.lang.OutOfMemoryError #}
        "-Xmx2048m",
        "-Djava.library.path=$library_path",
{%-         endif -%}
{%-         if other_jvm_args|length -%}
{%-             for jvm_arg in other_jvm_args %}
        "{{ jvm_arg }}",
{%-             endfor -%}
{%-         endif %}
    )
{%      endif -%}
{%- endmacro -%}

{%- set jvm_args = [] -%}
{%- if target.enable_preview -%}
{%-     set jvm_args = jvm_args + ["--enable-preview"] -%}
{%- endif -%}
{%- if jnis|length -%}
{%-     set jvm_args = jvm_args + ["jnis=" + jnis|join(",")] -%}
{%- endif %}
{%- if target.jvm_args|length %}
{%-     set jvm_args = jvm_args + target.jvm_args -%}
{%- endif -%}
{%- if jvm_args|length %}

tasks.withType<JavaExec> {
{#- glue -#}
{{ JvmArgs(jvm_args) }}
{#- glue -#}
}
{%- endif -%}

{%- set test_jvm_args = jvm_args -%}
{%- set extra_jvm_args = extra_targets|selectattr('jvm_args')|map(attribute='jvm_args')|sum -%}
{%- if extra_jvm_args|length and test_jvm_args != extra_jvm_args %}
{%-     set test_jvm_args = test_jvm_args + extra_jvm_args -%}
{%- endif -%}
{%- if test_jvm_args|length %}

tasks.withType<Test> {
{#- glue -#}
{{ JvmArgs(test_jvm_args) }}
{%- if target.enable_preview %}
    environment["JAVA_TOOL_OPTIONS"] = "--enable-preview"
{%- endif -%}
}
{%- endif -%}
