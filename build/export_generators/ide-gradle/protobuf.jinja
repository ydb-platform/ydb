{#- empty string #}
protobuf {
    protoc {
        // Download from repositories
        artifact = "com.google.protobuf:protoc:{%- if target.proto_compiler_version -%}{{ target.proto_compiler_version }}{%- else -%}3.22.5{%- endif -%}"
    }
{%- set proto_plugins = target.proto_plugins|rejectattr('name', 'eq', 'grpc_java') -%}
{%- if target.proto_grpc or proto_plugins|length %}

    plugins {
        id("grpc") {
            artifact = "io.grpc:protoc-gen-grpc-java:{%- if target.proto_grpc_version -%}{{ target.proto_grpc_version }}{%- else -%}1.45.0{%- endif -%}"
        }
{%-     if proto_plugins|length -%}
{%-         for proto_plugin in proto_plugins %}
        create("{{ proto_plugin.name }}") {
            path = {{ PatchRoots(proto_plugin.bin, true) }}
            rules
        }
{%-         endfor -%}
{%-     endif -%}
{%-     if target.proto_kotlin_grpc %}
        id("grpckt") {
            artifact = "io.grpc:protoc-gen-grpc-kotlin:{%- if target.proto_kotlin_grpc_version -%}{{ target.proto_kotlin_grpc_version }}{%- else -%}1.3.1{%- endif -%}:jdk8@jar"
        }
{%-     endif %}
    }
{%- endif %}

{%- if target.proto_kotlin or target.proto_grpc or proto_plugins|length %}

    generateProtoTasks {
        all().forEach {
{%-     if target.proto_grpc or proto_plugins|length %}
            it.plugins {
{%-         if target.proto_grpc %}
                id("grpc")
{%-         endif -%}
{%-         if target.proto_kotlin_grpc %}
                id("grpckt")
{%-         endif -%}
{%-         if proto_plugins|length -%}
{%-             for proto_plugin in proto_plugins %}
                create("{{ proto_plugin.name }}") {
                    outputSubDir = "java"
                }
{%-             endfor -%}
{%-         endif %}
            }
{%-     endif -%}
{%-     if target.proto_kotlin or target.proto_kotlin_grpc %}
            it.builtins {
                create("kotlin")
            }
{%-     endif %}
        }
    }
{%- endif %}
}
