title: iwyu
service: buildroot

shared:
  mapping_path: &mapping-path ${flow-vars.mapping_path}
  input: &base-input
    package: ${flow-vars.ix_package}
    toolchain_name: ${flow-vars.toolchain_name}

  native-build-params: &native-build
    checkout_arcadia_from_url: arcadia-arc:/#${tasks.update-mapping.result.arc_hash}
    targets: devtools/dummy_arcadia/cat
    package_ttl: 1
    build_logs_ttl: 1
    logs_ttl: 1

  shared-flow-vars-ui: &ui-vars
    required: [revision]
    type: object
    properties:
      revision:
        title: Repository revision (github.com/yandex/toolchains)
        type: string
        default: HEAD
      platforms:
        title: Build only for particular platforms (comma separated)
        type: string
        default: "linux-x86_64"

ci:
  secret: sec-01hnfbz3r6xqfacy9t3he0rzvf
  runtime:
    sandbox:
      owner: DTCC

  permissions:
    start-flow:
      - service: cc
      - service: ya_make

  releases:
    release-iwyu:
      title: "Release iwyu-22"
      flow: build-and-release-iwyu
      flow-vars:
        ix_package: ynd/bin/iwyu/22
        toolchain_name: iwyu-22
        mapping_path: build/platform/clang/iwyu/iwyu22.json
      flow-vars-ui:
        schema:
          <<: *ui-vars
      filters:
        - discovery: dir
          abs-paths:
            - toolchains/ynd/bin/iwyu/22/**

  flows:
    build-and-release-iwyu:
      title: "Build and Release ${flow-vars.toolchain_name}"
      jobs:
        build:
          title: Build
          task: projects/devtools/toolchain_registry/build
          input:
            <<: *base-input
            revision: ${flow-vars.revision}
            mapping_path: *mapping-path
            selected_platforms: ${flow-vars.platforms}

        release:
          title: Release
          task: projects/devtools/toolchain_registry/release
          needs: build
          input:
            <<: *base-input
            revision: ${flow-vars.revision}
            pr_id: ${tasks.build.output_params.pr_id}
            built_resources: ${tasks.build.output_params.built_resources}
