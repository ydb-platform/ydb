title: lld
service: buildroot

shared:
  mapping_path: &mapping-path ${flow-vars.mapping_path}
  input: &base-input
    package: ${flow-vars.ix_package}
    toolchain_name: ${flow-vars.toolchain_name}

  native-build-params: &native-build
    checkout_arcadia_from_url: arcadia-arc:/#${tasks.update-mapping.result.arc_hash}
    targets: devtools/dummy_arcadia/cat
    package_ttl: 1
    build_logs_ttl: 1
    logs_ttl: 1

  shared-flow-vars-ui: &ui-vars
    required: [revision]
    type: object
    properties:
      revision:
        title: Repository revision (github.com/yandex/toolchains)
        type: string
        default: HEAD
      platforms:
        title: Build only for particular platforms (comma separated)
        type: string
        default: ""

ci:
  secret: sec-01hnfbz3r6xqfacy9t3he0rzvf
  runtime:
    sandbox:
      owner: DTCC

  permissions:
    start-flow:
      - service: cc
      - service: ya_make

  releases:
    release-lld-16:
      title: "Release lld16"
      flow: build-and-release-lld
      flow-vars:
        ix_package: bin/lld/16/optimized
        toolchain_name: lld16
        mapping_path: build/platform/lld/lld16.json
      flow-vars-ui:
        schema:
          <<: *ui-vars
      filters:
        - discovery: dir
          abs-paths:
            - toolchains/ynd/bin/lld/16/**

    release-lld-18:
      title: "Release lld18"
      flow: build-and-release-lld
      flow-vars:
        ix_package: bin/lld/18
        toolchain_name: lld18
        mapping_path: build/platform/lld/lld18.json
      flow-vars-ui:
        schema:
          <<: *ui-vars
      filters:
        - discovery: dir
          abs-paths:
            - toolchains/ynd/bin/lld/18/**

    release-lld-20:
      title: "Release lld20"
      flow: build-and-release-lld
      flow-vars:
        ix_package: bin/lld/20
        toolchain_name: lld20
        mapping_path: build/platform/lld/lld20.json
      flow-vars-ui:
        schema:
          <<: *ui-vars
      filters:
        - discovery: dir
          abs-paths:
            - toolchains/ynd/bin/lld/20/**

  flows:
    build-and-release-lld:
      title: "Build and Release ${flow-vars.toolchain_name}"
      jobs:
        build:
          title: Build
          task: projects/devtools/toolchain_registry/build
          input:
            <<: *base-input
            revision: ${flow-vars.revision}
            mapping_path: *mapping-path
            selected_platforms: ${flow-vars.platforms}

        update-mapping:
          title: Update mapping.conf.json
          task: projects/devtools/deploy_mapping/deploy_mapping
          needs: build
          input:
            config:
              pr_id: ${tasks.build.output_params.pr_id}
              create_pr: false
              push_only: true
              orig_mapping: devtools/ya/opensource/mapping.conf.json
              public: true
              write_comment: false

        native-build-win32:
          title: "Build dummy project on win32"
          task: common/arcadia/ya_make
          needs: update-mapping
          requirements:
            sandbox:
              client_tags: GENERIC & WINDOWS
          input:
            <<: *native-build

        native-build-mac:
          title: "Build dummy project on MacOs"
          task: common/arcadia/ya_make
          needs: update-mapping
          requirements:
            sandbox:
              client_tags: GENERIC & OSX
          input:
            <<: *native-build

        release:
          title: Release
          task: projects/devtools/toolchain_registry/release
          needs: ['native-build-win32', 'native-build-mac']
          input:
            <<: *base-input
            revision: ${flow-vars.revision}
            pr_id: ${tasks.build.output_params.pr_id}
            built_resources: ${tasks.build.output_params.built_resources}
