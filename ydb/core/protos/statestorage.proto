import "ydb/library/actors/protos/actors.proto";
import "ydb/core/protos/base.proto";

package NKikimrStateStorage;
option java_package = "ru.yandex.kikimr.proto";

message TEvLookup {
    optional fixed64 TabletID = 1;
    optional uint64 Cookie = 2;
    optional uint64 ClusterStateGeneration = 3;
    optional fixed64 ClusterStateGuid = 4;
};

/**
 * The information about a follower for the given tablet.
 */
message TFollowerInfo {
    /**
     * The actor ID for the follower itself.
     */
    optional NActorsProto.TActorId Follower = 1;

    /**
     * The actor ID for the follower tablet;
     */
    optional NActorsProto.TActorId FollowerTablet = 2;

    /**
     * If set to true, this follower is a candidate.
     */
    optional bool IsCandidate = 3;

    /**
     * The follower ID for this follower.
     *
     * @warning In some cases State Storage does not know the follower ID
     *          for some followers. This can happen, if the given follower
     *          is running on an older node, which does not support reporting
     *          follower IDs.
     */
    optional uint32 FollowerId = 4;
}

message TEvInfo {
    optional NKikimrProto.EReplyStatus Status = 1;
    optional fixed64 TabletID = 2;
    optional uint64 Cookie = 3;
    optional NActorsProto.TActorId CurrentLeader = 4;
    optional NActorsProto.TActorId CurrentLeaderTablet = 5;
    optional uint32 CurrentGeneration = 6;
    optional uint32 CurrentStep = 7;
    optional bool Locked = 8;
    optional uint64 LockedFor = 9;
    optional uint64 Signature = 10;

    /**
     * @warning The Follower, FollowerTablet and FollowerCandidates fields
     *          are depricated. The FollowerInfo field should be used instead.
     *
     * @todo Remove the Follower, FollowerTablet and FollowerCandidates fields
     *       and update the code to use only the FollowerInfo field.
     */
    repeated NActorsProto.TActorId Follower = 11;
    repeated NActorsProto.TActorId FollowerTablet = 12;
    repeated NActorsProto.TActorId FollowerCandidates = 13;

    optional fixed32 ConfigContentHash = 14;
    optional uint64 ClusterStateGeneration = 15;
    optional fixed64 ClusterStateGuid = 16;

    /**
     * The list of followers for the given tablet.
     *
     * @warning This field supercedes the Follower, FollowerTablet
     *          and FollowerCandidate fields. For backwards compatibility,
     *          the now code will continue populating both the FollowerInfo field
     *          and the Follower, FollowerTablet, FollowerCandidate fields.
     *          At some point the old fields will be fully deprecated and removed
     *          from the API. At this point the code will need to be updated to stop
     *          using the old fields.
     *
     * @warning The new code should always use the FollowerInfo field,
     *          even if the old fields are populated.
     */
    repeated TFollowerInfo FollowerInfo = 17;
};

message TEvReplicaShutdown {
};

message TEvDumpRequest {
};

message TEvDump {
    repeated TEvInfo Info = 1;
};

message TEvUpdate {
    optional fixed64 TabletID = 1;
    optional uint64 Cookie = 2;
    optional NActorsProto.TActorId ProposedLeader = 3;
    optional NActorsProto.TActorId ProposedLeaderTablet = 4;
    optional uint32 ProposedGeneration = 5;
    optional uint32 ProposedStep = 6;
    optional uint64 Signature = 7;
    optional bool IsGuardian = 8;
    optional uint64 ClusterStateGeneration = 9;
    optional fixed64 ClusterStateGuid = 10;
};

message TEvDelete {
    optional fixed64 TabletID = 1;
    optional uint64 ClusterStateGeneration = 2;
    optional fixed64 ClusterStateGuid = 3;
};

message TEvCleanup {
    optional fixed64 TabletID = 1;
    optional NActorsProto.TActorId ProposedLeader = 2;
    optional uint64 ClusterStateGeneration = 3;
    optional fixed64 ClusterStateGuid = 4;
}

message TEvRegisterFollower {
    optional fixed64 TabletID = 1;
    optional NActorsProto.TActorId Follower = 2;
    optional NActorsProto.TActorId FollowerTablet = 3;
    optional bool Candidate = 4;
    optional uint64 ClusterStateGeneration = 5;
    optional fixed64 ClusterStateGuid = 6;
    optional uint32 FollowerId = 7;
}

message TEvUnregisterFollower {
    optional fixed64 TabletID = 1;
    optional NActorsProto.TActorId Follower = 2;
    optional uint64 ClusterStateGeneration = 3;
    optional fixed64 ClusterStateGuid = 4;
    optional uint32 FollowerId = 5;
}

message TEvLock {
    optional fixed64 TabletID = 1;
    optional uint64 Cookie = 2;
    optional NActorsProto.TActorId ProposedLeader = 3;
    optional uint32 ProposedGeneration = 4;
    optional uint64 Signature = 5;
    optional uint64 ClusterStateGeneration = 6;
    optional fixed64 ClusterStateGuid = 7;
};

message TEvReplicaLeaderDemoted {
    optional fixed64 TabletID = 1;
    optional uint64 Signature = 2;
};

message TEvReplicaBoardPublish {
    optional string Path = 1;
    optional bytes Payload = 2;
    optional uint64 TtlMs = 3;
    optional bool Register = 4;
    optional NActorsProto.TActorId Owner = 5;
    optional uint64 ClusterStateGeneration = 6;
    optional fixed64 ClusterStateGuid = 7;
};

message TEvReplicaBoardPublishAck {
};

message TEvReplicaBoardLookup {
    optional string Path = 1;
    reserved 2;
    optional bool Subscribe = 3;
    optional uint64 ClusterStateGeneration = 4;
    optional fixed64 ClusterStateGuid = 5;
};

message TEvReplicaBoardCleanup {
    optional uint64 ClusterStateGeneration = 1;
    optional fixed64 ClusterStateGuid = 2;
};

message TEvReplicaBoardUnsubscribe {
    optional uint64 ClusterStateGeneration = 1;
    optional fixed64 ClusterStateGuid = 2;
};

message TBoardEntryInfo {
    optional NActorsProto.TActorId Owner = 1;
    optional bytes Payload = 2;
    optional bool Dropped = 3 [default = false];
};

message TEvReplicaBoardInfo {
    optional string Path = 1;
    optional bool Dropped = 2;
    repeated TBoardEntryInfo Info = 3;
    optional uint64 ClusterStateGeneration = 4;
    optional fixed64 ClusterStateGuid = 5;
};

message TEvReplicaBoardInfoUpdate {
    optional string Path = 1;
    optional TBoardEntryInfo Info = 3;
    optional uint64 ClusterStateGeneration = 4;
    optional fixed64 ClusterStateGuid = 5;
};

message TEndpointBoardEntry {
    optional string Address = 1;
    optional uint32 Port = 2;
    optional float Load = 3;

    optional bool Ssl = 4;
    repeated string Services = 5;

    optional string DataCenter = 6;
    optional uint32 NodeId = 7;

    repeated string AddressesV4 = 8;
    repeated string AddressesV6 = 9;
    optional string TargetNameOverride = 10;
    optional string EndpointId = 11;

    optional string BridgePileName = 12;
};

