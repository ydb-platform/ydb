"use strict";(globalThis.webpackChunkydb_embedded_ui=globalThis.webpackChunkydb_embedded_ui||[]).push([[62377],{83796:(i,e,t)=>{t.r(e),t.d(e,{VDiskPage:()=>ni});var d=t(59284);const o=i=>d.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",viewBox:"0 0 16 16"},i),d.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M9.28 4.78a.75.75 0 0 0 0-1.06l-2.5-2.5a.75.75 0 1 0-1.06 1.06L6.94 3.5H1.75a.75.75 0 1 0 0 1.5h5.19L5.72 6.22a.75.75 0 1 0 1.06 1.06zm-.06 3.94-2.5 2.5a.75.75 0 0 0 0 1.06l2.5 2.5a.75.75 0 1 0 1.06-1.06L9.06 12.5h5.19a.75.75 0 0 0 0-1.5H9.06l1.22-1.22a.75.75 0 1 0-1.06-1.06M14 4.25a1.75 1.75 0 1 1-3.5 0 1.75 1.75 0 0 1 3.5 0M3.75 13.5a1.75 1.75 0 1 0 0-3.5 1.75 1.75 0 0 0 0 3.5",clipRule:"evenodd"}));var n=t(47653),s=t(96727),a=t(29859),l=t(66212),r=t(4980),v=t(13847),u=t(61750),c=t(80987),I=t(370),g=t(22983),D=t(3685),k=t(44508),b=t(42655),p=t(69832),h=t(58389),m=t(67808),N=t(92459),y=t(21334),f=t(67028),w=t(40174),S=t(7187),x=t(27295),T=t(78034);const j=y.F.injectEndpoints({endpoints:i=>({getVDiskData:i.query({queryFn:async(i,{signal:e})=>{try{const{nodeId:t,database:d,vDiskId:o}=i,n=o.split("-",1)[0],s=[window.api.storage.getStorageGroups({groupId:n,database:d,nodeId:t,fieldsRequired:"all"},{signal:e}),t?window.api.viewer.getNodeInfo({nodeId:t,database:d},{signal:e}):void 0],a=function([i,e],t){var d,o,n,s,a,l,r,v;const u=null===i||void 0===i||null===(d=i.StorageGroups)||void 0===d||null===(o=d[0].VDisks)||void 0===o?void 0:o.find((({VDiskId:i})=>i===t)),c=(0,x.WT)(null===u||void 0===u?void 0:u.Whiteboard),I=null===u||void 0===u||null===(n=u.PDisk)||void 0===n?void 0:n.Whiteboard,g=(0,x.or)(I),D=null===e||void 0===e||null===(s=e.SystemStateInfo)||void 0===s?void 0:s[0],k=(0,T.q1)(D),b=null!==(a=null!==(l=c.NodeId)&&void 0!==l?l:g.NodeId)&&void 0!==a?a:k.NodeId,p=k.Host,h=null===(r=k.Roles)||void 0===r?void 0:r[0],m=k.DC,N=null!==(v=c.PDiskId)&&void 0!==v?v:g.PDiskId,y=g.Type;return{...c,NodeId:b,NodeHost:p,NodeType:h,NodeDC:m,PDiskId:N,PDiskType:y}}(await Promise.all(s),o);return{data:a}}catch(t){return{error:t}}},providesTags:(i,e,t)=>["All",{type:"VDiskData",id:t.vDiskId}]}),getVDiskBlobIndexStat:i.query({queryFn:async({nodeId:i,pDiskId:e,vDiskSlotId:t,database:d},{signal:o})=>{try{return{data:await window.api.viewer.getVDiskBlobIndexStat({nodeId:i,pDiskId:e,vDiskSlotId:t,database:d},{signal:o})}}catch(n){return{error:n}}},providesTags:(i,e,t)=>["All",{type:"VDiskBlobIndexStat",id:(0,S.gh)(t.nodeId,t.pDiskId,t.vDiskSlotId)}]})}),overrideExisting:"throw"});var V=t(77506),C=t(53627),P=t(12888),$=t(81188),G=t(47199),E=t(4557),R=t(64689),z=t(17594),A=t(69326),H=t(76086),q=t(41650),B=t(48372);const F=JSON.parse('{"fqdn":"FQDN","node":"Node","pdisk":"PDisk","vdisk":"VDisk","storage":"Storage","tablets":"Tablets","tablet-id":"Tablet ID","channel-id":"Channel ID","count":"Count","size":"Size","evict-vdisk-button":"Evict VDisk","force-evict-vdisk-button":"Evict anyway","evict-vdisk-dialog-header":"Evict VDisk","evict-vdisk-dialog-text":"VDisk will be evicted. Do you want to proceed?","evict-vdisk-not-allowed":"You don\'t have enough rights to evict VDisk"}'),_=(0,B.g4)("ydb-vDisk-page",{en:F});var M=t(56839),L=t(28232);const Q="TabletId",W="ChannelId",O="Count",J="Size",X={[Q]:_("tablet-id"),[W]:_("channel-id"),[O]:_("count"),[J]:_("size")};var Y=t(60712);function K({id:i}){const e=(0,L.J)();return(0,Y.jsx)(p.E,{to:(0,N.DM)(i,{database:e}),children:i})}const Z="vdiskTabletsColumnsWidth",U=[{name:Q,header:X[Q],render:({row:i})=>{const e=i.TabletId;return e?(0,Y.jsx)(K,{id:e}):H.Pd},width:220},{name:W,header:X[W],align:E.Ay.RIGHT,render:({row:i})=>{var e;return null!==(e=i.ChannelId)&&void 0!==e?e:H.Pd},width:130,sortable:!0},{name:O,header:X[O],align:E.Ay.RIGHT,render:({row:i})=>(0,v.isNil)(i.Count)?H.Pd:(0,M.ZV)(i.Count),width:100},{name:J,header:X[J],align:E.Ay.RIGHT,render:({row:i})=>{const e=i.Size;if((0,v.isNil)(e))return H.Pd;const t=(0,q.y3)(e);return(0,M.z3)(t)},width:120}];function ii({nodeId:i,pDiskId:e,vDiskSlotId:t,className:o,scrollContainerRef:n}){const[s]=(0,C.Nt)(),{currentData:a,isFetching:l,error:u}=j.useGetVDiskBlobIndexStatQuery((0,v.isNil)(i)||(0,v.isNil)(e)||(0,v.isNil)(t)?r.hT:{nodeId:i,pDiskId:e,vDiskSlotId:t},{pollingInterval:s}),c=l&&void 0===a,I=d.useMemo((()=>{if(!a)return[];const i=a.stat;if(!i||!Array.isArray(i.tablets))return[];const e=[];return i.tablets.forEach((i=>{const t=i.tablet_id;t&&Array.isArray(i.channels)&&i.channels.forEach(((i,d)=>{i.count&&i.data_size&&e.push({TabletId:t,ChannelId:d,Count:(0,q.y3)(i.count),Size:(0,q.y3)(i.data_size)})}))})),e}),[a]);return u?(0,Y.jsx)(R.A,{error:u,position:"left",size:"s"}):(0,Y.jsx)("div",{className:o,children:(0,Y.jsx)(A.L.Table,{scrollContainerRef:n,loading:c,children:(0,Y.jsx)(z.l,{columnsWidthLSKey:Z,data:I,columns:U,settings:H.N3,initialSortOrder:{columnId:_("size"),order:E.Ay.DESCENDING}})})})}const ei=(0,V.cn)("ydb-vdisk-page"),ti={storage:"storage",tablets:"tablets"},di=[{id:ti.storage,get title(){return _("storage")}},{id:ti.tablets,get title(){return _("tablets")}}],oi=I.z.nativeEnum(ti).catch(ti.storage);function ni(){var i;const e=(0,C.YQ)(),t=d.useRef(null),I=(0,P.X)(),x=(0,f.c2)(),[{nodeId:T,pDiskId:V,vDiskId:E,activeTab:R,database:z}]=(0,c.useQueryParams)({nodeId:c.StringParam,pDiskId:c.StringParam,vDiskId:c.StringParam,activeTab:c.StringParam,database:c.StringParam}),A=null!==z&&void 0!==z?z:void 0,H=oi.parse(R),[q]=(0,C.Nt)(),B=d.useMemo((()=>(0,v.isNil)(E)?r.hT:{vDiskId:E,nodeId:null===T||void 0===T?void 0:T.toString(),database:A}),[T,E,A]),{currentData:F,isFetching:M,error:L}=j.useGetVDiskDataQuery(B,{pollingInterval:q}),Q=null===F||void 0===F?void 0:F.VDiskSlotId;d.useEffect((()=>{var i;e((0,w.g)("vDisk",{groupId:null===F||void 0===F||null===(i=F.VDiskId)||void 0===i?void 0:i.GroupID,tenantName:A,vDiskId:null===F||void 0===F?void 0:F.StringifiedId}))}),[e,A,null===F||void 0===F||null===(i=F.VDiskId)||void 0===i?void 0:i.GroupID,null===F||void 0===F?void 0:F.StringifiedId]);const W=M&&void 0===F,{NodeHost:O,NodeId:J,NodeType:X,NodeDC:K,PDiskId:Z,PDiskType:U,Severity:ti,VDiskId:ni}=F||{},{GroupID:si,GroupGeneration:ai,Ring:li,Domain:ri,VDisk:vi}=ni||!W&&function(i){const e=/^(\d+)-(\d+)-(\d+)-(\d+)-(\d+)$/.exec(null!==i&&void 0!==i?i:"");if(!e)return;const[,t,d,o,n,s]=e;return{GroupID:Number(t),GroupGeneration:Number(d),Ring:Number(o),Domain:Number(n),VDisk:Number(s)}}(E)||{},ui=!(0,v.isNil)(si)&&!(0,v.isNil)(ai)&&!(0,v.isNil)(li)&&!(0,v.isNil)(ri)&&!(0,v.isNil)(vi),ci=async i=>{if(ui){var e;const t={groupId:si,groupGeneration:ai,failRealmIdx:li,failDomainIdx:ri,vDiskIdx:vi,force:i};let d;if(d=x?await window.api.vdisk.evictVDisk(t):await window.api.tablets.evictVDiskOld(t),!1===(null===(e=d)||void 0===e?void 0:e.result)){throw{statusText:d.error,retryPossible:d.forceRetryPossible}}}},Ii=(null===F||void 0===F?void 0:F.StringifiedId)||(W?void 0:E),gi=()=>{e(y.F.util.invalidateTags([{type:"VDiskData",id:null===Ii||void 0===Ii?void 0:Ii.toString()},"StorageData"]))},{appTitle:Di}=(0,$.J)(),ki=()=>{switch(H){case"storage":return bi();case"tablets":return(0,Y.jsx)(ii,{scrollContainerRef:t,nodeId:null!==T&&void 0!==T?T:void 0,pDiskId:null!==V&&void 0!==V?V:void 0,vDiskSlotId:null!==Q&&void 0!==Q?Q:void 0,className:ei("tablets-content")});default:return null}},bi=()=>(0,v.isNil)(si)?null:(0,Y.jsx)(G.z,{database:A,groupId:si,nodeId:null!==T&&void 0!==T?T:void 0,pDiskId:null!==V&&void 0!==V?V:void 0,scrollContainerRef:t,viewContext:{groupId:null===si||void 0===si?void 0:si.toString(),nodeId:null===T||void 0===T?void 0:T.toString(),pDiskId:null===V||void 0===V?void 0:V.toString(),vDiskSlotId:null===Q||void 0===Q?void 0:Q.toString()}});return(0,Y.jsxs)("div",{className:ei(null),ref:t,children:[(()=>{const i=Q?`${_("vdisk")} ${Q}`:_("vdisk"),e=V?`${_("pdisk")} ${V}`:_("pdisk"),t=O||_("node");return(0,Y.jsx)(u.mg,{titleTemplate:`%s - ${i} - ${e} \u2014 ${t} \u2014 ${Di}`,defaultTitle:`${i} - ${e} \u2014 ${t} \u2014 ${Di}`})})(),(()=>{const i=O?`${_("fqdn")}: ${O}`:void 0,e=J?`${_("node")}: ${J}`:void 0,t=J?`${_("pdisk")}: ${Z}`:void 0;return(0,Y.jsx)(h.B,{className:ei("meta"),loading:W,items:[i,e,X,K,t,U]})})(),(0,Y.jsx)(D.$,{className:ei("title"),entityName:_("vdisk"),status:(0,S.XY)(ti),id:Ii}),(0,Y.jsx)("div",{className:ei("controls"),children:(0,Y.jsxs)(g.B,{onConfirmAction:ci,onConfirmActionSuccess:gi,buttonDisabled:!ui||!I,buttonView:"normal",dialogHeader:_("evict-vdisk-dialog-header"),dialogText:_("evict-vdisk-dialog-text"),retryButtonText:_("force-evict-vdisk-button"),withPopover:!0,popoverContent:_("evict-vdisk-not-allowed"),popoverDisabled:I,children:[(0,Y.jsx)(n.I,{data:o}),_("evict-vdisk-button")]})}),W?(0,Y.jsx)(b.y,{rows:9}):(0,Y.jsxs)(d.Fragment,{children:[L?(0,Y.jsx)(k.o,{error:L}):null,(0,Y.jsx)(m.E,{data:F,className:ei("info"),wrap:!0}),(0,Y.jsx)("div",{className:ei("tabs"),children:(0,Y.jsx)(s.f,{value:H,children:(0,Y.jsx)(a.w,{size:"l",children:di.map((({id:i,title:e})=>{let t;return(0,v.isNil)(Ii)||(t=(0,N.yX)({nodeId:null===T||void 0===T?void 0:T.toString(),vDiskId:null===Ii||void 0===Ii?void 0:Ii.toString()},{activeTab:i,database:A})),(0,Y.jsx)(l.o,{value:i,disabled:!t,children:(0,Y.jsx)(p.E,{as:"tab",to:t,children:e})},i)}))})})}),ki()]})]})}}}]);