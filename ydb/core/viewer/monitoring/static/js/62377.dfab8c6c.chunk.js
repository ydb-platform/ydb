"use strict";(globalThis.webpackChunkydb_embedded_ui=globalThis.webpackChunkydb_embedded_ui||[]).push([[62377],{83796:(e,i,t)=>{t.r(i),t.d(i,{VDiskPage:()=>de});var d=t(59284);const o=e=>d.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",viewBox:"0 0 16 16"},e),d.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M9.28 4.78a.75.75 0 0 0 0-1.06l-2.5-2.5a.75.75 0 1 0-1.06 1.06L6.94 3.5H1.75a.75.75 0 1 0 0 1.5h5.19L5.72 6.22a.75.75 0 1 0 1.06 1.06zm-.06 3.94-2.5 2.5a.75.75 0 0 0 0 1.06l2.5 2.5a.75.75 0 1 0 1.06-1.06L9.06 12.5h5.19a.75.75 0 0 0 0-1.5H9.06l1.22-1.22a.75.75 0 1 0-1.06-1.06M14 4.25a1.75 1.75 0 1 1-3.5 0 1.75 1.75 0 0 1 3.5 0M3.75 13.5a1.75 1.75 0 1 0 0-3.5 1.75 1.75 0 0 0 0 3.5",clipRule:"evenodd"}));var n=t(47653),s=t(96727),a=t(29859),r=t(66212),l=t(4980),v=t(61750),u=t(80987),c=t(370),I=t(22983),k=t(3685),D=t(44508),g=t(42655),p=t(69832),h=t(58389),b=t(67808),f=t(92459),m=t(21334),w=t(67028),y=t(40174),S=t(7187),x=t(27295),N=t(78034);const T=m.F.injectEndpoints({endpoints:e=>({getVDiskData:e.query({queryFn:async({nodeId:e,pDiskId:i,vDiskSlotId:t},{signal:d})=>{try{const o=await Promise.all([window.api.viewer.getVDiskInfo({nodeId:e,pDiskId:i,vDiskSlotId:t},{signal:d}),window.api.viewer.getNodeWhiteboardPDiskInfo({nodeId:e,pDiskId:i},{signal:d}),window.api.viewer.getNodeInfo(e,{signal:d})]);return{data:function([e,i,t]){var d,o,n,s,a,r,l;const v=null===(d=e.VDiskStateInfo)||void 0===d?void 0:d[0],u=(0,x.WT)(v),c=null===(o=i.PDiskStateInfo)||void 0===o?void 0:o[0],I=(0,x.or)(c),k=null===(n=t.SystemStateInfo)||void 0===n?void 0:n[0],D=(0,N.q1)(k),g=null!==(s=null!==(a=u.NodeId)&&void 0!==a?a:I.NodeId)&&void 0!==s?s:D.NodeId,p=D.Host,h=null===(r=D.Roles)||void 0===r?void 0:r[0],b=D.DC,f=null!==(l=u.PDiskId)&&void 0!==l?l:I.PDiskId,m=I.Type;return{...u,NodeId:g,NodeHost:p,NodeType:h,NodeDC:b,PDiskId:f,PDiskType:m}}(o)}}catch(o){return{error:o}}},providesTags:(e,i,t)=>["All",{type:"VDiskData",id:(0,S.gh)(t.nodeId,t.pDiskId,t.vDiskSlotId)}]}),getVDiskBlobIndexStat:e.query({queryFn:async({nodeId:e,pDiskId:i,vDiskSlotId:t},{signal:d})=>{try{return{data:await window.api.viewer.getVDiskBlobIndexStat({nodeId:e,pDiskId:i,vDiskSlotId:t},{signal:d})}}catch(o){return{error:o}}},providesTags:(e,i,t)=>["All",{type:"VDiskBlobIndexStat",id:(0,S.gh)(t.nodeId,t.pDiskId,t.vDiskSlotId)}]})}),overrideExisting:"throw"});var j=t(7435),P=t(77506),V=t(53627),C=t(12888),$=t(81188),E=t(47199),z=t(4557),A=t(64689),G=t(17594),R=t(76086),H=t(41650),B=t(48372);const F=JSON.parse('{"fqdn":"FQDN","node":"Node","pdisk":"PDisk","vdisk":"VDisk","storage":"Storage","tablets":"Tablets","tablet-id":"Tablet ID","channel-id":"Channel ID","count":"Count","size":"Size","evict-vdisk-button":"Evict VDisk","force-evict-vdisk-button":"Evict anyway","evict-vdisk-dialog-header":"Evict VDisk","evict-vdisk-dialog-text":"VDisk will be evicted. Do you want to proceed?","evict-vdisk-not-allowed":"You don\'t have enough rights to evict VDisk"}'),q=(0,B.g4)("ydb-vDisk-page",{en:F});var _=t(13847),M=t(56839);const Q="TabletId",L="ChannelId",O="Count",W="Size",X={[Q]:q("tablet-id"),[L]:q("channel-id"),[O]:q("count"),[W]:q("size")};var Y=t(60712);const J="vdiskTabletsColumnsWidth",K=[{name:Q,header:X[Q],render:({row:e})=>{const i=e.TabletId;return i?(0,Y.jsx)(p.E,{to:(0,f.DM)(String(i)),children:i}):R.Pd},width:220},{name:L,header:X[L],align:z.Ay.RIGHT,render:({row:e})=>{var i;return null!==(i=e.ChannelId)&&void 0!==i?i:R.Pd},width:130,sortable:!0},{name:O,header:X[O],align:z.Ay.RIGHT,render:({row:e})=>(0,_.isNil)(e.Count)?R.Pd:(0,M.ZV)(e.Count),width:100},{name:W,header:X[W],align:z.Ay.RIGHT,render:({row:e})=>{const i=e.Size;if((0,_.isNil)(i))return R.Pd;const t=(0,H.y3)(i);return(0,M.z3)(t)},width:120}];function Z({nodeId:e,pDiskId:i,vDiskSlotId:t,className:o}){const[n]=(0,V.Nt)(),s=e&&i&&t?{nodeId:e,pDiskId:i,vDiskSlotId:t}:l.hT,{currentData:a,isFetching:r,error:v}=T.useGetVDiskBlobIndexStatQuery(s,{pollingInterval:n}),u=r&&void 0===a,c=d.useMemo((()=>{if(!a)return[];const e=a.stat;if(!e||!Array.isArray(e.tablets))return[];const i=[];return e.tablets.forEach((e=>{const t=e.tablet_id;t&&Array.isArray(e.channels)&&e.channels.forEach(((e,d)=>{e.count&&e.data_size&&i.push({TabletId:t,ChannelId:d,Count:(0,H.y3)(e.count),Size:(0,H.y3)(e.data_size)})}))})),i}),[a]);return v?(0,Y.jsx)(A.A,{error:v,position:"left",size:"s"}):u?(0,Y.jsx)(g.y,{rows:5}):(0,Y.jsx)("div",{className:o,children:(0,Y.jsx)(G.l,{columnsWidthLSKey:J,data:c,columns:K,settings:R.N3,loading:u,initialSortOrder:{columnId:q("size"),order:z.Ay.DESCENDING}})})}const U=(0,P.cn)("ydb-vdisk-page"),ee={storage:"storage",tablets:"tablets"},ie=[{id:ee.storage,get title(){return q("storage")}},{id:ee.tablets,get title(){return q("tablets")}}],te=c.z.nativeEnum(ee).catch(ee.storage);function de(){const e=(0,V.YQ)(),i=d.useRef(null),t=(0,C.X)(),c=(0,w.c2)(),[{nodeId:x,pDiskId:N,vDiskSlotId:P,vDiskId:z,activeTab:A}]=(0,u.useQueryParams)({nodeId:u.StringParam,pDiskId:u.StringParam,vDiskSlotId:u.StringParam,vDiskId:u.StringParam,activeTab:u.StringParam}),G=te.parse(A);d.useEffect((()=>{e((0,y.g)("vDisk",{nodeId:x,pDiskId:N,vDiskSlotId:P}))}),[e,x,N,P]);const[R]=(0,V.Nt)(),H=(0,j.f8)(x)&&(0,j.f8)(N)&&(0,j.f8)(P)?{nodeId:x,pDiskId:N,vDiskSlotId:P}:l.hT,{currentData:B,isFetching:F,error:_}=T.useGetVDiskDataQuery(H,{pollingInterval:R}),M=F&&void 0===B,{NodeHost:Q,NodeId:L,NodeType:O,NodeDC:W,PDiskId:X,PDiskType:J,Severity:K,VDiskId:ee}=B||{},{GroupID:de,GroupGeneration:oe,Ring:ne,Domain:se,VDisk:ae}=ee||!M&&function(e){const i=/^(\d+)-(\d+)-(\d+)-(\d+)-(\d+)$/.exec(null!==e&&void 0!==e?e:"");if(!i)return;const[,t,d,o,n,s]=i;return{GroupID:Number(t),GroupGeneration:Number(d),Ring:Number(o),Domain:Number(n),VDisk:Number(s)}}(z)||{},re=(0,j.f8)(de)&&(0,j.f8)(oe)&&(0,j.f8)(ne)&&(0,j.f8)(se)&&(0,j.f8)(ae),le=async e=>{if(re){var i;const t={groupId:de,groupGeneration:oe,failRealmIdx:ne,failDomainIdx:se,vDiskIdx:ae,force:e};let d;if(d=c?await window.api.vdisk.evictVDisk(t):await window.api.tablets.evictVDiskOld(t),!1===(null===(i=d)||void 0===i?void 0:i.result)){throw{statusText:d.error,retryPossible:d.forceRetryPossible}}}},ve=()=>{e(m.F.util.invalidateTags([{type:"VDiskData",id:(0,S.gh)(x||0,N||0,P||0)},"StorageData"]))},{appTitle:ue}=(0,$.J)(),ce=()=>{const e=(0,j.f8)(x)&&(0,j.f8)(N)&&(0,j.f8)(P);return(0,Y.jsx)("div",{className:U("tabs"),children:(0,Y.jsx)(s.f,{value:G,children:(0,Y.jsx)(a.w,{size:"l",children:ie.map((({id:i,title:t})=>{const d=e?(0,f.yX)({nodeId:x,pDiskId:N,vDiskSlotId:P},{activeTab:i}):void 0;return(0,Y.jsx)(r.o,{value:i,children:(0,Y.jsx)(p.E,{as:"tab",to:d,children:t})},i)}))})})})},Ie=()=>{switch(G){case"storage":return ke();case"tablets":return(0,Y.jsx)(Z,{nodeId:null!==x&&void 0!==x?x:void 0,pDiskId:null!==N&&void 0!==N?N:void 0,vDiskSlotId:null!==P&&void 0!==P?P:void 0,className:U("tablets-content")});default:return null}},ke=()=>(0,j.f8)(de)&&(0,j.f8)(x)?(0,Y.jsx)(E.z,{groupId:de,nodeId:x,pDiskId:null!==N&&void 0!==N?N:void 0,scrollContainerRef:i,viewContext:{groupId:null===de||void 0===de?void 0:de.toString(),nodeId:null===x||void 0===x?void 0:x.toString(),pDiskId:null===N||void 0===N?void 0:N.toString(),vDiskSlotId:null===P||void 0===P?void 0:P.toString()}}):null;return(0,Y.jsxs)("div",{className:U(null),ref:i,children:[(()=>{const e=P?`${q("vdisk")} ${P}`:q("vdisk"),i=N?`${q("pdisk")} ${N}`:q("pdisk"),t=Q||q("node");return(0,Y.jsx)(v.mg,{titleTemplate:`%s - ${e} - ${i} \u2014 ${t} \u2014 ${ue}`,defaultTitle:`${e} - ${i} \u2014 ${t} \u2014 ${ue}`})})(),(()=>{const e=Q?`${q("fqdn")}: ${Q}`:void 0,i=L?`${q("node")}: ${L}`:void 0,t=L?`${q("pdisk")}: ${X}`:void 0;return(0,Y.jsx)(h.B,{className:U("meta"),loading:M,items:[e,i,O,W,t,J]})})(),(0,Y.jsx)(k.$,{className:U("title"),entityName:q("vdisk"),status:(0,S.XY)(K),id:(null===B||void 0===B?void 0:B.StringifiedId)||!M&&z}),(0,Y.jsx)("div",{className:U("controls"),children:(0,Y.jsxs)(I.B,{onConfirmAction:le,onConfirmActionSuccess:ve,buttonDisabled:!re||!t,buttonView:"normal",dialogHeader:q("evict-vdisk-dialog-header"),dialogText:q("evict-vdisk-dialog-text"),retryButtonText:q("force-evict-vdisk-button"),withPopover:!0,popoverContent:q("evict-vdisk-not-allowed"),popoverDisabled:t,children:[(0,Y.jsx)(n.I,{data:o}),q("evict-vdisk-button")]})}),M?(0,Y.jsx)(g.y,{rows:9}):(0,Y.jsxs)(d.Fragment,{children:[_?(0,Y.jsx)(D.o,{error:_}):null,(0,Y.jsx)(b.E,{data:B,className:U("info"),wrap:!0}),ce(),Ie()]})]})}}}]);