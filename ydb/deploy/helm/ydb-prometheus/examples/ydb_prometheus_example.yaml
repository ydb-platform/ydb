groups:
- name: ydb-rules
  rules:
  - alert: YDBHealthCheck
    expr: ydb_healthcheck{STATUS!="GOOD"}
    for: 1m
    labels:
      severity: '{{ if or (eq $labels.STATUS "RED") (eq $labels.STATUS "DEGRADED") }} critical {{ else }} warning {{ end }}'
      component: ydb
      database: "{{ $labels.DATABASE }}"
      type: "{{ $labels.TYPE }}"
      instance: "{{ $labels.instance }}"
    annotations:
      summary: "YDB Health Issue in {{ $labels.DATABASE }} (Status: {{ $labels.STATUS }})"
      description: |
        Health check failed for YDB.
        - Status: {{ $labels.STATUS }}
        - Message: {{ $labels.MESSAGE }}
        - Type: {{ $labels.TYPE }}
        - Database: {{ $labels.DATABASE }}
        - Domain: {{ $labels.DOMAIN }}
        - Instance: {{ $labels.instance }}
        This issue has been active for more than 1 minute.
  - alert: YDBExecPoolHighUtilization
    expr: |
      (
        sum by (instance, execpool) (
          rate(utils_ElapsedMicrosec[1m])
        ) / 1000000
      ) > 0.9
    for: 1m
    labels:
      severity: critical
      component: ydb
      subsystem: execpool
      instance: "{{ $labels.instance }}"
      execpool: "{{ $labels.execpool }}"
    annotations:
      summary: "YDB ExecPool high utilization on {{ $labels.instance }}"
      description: |
        ExecPool {{ $labels.execpool }} on host {{ $labels.instance }}
        is loaded at {{ $value | humanizePercentage }}.
        This may lead to performance degradation.
        - Instance: {{ $labels.instance }}
        - ExecPool: {{ $labels.execpool }}
        - Current utilization: {{ $value | humanizePercentage }}
  - alert: YDBAuthTicketErrors
    expr: auth_TicketsErrors > 2
    for: 1m
    labels:
      severity: critical
      component: ydb
      subsystem: auth
      instance: "{{ $labels.instance }}"
    annotations:
      summary: "YDB authentication ticket errors on {{ $labels.instance }}"
      description: |
        Authentication errors detected in YDB.
        This may indicate security issues or misconfiguration.
        - Current error count: {{ $value }}
        - Instance: {{ $labels.instance }}
        - Host: {{ $labels.host }}
  - alert: YDBStorageUsageWarning
    expr: |
      (ydb_resources_storage_used_bytes / ydb_resources_storage_limit_bytes) * 100 > 80
      and ydb_resources_storage_limit_bytes > 0
    for: 5m
    labels:
      severity: warning
      component: ydb
      subsystem: storage
      database: "{{ $labels.database }}"
    annotations:
      summary: "High storage usage in YDB database {{ $labels.database }}"
      description: |
        Storage usage is above warning threshold.
        Consider cleaning up old data or increasing storage capacity.
        - Database: {{ $labels.database }}
        - Current usage: {{ printf "%.2f" $value }}%
        - Threshold: 80%
        - Duration: more than 5 minutes
  - alert: YDBStorageUsageCritical
    expr: |
      (ydb_resources_storage_used_bytes / ydb_resources_storage_limit_bytes) * 100 > 90
      and ydb_resources_storage_limit_bytes > 0
    for: 5m
    labels:
      severity: critical
      component: ydb
      subsystem: storage
      database: "{{ $labels.database }}"
    annotations:
      summary: "Critical storage usage in YDB database {{ $labels.database }}"
      description: |
        Storage usage is critically high. Immediate action required!
        Database may stop accepting writes soon.
        - Database: {{ $labels.database }}
        - Current usage: {{ printf "%.2f" $value }}%
        - Threshold: 90%
        - Duration: more than 5 minutes

