# Векторные индексы

{{ ydb-short-name }} поддерживает [векторные индексы](https://en.wikipedia.org/wiki/Vector_database) для эффективного приближенного поиска k ближайших строк к вектору запроса (ANN поиск). В отличие от [вторичных индексов](secondary_indexes.md), оптимизирующих поиск по равенству или диапазону, векторные индексы позволяют выполнять поиск по сходству на основе функций расстояния или схожести.

Векторные индексы особенно полезны для:

* рекомендательных систем (поиск похожих товаров/пользователей;
* cемантического поиска (сопоставление текстовых эмбеддингов);
* поиска похожих изображений;
* обнаружения аномалий (поиск выбросов);
* классификационных систем (поиск ближайших размеченных примеров).

## Характеристики векторных индексов {#characteristics}

Векторные индексы в {{ ydb-short-name }} решают задачу поиска ближайших соседей с использованием функций схожести или расстояния.

Поддерживается несколько функций расстояния/схожести: "inner_product", "cosine" (схожесть) и "cosine", "euclidean" и "manhattan" (расстояние).

В текущей реализации доступен один тип индекса: `vector_kmeans_tree`.

### Векторный индекс типа `vector_kmeans_tree` {#vector-kmeans-tree-type}

Индекс `vector_kmeans_tree` реализует иерархическую кластеризацию данных. Его структура включает:

1. Иерархическая кластеризация:

    - индекс строит несколько уровней k-means кластеров;
    - на каждом уровне векторы распределяются по заданному количеству кластеров в степени уровня;
    - первый уровень кластеризует весь набор данных;
    - последующие уровни рекурсивно кластеризуют содержимое каждого родительского кластера.

2. Процесс поиска:

    - поиск идет рекурсивно от первого уровня к последующим;
    - при выполнении запросов индекс анализирует только наиболее перспективные кластеры;
    - такое усечение пространства поиска позволяет избежать полного перебора всех векторов.

3. Параметры:

    - `levels`: число уровней в дереве, задает глубину поиска (обычно 1-3);
    - `clusters`: число кластеров в k-means, определяет ширину поиска (обычно 64-512).

## Типы векторных индексов {#types}

### Базовый векторный индекс {#basic}

Глобальный векторный индекс по колонке `embedding`:  

```yql
ALTER TABLE my_table
  ADD INDEX my_index
  GLOBAL USING vector_kmeans_tree
  ON (embedding)
  WITH (distance=cosine, type="uint8", dimension=512, levels=2, clusters=128);
```

### Векторный индекс с покрывающими колонками {#covering}

Покрывающий векторный индекс, включающий дополнительную колонку `data`, чтобы избежать чтения из основной таблицы при поиске:  

```yql
ALTER TABLE my_table
  ADD INDEX my_index
  GLOBAL USING vector_kmeans_tree
  ON (embedding) COVER (data)
  WITH (distance=cosine, type="uint8", dimension=512, levels=2, clusters=128);
```

### Векторный индекс с префиксом {#prefixed}

Векторный индекс с префиксом, позволяющий фильтровать по префиксной колонке `user` в момент выполнения векторного поиска:

```yql
ALTER TABLE my_table
  ADD INDEX my_index
  GLOBAL USING vector_kmeans_tree
  ON (user, embedding)
  WITH (distance=cosine, type="uint8", dimension=512, levels=2, clusters=128);
```

### Векторный индекс с префиксом и покрывающими колонками {#prefixed-covering}

Векторный индекс с префиксом и покрывающими колонками:  

```yql
ALTER TABLE my_table
  ADD INDEX my_index
  GLOBAL USING vector_kmeans_tree
  ON (user, embedding) COVER (data)
  WITH (distance=cosine, type="uint8", dimension=512, levels=2, clusters=128);
```

## Создание векторных индексов {#creation}

Векторные индексы можно создавать:

* при создании таблицы с помощью YQL-оператора [CREATE TABLE](../../yql/reference/syntax/create_table/vector_index.md);
* добавлять к существующей таблице с помощью YQL-оператора [ALTER TABLE](../../yql/reference/syntax/alter_table/indexes.md).

Подробнее про параметры создания векторного индекса смотри в [CREATE TABLE](../../yql/reference/syntax/create_table/vector_index.md)

## Использование векторных индексов {#usage}

Запросы к векторным индексам выполняются с использованием синтаксиса VIEW в YQL. Для индексов с префиксом укажите префиксные колонки в условии WHERE:

```yql
SELECT user, data
FROM my_table VIEW my_index
WHERE user = "..."
ORDER BY Knn::CosineSimilarity(embedding, ...) DESC
LIMIT 10;
```

## Ограничения {#limitations}

В настоящее время не поддерживается:  

* изменение строк в индексированных таблицах;
* тип битовых векторов.