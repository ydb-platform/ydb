# Асинхронная репликация

Асинхронная репликация позволяет реплицировать данные между базами данных {{ ydb-short-name }} почти в реальном времени. Также она может быть использована для переноса данных между базами с минимальным простоем. Базы данных могут располагаться как в одном [кластере](glossary.md#cluster), так и на разных.

В отличие от синхронной [репликации](glossary.md#replication), реализованной в [распределенном хранилище](glossary.md#distributed-storage-implementation) и оперирующей бинарными данными, асинхронная репликация реализована поверх [Change Data Capture](cdc.md) и оперирует логическими данными.

## Принцип работы {#how-it-works}

В асинхронной репликации участвуют:
* База с _исходными объектами_ (база-_источник_).
* База, в которой будут созданы _экземпляр репликации_ и _объекты-реплики_ (база-_приемник_).

Процесс асинхронной репликации можно разделить на стадии:
1. Инициализация.
2. Репликация первоначальных данных.
3. Репликация изменений.

### Инициализация {#init}

* [Создание экземпляра асинхронной репликации](../yql/reference/syntax/create-async-replication.md) в приемнике.
* Установка соединения с источником.

Для соединения с источником приемник использует [параметры подключения](../yql/reference/syntax/create-async-replication.md#params), указанные при создании экземпляра асинхронной репликации.

{% note info %}

Пользователь, от имени которого производится подключение к источнику, должен обладать следующими [правами](../security/short-access-control-notation.md#access-rights):
* просмотр объектов схемы и содержимого каталогов;
* создание/изменение/удаление/чтение потоков изменений.

{% endnote %}

* Для заданного набора исходных объектов создаются:
  * потоки изменений (в источнике);
  * объекты-реплики (в приемнике).

{% note info %}

Объекты-реплики создаются от имени пользователя, создавшего экземпляр асинхронной репликации.

{% endnote %}

### Репликация первоначальных данных {#initial-scan}

* В приемнике запускаются [читатели](topic.md#consumer).
* Прочитанные читателями данные записываются в объекты-реплики.

Первоначальные данные исходных таблиц отгружаются в потоки изменений с использованием [первоначального сканирования](cdc.md#initial-scan). Прогресс первоначального сканирования можно получить из описания экземпляра асинхронной репликации.

### Репликация изменений {#replication-of-changes}

После завершения первоначального сканирования читатели получают только данные об изменениях. Для каждого изменения известно _время его возникновения_ (`created_at`). В то же время читатели отслеживают _время получения_ изменения (`received_at`). Таким образом, _отставание репликации_ может быть вычислено по формуле:

```text
replication_lag = received_at - created_at
```

Отставание репликации также можно получить из описания экземпляра асинхронной репликации.

## Ограничения {#restrictions}

* Набор исходных объектов задается при создании экземпляра асинхронной репликации и не может быть изменен.
* В качестве исходных объектов поддерживаются:
  * [строковые таблицы](datamodel/table.md#row-oriented-tables);
  * [директории](datamodel/dir.md). Содержимое директорий будет "развернуто" до списка строковых таблиц при создании экземпляра асинхронной репликации.
* Во время работы асинхронной репликации в исходных таблицах блокируется возможность [изменения состава столбцов](../yql/reference/syntax/alter_table.md#columns).
* Во время работы асинхронной репликации объекты-реплики доступны только для чтения.

## Обработка ошибок в процессе асинхронной репликации {#error-handling}

В процессе асинхронной репликации возможно возникновение разных классов ошибок:
* **Временные сбои**. Например: транспортные ошибки, перегрузка системы и т.д. Запросы будут повторяться до успешного выполнения.
* **Критичные ошибки**. Например: ошибки прав доступа, ошибки схемы и т.д. Процесс репликации будет остановлен и в описании экземпляра репликации будет указан текст ошибки.

{% note warning %}

Остановленный из-за ошибки процесс асинхронной репликации не может быть перезапущен.

{% endnote %}

Подробнее про классы ошибок и политики их обработки см. в разделе [Обработка ошибок](../reference/ydb-sdk/error_handling.md).

## Завершение асинхронной репликации {#done}

Процесс асинхронной репликации может быть завершен (например, как один из последних шагов при переносе данных между базами). При завершении:
* В исходных таблицах удаляются потоки изменений.
* В исходных таблицах разблокируется возможность изменения состава столбцов.
* Объекты-реплики становятся доступными как для чтения, так и для записи.

{% note warning %}

На данный момент поддерживается только _принудительное_ завершение асинхронной репликации, при котором не производится никаких дополнительных проверок (на консистентность данных, на отставание и т.д.).

{% endnote %}

Для завершения асинхронной репликации используйте выражение [ALTER ASYNC REPLICATION](../yql/reference/syntax/alter-async-replication.md).

## Удаление асинхронной репликации {#drop}

При удалении асинхронной репликации:
* В исходных таблицах удаляются потоки изменений.
* В исходных таблицах разблокируется возможность изменения состава столбцов.
* Опционально могут быть удалены все объекты-реплики.

Для удаления асинхронной репликации используйте выражение [DROP ASYNC REPLICATION](../yql/reference/syntax/drop-async-replication.md).
