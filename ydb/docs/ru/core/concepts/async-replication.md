# Асинхронная репликация

Асинхронная репликация позволяет реплицировать данные между [базами данных](glossary.md#database) {{ ydb-short-name }} почти в реальном времени. Также она может быть использована для переноса данных между базами с минимальным простоем работающих с ними приложений. Базы данных могут располагаться как в одном [кластере](glossary.md#cluster) {{ ydb-short-name }}, так и на разных.

В отличие от синхронной [репликации](glossary.md#replication), реализованной в [распределенном хранилище](glossary.md#distributed-storage-implementation) и оперирующей бинарными данными, асинхронная репликация реализована поверх [Change Data Capture](cdc.md) и оперирует логическими данными.

## Принцип работы {#how-it-works}

В асинхронной репликации участвуют две базы:

1. **Источник** — база данных с исходными объектами.
2. **Приёмник** — база данных, в которой будут созданы **экземпляр репликации** и **объекты-реплики**.

Процесс асинхронной репликации можно разделить на стадии:

* [Инициализация](#init).
* [Репликация первоначальных данных](#initial-scan).
* [Репликация изменений](#replication-of-changes).

### Инициализация {#init}

Инициализация асинхронной репликации состоит из:

* [Создания экземпляра асинхронной репликации](../yql/reference/syntax/create-async-replication.md) в приемнике.
* Установки соединения с источником. Для соединения с источником приемник использует [параметры подключения](../yql/reference/syntax/create-async-replication.md#params), указанные при создании экземпляра асинхронной репликации.

{% note info %}

Пользователь, от имени которого производится подключение к источнику, должен обладать следующими [правами](../security/short-access-control-notation.md#access-rights):

* просмотр объектов схемы и содержимого каталогов;
* создание, изменение, удаление и чтение потоков изменений.

{% endnote %}

* Для заданного набора исходных объектов создаются:
  * потоки изменений (в источнике);
  * объекты-реплики (в приемнике).

{% note info %}

Объекты-реплики создаются от имени пользователя, создавшего экземпляр асинхронной репликации.

{% endnote %}

### Репликация первоначальных данных {#initial-scan}

Первоначальные данные исходных таблиц отгружаются в потоки изменений с использованием [первоначального сканирования](cdc.md#initial-scan). В это время в приемнике:

* Запускаются [читатели](topic.md#consumer).
* Прочитанные читателями данные записываются в объекты-реплики.

Прогресс репликации первоначальных данных можно получить из [описания](../reference/ydb-cli/commands/scheme-describe.md) экземпляра асинхронной репликации.

### Репликация изменений {#replication-of-changes}

После завершения первоначального сканирования читатели получают только данные об изменениях. Для каждого изменения известно *время его возникновения* ($created\_at$). В то же время читатели отслеживают *время получения* изменения ($received\_at$). Таким образом, *отставание репликации* может быть вычислено по формуле:

$$
replication\_lag = received\_at - created\_at
$$

Отставание репликации также можно получить из [описания](../reference/ydb-cli/commands/scheme-describe.md) экземпляра асинхронной репликации.

## Ограничения {#restrictions}

* Набор исходных объектов задается при создании экземпляра асинхронной репликации и не может быть изменен.
* В качестве исходных объектов поддерживаются:
  * [строковые таблицы](datamodel/table.md#row-oriented-tables);
  * [директории](datamodel/dir.md) — их cодержимое будет «развёрнуто» до списка строковых таблиц в момент создании экземпляра асинхронной репликации.
* Во время работы асинхронной репликации в исходных таблицах блокируется возможность [изменения состава столбцов](../yql/reference/syntax/alter_table.md#columns).
* Во время работы асинхронной репликации объекты-реплики доступны только для чтения.

## Обработка ошибок в процессе асинхронной репликации {#error-handling}

В процессе асинхронной репликации возможно возникновение разных классов ошибок:

* **Временные сбои**. Например, транспортные ошибки, перегрузка системы и т.д. Запросы будут повторяться до успешного выполнения.
* **Критичные ошибки**. Например, ошибки прав доступа, ошибки схемы и т.д. Процесс репликации будет остановлен, и в [описании](../reference/ydb-cli/commands/scheme-describe.md) экземпляра репликации будет указан текст ошибки.

{% note warning %}

Остановленный из-за критичной ошибки процесс асинхронной репликации не может быть перезапущен.

{% endnote %}

Подробнее про классы ошибок и политики их обработки см. в разделе [Обработка ошибок](../reference/ydb-sdk/error_handling.md).

## Завершение асинхронной репликации {#done}

Процесс асинхронной репликации может быть завершен (например, как один из последних шагов при переносе данных между базами). При завершении:

* В исходных таблицах удаляются потоки изменений.
* В исходных таблицах разблокируется возможность изменения состава столбцов.
* Объекты-реплики становятся доступными как для чтения, так и для записи.

{% note warning %}

На данный момент поддерживается только **принудительное** завершение асинхронной репликации, при котором не производится никаких дополнительных проверок (на консистентность данных, на отставание и т.д.).

{% endnote %}

Для завершения асинхронной репликации используйте выражение [ALTER ASYNC REPLICATION](../yql/reference/syntax/alter-async-replication.md).

## Удаление асинхронной репликации {#drop}

При удалении асинхронной репликации:

* В исходных таблицах удаляются потоки изменений.
* В исходных таблицах разблокируется возможность изменения состава столбцов.
* Опционально могут быть удалены все объекты-реплики.
* Удаляется экземпляр асинхронной репликации.

Для удаления асинхронной репликации используйте выражение [DROP ASYNC REPLICATION](../yql/reference/syntax/drop-async-replication.md).
