# Коллекции резервных копий

Коллекции резервных копий обеспечивают продвинутое решение для резервного копирования в YDB, которое организует полные и инкрементальные резервные копии в управляемые коллекции. Этот подход предназначен для производственных нагрузок, требующих эффективного аварийного восстановления и возможностей восстановления на момент времени.

## Что такое коллекции резервных копий? {#what-are-backup-collections}

Коллекция резервных копий — это именованный набор скоординированных резервных копий для выбранных объектов базы данных. Коллекции организуют связанные резервные копии и обеспечивают их согласованное восстановление, предоставляя:

{% note info %}

В настоящее время поддерживаются только таблицы. Поддержка других объектов запланирована на будущие выпуски.

{% endnote %}

- **Эффективные инкрементальные резервные копии**: Коллекции позволяют создавать инкрементальные резервные копии, которые захватывают только изменения с момента предыдущей резервной копии
- **Организацию**: Связанные резервные копии группируются в логические коллекции
- **Гибкость восстановления**: Позволяет восстановление на любой момент времени, в который был сделан один из бэкапов

## Основные концепции {#core-concepts}

### Коллекция резервных копий {#backup-collection}

Именованный контейнер, который группирует резервные копии для определенного набора объектов базы данных (в настоящее время только таблицы). Коллекции обеспечивают согласованное резервное копирование всех включенных объектов.

### Полная резервная копия {#full-backup}

Полный снимок всех выбранных таблиц в определенный момент времени. Служит базовой линией для последующих инкрементальных резервных копий и содержит все данные, необходимые для независимого восстановления.

### Инкрементальная резервная копия {#incremental-backup}

Захватывает только изменения (вставки, обновления, удаления) с момента предыдущей резервной копии в цепочке. Значительно меньше полных резервных копий для наборов данных с ограниченными изменениями.

### Цепочка резервных копий {#backup-chain}

Упорядоченная последовательность резервных копий, начинающаяся с полной резервной копии, за которой следует ноль или более инкрементальных резервных копий. Каждая инкрементальная резервная копия зависит от всех предыдущих резервных копий в цепочке для полного восстановления.

## Архитектура и компоненты {#architecture}

### Поток резервного копирования {#backup-flow}

1. **Создание коллекции резервных копий**: Определение таблиц для включения и места хранения резервных копий
2. **Начальная полная резервная копия**: Создание базового снимка всех таблиц
3. **Инкрементальные резервные копии**: Захват текущих изменений (создаются по требованию)
4. **Управление цепочкой**: Мониторинг цепочек резервных копий и ручное управление хранением

### Структура хранения {#storage-structure}

Коллекции резервных копий хранятся в выделенной структуре каталогов в базе данных:

```text
/.backups/collections/
├── collection_name_1/
│   ├── backup_20240315_120000/     # Полная резервная копия
│   ├── backup_20240315_180000/     # Инкрементальная резервная копия
│   └── backup_20240316_060000/     # Инкрементальная резервная копия
├── collection_name_2/
│   └── backup_20240316_000000/     # Полная резервная копия
```

Каждая резервная копия содержит:

- Схемы таблиц на момент резервного копирования (хранятся в составе метаданных резервной копии)
- Файлы данных (полные или инкрементальные изменения)

### Бэкенды хранения {#storage-backends}

#### Кластерное хранилище {#cluster-storage}

Резервные копии хранятся в том же кластере YDB с использованием распределенного файлового хранения:

```sql
WITH ( STORAGE = 'cluster' )
```

#### Внешнее хранилище {#external-storage}

{% note info %}

В будущих версиях YDB планируется поддержка внешних хранилищ S3-совместимых систем.

{% endnote %}

Внешние системы хранения предоставляют:

### Фоновые операции {#background-operations}

Все операции резервного копирования выполняются асинхронно в фоновом режиме, позволяя:

- Продолжать обычные операции с базой данных во время резервного копирования
- Отслеживать прогресс с помощью команд операций YDB CLI
- Обрабатывать большие наборы данных без блокировки других действий

## Как работают коллекции резервных копий внутри {#how-they-work}

### Процесс создания резервной копии {#backup-creation-process}

1. **Изоляция транзакций**: Резервное копирование начинается с согласованной точки снимка
2. **Сканирование таблиц**: Каждая таблица сканируется на предмет данных и схемы
3. **Отслеживание изменений**: Для инкрементальных резервных копий захватываются только изменения с последней резервной копии
4. **Запись в хранилище**: Данные записываются в место хранения резервных копий
5. **Запись метаданных**: Метаданные резервной копии записываются для валидации цепочки

### Механизм инкрементального резервного копирования {#incremental-backup-mechanism}

Инкрементальные резервные копии основываются на отслеживании изменений на уровне данных:

- **Новых строк**: Добавленных с последней резервной копии
- **Измененных строк**: Измененных данных в существующих строках  
- **Удаленных строк**: Удаленных данных (записи tombstone)
- **Изменений схемы**: Модификаций структуры таблиц

### Отношение к инкрементальным резервным копиям {#relation-to-incremental-backups}

Коллекции резервных копий являются основой для функциональности инкрементального резервного копирования:

- **Коллекции разрешают инкрементальность**: Необходимо иметь коллекцию для создания инкрементальных резервных копий
- **Управление цепочкой**: Коллекции управляют последовательностью полных и инкрементальных резервных копий
- **Согласованность**: Все таблицы в коллекции создаются согласованно

Без коллекций резервных копий доступны только операции полного экспорта/импорта.

### Валидация цепочки и целостность {#chain-validation-integrity}

Система обеспечивает целостность цепочки резервных копий через:

- **Отслеживание зависимостей**: Каждая инкрементальная резервная копия записывает своего родителя
- **Проверки валидации**: Полнота цепочки проверяется перед операциями
- **Гарантии согласованности**: Все таблицы создаются из одной точки транзакции
- **Обнаружение ошибок**: Поврежденные или отсутствующие резервные копии определяются автоматически

## Когда использовать коллекции резервных копий {#when-to-use}

**Идеальные сценарии:**

- Производственные среды, требующие регулярного планирования резервного копирования
- Большие наборы данных, где инкрементальные изменения намного меньше общих данных
- Сценарии, требующие цепочек резервных копий для эффективности

**Рассмотрите традиционный экспорт/импорт для:**

- Небольших баз данных или отдельных таблиц
- Одноразовых задач миграции данных
- Сред разработки/тестирования
- Простых сценариев резервного копирования без инкрементальных потребностей
- Требований внешнего хранилища (до поддержки автоматического внешнего хранилища)

## Преимущества и ограничения {#benefits-limitations}

### Преимущества {#benefits}

- **Эффективность хранения**: Инкрементальные резервные копии используют значительно меньше места для хранения
- **Более быстрое резервное копирование**: После начальной полной резервной копии обрабатываются только изменения
- **SQL интерфейс**: Знакомые SQL команды для управления резервным копированием
- **Фоновая обработка**: Неблокирующие операции
- **Целостность цепочки**: Автоматическая валидация и проверки согласованности

### Текущие ограничения {#current-limitations}

- **Только кластерное хранилище**: Внешнее хранилище требует ручного экспорта/импорта
- **Нет модификации коллекций**: Нельзя добавлять/удалять таблицы после создания
- **Единый бэкенд хранения**: Только 'cluster' хранилище поддерживается через SQL

## Следующие шаги {#next-steps} {#next-steps}

- **Начать работу**: Следуйте [руководству по операциям](../maintenance/manual/backup-collections.md) для пошаговых инструкций
- **Посмотреть примеры**: Изучите [общие сценарии](../recipes/backup-collections.md) и лучшие практики

## См. также {#see-also}

- [Общие концепции резервного копирования](backup.md) - Обзор всех подходов резервного копирования в YDB
- [Руководство по операциям](../maintenance/manual/backup-collections.md) - Практические инструкции и примеры
- [Общие рецепты](../recipes/backup-collections.md) - Сценарии реального использования
