# Коллекции резервных копий и инкрементальные бэкапы

Доступность: YDB vX.Y+ (уточняется)

Краткое описание
- Организация полных и инкрементальных резервных копий в коллекции для эффективного аварийного восстановления и восстановления на момент времени.
- Работает с кластерным хранилищем; экспорт/импорт в FS или S3 через CLI.
- Фоновые операции с поддержкой мониторинга статуса через long operations API.

Глоссарий
- Коллекция резервных копий: именованный набор бэкапов для выбранных таблиц.
- Полная резервная копия: базовый снимок для коллекции.
- Инкрементальная резервная копия: изменения с момента предыдущего бэкапа в цепочке.
- Синтетическая полная копия: консолидированная полная копия из существующей цепочки (поддержка уточняется).
- Цепочка: упорядоченная последовательность полная → инкрементальные с зависимостями.
- Хранилище бэкапов vs цель бэкапа: где живут бэкапы vs что резервируется.
- Политика хранения: правила удаления старых бэкапов без нарушения цепочек.

Обзор архитектуры
- Поток: создание коллекции → полная → инкрементальные → опциональная синтетическая полная → очистка по политике хранения.
- Схема хранения: кластер (текущая), экспорт/импорт в FS или S3. Файлы метаданных включают metadata.json и mapping.json.
- Совместимость: См. reference/compatibility для версий форматов и кросс-версионных заметок.

Когда использовать
- Аварийное восстановление и восстановление на момент времени.
- Большие наборы данных, где инкрементальные изменения гораздо меньше полных снимков.

## Создание и управление коллекциями

### Создание коллекции резервных копий

```sql
-- Создание коллекции с указанием таблиц
CREATE BACKUP COLLECTION `my_backup_collection`
    ( TABLE `/Root/database/orders`
    , TABLE `/Root/database/products`
    )
WITH
    ( STORAGE = 'cluster'
    );
```

## Выполнение резервного копирования

### Создание полной резервной копии

```sql
-- Создание полного бэкапа коллекции
BACKUP `my_backup_collection`;
```

### Создание инкрементальной резервной копии

```sql
-- Создание инкрементального бэкапа
BACKUP `my_backup_collection` INCREMENTAL;
```

## Экспорт и импорт коллекций

### Экспорт коллекции в файловую систему

```bash
# Экспорт коллекции с помощью tools dump
ydb tools dump -p .backups/collections/my_backup_collection -o exported_backups

# Анализ созданных бэкапов
ls -la exported_backups/
```

### Импорт коллекции из файловой системы

```bash
# Восстановление полного бэкапа
for backup_dir in exported_backups/*/; do
    backup_name=$(basename "$backup_dir")
    case "$backup_name" in
        *_full*)
            echo "Импортируем полный бэкап: $backup_name"
            ydb tools restore -p ".backups/collections/target_collection/$backup_name" -i "$backup_dir"
            ;;
        *_incremental*)
            echo "Импортируем инкрементальный бэкап: $backup_name"
            ydb tools restore -p ".backups/collections/target_collection/$backup_name" -i "$backup_dir"
            ;;
    esac
done
```

## Мониторинг операций

Операции инкрементального резервного копирования и восстановления выполняются в фоновом режиме. Для отслеживания их статуса используются долгосрочные операции (long operations):

### Операции инкрементального резервного копирования (`incbackup`)

При создании инкрементального бэкапа запускается фоновая операция типа `incbackup`. Получить список всех операций инкрементального резервного копирования:

```bash
{{ ydb-cli }} operation list incbackup
```

Получить статус конкретной операции:

```bash
{{ ydb-cli }} operation get "ydb://incbackup/N?id=<operation-id>"
```

### Операции восстановления (`restore`)

При восстановлении из коллекции резервных копий запускается фоновая операция типа `restore`. Получить список всех операций восстановления:

```bash
{{ ydb-cli }} operation list restore
```

Получить статус конкретной операции:

```bash
{{ ydb-cli }} operation get "ydb://restore/N?id=<operation-id>"
```

### Управление операциями

После успешного завершения операции рекомендуется удалить её из списка:

```bash
{{ ydb-cli }} operation forget "ydb://incbackup/N?id=<operation-id>"
{{ ydb-cli }} operation forget "ydb://restore/N?id=<operation-id>"
```

Идентификаторы операций возвращаются при запуске соответствующих команд резервного копирования или восстановления и могут быть использованы для отслеживания прогресса и статуса выполнения.

## Ограничения и рекомендации

### Текущие ограничения
- Максимальная длина цепочки инкрементальных бэкапов: 100
- Максимальный размер одной операции: 1 ТБ
- Параллельные операции: не более 3 на коллекцию
- PITR гранулярность: 1 секунда

### Рекомендации по производительности
- Планируйте полные бэкапы на периоды низкой нагрузки
- Используйте отдельные коллекции для разных наборов таблиц
- Мониторьте размер цепочек и время восстановления

### Совместимость версий
- Формат v1: YDB 24.3+
- Формат v2: YDB 25.1+ (с поддержкой сжатия)
- Обратная совместимость: можно восстановить v1 в v2, но не наоборот

## См. также

- [Основы резервного копирования](../backup.md)
- [Справочник команд экспорта и импорта](../../reference/ydb-cli/export-import/index.md)
- [Коллекции резервных копий - детальное руководство](../../reference/ydb-cli/export-import/backup-collections/overview.md)
