# Режим bridge

Эта статья описывает особый режим работы кластера {{ ydb-short-name }}, при котором хранение данных осуществляется с синхронной репликацией между несколькими частями кластера, называемыми [пайлами](glossary.md#pile).

Режим bridge позволяет достичь максимальной отказоустойчивости кластера, однако он требует большего количества оборудования и сложнее в эксплуатации по сравнению с кластерами, где он не используется. Режим bridge рекомендуется для кластеров, размещённых в двух дата-центрах, а также для кластеров с высокими требованиями к отказоустойчивости — например, когда необходимо сохранять доступность при отказе трёх дата-центров из четырёх.

## Описание режима

В режиме bridge узлы кластера разделяются на несколько [пайлов](glossary.md#pile) (обычно — по одному пайлу в датацентре). При отказе одного из пайлов кластер становится недоступным до тех пор, пока не будет выполнена команда отключения этого пайла. После отключения кластер возобновляет работу.

{{ ydb-short-name }} поддерживается произвольное количество пайлов, однако для простоты изложения далее рассматривается случай с двумя пайлами.

На уровне [распределённого хранилища](glossary.md#distributed-storage) в режиме bridge реализуется синхронная репликация по схеме Active / Active между пайлами. На уровне [узлов баз данных](glossary.md#database-node) возможно резервирование по схеме Active / Passive.

Для хранения данных используются пары [групп хранения](glossary.md#storage-group) из разных пайлов. При этом для хранения данных в каждом из пайлов могут применяться любые поддерживаемые {{ ydb-short-name }} [режимы работы](topology.md#cluster-config).

В режиме bridge может быть достигнут zero-downtime [switchover](https://en.wikipedia.org/wiki/Switchover). При [failover](https://en.wikipedia.org/wiki/Failover) кластер требует явного отключения репликации в отказавший пайл для возобновления работы. При отключении любого пайла происходит приостановка обслуживания запросов до выполнения команды отключения репликации в этот пайл.

Пайлы не являются самостоятельными кластерами {{ ydb-short-name }}, а представляют собой части одного кластера со сложной топологией:

- [таблетки](glossary.md#tablet) в режиме bridge запускаются в единственном экземпляре;
- в каждом пайле работает отдельная [статическая группа](glossary.md#static-group) и набор независимых групп хранения с обычными [VDisk](glossary.md#vdisk). Доступ к группам хранения осуществляется через dsproxy-proxy, который предоставляет таблеткам интерфейс dsproxy и выполняет операции с использованием двух [dsproxy](glossary.md#ds-proxy) — по одной для групп в каждом пайле;
- в каждом пайле работает свой набор реплик [state storage](glossary.md#state-storage), scheme board и board. Доступ к state storage и бордам осуществляется через аналогичные proxy-proxy.

## Состояния пайлов

Режим работы кластера определяется состояниями всех его пайлов. Например, для кластера из пайлов А и Б состояния пайлов указываются как (А, Б), где порядок имеет значение.

Каждый пайл может находиться в одном из следующих состояний:

- `PRIMARY`. Основной пайл, в котором работают таблетки. Только один пайл может находиться в состоянии `PRIMARY`.

- `SYNCHRONIZED`. Ведомый пайл, в котором все группы хранения синхронизированы с `PRIMARY`.

- `DISCONNECTED`. Отключённый от `PRIMARY`, не участвует в выполнении операций.

- `NOT_SYNCHRONIZED`. Пайл, в котором группы хранения ещё не синхронизированы с `PRIMARY`. При завершении синхронизации {{ ydb-short-name }} автоматически переключает пайл в состояние `SYNCHRONIZED`.

- `PROMOTED`. Пайл, который необходимо плавно переключить из состояния `SYNCHRONIZED` в состояние `PRIMARY`. Пайл пребывает в этом состоянии до завершения плавного переключения, после чего {{ ydb-short-name }} автоматически переключает его в состояние `PRIMARY`.

- `DEMOTED`. Пайл, который необходимо плавно переключить из состояния `PRIMARY` в состояние `SYNCHRONIZED`. Пайл пребывает в этом состоянии до завершения плавного переключения, после чего {{ ydb-short-name }} автоматически переключает его в состояние `SYNCHRONIZED`.

- `SUSPENDED`. Пайл, который необходимо плавно переключить в состояние `DISCONNECTED`. По завершении переключения {{ ydb-short-name }} автоматически переводит пайл в состояние `DISCONNECTED`.

В норме пара пайлов работает в режиме `PRIMARY/SYNCHRONIZED` или `SYNCHRONIZED/PRIMARY`. То есть один из пайлов — `PRIMARY`, в нём работают таблетки, второй пайл — `SYNCHRONIZED`, все его группы хранения синхронизированы с `PRIMARY`. Операция записи считается завершённой при таком состоянии пайлов только после успешного выполнения записи в группы хранения каждого пайла с необходимой избыточностью.


### Переходы между состояниями

#|
|| Состояние до | Состояние после | Как происходит | Пояснение ||
|| `PRIMARY` | `DEMOTED` | Вручную — [switchover](../reference/ydb-cli/commands/bridge/switchover.md) | Старт плановой zero-downtime смены `PRIMARY`. ||
|| `SYNCHRONIZED` | `PROMOTED` | Вручную — [switchover](../reference/ydb-cli/commands/bridge/switchover.md) | Старт плановой zero-downtime смены `PRIMARY`. ||
|| `DEMOTED` | `SYNCHRONIZED` | Автоматически | Завершение планового переключения. ||
|| `PROMOTED` | `PRIMARY` | Автоматически | Завершение планового переключения. ||
|| `PRIMARY` | `SUSPENDED` | Вручную — [takedown](../reference/ydb-cli/commands/bridge/takedown.md) | Плановое отключение пайла. ||
|| `SYNCHRONIZED` | `SUSPENDED` | Вручную — [takedown](../reference/ydb-cli/commands/bridge/takedown.md) | Плановое отключение пайла. ||
|| `SUSPENDED` | `DISCONNECTED` | Автоматически | Завершение планового отключения. ||
|| `PRIMARY` | `DISCONNECTED` | Вручную — [takedown](../reference/ydb-cli/commands/bridge/takedown.md) | Плановое отключение текущего `PRIMARY`. ||
|| `PRIMARY` | `DISCONNECTED` | Вручную — [failover](../reference/ydb-cli/commands/bridge/failover.md) | Аварийное отключение недоступного `PRIMARY` с возможным выбором нового `PRIMARY`. ||
|| `SYNCHRONIZED` | `DISCONNECTED` | Вручную — [takedown](../reference/ydb-cli/commands/bridge/takedown.md) | Плановое отключение ведомого пайла. ||
|| `DISCONNECTED` | `NOT_SYNCHRONIZED` | Вручную — [rejoin](../reference/ydb-cli/commands/bridge/rejoin.md) | Возврат пайла в кластер после обслуживания/восстановления. ||
|| `NOT_SYNCHRONIZED` | `SYNCHRONIZED` | Автоматически | Завершение синхронизации данных. ||
|#

## Сценарии изменения состояния

### Отказ пайла {#failover}

При отказе пайла кластер становится недоступным. Для возобновления работы кластера необходимо отключить отказавший пайл, переведя его в состояние `DISCONNECTED`.

Аналогично выполняется переключение и в случае, когда отказавший пайл был в любом другом состоянии, а назначаемый PRIMARY пайл был в одном из допустимых состояний (PRIMARY, SYNCHRONIZED, PROMOTED, DEMOTED).

Администратор может подать команду переключения из состояния `PRIMARY/SYNCHRONIZED` или `SYNCHRONIZED/PRIMARY` в одно из состояний `PRIMARY/DISCONNECTED` или `DISCONNECTED/PRIMARY`. Команда изменяет конфигурацию групп хранения и приводит к изменению способа записи в эти группы. [Interconnect](glossary.md#actor-system-interconnect) разрывает сессии со всеми узлами пайла в состоянии `DISCONNECTED`; при этом сессии для обмена данными не устанавливаются (TCP-соединения для обмена метаданными о состояниях пайлов могут оставаться активными). Дальнейшие операции записи и чтения выполняются без участия пайла в состоянии `DISCONNECTED`. Если изменился `PRIMARY`-пайл, таблетки перезапускаются в нём.

Аналогичным образом выполняется переключение, если отказавший пайл находился в любом состоянии, а назначаемый `PRIMARY`-пайл — в одном из допустимых состояний: `PRIMARY`, `SYNCHRONIZED`, `PROMOTED` или `DEMOTED`.

Если назначаемый `PRIMARY`-пайл находился в состоянии `DISCONNECTED`, `NOT_SYNCHRONIZED` или `SUSPENDED`, штатное переключение невозможно, поскольку пайл может не содержать полной и актуальной реплики данных.

### Восстановление пайла {#rejoin}

После восстановления работоспособности узлов отказавшего пайла его необходимо повторно подключить к кластеру, переведя в состояние `NOT_SYNCHRONIZED`.

Администратор может подать команду переключения из состояния `PRIMARY/DISCONNECTED` в `PRIMARY/NOT_SYNCHRONIZED` или из `DISCONNECTED/PRIMARY` в `NOT_SYNCHRONIZED/PRIMARY`. Произойдёт обмен конфигурацией между узлами; сессии interconnect устанавливаются только между узлами с одинаковой конфигурацией. Команда запускает синхронизацию групп хранения. По завершении синхронизации происходит автоматическое переключение из состояния `PRIMARY/NOT_SYNCHRONIZED` в `PRIMARY/SYNCHRONIZED` или из `NOT_SYNCHRONIZED/PRIMARY` в `SYNCHRONIZED/PRIMARY`.

### Плановое переключение PRIMARY-пайла {#switchover}

Для плановой смены `PRIMARY`-пайла необходимо перевести текущий `PRIMARY`-пайл в состояние `DEMOTED`, а назначаемый — в состояние `PROMOTED`.

Администратор может подать команду переключения из состояния `PRIMARY/SYNCHRONIZED` в `DEMOTED/PROMOTED` или из `SYNCHRONIZED/PRIMARY` в `PROMOTED/DEMOTED`. Команда не изменяет способ записи в группы хранения, но обновляет их конфигурацию и инициирует смену `PRIMARY`-пайла с плавным переносом таблеток в новый `PRIMARY`. По завершении переключения состояние `PROMOTED` сменяется на `PRIMARY`, а `DEMOTED` — на `SYNCHRONIZED`.

### Плановое отключение пайла {#takedown}

Для планового отключения пайла его необходимо перевести в состояние `SUSPENDED`.

Администратор может подать команду переключения из состояния `PRIMARY/SYNCHRONIZED` в `PRIMARY/SUSPENDED` или из `SYNCHRONIZED/PRIMARY` в `SUSPENDED/PRIMARY`. Будет выполнено плановое отключение узлов пайла, переведённого в состояние `SUSPENDED`, с переводом их в режим `DISCONNECTED`. Система стремится минимизировать влияние этого процесса на работу кластера. После завершения перевода пайла в состояние `DISCONNECTED` его узлы могут быть выключены для технического обслуживания.

Для восстановления единого кластера необходимо выбрать, какой из пайлов будет очищен, после чего остановить все узлы очищаемого пайла, дождавшись их остановки, очистить все диски всех узлов, после чего снова включить узлы очищаемого пайла.

После этого необходимо выполнить штатное восстановление пайла, переключив его в состояние `NOT_SYNCHRONIZED`.

### Восстановление при разделении кластера на две части с несовместимой конфигурацией (split brain) {#split-brain}

Может возникнуть ситуация, когда администратор привёл кластер в состояние, при котором пайлы А и Б оказались изолированы друг от друга, а затем пайл А был переконфигурирован так, что стал `PRIMARY`, а пайл Б — `SYNCHRONIZED`, и одновременно пайл Б был переконфигурирован так, что стал `PRIMARY`, а пайл А — `SYNCHRONIZED`. Это приводит к разделению кластера на две части с несовместимой конфигурацией ([split-brain](https://en.wikipedia.org/wiki/Split-brain_(computing))). В таком состоянии каждая часть кластера может оставаться работоспособной.

Для восстановления единого кластера необходимо выбрать, какой из пайлов будет очищен. После этого нужно остановить все узлы этого пайла, дождаться их полной остановки, очистить все диски на всех узлах, а затем снова включить узлы очищаемого пайла.
После этого следует выполнить штатное восстановление пайла, переведя его в состояние `NOT_SYNCHRONIZED`.

### Нештатное восстановление пайла

В сложных ситуациях, например при последовательных отказах пайлов, может возникнуть следующий сценарий: сначала отказал пайл А, он был переведён в состояние `DISCONNECTED`, и кластер продолжил работу; затем произошёл необратимый отказ пайла Б; после этого удалось восстановить работоспособность пайла А. В таких случаях возможно восстановление кластера на основе пайла А.

Если необходимо возобновить работу кластера, когда работоспособность сохранил только пайл, находящийся в состоянии `DISCONNECTED`, `NOT_SYNCHRONIZED` или `SUSPENDED`, администратор может выполнить команду переключения из `PRIMARY/DISCONNECTED` в `DISCONNECTED/PRIMARY` (или аналогично для `NOT_SYNCHRONIZED `или `SUSPENDED`) с указанием специального параметра `force`. Это приведёт к разделению кластера на две части с несовместимой конфигурацией. В зависимости от фактического состояния данных в пайле, который переводится в состояние `PRIMARY`, кластер может быть восстановлен в корректное или внутренне неконсистентное состояние. Работоспособность такого кластера не гарантируется.

Если кластер оказался работоспособным, можно продолжить восстановление до нормального состояния. Перед восстановлением отключённого пайла необходимо полностью очистить данные и метаданные на всех его узлах, после чего перевести пайл в состояние `NOT_SYNCHRONIZED`.

## Особенности реализации режима bridge

Подробнее об устройстве режима bridge см. в [{#T}](../contributor/bridge.md).
