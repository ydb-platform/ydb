# Режим bridge

Эта статья описывает особый режим работы кластера {{ ydb-short-name }}, при котором хранение данных осуществляется с синхронной репликацией между несколькими [пайлами](glossary.md#pile).

Режим bridge позволяет достичь максимальной отказоустойчивости кластера. Однако, он требует большего количества оборудования и сложнее в эксплуатации, чем другие режимы работы кластера. Режим bridge рекомендуется для кластеров, размещенных в двух дата-центрах и для кластеров с высокими требованиями к отказоустойчивости, например, если требуется сохранять доступность при отказе трёх дата-центров из четырех.

## Описание режима

В режиме bridge узлы кластера разделяют на несколько [пайлов](glossary.md#pile) (обычно дата-центров). При отказе части пайлов, кластер становится недоступным до тех пор, пока не будет выполнена команда отключения отказавшего пайла. После отключения кластер возобновляет работу.

Поддерживается произвольное количество пайлов, однако, для простоты изложения далее рассматривается случай с двумя пайлами.

Для хранения данных используются пары групп Distributed Storage из разных пайлов, при этом для хранения данных в разных пайлах возможно использование любых комбинаций поддерживаемых {{ ydb-short-name }} [режимов работы](topology.md#cluster-config).

На уровне распределённого хранилища в режиме bridge осуществляется синхронная репликация (Active / Active) между пайлами. На уровне динамических узлов может осуществляться резервирование по схеме Active / Passive.

В режиме bridge может быть достигнут zero-downtime switchover. При failover кластер требует явного отключения репликации в отказавший пайл для возобновления работы. Failover при отключении любого пайла происходит с приостановкой обслуживания до отключения репликации в отказавший пайл.

Пайлы не являются самостоятельными кластерами {{ ydb-short-name }}, а являются частью одного кластера со сложной топологией:

— таблетки в режиме bridge запускаются в единственном экземпляре;

— в каждом пайле работает самостоятельная статическая группа и набор самостоятельных групп хранения с обычными VDisk. Доступ к группам хранения осуществляется через dsproxy-proxy, предоставляющую таблеткам интерфейс dsproxy и выполняющую операции при помощи 2 dsproxy по одной для групп в каждом пайле;

— в каждом пайле работает свой набор реплик state storage, scheme board и board. Доступ к state storage и бордам осуществляется через аналогичные proxy-proxy.

## Состояния пайлов

Режим работы кластера определяется состояниями всех его пайлов. Так, для кластера из пайлов А и Б мы будем указывать состояния работы соответственно пайлов А и Б (порядок важен).

Пайлы могут находиться в одном из следующих состояний:

- PRIMARY. Основной пайл, в котором работают таблетки. В этом состоянии пайл может быть переключен в состояния SYNCHRONIZED, DISCONNECTED, DEMOTED, SUSPENDED. Только один пайл может находиться в состоянии PRIMARY.

- SYNCHRONIZED. Ведомый пайл, в котором все группы хранения синхронизированы с PRIMARY. Пайл из этого состояния может быть переключен в состояния PRIMARY, PROMOTED, SUSPENDED, DISCONNECTED, DEMOTED.

- DISCONNECTED. Отключенный от PRIMARY, не участвует в выполнении операций. Из этого состояния пайл может быть переключен только в состояние NOT_SYNCHRONIZED.

- NOT_SYNCHRONIZED. Пайл, в котором группы хранения еще не синхронизированы с PRIMARY. При завершении синхронизации {{ ydb-short-name }} автоматически переключает пайл в состояние SYNCHRONIZED. В состоянии NOT_SYNCHRONIZED пайл может быть переключен в состояния SUSPENDED, DISCONNECTED.

- PROMOTED. Пайл, который необходимо плавно переключить из состояния SYNCHRONIZED в состояние PRIMARY. Пайл пребывает в этом состоянии до завершения плавного переключения, после чего {{ ydb-short-name }} автоматически переключает пайл в состояние PRIMARY. В состоянии PROMOTED пайл может быть переключен в состояния PRIMARY, SYNCHRONIZED, DISCONNECTED, DEMOTED, SUSPENDED.

- DEMOTED. Пайл, который необходимо плавно переключить из состояния PRIMARY в состояние SYNCHRONIZED. Пайл пребывает в этом состоянии до завершения плавного переключения, после чего {{ ydb-short-name }} автоматически переключает пайл в состояние SYNCHRONIZED. В состоянии DEMOTED пайл может быть переключен в состояния PRIMARY, SYNCHRONIZED, DISCONNECTED, PROMOTED, SUSPENDED.

- SUSPENDED. Пайл, который необходимо плавно переключить в состояние DISCONNECTED. По завершении переключения {{ ydb-short-name }} автоматически переключает пайл в состояние DISCONNECTED. В состоянии SUSPENDED пайл может быть переключен в состояния DISCONNECTED, NOT_SYNCHRONIZED.

В норме пара пайлов работает в режиме PRIMARY/SYNCHRONIZED или SYNCHRONIZED/PRIMARY. То есть один из пайлов - PRIMARY, в нем работают таблетки, второй пайл - SYNCHRONIZED, все его группы хранения синхронизированы c PRIMARY. Операция записи считается завершенной при таком состоянии пайлов только после успешного выполнения записи в группы хранения каждого пайла с необходимой избыточностью.


## Сценарии изменения состояния

### Отказ пайла

При отказе пайла, кластер становится недоступным. Для возобновления работы кластера необходимо отключить отказавший пайл, переведя его в состояние DISCONNECTED.

Администратор может подать команду переключения из PRIMARY/SYNCHRONIZED или SYNCHRONIZED/PRIMARY в любой из режимов PRIMARY/DISCONNECTED или DISCONNECTED/PRIMARY. Команда меняет конфигурацию групп хранения и приводит к изменению способа записи в группы хранения. Интерконнект разрывает сессии со всеми узлами DISCONNECTED пайла, и не устанавливает сессии для обмена данными (TCP соединения для обмена метаданными о состояниях пайлов при этом могут быть установлены). Дальнейшие запись и чтение выполняются без участия DISCONNECTED пайла. Если поменялся PRIMARY пайл, таблетки перезапускаются в нем.

Аналогично выполняется переключение и в случае, когда отказавший пайл был в любом другом состоянии, а назначаемый PRIMARY пайл был в одном из допустимых состояний (PRIMARY, SYNCHRONIZED, PROMOTED, DEMOTED).

Если назначаемый PRIMARY пайл был в состоянии DISCONNECTED, NOT_SYNCHRONIZED или SUSPENDED, то штатное переключение невозможно, так как пайл может не содержать полноценной реплики данных.

### Восстановление пайла

После восстановления работоспособности узлов отказавшего пайла, необходимо снова подключить этот пайл к кластеру, переведя его в состояние NOT_SYNCHRONIZED.

Администратор может подать команду переключения из PRIMARY/DISCONNECTED в PRIMARY/NOT_SYNCHRONIZED или из DISCONNECTED/PRIMARY в NOT_SYNCHRONIZED/PRIMARY. Произойдет обмен конфигурацией между узлами, сессии interconnect устанавливаются только между узлами, имеющими одинаковую конфигурацию. Команда запускает синхронизацию групп хранения. В результате синхронизации групп хранения произойдет автоматическое переключение из PRIMARY/NOT_SYNCHRONIZED в PRIMARY/SYNCHRONIZED или из NOT_SYNCHRONIZED/PRIMARY в SYNCHRONIZED/PRIMARY.

### Плановое переключение PRIMARY пайла

Для плановой смены PRIMARY пайла необходимо перевести его в состояние DEMOTED, а назначаемый PRIMARY пайл в состояние PROMOTED.

Администратор может подать команду переключения из PRIMARY/SYNCHRONIZED в DEMOTED/PROMOTED или наоборот из SYNCHRONIZED/PRIMARY в PROMOTED/DEMOTED. Команда не приводит к изменениям в способе записи в группы хранения, однако меняет конфигурацию групп хранения и приводит к смене PRIMARY пайла и плавному переезду в него таблеток. По завершении переключения PROMOTED переходит в PRIMARY, DEMOTED переходит в SYNCHRONIZED.

### Плановое отключение пайла

Для планового отключения пайла необходимо перевести его в состояние SUSPENDED.

Администратор может подать команду переключения из PRIMARY/SYNCHRONIZED в PRIMARY/SUSPENDED или из SYNCHRONIZED/PRIMARY в SUSPENDED/PRIMARY. Будет произведен плановый вывод узлов переключенного в SUSPENDED пайла в режим DISCONNECTED. Система при этом стремится минимизировать влияние переключения на работу кластера. После завершения переключения пайла в режим DISCONNECTED, узлы этого пайла могут быть выключены для обслуживания.

### Восстановление при разделении кластера на две части с несовместимой конфигурацией (split brain)

Возможна ситуация, когда администратор привел кластер в состояние, в котором пайлы А и Б были изолированы друг от друга и пайл А был переконфигурирован в состояние, в котором А - PRIMARY, а Б - SYNCHRONIZED, а пайл Б переконфигурирован в состояние, в котором Б - PRIMARY, а А - SYNCHRONIZED, то есть произошло разделение кластера на две части с несовместимой конфигурацией (split brain). В таком состоянии каждая половина кластера может сохранять работоспособность.

Для восстановления единого кластера необходимо выбрать, какой из пайлов будет очищен, после чего остановить все узлы очищаемого пайла, дождавшись их остановки, очистить все диски всех узлов, после чего снова включить узлы очищаемого пайла.

После этого необходимо выполнить штатное восстановление пайла, переключив его в состояние NOT_SYNCHRONIZED.

### Нештатное восстановление пайла

В сложных ситуациях, например, при стремительных последовательных отказах пайлов, может возникнуть ситуация, когда сначала отказал пайл А, он был переключен в состояние DISCONNECTED и кластер продолжил работу, затем в результате отказа был безвозвратно утрачен пайл Б, а через некоторое время удалось восстановить работоспособность пайла А. В таких ситуациях может быть предпринята попытка восстановления кластера на базе пайла А.

При необходимости возобновления работы кластера в ситуации, когда работоспособность сохранил только находящийся в состоянии DISCONNECTED, NOT_SYNCHRONIZED или SUSPENDED пайл, администратор может подать команду переключения из PRIMARY/DISCONNECTED в DISCONNECTED/PRIMARY (или аналогично для NOT_SYNCHRONIZED или SUSPENDED) с указанием специального параметра `force`. Произойдет разделение кластера на две части с несовместимой конфигурацией. В зависимости от фактического состояния данных в переключаемом в PRIMARY состояние пайле, кластер может быть восстановлен в корректное, либо во внутренне неконсистентное состояние. Успешная эксплуатация такого кластера не гарантируется.

Если полученный кластер оказался работоспособным, то далее возможно восстановление кластера в нормальное состояние, для чего необходимо перед выполнением восстановления отключенного пайла выполнить полную очистку данных и метаданных на всех его узлах, после чего перевести пайл в состояние NOT_SYNCHRONIZED.

## Особенности реализации режима bridge

### Хранение конфигураций

Distconf хранит конфигурацию двух статических групп, двух наборов state storage, scheme board и board. Там же хранится и режим работы кластера.

Для хранения конфигурации статических групп, state storage и бордов используется схема хранения с двумя комплектами кворумов:


  - кворум 1+А, использующий только узлы в пайле А. Запись успешна при успешной записи на кворуме узлов в пайле А и на кворуме статической группы 1.

  - кворум 2+Б, использующий только узлы в пайле Б. Запись успешна при успешной записи на кворуме узлов в пайле Б и на кворуме статической группы 2.


При отказе одного из пайлов запись в соответствующий кворум невозможна.

Distconf хранит конфигурацию и использует при этом кворумы 1+А и 2+Б:


  - Конфигурация, содержащая режим PRIMARY/DISCONNECTED записывается только в кворум 1+А.

  - Конфигурация, содержащая режим DISCONNECTED/PRIMARY записывается только в кворум 2+Б.

  - Все остальные режимы записываются и в кворум 1+А и в кворум 2+Б.


При failover администратор подает команду переключения в режим PRIMARY/DISCONNECTED или DISCONNECTED/PRIMARY, в этом режиме конфигурация общих компонент сохраняется только на кворуме из PRIMARY пайла.

Для начала восстановления администратор подает команду переключения пары из живого и отказавшего пайла в режим PRIMARY/NOT_SYNCHRONIZED, эта конфигурация сохраняется на всех кворумах.

Сохранение конфигурации не должно происходить при несовместимости сохраняемой и последней сохраненной конфигурации на узле, например недопустим переход из PRIMARY/DISCONNECTED в DISCONNECTED/PRIMARY. Это необходимо для выявления переключения пайла А в режим PRIMARY/DISCONNECTED и одновременного переключения пайла Б в режим DISCONNECTED/PRIMARY.

Для защиты от взаимодействия пайла А и пайла Б в случае перехода в такой режим предлагается предусмотреть разрыв/отказ устанавливать сессии интерконнекта при такого рода конфликте конфигураций нод.

### Запуск статических групп

Так как конфигурация каждой из статических групп хранится только в соответствующем пайле, статические группы получают конфигурацию от дистконфа, собравшего кворум в соответствующем пайле.

Получившие конфигурацию Node Warden запускают VDisk и PDisk статической группы.

Для доступа к статической группе предлагается использовать dsproxy-proxy, сервис, предоставляющий таблеткам интерфейс dsproxy и выполняющий операции синхронно с двумя группами в паре.

Dsproxy-proxy статической группы меняет режим работы в зависимости от конфигурации полученной от distconf. Конфигурация Dsproxy-proxy хранится в конфигурации общих компонент.

### Поведение dsproxy-proxy

в режиме PRIMARY/SYNCHRONIZED запись выполняется синхронно в 2 группы, чтение выполняется из PRIMARY и на каждом чтении выполняется пинг-запрос во вторую группу чтобы гарантировать своевременное уведомление о разрыве связи/смене режима работы группы.

в режиме PRIMARY/DISCONNECTED запись и чтение выполняется только в PRIMARY группе.

в режиме PRIMARY/NOT_SYNCHRONIZED dsproxy-proxy имеет множество подрежимов работы, определяющих, какие виды записи выполняются в SECONDARY группе:

  WRITE_KEEP - выполняется только запись KEEP флагов

  WRITE_KEEP_BARRIER_DONOTKEEP - выполняется запись барьеров, KEEP, DO NOT KEEP флагов

  WRITE_KEEP_BARRIER_DONOTKEEP_DATA - выполняется запись данных, барьеров, KEEP, DO NOT KEEP флагов

Конфигурация dsproxy-proxy содержит:


 - режим

 - подрежим

 - PPGeneration - номер поколения конфигурации dsproxy-proxy

 - номер поколения конфигурации dsproxy группы из пайла А

 - номер поколения конфигурации dsproxy группы из пайла Б


При смене конфигурации dsproxy-proxy обязательно изменение номера поколения конфигурации и конфигурации группы для PRIMARY группы - всегда, для SECONDARY - кроме как в состоянии DISCONNECTED.

В конфигурацию группы вводится:


 - режим

 - подрежим

 - PPGeneration - номер поколения конфигурации управляющей dsproxy-proxy


При каждой операции группы проверяют режим, подрежим и PPGeneration. Это необходимо чтобы не выполнялись операции от старых dsproxy-proxy, пропустивших смену режима или подрежима и не произошло перекрестное взаимодействие при возникновении двух PRIMARY.

Для продвижения из режима PRIMARY/NOT_SYNCHRONIZED в режим PRIMARY/SYNCHRONIZED выполняется синхронизация. В процессе синхронизации происходит перенос недостающих данных из PRIMARY группы в SECONDARY группу и двустороннее копирование информации о блокировках.

### Bootstrap BSController и других системных таблеток

В списке узлов для запуска таблетки достаточно перечислить один набор узлов включающий достаточно количество узлов из каждого пайла. Bootstrapper должен смотреть на конфигурацию state storage proxy-proxy и по ней определять, можно ли запускать на ноде таблетку. Если таблетку на ноде запускать нельзя (т.к. нода не в PRIMARY пайле), Bootstrapper должен пройти по дереву подсоединившихся к нему Bootstrapper-ов и назначить запускателем таблетки Bootstrapper из PRIMARY пайла. Если такого нет, таблетку запускать этому Bootstrapper нельзя.

### Конфигурация и запуск остальных таблеток

Динамическими группами хранения управляет BS Controller. Вместо каждого обычного storage-пула каждый раз создается 3 storage-пула, в пуле А - группы из пайла А, в пуле Б - группы из пайла Б, в пуле Ц - прокси-прокси группы, составленные из пар групп из пулов А и Б. Управляемые хайвом таблетки используют только группы прокси-прокси из пула Ц.

Запуск таблеток выполняется только в PRIMARY или PROMOTED пайла. Перевоз таблеток из DEMOTED в PROMOTED выполняется по возможности мягко, перевоз таблеток из DISCONNECTED в PRIMARY происходит как можно быстрее.

### Поведение interconnect

В интерконнекте разделяется обмен метаданными и установка сессии.

Обмен метаданными происходит до установления сессии и позволяет паре узлов определить используемый набор фич интерконнекта и обменяться конфигурацией.

 интерконнект с узлами из disconnected половины кластера разрывается и попыток установления соединения не предпринимается. Установление соединения возможно только после перевода пайлов в состояние PRIMARY/NOT_SYNCHRONIZED.
