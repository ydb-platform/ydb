# Change Data Capture (CDC)

Change Data Capture (CDC) обеспечивает захват изменений строк таблицы {{ ydb-short-name }}, формирует из них _поток изменений (changefeed)_, записывает в распределенное хранилище и предоставляет доступ к этим записям для дальнейшей обработки. В качестве распределенного хранилища используется [топик](topic.md), который позволяет эффективно хранить лог изменений таблицы.

Когда в таблице добавляется, обновляется или удаляется строка, CDC формирует запись о произошедшем изменении с указанием [первичного ключа](datamodel/table.md) строки и пишет ее в соответствующую данному ключу партицию топика.

## Гарантии {#guarantees}

* Записи об изменении шардированы между партициями топика по первичному ключу.
* Каждое изменение доставляется ровно один раз (exactly-once семантика).
* Изменения по одному и тому же первичному ключу доставляются в том же порядке, в котором они происходили в таблице в одну и ту же партицию топика.

## Ограничения {#restrictions}

* Количество партиций топика фиксируется на момент создания потока изменений и остается неизменным (топики, в отличие от таблиц, не являются эластичными).
* В потоке изменений поддерживаются записи о следующих видах операций:
  * обновление;
  * удаление.

  Таким образом, добавление строки является частным случаем обновления, и в потоке изменений запись о добавлении строки будет выглядеть аналогично записи об обновлении.

## Структура записи {#record-structure}

В зависимости от [параметров потока](../yql/reference/syntax/alter_table.md#changefeed-options) структура записи может отличаться.

Запись в формате [JSON](https://en.wikipedia.org/wiki/JSON) имеет следующую структуру:

```json
{
    "key": [<key components>],
    "update": {<columns>},
    "erase": {},
    "newImage": {<columns>},
    "oldImage": {<columns>}
}
```

* `<key components>` — массив значений компонент первичного ключа.
* `<columns>` — словарь из названий столбцов (ключ) и их значений (значение).

>Например:
>
>```json
>{
>    "key": [1, "one"],
>    "update": {
>        "payload": "lorem ipsum",
>        "date": "2022-02-22"
>    }
>}
>```

В некоторых режимах часть ключей может быть опущена:

Ключ | `KEYS_ONLY` | `UPDATES` | `NEW_IMAGE` | `OLD_IMAGE` | `NEW_AND_OLD_IMAGES`
:--- | :---: | :---: | :---: | :---: | :---:
`"key"` | + | + | + | + | +
`"update"` | Пустой | + | Пустой | Пустой | Пустой
`"erase"` | Пустой | Пустой | Пустой | Пустой | Пустой
`"newImage"` | - | - | + | - | +
`"oldImage"` | - | - | - | + | +

Как видно, вне зависимости от режима в записи всегда указываются:

* значения компонент первичного ключа таблицы (`"key"`);
* признак изменения (`"update"` или `"erase"`).

## Создание и удаление потока изменений {#ddl}

Поток изменений может быть добавлен к существующей таблице или удален директивами [ADD CHANGEFEED и DROP CHANGEFEED](../yql/reference/syntax/alter_table.md#changefeed) операции YQL `ALTER TABLE`. При удалении таблицы добавленный к ней поток изменений также будет удален.

## Назначение и применение CDC {#best_practices}

Об использовании CDC при разработке приложений смотрите в [рекомендациях](../best_practices/cdc.md).
