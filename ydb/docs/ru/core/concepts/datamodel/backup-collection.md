# Коллекции резервных копий

{% include [feature_enterprise.md](../../_includes/feature_enterprise.md) %}

Коллекция резервных копий — это [схемный объект](index.md), который обеспечивает [восстановление на момент времени](https://en.wikipedia.org/wiki/Point-in-time_recovery) для выбранных [строковых таблиц](table.md#row-oriented-tables). Коллекции резервных копий организуют полные и инкрементальные резервные копии в управляемые цепочки, обеспечивая эффективное аварийное восстановление и защиту от случайной потери данных, такой как ошибочные удаления или изменения.

{% note info %}

Практические инструкции по созданию и управлению коллекциями резервных копий см. в [Руководстве по резервному копированию и восстановлению](../../devops/backup-and-recovery/full-and-incremental-backups.md).

{% endnote %}

## Обзор

Коллекции резервных копий решают типичные задачи резервного копирования для производственных нагрузок:

- **Эффективность хранения**: Инкрементальные резервные копии захватывают только изменения с момента предыдущей резервной копии, значительно сокращая требования к хранилищу по сравнению с множеством полных резервных копий.
- **Согласованное восстановление**: Все таблицы в коллекции создаются из одного глобального снимка, обеспечивая ссылочную целостность между таблицами при восстановлении.
- **Восстановление на момент времени**: Восстановление данных на любой момент, когда была создана резервная копия в цепочке.

Для сравнения с другими методами резервного копирования (export/import, dump/restore) см. [Концепции резервного копирования](../../devops/backup-and-recovery/index.md).

## Ключевые концепции

Эти термины необходимы для понимания коллекций резервных копий. Подробные определения см. в [глоссарии](../glossary.md#backup-collection).

- **[Полная резервная копия](../glossary.md#backup)**: Полный снимок всех данных в коллекции на определённый момент времени. Служит основой для последующих инкрементальных резервных копий.
- **[Инкрементальная резервная копия](../glossary.md#backup)**: Захватывает только изменения (вставки, обновления, удаления) с момента предыдущей резервной копии. Требует всей цепочки резервных копий для восстановления.
- **[Цепочка резервных копий](../glossary.md#backup-chain)**: Упорядоченная последовательность, начинающаяся с полной резервной копии, за которой следует ноль или более инкрементальных резервных копий.

## Ограничения {#limitations}

Перед использованием коллекций резервных копий учтите эти ограничения:

- **Только строковые таблицы**: [Колоночные таблицы](table.md#column-oriented-tables) и [другие виды объектов схемы](../glossary.md#scheme-object) не поддерживаются.
- **Одна коллекция на таблицу**: Таблица может принадлежать только одной коллекции резервных копий одновременно. Чтобы включить таблицу в другую коллекцию, ее сначала нужно удалить из существующей, удалив саму коллекцию.
- **Неизменяемый состав**: После создания список таблиц в коллекции не может быть изменен. Чтобы добавить новые таблицы, создайте новую коллекцию, включающую все необходимые таблицы.
- **Нет частичного восстановления**: Нельзя восстановить отдельные таблицы из коллекции; вся коллекция восстанавливается целиком.
- **Внешнее планирование**: {{ ydb-short-name }} не предоставляет встроенного планировщика резервных копий. Используйте внешние инструменты, такие как cron, для автоматизации процесса.
- **Функциональность пока не поддерживается в резервных копиях и находится в разработке**: перемещение таблиц, новые таблицы, созданные после формирования коллекции, изменение прав доступа к таблицам, [векторные индексы](../../concepts/glossary.md#vector-index), [CDC](../../concepts/glossary.md#cdc), [политики TTL](../../concepts/glossary.md#ttl), автоинкрементные столбцы, [асинхронные вторичные индексы](../../concepts/secondary_indexes.md#async), последовательности (sequences) и метаданные сущностей.

## Архитектура

Коллекции резервных копий используют механизм копирования при записи в сочетании с [потоками изменений](../cdc.md) для эффективных инкрементальных резервных копий. В этом разделе объясняется, как компоненты работают вместе.

###  Как работают коллекции резервных копий

Следующая диаграмма иллюстрирует процесс резервного копирования:

```mermaid
block-beta
    columns 5

    CREATE["Создание\nколлекции"]
    FULL["Полная\nрезервная копия"]
    INC1["Инкрементальная\nрезервная копия"]
    INC2["Инкрементальная\nрезервная копия"]
    DROP["Удаление\nколлекции"]

    CREATE --> FULL
    FULL --> INC1
    INC1 --> INC2
    INC2 --> DROP

    style CREATE fill:#1976D2,color:#fff
    style FULL fill:#1565C0,color:#fff
    style INC1 fill:#42A5F5,color:#fff
    style INC2 fill:#64B5F6,color:#000
    style DROP fill:#E91E63,color:#fff
```

**Создание коллекции** определяет, какие таблицы включить, и создаёт схемный объект. Это быстрая операция только с метаданными.

**Полная резервная копия** создаёт согласованный снимок всех таблиц в коллекции. Ключевые характеристики:

- Использует **глобальный снимок**, который обеспечивает ссылочную целостность всех таблиц в коллекции.
- Создаёт **потоки изменений** для каждой таблицы для отслеживания последующих модификаций.
- Использует **копирование при записи**: Резервная копия создаётся быстро путём ссылки на существующие данные; фактическое копирование данных происходит только при модификации исходных данных.

**Инкрементальная резервная копия** захватывает все изменения с момента предыдущей резервной копии:

- Использует **распределённую транзакцию** для чтения потоков изменений из всех таблиц в согласованной точке, обеспечивая ссылочную целостность всей коллекции.
- Считывает накопленные изменения из потоков изменений, созданных при полной резервной копии.
- Записывает все модификации: вставки, обновления и удаления (как записи-tombstone).
- Компактифицирует данные потоков изменений в таблицы инкрементальной резервной копии.

{% note warning %}

Изменения схемы (ALTER TABLE) таблиц в коллекции резервных копий не отслеживаются инкрементальными резервными копиями. Если вам нужно изменить схему таблицы с резервной копией, создайте новую полную резервную копию после изменения схемы, чтобы цепочка резервных копий отражала новую структуру.

{% endnote %}

{% note info %}

Потоки изменений, созданные при полной резервной копии, автоматически удаляются при удалении коллекции резервных копий. Их нельзя удалить вручную или использовать для других целей, пока коллекция существует.

{% endnote %}

### Хранение

Коллекции резервных копий хранятся в кластере {{ ydb-short-name }} в выделенной структуре каталогов:

```text
/Root/database/.backups/collections/
├── my_collection/
│   ├── 20250821141425Z_full/
│   │   ├── table_1/
│   │   └── table_2/
│   └── 20250821151519Z_incremental/
│       ├── table_1/
│       └── table_2/
```

{% note info %}

Каталог `.backups` создается автоматически при создании первой коллекции резервных копий. Не создавайте эту директорию вручную. После ее появления вы можете управлять таблицами резервных копий внутри нее (например, [при экспорте или импорте резервных копий](../../devops/backup-and-recovery/full-and-incremental-backups.md#s3export)).

{% endnote %}

#### Хранение в кластере

Кластерное хранилище

По умолчанию резервные копии хранятся в кластере. Резервные копии в кластере предназначены для восстановления после **логических ошибок**, таких как случайный `DROP TABLE`, `TRUNCATE TABLE` или ошибочные изменения данных. Преимущества:

- Быстрые операции резервного копирования и восстановления.
- Интегрированные механизмы безопасности.
- Не требуется внешняя инфраструктура.


{% note warning %}

Резервные копии, хранящиеся в кластере, находятся в том же домене отказа, что и защищаемые ими данные. Если в кластере произойдет масштабный сбой, выходящий за пределы расчетной отказоустойчивости (определяемой выбранной [топологией кластера](../topology.md)), и данные, и резервные копии могут быть потеряны или стать недоступными. Для защиты от таких сценариев используйте внешнее хранилище.

{% endnote %}

#### Внешнее хранилище

Для **аварийного восстановления** и защиты от отказов всего кластера регулярно экспортируйте коллекции резервных копий во внешнее хранилище (S3-совместимое хранилище или файловую систему) с помощью [операций export/import](../../reference/ydb-cli/export-import/index.md).

Для экспорта резервных копий во внешнее хранилище используйте CLI {{ ydb-short-name }}:

- `ydb export s3` для S3-совместимого хранилища.
- `ydb tools dump` для файловой системы.

Каждую резервную копию в цепочке необходимо экспортировать отдельно. Сохраняйте порядок цепочки при экспорте/импорте для успешного восстановления.

### Фоновые операции

Все операции резервного копирования и восстановления выполняются асинхронно, позволяя продолжать обычные операции с базой данных. Отслеживайте прогресс с помощью `ydb operation list incbackup`.

## Восстановление из резервных копий

Восстановление позволяет вернуть данные из цепочки резервных копий на указанный момент времени.

### Процесс восстановления

1. **Импорт из внешнего хранилища** (при необходимости): Если резервные копии были экспортированы, импортируйте полную резервную копию и все инкрементальные резервные копии до нужной точки восстановления.

2. **Выполнение восстановления**: Выполните `RESTORE collection_name` для восстановления всех таблиц из коллекции резервных копий. Система применяет полную резервную копию и все инкрементальные резервные копии последовательно для достижения последней точки резервного копирования.

{% note warning %}

Операция восстановления перезаписывает существующие таблицы с теми же именами. Создайте резервную копию или переименуйте существующие таблицы перед восстановлением, если вам нужно сохранить их текущие данные.

{% endnote %}

Операция восстановления поддерживает транзакционную согласованность всех таблиц в коллекции.

{% note info %}

Во время операции восстановления целевые таблицы находятся в состоянии `EPathStateIncomingIncrementalRestore`. Частично восстановленные данные могут быть видны рабочим нагрузкам во время выполнения операции. Планируйте операции восстановления на период технического обслуживания, если ваше приложение не может работать с таблицами в этом состоянии.

{% endnote %}

## См. также

- [Руководство по резервному копированию и восстановлению](../../devops/backup-and-recovery/full-and-incremental-backups.md): Практическое руководство по эксплуатации.
- Справочник YQL:
  - [CREATE BACKUP COLLECTION](../../yql/reference/syntax/create-backup-collection.md)
  - [BACKUP](../../yql/reference/syntax/backup.md)
  - [RESTORE](../../yql/reference/syntax/restore-backup-collection.md)
  - [DROP BACKUP COLLECTION](../../yql/reference/syntax/drop-backup-collection.md)
