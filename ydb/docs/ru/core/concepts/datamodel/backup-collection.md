# Коллекция резервных копий

Коллекция резервных копий — это [схемный объект](index.md), который обеспечивает [восстановление на момент времени](https://en.wikipedia.org/wiki/Point-in-time_recovery) для выбранных [строковых таблиц](table.md#row-oriented-tables). Коллекции резервных копий организуют полные и инкрементальные резервные копии в управляемые цепочки, обеспечивая эффективное аварийное восстановление и защиту от случайной потери данных, такой как ошибочные удаления или изменения.

{% note info %}

Практические инструкции по созданию и управлению коллекциями резервных копий см. в [Руководстве по резервному копированию и восстановлению](../../devops/backup-and-recovery.md#backup-collections).

{% endnote %}

## Обзор

Коллекции резервных копий решают типичные задачи резервного копирования для производственных нагрузок:

- **Эффективность хранения**: Инкрементальные резервные копии захватывают только изменения с момента предыдущей резервной копии, значительно сокращая требования к хранилищу по сравнению с множеством полных резервных копий.
- **Согласованное восстановление**: Все таблицы в коллекции создаются из одного глобального снимка, обеспечивая ссылочную целостность между таблицами при восстановлении.
- **Восстановление на момент времени**: Восстановление данных на любой момент, когда была создана резервная копия в цепочке.

Для сравнения с другими методами резервного копирования (export/import, dump/restore) см. [Концепции резервного копирования](../backup.md).

## Ключевые концепции

Эти термины необходимы для понимания коллекций резервных копий. Подробные определения см. в [глоссарии](../glossary.md#backup-collection).

- **[Полная резервная копия](../glossary.md#backup)**: Полный снимок всех данных в коллекции на определённый момент времени. Служит основой для последующих инкрементальных резервных копий.
- **[Инкрементальная резервная копия](../glossary.md#backup)**: Захватывает только изменения (вставки, обновления, удаления) с момента предыдущей резервной копии. Требует всей цепочки резервных копий для восстановления.
- **[Цепочка резервных копий](../glossary.md#backup-chain)**: Упорядоченная последовательность, начинающаяся с полной резервной копии, за которой следует ноль или более инкрементальных резервных копий.

## Ограничения

Перед использованием коллекций резервных копий учтите эти ограничения:

- **Только строковые таблицы**: [Колоночные таблицы](table.md#column-oriented-tables) не поддерживаются.
- **Одна коллекция на таблицу**: Таблица может принадлежать только одной коллекции резервных копий. Чтобы включить таблицу в другую коллекцию, сначала необходимо удалить существующую коллекцию.
- **Неизменяемый состав**: После создания список таблиц в коллекции нельзя изменить. Для добавления новых таблиц создайте новую коллекцию со всеми нужными таблицами.
- **Нет частичного восстановления**: Нельзя восстановить отдельные таблицы из коллекции; восстанавливается вся коллекция целиком.
- **Внешнее планирование**: {{ ydb-short-name }} не предоставляет встроенного планирования резервного копирования. Используйте внешние инструменты, такие как cron, для автоматизации.

## Архитектура

Коллекции резервных копий используют механизм копирования при записи в сочетании с [потоками изменений](../cdc.md) для эффективных инкрементальных резервных копий. В этом разделе объясняется, как компоненты работают вместе.

### Как работают коллекции резервных копий

Следующая диаграмма иллюстрирует процесс резервного копирования:

```mermaid
block-beta
    columns 5

    CREATE["Создание\nколлекции"]
    FULL["Полная\nкопия"]
    INC1["Инкрементальная\nкопия"]
    INC2["Инкрементальная\nкопия"]
    DROP["Удаление\nколлекции"]

    CREATE --> FULL
    FULL --> INC1
    INC1 --> INC2
    INC2 --> DROP

    style CREATE fill:#E3F2FD
    style FULL fill:#2196F3,color:#fff
    style INC1 fill:#90CAF9
    style INC2 fill:#BBDEFB
    style DROP fill:#FFB6C1
```

**Создание коллекции** определяет, какие таблицы включить, и создаёт схемный объект. Это быстрая операция только с метаданными.

**Полная резервная копия** создаёт согласованный снимок всех таблиц в коллекции. Ключевые характеристики:

- Использует **глобальный снимок**, который обеспечивает ссылочную целостность всех таблиц в коллекции.
- Создаёт **потоки изменений** для каждой таблицы для отслеживания последующих модификаций.
- Использует **копирование при записи**: Резервная копия создаётся быстро путём ссылки на существующие данные; фактическое копирование данных происходит только при модификации исходных данных.

**Инкрементальная резервная копия** захватывает все изменения с момента предыдущей резервной копии:

- Считывает накопленные изменения из потоков изменений, созданных при полной резервной копии.
- Записывает все модификации: вставки, обновления и удаления (как записи-tombstone).
- Компактифицирует данные потоков изменений в таблицы инкрементальной резервной копии.

{% note warning %}

Изменения схемы (ALTER TABLE) таблиц в коллекции резервных копий не отслеживаются инкрементальными резервными копиями. Если вам нужно изменить схему таблицы с резервной копией, создайте новую полную резервную копию после изменения схемы, чтобы цепочка резервных копий отражала новую структуру.

{% endnote %}

### Хранение

Коллекции резервных копий хранятся в кластере {{ ydb-short-name }} в выделенной структуре каталогов:

```text
/Root/database/.backups/collections/
├── my_collection/
│   ├── 20250821141425Z_full/
│   │   ├── table_1/
│   │   └── table_2/
│   └── 20250821151519Z_incremental/
│       ├── table_1/
│       └── table_2/
```

#### Кластерное хранилище

По умолчанию резервные копии хранятся в кластере со следующими преимуществами:

- Репликация и отказоустойчивость кластера
- Быстрые операции резервного копирования и восстановления
- Интегрированные механизмы безопасности

#### Внешнее хранилище

{% note warning %}

Резервные копии, хранящиеся в кластере, не защищают от отказов всего кластера (таких как полная потеря кластера или катастрофические события в дата-центре). Для сценариев аварийного восстановления регулярно экспортируйте коллекции резервных копий во внешнее хранилище (S3-совместимое хранилище или файловую систему) с помощью [операций export/import](../../reference/ydb-cli/export-import/index.md).

{% endnote %}

Для экспорта резервных копий во внешнее хранилище используйте {{ ydb-short-name }} CLI:

- `ydb export s3` для S3-совместимого хранилища
- `ydb tools dump` для файловой системы

Каждую резервную копию в цепочке необходимо экспортировать отдельно. Сохраняйте порядок цепочки при экспорте/импорте для успешного восстановления.

### Фоновые операции

Все операции резервного копирования и восстановления выполняются асинхронно, позволяя продолжать обычные операции с базой данных. Отслеживайте прогресс с помощью `ydb operation list incbackup`.

## Восстановление из резервных копий

Восстановление позволяет вернуть данные из цепочки резервных копий на указанный момент времени.

### Процесс восстановления

1. **Импорт из внешнего хранилища** (при необходимости): Если резервные копии были экспортированы, импортируйте полную резервную копию и все инкрементальные резервные копии до нужной точки восстановления.

2. **Создание коллекции для восстановления**: Определите целевое расположение для восстановленных данных.

3. **Выполнение восстановления**: Система применяет полную резервную копию и все инкрементальные резервные копии последовательно для достижения указанной точки восстановления.

4. **Очистка**: После проверки восстановленных данных опционально удалите коллекцию восстановления.

Операция восстановления поддерживает транзакционную согласованность всех таблиц в коллекции.

## См. также

- [Концепции резервного копирования](../backup.md): Обзор всех подходов к резервному копированию в {{ ydb-short-name }}
- [Руководство по резервному копированию и восстановлению](../../devops/backup-and-recovery.md#backup-collections): Практическое руководство
- [Рецепты и примеры](../../recipes/backup-collections.md): Типовые сценарии и примеры
