# Потоковые запросы

Потоковые запросы предназначены для непрерывной обработки данных из [топиков](datamodel/topic.md) в реальном времени.

В отличие от обычных запросов, которые выполняются над уже сохранёнными данными и завершаются после обработки, потоковый запрос создаётся один раз и работает постоянно. Данные поступают в топик, «протекают» через запрос и записываются в приёмник — другой топик или таблицу.

Потоковые запросы используются для:

- мониторинга и алертинга — обнаружение аномалий и ошибок в реальном времени;
- агрегации метрик — подсчёт статистики по временным окнам;
- трансформации данных — преобразование и фильтрация событий на лету;
- обогащения событий — добавление данных из справочников;
- поиска паттернов — обнаружение последовательностей событий.

Запросы пишутся на YQL и поддерживают привычные конструкции: `SELECT`, `WHERE`, `GROUP BY`, `JOIN`. Для работы с временными окнами используется [GROUP BY HOP](../yql/reference/syntax/select/group-by.md#group-by-hop), для поиска паттернов — [MATCH_RECOGNIZE](../yql/reference/syntax/select/match_recognize.md).

В обычных запросах данные уже сохранены в таблицах. Запрос выполняется, возвращает результат и завершается.

![Обычные запросы](../concepts/_assets/streaming_queries_1.drawio.png "Обычные запросы" =640x)

В потоковых запросах всё наоборот: сначала создаётся запрос, а затем данные непрерывно поступают и обрабатываются.

![Потоковые запросы](../concepts/_assets/streaming_queries_2.drawio.png "Потоковые запросы" =640x)

## Отличия от обычных запросов {#differences}

| Характеристика | Обычные запросы | Потоковые запросы |
|----------------|-----------------|-------------------|
| Данные | Конечный набор в таблицах | Бесконечный поток событий |
| Время жизни | Завершается после обработки | Работает непрерывно |
| Результат | Доступен после завершения | Обновляется по мере поступления данных |
| Восстановление | Перезапуск вручную | Автоматическое восстановление из чекпоинта |

## Источники и приёмники данных {#data-flow}

### Источники {#sources}

**Топики** — основной источник потоковых данных. Запрос читает сообщения из одного или нескольких [топиков](datamodel/topic.md) и обрабатывает их по мере поступления.

**CDC (Change Data Capture)** — поток изменений из таблиц. Позволяет реагировать на вставки, обновления и удаления записей в реальном времени. Подробнее: [{#T}](cdc.md).

**S3** — внешнее хранилище для обогащения потока. Справочные данные из S3 загружаются в память и присоединяются к событиям через `JOIN`. Подробнее: [{#T}](federated_query/s3/external_data_source.md).

### Приёмники {#sinks}

**Топики** — для передачи результатов другим системам или следующим этапам обработки.

**Таблицы** — для материализации результатов. Данные сохраняются через [UPSERT](../yql/reference/syntax/upsert_into.md) и доступны для обычных SQL-запросов.

{% note info %}

Запись в таблицы других баз данных {{ ydb-short-name }} не поддерживается.

{% endnote %}

## Гарантии {#guarantees}

Потоковые запросы обеспечивают гарантию **at-least-once**: каждое событие будет обработано минимум один раз. При записи в топик применяется дедупликация для предотвращения дублирования.

{{ ydb-short-name }} автоматически сохраняет состояние запроса и восстанавливает его после сбоев. Подробнее: [{#T}](../dev/streaming-query/checkpoints.md).

## Ограничения {#limitations}

- Запрос должен содержать хотя бы одно чтение из топика;
- `JOIN` двух потоков не поддерживается;
- обогащение из локальных таблиц {{ ydb-short-name }} не поддерживается (в разработке);
- чтение/запись локальных топиков без использования [внешних источников данных](../concepts/datamodel/external_data_source.md) не поддерживается.

## Управление {#control}

Потоковые запросы управляются через YQL:

- [CREATE STREAMING QUERY](../yql/reference/syntax/create-streaming-query.md) — создание;
- [ALTER STREAMING QUERY](../yql/reference/syntax/alter-streaming-query.md) — изменение и управление состоянием;
- [DROP STREAMING QUERY](../yql/reference/syntax/drop-streaming-query.md) — удаление.

Состояние запросов доступно в системной таблице [.sys/streaming_queries](../dev/system-views.md#streaming).

## См. также

- [{#T}](../recipes/streaming_queries/topics.md) — пошаговое руководство;
- [{#T}](../dev/streaming-query/troubleshooting.md) — диагностика проблем;
- [{#T}](../dev/streaming-query/streaming-query-formats.md) — форматы данных.
