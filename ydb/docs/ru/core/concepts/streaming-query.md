# Потоковые запросы

Потоковый запрос — это тип запроса, предназначенный для непрерывной обработки неограниченного потока данных ([stream processing](https://en.wikipedia.org/wiki/Stream_processing)). В отличие от обычных запросов, потоковый запрос не завершается после получения результата, а работает постоянно, обрабатывая данные по мере их поступления.

Потоковая обработка данных — широко применяемый подход, реализованный в таких системах, как [Apache Flink](https://flink.apache.org/), [Apache Kafka Streams](https://kafka.apache.org/documentation/streams/), [Amazon Kinesis Data Analytics](https://aws.amazon.com/kinesis/data-analytics/). Типичные сценарии применения — мониторинг и алертинг, агрегация метрик по временным окнам, трансформация и фильтрация событий на лету, обогащение событий данными из справочников, поиск паттернов в последовательностях событий.

{{ ydb-short-name }} реализует потоковую обработку как часть единой платформы {{ydb-short-name}}. В дополнение к типовым сценариям использования потоковых запросов, интеграция в общую платформу {{ydb-short-name}} позволяет получать данные из [топиков](datamodel/topic.md) {{ydb-short-name}}, обрабатывать потоки изменений из [строковых таблиц](datamodel/table.md#row-oriented-tables) через [CDC](cdc.md), а результаты обработки записывать в выходные топики или напрямую в таблицы. Это позволяет полностью построить конвейеры обработки данных в реальном времени внутри {{ydb-short-name}}.

## Отличия от обычных запросов {#differences}

Обычные запросы работают с данными, которые уже сохранены в таблицах. Запрос выполняется, возвращает результат и завершается. Потоковый запрос создается и продолжает работу бесконечно до явной отмены пользователем. Данные непрерывно поступают в топик, «протекают» через запрос и записываются в приёмник — другой топик или таблицу.


| Характеристика | Обычные запросы | Потоковые запросы |
|----------------|-----------------|-------------------|
| Данные | Конечный набор в таблицах | Бесконечный поток событий |
| Время жизни | Завершается после обработки | Работает непрерывно |
| Результат | Доступен после завершения | Обновляется по мере поступления данных |
| Восстановление при сбоях | Перезапуск вручную | Автоматическое восстановление из [чекпоинта](../dev/streaming-query/checkpoints.md) |

## Источники и приёмники данных {#data-flow}

Потоковые запросы работают только с сущностями {{ ydb-short-name }} — [топиками](datamodel/topic.md), [таблицами](datamodel/table.md) и потоками изменений ([CDC](cdc.md)). Чтение из внешних систем, например из Apache Kafka, или запись в таблицы других баз данных, таких как PostgreSQL, не поддерживается.

### Источники {#sources}

**Топики** — основной источник потоковых данных. Запрос читает сообщения из одного или нескольких [топиков](datamodel/topic.md) и обрабатывает их по мере поступления.

**CDC (Change Data Capture)** — поток изменений из таблиц. Позволяет реагировать на вставки, обновления и удаления записей в реальном времени. Подробнее: [{#T}](cdc.md).

### Приёмники {#sinks}

**Топики** — для передачи результатов другим системам или следующим этапам обработки.

**Таблицы** — для материализации результатов. Данные сохраняются через [UPSERT](../yql/reference/syntax/upsert_into.md) и доступны для обычных SQL-запросов.

{% note info %}

Запись в таблицы других баз данных {{ ydb-short-name }} не поддерживается.

{% endnote %}

## Гарантии {#guarantees}

Потоковые запросы обеспечивают гарантию **at-least-once**: каждое событие будет обработано минимум один раз. При записи в топик применяется дедупликация для предотвращения дублирования.

{{ ydb-short-name }} автоматически сохраняет состояние запроса и восстанавливает его после сбоев. Подробнее: [{#T}](../dev/streaming-query/checkpoints.md).

## Ограничения {#limitations}

{% note warning %}

Запрос должен содержать хотя бы одно чтение из топика.

Не поддерживаются:

- `JOIN` двух потоков;
- обогащение из таблиц {{ ydb-short-name }} — потоковые запросы могут использовать только [внешние таблицы S3](federated_query/s3/external_table.md) для обогащения данными (будет поддержано в версии 26.1);
- чтение и запись локальных топиков — для работы с локальными топиками нужно создать [внешний источник данных](datamodel/external_data_source.md), ведущий на текущую базу данных (будет поддержано в версии 26.1).

{% endnote %}

Для работы с локальными топиками используйте [внешние источники данных](../concepts/datamodel/external_data_source.md):

- Создайте [внешний источник данных](datamodel/external_data_source.md) и [внешнюю таблицу](datamodel/external_table.md), указывающие на ту же или другую базу данных {{ ydb-short-name }}, и обращайтесь к топикам через них.

## Управление {#control}

Потоковые запросы создаются, изменяются и удаляются с помощью YQL-команд:

- [CREATE STREAMING QUERY](../yql/reference/syntax/create-streaming-query.md) — создание;
- [ALTER STREAMING QUERY](../yql/reference/syntax/alter-streaming-query.md) — изменение и управление состоянием;
- [DROP STREAMING QUERY](../yql/reference/syntax/drop-streaming-query.md) — удаление.

Состояние запросов доступно в системной таблице [.sys/streaming_queries](../dev/system-views.md#streaming).

## Язык запросов {#syntax}

Потоковые запросы пишутся на [YQL](../yql/reference/index.md) и поддерживают привычные SQL-конструкции: [SELECT](../yql/reference/syntax/select/index.md), [WHERE](../yql/reference/syntax/select/where.md), [GROUP BY](../yql/reference/syntax/select/group-by.md), [JOIN](../yql/reference/syntax/select/join.md). Для работы с временными окнами используется [GROUP BY HOP](../yql/reference/syntax/select/group-by.md#group-by-hop), для поиска паттернов — [MATCH_RECOGNIZE](../yql/reference/syntax/select/match_recognize.md).

## См. также

- [{#T}](../recipes/streaming_queries/topics.md) — пошаговое руководство;
- [{#T}](../dev/streaming-query/streaming-query-formats.md) — форматы данных.
