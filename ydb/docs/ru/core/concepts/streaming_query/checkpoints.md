# Чекпойнты

Чекпойнт представляет из себя состояние рабочего потокового запроса, которое необходимо для восстановление работы запросы в случае сбоев в распределенной системе: выход из строя узлов, падения процессов при нехватке памяти и др. Инфраструктура собирает чекпойнты всех запущенных потоковых запросов периодически и сохраняет в системные таблицы базы.

Чекпойнт состоит из:

- состояний агрегаций (таких как [MATCH RECOGNIZE](../../../yql/reference/syntax/select/match_recognize) и [GROUP BY HOP](../../../yql/reference/syntax/select/group-by#group-by-hop)),
- текущих [смещения](../topic#consumer-offset) во входных топиках,
- текущих [порядковых номеров сообщений](../topic#seqno) в выходных топиков.

При первом запуске запроса производится его компиляция, результат которой сохраняется в системную таблицу.
В случае завершения запроса с ошибкой, он будет перезапущен автоматически, при этом:

- повторной компиляции не будет, т.к. в самом начале ее сделали, и в таблице есть ее результат,
- внутреннее состояние запроса будет восстановлено из последнего сохранённого чекпойнта.

У пользователя нет возможности для конкретного запроса как-то повлиять на сохранение чекпойнтов и выбор чекпойнта для восстановления, это делается автоматически.

## Очистка

Размер чекпойнта зависит от сложности запроса, используемых агрегаций и от характера данных. Для оптимального потребления хранилища после очередного успешного сохранения чекпойнта старые удаляются автоматически. Т.е. в большинстве времени для одного запроса в хранилище хранится только один чекпойнт.

## Отключение чекпойнтов

Для снижения накладных расходов (от сохраннения чекпойтов) возможно отключение чекпойнтов. Для этого используется прагма `ydb.DisableCheckpoints`. При этом нужно отменить отсутствие гарантий на консистентность данных (при пользовательных или внутренних перезапусках запроса). Используете исключительно с целью отладки.

```sql
CREATE OR REPLACE STREAMING QUERY `my_queries/query1` AS
DO BEGIN
    PRAGMA ydb.DisableCheckpoints="True";
    INSERT INTO ydb_source.output_topic_name SELECT * FROM ydb_source.input_topic_name;
END DO;
```
