# Чекпойнты

Стриминговые запросы в процессе работы записывают свое состояние в т.н. чекпойнт. Он сохраняется с хранилище (в текущую или внешную YDB).

Чекпойнт предназначен для восстановления состояния после сбоя (падения нод, завершения запроса по ошибке) или после ручного рестарта запроса.

Чекпойнт состоит из:

- стейтов агрегаций для тасок, содержащих потоковую агрегацию (таких как [MATCH RECOGNIZE](../../../yql/reference/syntax/select/match_recognize) и [GROUP BY HOP](../../..//yql/reference/syntax/select/group-by#group-by-hop)),
- текущих [смещения](../topic#consumer-offset) во входных топиках,
- текущих [порядковых номеров сообщений](../topic#seqno) в выходных топиков.

На старте запроса сохраняется физический граф запроса описывающий все таски и каналы в графе.
В случае завершения запроса с ошибкой, он будет перезапущен автоматически, при этом:

- запрос начнёт выполняться без компиляции используя сохранённый физический граф,
- после того как все таски будут запущены, будет проведена синхронизация состояния с последним сохранённым чекпоинтом.

У пользователя нету возможности для конкретного запроса как-то повлиять на сохранение чекпоинтов и выбор чекпоинта для восстановления, это делается автоматически, пользователь может управлять чекпоинтами при:
- cтарте запроса после ручной остановки: выбрать восстановление его из чекпоинта или без использования чекпойнта (с потерей состояния).

## Очистка

При успешном сохранении чекпойнта предыдущие чекпойнты удаляются из хранилища. Т.е. в большинстве времени для одного запроса в хранилище хранится только один чекпойнт.

## Отключение чекпойнтов

Для отключения (исключительно в тестовых целях) используетcя прагма `ydb.DisableCheckpoints`.

```sql

CREATE OR REPLACE STREAMING QUERY `my_queries/query1`
BEGIN
    PRAGMA ydb.DisableCheckpoints="True";
    INSERT INTO `source_name`.`output_topic_name` SELECT * FROM `source_name`.`input_topic_name`;
END;
```
