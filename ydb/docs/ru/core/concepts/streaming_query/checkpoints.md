# Чекпойнты

Чекпойнты предназначены для восстановления состояния после сбоя (падения нод, завершения запроса по ошибке) или после ручного рестарта запроса. Потоковые запросы в процессе работы периодически сохраняют свое состояние (чекпойнт). Чекпойнты сохраняется в текущую базу.

Чекпойнт состоит из:

- состояний агрегаций (таких как [MATCH RECOGNIZE](../../../yql/reference/syntax/select/match_recognize) и [GROUP BY HOP](../../../yql/reference/syntax/select/group-by#group-by-hop)),
- текущих [смещения](../topic#consumer-offset) во входных топиках,
- текущих [порядковых номеров сообщений](../topic#seqno) в выходных топиков.

На старте запроса выполняется компиляция запроса и результат компиляции сохраняется в системные таблицы.
В случае завершения запроса с ошибкой, он будет перезапущен автоматически, при этом:

- запрос начнёт выполняться из сохраненнного результата компиляции (без перекомплиляции),
- внутреннее состояние запроса будет восстановлено из последнего сохранённого чекпойнта.

У пользователя нету возможности для конкретного запроса как-то повлиять на сохранение чекпойнтов и выбор чекпойнта для восстановления, это делается автоматически.

## Очистка

Размер чекпойнта зависит сложности запроса (наличия аггрегаций) и от характера данных. Для уменьшения занимаемого места при успешном сохранении чекпойнта предыдущие чекпойнты удаляются из хранилища. Т.е. в большинстве времени для одного запроса в хранилище хранится только один чекпойнт.

## Отключение чекпойнтов

Для снижения накладных расходов (от сохраннения чекпойтов) возможно отключение чекпойнтов. Для этого используется прагма `ydb.DisableCheckpoints`. При этом нужно отменить отсутствие гарантий на консистентность данных (при пользовательных или внутренних перезапусках запроса).

```sql
CREATE OR REPLACE STREAMING QUERY `my_queries/query1` AS
DO BEGIN
    PRAGMA ydb.DisableCheckpoints="True";
    INSERT INTO source_name.output_topic_name SELECT * FROM source_name.input_topic_name;
END DO;
```
