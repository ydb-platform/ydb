# Потоковые запросы

Потоковые запросы служат для распределенной обработки неограниченного потока данных с минимальным отставанием от реального времени.
Потоковые запросы обрабатывают данные в режиме непрерывного потока. Данных последовательно проходят через различные стадии обработки, например чтение, парсинг, преобразование, агрегацию и запись результатов. Эти стадии обработки выполняются параллельно, позволяя системе эффективно обрабатывать данные в реальном времени.

Отличительные особенности от обычных запросов:

- не имеют максимальной длительности (таймаута),
- сами производят перезапуск в случае ошибок (падений нод, дисконнектов),
- периодически сохраняют свое состояние (чекпойнты),
- не могут иметь результата. Посчитанные данные следует явно вставить в другой топик.

На данный момент в качестве неограниченных входных данных могут быть использованы [топики](../topic). Для обогащения основного потока могут быть использованы ограниченные потоки (таблицы {{ ydb-short-name }} или внешние источники S3). Для выходных данных могут быть использованы только топики.

В случае внутренних сбоев запрос автоматически перезапускается и восстанавливается из последнего сохраненного [чекпойнта](checkpoints.md).

Потоковые запросы обеспечивают гарантию at least once. Это гарантируется повторной обработкой данных с последнего сохраненного чекпойнта с дедупликацией при вставке в топик.

В частности это обеспечивается:

- гарантиями [топиков](../topic) (at-least-once при чтении / exactly-once при записи),
- сохранения [смещений](../topic#offset) во входных топиках,
- сохранения [порядковых номеров сообщений](../topic#seqno) для дедупликации в выходных топиках,
- сохранения стейтов агрегаций для тасок, содержащих потоковую агрегацию (таких как `GROUP BY HOP` / `MATCH_RECOGNIZE`).

### Использование [читателя](../datamodel/topic#consumer)

По умолчанию чтение из топика происходит [без использования читателя](../../reference/ydb-sdk/topic.md#no-consumer).
Чтобы использовать читателя необходимо предварительно его создать через [CLI](../../reference/ydb-cli/topic-consumer-add) или при создании топика с помощью [YQL](../../../yql/reference/syntax/create-topic.md).
Далее указать его имя в тексте запроса через `PRAGMA pq.Consumer=my_consumer` (см. пример в [CREATE STREAMING QUERY](../../../yql/reference/syntax/create-streaming-query)).

### Состояние запроса

Запросы могут быть в 2-х состояних: запущен или остановлен. При этом в запущенном состоянии запрос может быть в нескольких статусах.
Подробную информацию о запросе можно получить через системную таблицу [streaming_queries](../../dev/system-views.md#streaming_queries).
Пример запроса:

```sql
SELECT Path, Status, Text, Run FROM `.sys/streaming_queries`;
);
```

### Поддерживаемые типы данных

Топики {{ ydb-short-name }} хранят неструктурированные данные. Поэтому при чтении необоходимо указывать формат и схему данных (см. [Форматы данных](formats.md)). Запись можно выполнять только в виде неструктурированных данных (например как строка или JSON).

### Конфигурирование

Функциональность включается установкой флагов `enable_external_data_sources` и `enable_streaming_queries` в конфигурации кластера.
Пример:

```yaml
feature_flags:
  enable_external_data_sources: true
  enable_streaming_queries: true
```

### Синтаксис

Чтение реализовано через [внешние источники данных](../datamodel/external_data_source), поэтому предварительно необходимо создать источник через [CREATE EXTERNAL DATA SOURCE](../../../yql/reference/syntax/create-external-data-source).

Пример:

```sql
CREATE EXTERNAL DATA SOURCE source_name WITH (
    SOURCE_TYPE = 'Ydb',
    LOCATION = 'localhost:2135',
    DATABASE_NAME = '/Root',
    AUTH_METHOD = 'NONE'
);
```

Управлять потоковыми запросами можно с помощью следующих конструкций SQL:

- [CREATE STREAMING QUERY](../../../yql/reference/syntax/create-streaming-query),
- [ALTER STREAMING QUERY](../../../yql/reference/syntax/alter-streaming-query),
- [DROP STREAMING QUERY](../../../yql/reference/syntax/drop-streaming-query).

### См. также

- [Форматы данных](formats.md)
- [Чекпойнты](checkpoints.md)
- [Рецепты работы с потоковыми запросами](../../recipes/streaming.md)
