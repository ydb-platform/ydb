# Стриминговые запросы

Стриминговые запросы служат для потоковой обработки данных. Они осуществляют обработку над неограниченным потоком данных.
На данный момент в качестве входных данных могут быть использованы [топики](../topic) и таблицы (для JOIN). Для выходных данных могут быть использованы только топики. 

Отличительные особенности от обычных запросов:

- не имеют максимальной длительности (таймаута),
- сами производят перезапуск в случае ошибок (падений нод, дисконнектов),
- периодически сохраняют свое состояние (чекпойнты),
- не могут иметь результата. Посчитанные данные следует явно вставить в другой топик.

В случае внутренних сбоев запрос автоматически перезапускается и восстанавливается из последнего сохраненного [чекпойнта](checkpoints.md).

Стриминговые запросы обеспечивают гарантию exactly-once. Это гарантируется повторной обработкой данных с последнего сохраненного чекпойнта с дедупликацией при вставке в топик.

В частности это обеспечивается:

- гарантиями [топиков](../topic) (at-least-once при чтении / exactly-once при записи),
- сохранения [смещений](../topic#offset) во входных топиках,
- сохранения [порядковых номеров сообщений](../topic#seqno) для дедупликации в выходных топиках,
- сохранения стейтов агрегаций для тасок, содержащих потоковую агрегацию (таких как `GROUP BY HOP` / `MATCH_RECOGNIZE`).

## Использование [читателя](../glossary.md#consumer)

По умолчанию чтение из топика происходит [без использования читателя](../../reference/ydb-sdk/topic.md#no-consumer)).
Чтобы использовать читателя необходимо вручную его создать и указать его имя в тексте запроса через `PRAGMA pq.Consumer = ...` (см. пример в [CREATE STREAMING QUERY](../../../yql/reference/syntax/create-streaming-query),).

## Состояние запроса

Запросы могут быть в 2-х статусах: запущен или остановлен.
Подробную информацию о запросе можно получить через системную таблицу [streaming_queries](../../dev/system-views.md#streaming_queries)).

### Поддерживаемые типы данных

Чтение может быть произведено в формате как есть (в "сыром" виде) или в формате JSON. Запись можно выполнять только в виде байтового потока, который интерпретируется на принимающей стороне.

### Конфигурирование

Функциональность включается установкой флагов `enable_external_data_sources` и `enable_streaming_queries` в конфигурации кластера.
Пример:

```yaml
feature_flags:
  enable_external_data_sources: true
  enable_streaming_queries: true
```

## Синтаксис

Чтение реализовано через [внешние источники данных](../datamodel/external_data_source), поэтому предварительно необходимо создать источник через [CREATE EXTERNAL DATA SOURCE](../../../yql/reference/syntax/create-external-data-source).

Пример:

```sql
CREATE EXTERNAL DATA SOURCE `source_name` WITH (
    SOURCE_TYPE = 'Ydb',
    LOCATION = 'localhost:2135',
    DATABASE_NAME = '/Root',
    AUTH_METHOD = 'NONE'
);
```

Для управления (запуск, изменение и останавка) стриминговыми запросами предназначена сущность STREAMING QUERY, которую можно создавать и изменять через DDL:

- [CREATE STREAMING QUERY](../../../yql/reference/syntax/create-streaming-query),
- [ALTER STREAMING QUERY](../../../yql/reference/syntax/alter-streaming-query),
- [DROP STREAMING QUERY](../../../yql/reference/syntax/drop-streaming-query).

## См. также

- [Чекпойнты](checkpoints.md)
- [Рецепты работы со стриминговыми запросами](../../recipes/streaming.md)
