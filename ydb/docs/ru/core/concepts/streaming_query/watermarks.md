# Водяные знаки

В этом разделе описывается работа со временем и водяными знаками в потоковых запросах внутри YDB.

## Время события

В системе потоковой обработки важно знать, что стоит за понятием *времени события*, например, при работе с окнами [HoppingWindow](../../yql/reference/syntax/select/group-by.md#hopping_window). Сейчас в YDB в качестве такой временной метки выступает время записи события в [топик](../datamodel/topic.md).

Поверх этого времени события можно делать, например, агрегацию на временном окне ([HoppingWindow](../../yql/reference/syntax/select/group-by.md#hopping_window)). Однако встает вопрос полноты: как узнать, что были обработаны все данные для заданного окна? Для решения этой проблемы вводится понятие водяного знака.

## Водяной знак

Водяной знак - это специальное событие, которое распространяет по системе нижнюю оценку временных меток во всем топике. Водяной знак со значением времени X означает, что все входные данные с временем события меньше X были получены.

Другими словами, [HoppingWindow](../../yql/reference/syntax/select/group-by.md#hopping_window) при получении водяного знака может закрыть все "устаревшие" окна и вернуть результат пользователю, так как водяной знак гарантирует отсутствие данных для этих окон.

### Отставание водяного знака

В условиях распределенных систем, когда часы на разных устройствах могут дрейфовать, а данные - задерживаться из-за проблем с сетью, водяной знак не может полагаться на монотонное возрастание времени событий даже в рамках одной партиции. Для этого в формулу расчета водяного знака закладывается отставание.

### Использование

Для включения механизма водяных знаков необходимо указать выражение для вычисления водяного знака в секции [WITH](../../yql/reference/syntax/select/with.md). Сейчас поддерживается только время записи в [топик](../datamodel/topic.md) с константной задержкой. Более тонкая настройка параметров водяного знака может быть произведена также в секции [WITH](../../yql/reference/syntax/select/with.md).

При использовании [HoppingWindow](../../yql/reference/syntax/select/group-by.md#hopping_window) необходимо корректно указать первый параметр - **time extractor**. В текущей реализации это должно быть только время записи события в [топик](../datamodel/topic.md) (`SystemMetadata("write_time")`).

### Пример

Входными данными для примера являются:

```json
{"pass": 1, "payload": "a"} // 1970-01-01T00:00:40Z
{"pass": 1, "payload": "b"} // 1970-01-01T00:00:42Z
{"pass": 0, "payload": "c"} // 1970-01-01T00:00:50Z
{"pass": 1, "payload": "d"} // 1970-01-01T00:00:40Z
```

Пусть для примера каждое событие было записано во время, указанное в комментарии

Тело запроса:

```sql
CREATE STREAMING QUERY example AS
DO BEGIN
    $input =
        SELECT
            t.*,
            SystemMetadata("write_time") AS ts
        FROM
            input_topic
        WITH (
            FORMAT = json_each_row,
            SCHEMA = (
                pass Int64,
                payload String
            ),
            WATERMARK = SystemMetadata("write_time") - Interval("PT5S")
            -- , WATERMARK_ADJUST_LATE_EVENTS
        ) AS t;

    SELECT
        AGGREGATE_LIST(payload) AS result,
        HOP_END() AS ts
    FROM
        $input
    WHERE pass > 0
    GROUP BY
        HoppingWindow(ts, "PT5S", "PT10S");
END DO;
```

Результат:

```json
{"result": ["a", "b"], "ts": 45}
```

Пояснение:

1. Первое событие порождает водяной знак, равный 35 секундам. Первое событие проходит сквозь фильтр и "застревает" в HoppingWindow. Водяной знак, порожденный первым событием, не оказывает никакого влияния;
2. Второе событие порождает водяной знак, равный 37 секундам. Далее - аналогично первому событию;
3. Третье событие порождает водяной знак, равный 45 секундам. Третье событие отбрасывается на фильтре. Водяной знак, порожденный третьим событием, закрывает окно `[35; 45)`, результат отдается пользователю;
4. Четвертое событие порождает водяной знак, равный 35 секундам. Четвертое событие проходит сквозь фильтр и отбрасывается в HoppingWindow как опоздавшее событие, так как оно пришло после водяного знака со значением 45;
    - Чтобы не отбрасывать опоздавшие события, нужно раскомментировать строку с опцией `WATERMARK_ADJUST_LATE_EVENTS` в секции `WITH`. В случае включения опции четвертое событие было бы учтено в окне `[40; 50)`.
