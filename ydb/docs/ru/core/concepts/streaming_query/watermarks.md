# Водяные знаки

Каждое [событие](../datamodel/topic.md#message) в системе потоковой обработки данных имеет ассоциированную с ним временную метку. Эта метка может равняться времени чтения события из [топика](../datamodel/topic.md), может быть получена из данных внутри события или из метаданных [топика](../datamodel/topic.md).

Поверх этого времени события можно делать сортировку на потоке (внутри [MATCH_RECOGNIZE](../../yql/reference/syntax/select/match_recognize.md#order_by)) или агрегацию на временнОм окне ([HoppingWindow](../../yql/reference/syntax/select/group-by.md#hopping_window)). Эти потоковые операции должны знать текущее время, чтобы на основе этой информации генерировать выходные данные и делать это в режиме реального времени. Времени, получаемого из события, может быть недостаточно.

Например, агрегации поверх временных окон [HoppingWindow](../../yql/reference/syntax/select/group-by.md#hopping_window) для завершения окна нужно получить событие с временной меткой, выходящей за границы этого окна. Даже если такие события приходят, они зачастую отфильтровываются на более ранних этапах, не доходя до агрегации. В таком случае выдача результата откладывается на неопределенный срок, до получения события, проходящего все фильтры вплоть до агрегации.

Для решения проблемы продвижения времени в отсутствие данных нужно специальное событие, на которое не будут действовать фильтры и которое будет рассылаться по всем партициям сразу. Такое специальное событие называется водяной знак. Это нижняя оценка временных меток во всем топике.

Другими словами, [HoppingWindow](../../yql/reference/syntax/select/group-by.md#hopping_window) при получении водяного знака может завершить все "устаревшие окна", в которых каждое событие имеет временную метку менее водяного знака. Это корректно, так как водяной знак - нижняя оценка времени в топике, то есть события с меньшей меткой больше не придут.

В условиях распределенных систем, когда часы на разных устройствах могут дрейфовать, а данные - задерживаться из-за проблем с сетью, водяной знак не может полагаться на монотонное возрастание времени событий даже в рамках одной партиции. Для этого в формулу расчета водяного знака закладывается отставание. Сейчас водяной знак считается как время записи события в топик, уменьшенное на 5 секунд.
