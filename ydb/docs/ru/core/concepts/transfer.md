# Трансфер данных

Трансфер в {{ ydb-short-name }} — асинхронный механизм переноса данных из [топика](topic.md) в таблицу, упрощающий добавление и актуализацию данных в таблице из внешних источников.

Часто на практике удобнее записывать данные не напрямую в таблицу, а в очередь сообщений, чтобы затем в асинхронном режиме переписывать их из топика в таблицу. Такой подход позволяет равномерно распределять нагрузку и справляться со всплесками нагрузки, поскольку операция записи в очередь сообщений — более лёгкая. В зависимости от количества записывамемых сообщений в топик задержка доступности данных на чтение из таблицы может составлять от нескольких секунд до нескольких минут.

Трансфер осуществляет чтение сообщений из указанного топика, их преобразование в формат, пригодный для записи в таблицу, и последующую запись в целевую таблицу. Если в таблице уже есть строка с указанным первичным ключем, то строка будет обновлена. Преобразование данных осуществляется с помощью [lambda-функции](../yql/reference/syntax/expressions.md#lambda), которая принимает сообщение в качестве параметра и возвращает список [структур](../yql/reference/types/containers.md), каждая из которых соответствует записи, подлежащей добавлению или модификации в таблице. Например, если таблица содержит колонку `example_column` типа Int32, структура должна включать именованное поле `example_column` того же типа.
Если [lambda-функция](../yql/reference/syntax/expressions.md#lambda) возвращает пустой список, ни одна строка в таблице не будет изменена. Из lambda-функции не допускается обращение к таблицам и другим объектам {{ ydb-short-name }}.

На работу трансфера тратытся дополнительные ресурсы сервера, в первую очередь CPU. Потребление CPU зависит от сложности преобразования записанных в топик данных.

Трансфер способен читать данные из топиков, расположенных как в базе данных, где он создаётся, так и в других базах {{ ydb-short-name }} или кластерах {{ ydb-short-name }}. Для чтения топика из другой базе данных при создании трансфера необходимо указать опцию `CONNECTION_STRING`. Целевая таблица должна находиться в той же базе данных, где создаётся трансфер.

Чтение из топика осуществляется с использованием консьюмера. Трансфер автоматически добавляет в топик консьюмера с уникальным именем для чтения сообщений. При удалении трансфера автоматически созданный консьюмер удаляется. Также возможно создать консьюмера вручную и указать его имя при создании трансфера. Консьюмер, созданный вручную, не удаляется автоматически при удалении трансфера.

Если требуется передача данных из одного топика в несколько таблиц, для каждой таблицы необходимо создать отдельный трансфер. Аналогично, данные из нескольких топиков могут быть направлены в одну таблицу, для чего каждый топик должен быть ассоциирован с отдельным трансфером. При наличии нескольких трансферов, читающих из одного топика, необходимо назначить каждому трансферу уникального консьюмера, иначе данные будут обработаны только одним из них.

{% note info %}

При обновлении строки в таблице производится полное перезаписывание её значений данными из возвращаемой lambda-функцией структуры. Если структура не содержит именованного поля, соответствующего колонке таблицы, значение этой колонки будет установлено в NULL. Именованные поля, не имеющие соответствия в таблице, игнорируются.

{% endnote %}

{% note info %}

Рекомендуется группировать сообщения, относящиеся к одной строке таблицы, в одну партицию [топика](topic.md), так как порядок сообщений гарантирован только в пределах одной партиции.

{% endnote %}

У сообщения [топика](topic.md) доступны следующие поля:

| Аттрибут          | Тип значения |  Описание                      |
|-------------------|--------------|--------------------------------|
| _data             | String       | тело сообщения                 |
| _message_group_id | String       | идентификатор группы сообщений |
| _offset           | Uint64       | смещение сообщения             |
| _partition        | Uint32       | номер партиции сообщения       |
| _producer_id      | String       | идентификатор источника        |
| _seq_no           | Uint64       | порядковые номера сообщений    |

## Необходимые права для работы трансфера {#permissions}

Для создания и выполнения трансфера пользователь должен обладать правами на запись в целевую таблицу и чтение из исходного топика. В случае, если топик расположен в другой базе данных {{ ydb-short-name }}, дополнительно требуется право на модификацию топика, что позволяет трансферу автоматически создавать консьюмер и удалять его при удалении трансфера.

## Диагностика

Текущие параметры трансфера, включая текст lambda-функции, можно просмотреть в пользовательском интерфейсе Embedded UI и с помощью команды describe в YDB CLI.

Скорость обработки данных и задержки можно контролировать по [метрикам консьюмера](../reference/observability/metrics/index.md#topics), который используется для чтения из топика.

## Обработка ошибок в процессе трансфера {#error-handling}

В процессе трансфера возможно возникновение разных типов ошибок:

* **Временные сбои**. Транспортные ошибки, перегрузка системы и другие временные проблемы. Запросы будут повторяться до успешного выполнения.
* **Критичные ошибки**. Ошибки, связанные с правами доступа, схемой данных и другими критическими аспектами. В случае возникновения таких ошибок трансфер будет остановлен, и в [описании](../reference/ydb-cli/commands/scheme-describe.md) экземпляра трансфера будет указан текст ошибки.

После устранения причины ошибки трансфер может быть возобновлен путем [установки](../yql/reference/syntax/alter-transfer.md#params) статуса `STANDBY`.

## См. также

* [CREATE TRANSFER](../yql/reference/syntax/create-transfer.md)
* [ALTER TRANSFER](../yql/reference/syntax/alter-transfer.md)
* [DROP TRANSFER](../yql/reference/syntax/drop-transfer.md)
