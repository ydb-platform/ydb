# Трансфер данных

Трансфер в {{ ydb-short-name }} — это асинхронный процесс переноса данных из [топика](topic.md) в таблицу, который упрощает процесс добавления и актуализации данных в таблице из внешних источников.

Часто на практике удобнее записывать данные не напрямую в таблицу, а в очередь сообщений, и уже в асинхронном режиме из топика переписывать данные в таблицу. Такой подход позволяет равномерно распределять нагрузку и обеспечить устойчивость к пиковым нагрузкам, поскольку операция записи в очередь сообщений - более легкая операция.

Трансфер осуществляет чтение сообщений из указанного топика, их преобразование в формат, пригодный для записи в таблицу, и последующую запись в целевую таблицу. Преобразование данных осуществляется с помощью [lambda функции](../yql/reference/syntax/expressions.md#lambda), которая принимает сообщение в качестве параметра и возвращает список [структур](../yql/reference/types/containers.md), каждая из которых соответствует записи, подлежащей добавлению или модификации в таблице. Например, если таблица содержит колонку `example_column` типа Int32, структура должна включать именованное поле `example_column` того же типа.  
Если [lambda-функция](../yql/reference/syntax/expressions.md#lambda) возвращает пустой список, ни одна строка в таблице не будет изменена. В lambda-функции допускается выполнение операций с примитивными типами данных, такими как строки, числа и временные метки, при этом запрещено обращение к таблицам и другим объектам {{ ydb-short-name }}.

Трансфер способен читать данные из топиков, расположенных как в базе данных, в которой он создается, так и в других базах {{ ydb-short-name }} или кластерах {{ ydb-short-name }}. Для чтения топика из другой базы данных при создании трансфера необходимо указать опцию `CONNECTION_STRING`. Целевая таблица должна находиться в той же базе данных, где создается трансфер.

Чтение из топика осуществляется с использованием консьюмера. Трансфер автоматически добавит в топик консьюмер с уникальным именем для чтения сообщений. При удалении трансфера созданный автоматически консьюмер будет удален. Так же возможно создать консьюмер вручную и указать его имя при создании трансфера. Консьюмер, созданный вручную, не будет удален автоматически при удалении трансфера.

Если требуется передача данных из одного топика в несколько таблиц, для каждой таблицы необходимо создать отдельный трансфер. Аналогично, данные из нескольких топиков могут быть направлены в одну таблицу, для чего каждый топик должен быть ассоциирован с отдельным трансфером. При наличии нескольких трансферов, читающих из одного топика, необходимо назначить каждому трансферу уникальный консьюмер, иначе данные будут обработаны только одним из них.

{% note info %}

При обновлении строки в таблице производится полное перезаписывание её значений данными из возвращаемой lambda-функцией структуры. Если структура не содержит именованного поля, соответствующего колонке таблицы, значение этой колонки будет установлено в NULL. Именованные поля, не имеющие соответствия в таблице, игнорируются.

{% endnote %}

{% note info %}

Рекомендуется группировать сообщения, относящиеся к одной строке таблицы, в одну партицию [топика](topic.md), так как порядок сообщений гарантирован только в пределах одной партиции.

{% endnote %}

## Необходимые права для работы трансфера {#permissions}

У пользователя, создающего трансфер, должны быть права на запись в таблицу и чтения из топика. Если топик находится в другой базе {{ ydb-short-name }}, то дополнительно требуется право на изменение топика, чтобы трансфер мог автоматически создать консьюмер для чтения из топика и удалить консьюмер при удалении трансфера.

## Диагностика

Текущие параметры трансфера, включая текст lambda-функции, можно просмотреть в пользовательском интерфейсе Embedded UI и с помощью команды describe в YDB CLI.

Скорость обработки данных и лаг можно контролировать по [метрикам консьюмера](../reference/observability/metrics/index.md#topics), который используется для чтения из топика.

## Обработка ошибок в процессе трансфера {#error-handling}

В процессе трансфера возможно возникновение разных типов ошибок:

* **Временные сбои**. Транспортные ошибки, перегрузка системы и другие временные проблемы. Запросы будут повторяться до успешного выполнения.
* **Критичные ошибки**. Ошибки, связанные с правами доступа, схемой данных и другими критическими аспектами. В случае возникновения таких ошибок трансфер будет остановлен, и в [описании](../reference/ydb-cli/commands/scheme-describe.md) экземпляра трансфера будет указан текст ошибки.

После устранения причины ошибки трансфер может быть возобновлен путем [установки](../yql/reference/syntax/alter-transfer.md#params) статуса `STANDBY`.

## Пример {#example}

```
CREATE TABLE example_table (
    partition Uint32 NOT NULL,
    offset Uint64 NOT NULL,
    message Utf8,
    PRIMARY KEY (partition, offset)
);

CREATE TOPIC example_topic;

$transformation_lambda = ($msg) -> {
    return [
        <|
            partition:CAST($msg._partition AS Uint32),
            offset:CAST($msg._offset AS Uint32),
            message:CAST($msg._data AS Utf8)
        |>
    ];
};

CREATE TRANSFER example_transfer
    FROM example_topic TO example_table USING $transformation_lambda
WITH (
    CONNECTION_STRING = 'grpcs://example.com:2135/?database=/Root/another_database',
    TOKEN_SECRET_NAME = 'my_secret'
);
```

У сообщения [топика](topic.md) доступны следующие поля:
* `_data` - тело сообщения
* `_message_group_id` - идентификатор группы сообщений
* `_offset` - смещение сообщения
* `_partition`- номер партиции сообщения
* `_producer_id` - идентификатор источника
* `_seq_no`- порядковые номера сообщений


Пример обработки сообщения в формате JSON

```
// example message:
// {
//   "update": {
//     "operation":"value_1"
//   },
//   "key": [
//     "id_1",
//     "2019-01-01T15:30:00.000000Z"
//   ]
// }

$transformation_lambda = ($msg) -> {
    $json = CAST($msg._data AS JSON);
    return [
        <|
            timestamp: DateTime::MakeDatetime(DateTime::ParseIso8601(CAST(Yson::ConvertToString($json.key[1]) AS Utf8))),
            object_id: CAST(Yson::ConvertToString($json.key[0]) AS Utf8),
            operation: CAST(Yson::ConvertToString($json.update.operation) AS Utf8)
        |>
    ];
};
```

## См. также

* [CREATE TRANSFER](../yql/reference/syntax/create-transfer.md)
* [ALTER TRANSFER](../yql/reference/syntax/alter-transfer.md)
* [DROP TRANSFER](../yql/reference/syntax/drop-transfer.md)
