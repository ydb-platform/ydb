# Управление группами хранения в Hive

В данной статье описывается процесс выдачи [таблеткам](../concepts/glossary.md#tablet) [групп хранения](../concepts/glossary.md#storage-group) со стороны [Hive](../concepts/glossary.md#hive). При создании таблетки Hive назначает ей группы и в дальнейшем может их изменить:

* Если в группе заканчивается место, таблетки получают об этом сигнал от [прокси](../concepts/glossary.md#ds-proxy) и передают в Hive запрос выдать им другую группу.
* При [ручном перераспределении групп](../reference/embedded-ui/hive.md#reassign-groups).
* При автоматическом перераспределении групп (отключёно по умолчанию в [конфигурации Hive](../reference/configuration/hive.md#storage)).

## Выбор группы {#pick-group}

Для каждого из [каналов](../concepts/glossary.md#channel) таблетки группа выбирается независимо. Разные каналы одной и той же таблетки могут писать в одну и ту же группу. Группы могут быть выбраны только из закреплённого за каналом [пула хранения](../concepts/glossary.md#storage-pool). Пулы хранения не пересекаются между разными базами данных на одном кластере, при этом у одной базы может быть больше одного пула.

Выбор группы внутри пула делается на основе метрик потребления, принцип работы которых описан в [следующем разделе](#allocation-units). С их помощью для каждой группы-кандидата $i$ определяется значение потребления $0 < \mathrm{usage}_i < 1$. Затем группа выбирается при помощи взвешенной случайности с весами $w_i = \max_j (\mathrm{usage}_j) - \mathrm{usage}_i$.

Чтобы избежать постоянного перемещениями между группами с недостатком свободного места, веса дополнительно модифицируются, пессимизируя такие группы. Если таблетка перевозится с группы $j$, в которой кончается место, то для группы $i$ модифицированный вес вычисляется по формуле:

$$
\hat{w_i} =
\begin{cases}
  0, & \mathrm{free}_i < \mathrm{free}_j \\
  \alpha \cdot w_i, & \mathrm{free}_j \le \mathrm{free_i} < \beta \cdot \mathrm{free}_j \\
  w_i, & \mathrm{free}_i \ge \beta \cdot \mathrm{free}_j
\end{cases}
$$

где:

* $free_g$ — реальное свободное место в группе $g$;
* $\alpha, \beta$ — константы. По умолчанию $\alpha = 0.2, \beta = 1.1$. Значения можно настроить в [конфигурации Hive](../reference/configuration/hive.md#storage) как `space_usage_penalty` и `space_usage_penalty_threshold` соответственно.

## Единицы аллокации {#allocation-units}

Как и для [выбора узла](hive-booting.md#findbestnode) для запуска таблеток, для выбора групп в Hive предусмотрен учёт различных ресурсов. Однако, смена группы — более редкая операция, поэтому мгновенные значения потребления для неё бы не подошли. Необходимо ещё на этапе создания таблеток предсказать их потребление в долгосрочной перспективе. Для этого используются фиксированные значения: [SchemeShard](../concepts/glossary.md#scheme-shard) выставляет для каждого из каналов [единицу аллокации](../concepts/glossary.md#allocation-unit) — ожидаемое потребление ресурсов этим каналом, и Hive в дальнейшем использует эти значения. Единицами аллокации для различных таблеток можно управлять при помощи секции `channel_profile_config` в конфигурации кластера. Используются метрики:

* IOPS;
* скорость записи данных;
* потребление дискового пространства.

В конфигурации Hive можно настроить учёт какой-либо одной из них или сразу всех.


## Процесс переназначения групп {#reassign}

Для безопасной смены группы Hive:

* Осуществляет блокировку записи в текущем [поколении](../concepts/glossary.md#tablet-generation) в системном канале таблетки.
* Запускает новое поколение таблетки с новой записью в [истории](general-schema.md#history).
