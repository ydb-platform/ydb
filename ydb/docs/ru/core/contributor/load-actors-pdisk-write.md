# PDiskWriteLoad

Тестирует производительность записи на PDisk. Нагрузка подается от имени VDisk. Актор создает на указанном PDisk чанки и записывает в них случайные данные. После снятия нагрузки записанные актором данные удаляются.

Вы можете подать нагрузку двух видов:

* _Постоянная_ — актор следит, чтобы одновременно было запущено указанное число запросов. Чтобы подать постоянную нагрузку, задайте нулевую паузу между запросами (например, `IntervalMsMin: 0`, `IntervalMsMax: 0`) и отличный от нуля `InFlightWrites`.
* _Интервальная_ — актор запускает запросы через заданные промежутки времени. Чтобы подать интервальную нагрузку, задайте ненулевую паузу между запросами (например, `IntervalMsMin: 10`, `IntervalMsMax: 100`). Максимальное количество одновременно выполняемых запросов задается параметром `InFlightWrites`. Если его значение равно `0`, то ограничения нет.

## Параметры актора {#options}

{% include [load-actors-params](../_includes/load-actors-params.md) %}

Параметр | Описание
--- | ---
`PDiskId` | Идентификатор нагружаемого PDisk на узле.
`PDiskGuid` | Глобально-уникальный идентификатор нагружаемого PDisk.
`VDiskId` | Нагрузка подается от имени VDisk со следующими реквизитами:<ul><li>`GroupID` — идентификатор группы.</li><li>`GroupGeneration` — поколение группы.</li><li>`Ring` — идентификатор кольца в группе.</li><li>`Domain` — идентификатор фэйл-домена в кольце.</li><li>`VDisk` — индекс VDisk в фэйл-домене.</li></ul>
`Chunks` | Параметры чанка.<br>`Slots` — количество слотов в чанке, определяет размер записи.<br>Вы можете указать несколько `Chunks`, и тогда выбор конкретного чанка для записи будет определяться его `Weight`.
`DurationSeconds` | Продолжительность нагрузки в секундах.
`IntervalMsMin`,<br>`IntervalMsMax` | Минимальный и максимальный промежутки времени между запросами при интервальной нагрузке в миллисекундах. Значение промежутка выбирается случайно из указанного диапазона.
`InFlightWrites` | Количество одновременно обрабатываемых запросов на запись.
`LogMode` | Режим записи лога. В режиме `LOG_SEQUENTIAL` сначала происходит запись в чанк, а после ее подтверждения запись — в лог.
`Sequential` | Тип записи.<ul><li>`True` — последовательная.</li><li>`False` — случайная.</li></ul>
`IsWardenlessTest` | Если PDiskReadLoad запускается на кластере, укажите `False`. Иначе (например, при запуске в юнит-тестах) укажите `True`.

<!-- 
Параметр | Описание
--- | ---
`LogMode` |  {
    LOG_PARALLEL = 1; // Писать в чанк и писать в лог (о факте записи) параллельно, и считать запись завершенной только если обе записи прошли
    LOG_SEQUENTIAL = 2; // Писать сначала в чанк, потом в лог. Считать запись завершенной после записи в лог
    LOG_NONE = 3;
}

message TPDiskWriteLoad {
    message TChunkInfo {
        optional uint32 Slots = 1; // количество слотов в чанке. Фактически определяет размер записей/чтений,
                                   // которой можно расчитать, разделив размер чанка на количество слотов
        optional uint32 Weight = 2; // вес, с которым запись будет осуществляться именно в этот чанк
    }
    optional uint64 Tag = 1; // необязательный. Если не задан, то тег будет присвоен автоматически
    optional uint32 PDiskId = 2; // обязательный. Id, на который нужно подать нагрузку. Можно узнать из UI кластера
    optional uint64 PDiskGuid = 3; // обязательный. Guid того PDisk, на который подается нагрузка. Можно узнать на UI странице PDisk
    optional NKikimrBlobStorage.TVDiskID VDiskId = 4; // обязательный. Этим VDiskId нагружающий актор представится PDisk.
                                                    // Не должен дублироваться между разными нагружающими акторами.
    repeated TChunkInfo Chunks = 5; // обязательный. Описание того, сколько чанков использовать для подачи нагрузки. Позволяет варьировать нагрузку.
                                    // К примеру, можно сделать два чанка - один с большим количеством слотов и один с маленьким и задать веса чанков
                                    // таким образом, чтобы 95% записей были небольшого размера, а 5% -- большого, имитируя тем самым compaction VDisk
    optional uint32 DurationSeconds = 6; // обязательный. Длительность теста
    optional uint32 InFlightWrites = 7; // обязательный. Ограничивает количество запросов в полете к PDisk
    optional ELogMode LogMode = 8; // обязательный. См. выше ELogMode
    optional bool Sequential = 9 [default = true]; // необязательный. Писать в слоты чанков записи последовательно или случайно.
    optional uint32 IntervalMsMin = 10; // необязательный. См. ниже
    optional uint32 IntervalMsMax = 11; // необязательный. Позволяет подавать жесткую нагрузку, которая будет отправлять запросы строго регулярно.
                                        // Время между запросами случайно выбирается между [IntervalMsMin, IntervalMsMax].
                                        // Учитывает InFlightWrites и не превышает его. Если не заданы IntervalMsMin и IntervalMsMax, то учитывается
                                        // только InFlightWrites
    optional bool Reuse = 12 [default = false]; // должен ли актор переиспользовать полностью записанные чанки или должен выделять
                                                // новые чанки и освобождать старые чанки
    optional bool IsWardenlessTest = 13 [default = false]; // позволяет использовать в тестах, где нет NodeWarden
}
```
 -->

## Примеры {#example}

Следующий актор пишет данные блоками по `32` МБ, в течение `120` секунд, одновременно выполняются `64` запроса (постоянная нагрузка):

```proto
PDiskWriteLoad: {
    PDiskId: 1000
    PDiskGuid: 2258451612736857634
    VDiskId: {
        GroupID: 11234
        GroupGeneration: 5
        Ring: 1
        Domain: 1
        VDisk: 3
    }
    Chunks: { Slots: 4096 Weight: 1 }
    Chunks: { Slots: 4096 Weight: 1 }
    Chunks: { Slots: 4096 Weight: 1 }
    Chunks: { Slots: 4096 Weight: 1 }
    Chunks: { Slots: 4096 Weight: 1 }
    Chunks: { Slots: 4096 Weight: 1 }
    Chunks: { Slots: 4096 Weight: 1 }
    Chunks: { Slots: 4096 Weight: 1 }
    DurationSeconds: 120
    IntervalMsMin: 0
    IntervalMsMax: 0
    InFlightWrites: 64
    LogMode: LOG_SEQUENTIAL
    Sequential: false
    IsWardenlessTest: false
}
```

При просмотре результата тестирования наибольший интерес представляют следующее значение:

* `Average speed since start` — средняя скорость записи с момента запуска в МБ/с, например `615.484013`.
