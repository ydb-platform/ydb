# Автоматический выбор вторичных индексоем primary key

{% note warning "Предупреждение" %}

Данный механизм является экспериментальным и по умолчанию пока выключен. Включение данного механизма производится с помощью [настройки index_auto_choose_mode в table_service_config](https://github.com/ydb-platform/ydb/blob/main/ydb/core/protos/table_service_config.proto#L268)

{% endnote %}

YDB на данный момент не умеет оценивать оптимальность плана выполнения ввиду отсутствия статистик данных, и автоматический выбор делается исключительно исходя из текста запроса. Оптимальность для конкретного распределения данных или схем индексов не гарантируется, и для случаев, в которых оптимизатор может ошибаться используется следующий синтаксис для явного указания используемого индекса:
```
SELECT * FROM `Table` VIEW Index
```
Для явного указания чтения с использованием primary key:
```
SELECT * FROM `Table` VIEW PRIMARY KEY
```

## Критерии выбора вторичного индекса
Выбор индекса используемого для чтения происходит во время оптимизации запроса при определении диапазона(ов) строк, которые необходимо прочитать (predicate pushdown). Индексы, как и основная таблица представляют из себя набор строк упорядоченных по набору ключевых колонок.

Выбор между чтениями с использованием индекса и c использованием primary key происходит на основе следующих метрик:
1. Необходимость дополнительного чтения из основной таблицы -- в индексе могут присутствовать все нужные для запроса колонки. В этом случае дополнительные чтения необязательны.
2. Длина точечного префикса предиката для ключа соответствующей таблицы. То есть, предикат ограничивает некоторый набор колонок являющихся первыми компонентами ключа точечными условиями: =, in, is null. Здесь приоритет отдается индексам, для которых зафиксированы все индексируемые колонки или основной таблице если точечным является первичный ключ целиком.
3. Количество использованных колонок в границах диапазона для чтения. К примеру, в запросе к таблице Table с первичным ключом (Key1, Key2, Key3)
```
SELECT * FROM `Table` WHERE (Key1, Key2, Key3) < ($param1, $param2, $param3) AND (Key1, Key2) > ($param4, $param5)
```
оптимизатор определит что чтение может производиться в диапазоне
`(($param4, $param5), ($param1, $param2, $param3))` -- здесь количество использованных колонок 3. Аналогично 2 здесь отдается предпочтение индексам для которых использованы все индексируемые колонки.

Способы чтения ранжируются между собой в соответствии с критерием 2, при равенстве с критерием 3 и дополнительно учитывается критерий 1.

## Примеры

```
CREATE TABLE `/Root/Table` (
     Key Int32,
     SubKey1 Int32,
     SubKey2 String,
     Value1 String,
     Value2 String,
     PRIMARY KEY (Key, SubKey1, SubKey2),
     INDEX Index12 GLOBAL ON (SubKey1, SubKey2),
     INDEX Index21 GLOBAL ON (SubKey2, Value1),
     INDEX Index212 GLOBAL ON (SubKey2) COVER (Value2)
);

```

`SELECT * FROM Table WHERE SubKey1 = $p1 and SubKey2 > $p2` длина точечного префикса для Index12 -- 1, использованы 2 колонки. Автовыбираем Index12. Выражение для диапазона `(($p1; $p2), ($p1)]`. 

`SELECT * FROM Table WHERE Key = $p1 and SubKey1 = $p2 And SubKey2 = $p2` - При выборе скана основной таблицы используется все 3 колонки `[Key, Fk1, Fk2], длина точечного префикса 3. Индекс должен не использоваться

`SELECT * FROM Table WHERE Key = $p1 and SubKey2 = $p2` - при выборе любого индекса используется 1 колонка, точечный префикс также не более 1 при любом варианте выбора индекса. Индекс должен не использоваться

`SELECT * FROM Table WHERE Key >= $p1 and SubKey1 = $p2 And SubKey2 = $p3` - при выборе индекса должен быть выбран Index12, так как при его выборе в получающемся диапазоне [[Fk1; Fk2; Key], [Fk1; Fk2]) проекция на первые две колонки является точечной. Длина точечного префикса -- 2, использовано 3 колонки.

`SELECT * FROM Table WHERE Key = 2 and SubKey2 = 3` - в случае чтения по PK и при использовании Index212 точечный префикс состоит из одной колонки. В диапазоне участвует одна колонка. Выбираем чтение по PK

`SELECT * FROM Table WHERE SubKey1 > 2` - Только при использовании Index12 будет нетривиальный диапазон для чтения. Должен быть выбран Index12

`SELECT * FROM Table WHERE SubKey2 = 2` - при использовании Index21 и Index212 длина точечного префикса будет 1. Может быть выбран любой из них.

`SELECT Value2 FROM Table WHERE SubKey2 = 2` - при использовании Index21 и Index212 длина точечного префикса будет 1, но при использовании Index212 не нужно чтение основной таблицы. Должен быть выбран Index212.

`SELECT * FROM Table WHERE SubKey2 > 2` - Диапазон нетривиален только при использовании Index21 и Index212, однако для чтения нужен join с основной таблицей.

`SELECT * FROM Table WHERE SubKey1 = 2` - при использовании Index12  длина точечного префикса будет 1, в остальных случаях 0.
