# Как получить графическое представление плана

## UI {#ui}

Если вы работает непосредственно в {{ ydb-short-name }} UI то вы можете получить графическое представление плана, включив настройку ```Experiments | Execution plan```

![Включение графического представления в UI](../../_assets/rts-ui-settings.png)

Если после этого выполнить какой-нибудь запрос, например

```sql
SELECT count(*) FROM lineitem
```

То в дополнительном меню в правой части экрана, которое открывается по кнопке [...] появляются новые пункты меню

- ```Open Execution Plan``` открывает план выполнения в новой вкладке браузера
- ```Download Execution Plan``` сохраняет план в виде файла на диск

Два разных пункта меню требуются по причине того, что некоторые браузеры блокируют сохранение на диск плана из отдельной вкладке браузера. В разных ситуация бывает удобно иметь возможность выполнить оба действия - быстро посмотреть на план или сохранить его для дальнейшего использования. В этом же меню находится ещё один полезный пункт

- ```Download Diagnostics``` о котором речь пойдёт ниже

![Просмотр и сохранение плана](../../_assets/rts-get-execution-plan.png)

Если же открыть план выполнения этого запроса, то вы получите примерно следующее изображение (конкретные значения отдельных метрик могут меняться в зависимости от мощности и настроек вашего кластера):

![План выполнения запроса](../../_assets/rts-count-lineitem.svg){inline=false}

Поздравляем, вы получили ваш первый план выполнения запроса! Это станет вашим надёжным инструментом быстрого понимания того, как выполняется ваш запрос и поможет быстро диагностировать возможные проблемы. Если вам нетерпится приступить к исследованию полученного плана, то вы можете перейти в раздел , а мы тем временем обсудим, как получить план, если графический интерфейс недоступен и в вашем распоряжении есть только командная строка.

## ydb cli {#cli}

Если вы используете утилиту командной строки, то вам доступны следующие варианты

1. Для стандартных тестов, например TPC-H, можно использовать команду workload с опцией ```--plan``` - ```ydb workload tpch run --plan filename```, в результате чего на локальном диске будут созданы файлы с названием ```filename``` в различных форматах, расширение ```.svg``` соответствует графическому формату
2. Для своих собственных запросов можно использовать формат ```ydb workload query run --plan filename```

В одной из следующих версий ожидается добавление аналогичной функциональности в команду ```ydb sql```. На данный момент вы можете

3. Cохранить статистику выполнения в режиме EXPLAIN ANALYZE

```bash
ydb sql --explain-analyze --format json-unicode > filename.json
```

4. Собрать расширенную диагностику выполнения запроса

```bash
ydb sql --stats full --diagnostics-file filename.json
```

и использовать эти файлы для преобразование в графический формат как описано следующем разделе

## ydb_int {#ydb_int}

Если у вас есть статистика выполнения вашего запроса в формате json, то мы можете использовать её для преобразования в графический формат. Это может быть

- план + статистика, которые выдаёт EXPLAIN ANALYZE
- план + статистика, который вы сохранили программно из вашего SDK
- расширенная диагностика которую сохраняет ydb cli
- аналогичная расширенная диагностика, которую можно сохранить из UI (показанный выше пункт меню ```Download Diagnostics```)

Преобразование выполняется внутренней утилитой ydb_int

```bash
ydb_int exp json2svg -i filename.json -o filename.svg
```

Такой способ удобен, если мы помогаете исследовать проблему клиенту и не при этом не имеета доступа к его кластеру. Следует попросить его собрать расширенную диагностику (через cli или UI) и прислать для изучения.

Аналогичная функциональность скоро появится и в публичном ydb cli

## kqprun {#kqprun}

Если вы используете для разработки утилиту kqprun (это примерно как весь кластер ydb в одном процессе с крайне простым способом запуска), то она тоже поддерживает опцию выдачи и статистики в формате json, и сразу же генерацию графического представления плана.

Тут будет ссылка на доку по kqprun