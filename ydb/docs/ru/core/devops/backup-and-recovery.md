# Резервное копирование и восстановление

Резервное копирование применяется для защиты от потери данных, позволяя восстановить их из резервной копии.

{{ ydb-short-name }} предоставляет несколько решений для выполнения резервного копирования и восстановления. Концептуальную информацию и сравнение методов резервного копирования см. в [Концепциях резервного копирования](../concepts/backup.md).

{% include [_includes/backup_and_recovery/options_overlay.md](_includes/backup_and_recovery/options_overlay.md) %}

## {{ ydb-short-name }} CLI {#cli}

### Файлы {#files}

Для выполнения резервного копирования в файлы применяются команды:

- `{{ ydb-cli }} admin cluster dump` — для резервного копирования метаданных кластера
- `{{ ydb-cli }} admin database dump` — для резервного копирования базы данных
- `{{ ydb-cli }} tools dump` — для резервного копирования отдельных схемных объектов или директорий

Узнать больше об этих командах можно в [{#T}](../reference/ydb-cli/export-import/tools-dump.md).

Для выполнения восстановления из файловой резервной копии применяются команды:

- `{{ ydb-cli }} admin cluster restore` — для восстановления метаданных кластера из резервной копии
- `{{ ydb-cli }} admin database restore` — для восстановления базы данных из резервной копии
- `{{ ydb-cli }} tools restore` — для восстановления отдельных схемных объектов или директорий из резервной копии

Узнать больше об этих командах можно в [{#T}](../reference/ydb-cli/export-import/tools-restore.md).

### S3-совместимое хранилище {#s3}

Для выполнения резервного копирования в S3-совместимое хранилище (например, [AWS S3](https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html))  применяется команда `{{ ydb-cli }} export s3`. Перейдите [по ссылке](../reference/ydb-cli/export-import/export-s3.md) в справочник по {{ ydb-short-name }} CLI для получения информации о данной команде.

Для выполнения восстановления из резервной копии, созданной в S3-совместимом хранилище, применяется команда `{{ ydb-cli }} import s3`. Перейдите [по ссылке](../reference/ydb-cli/export-import/import-s3.md) в справочник по {{ ydb-short-name }} CLI для получения информации о данной команде.

{% note info %}

Скорость операций резервного копирования и восстановления в/из S3-совместимого хранилища подобрана таким образом, чтобы минимизировать влияние на пользовательскую нагрузку. Для управления скоростью операций настройте лимиты для соответствующей очереди [брокера ресурсов](../reference/configuration/resource_broker_config.md#resource-broker-config).

{% endnote %}

{% note info %}

При выполнении выгрузки в корневом каталоге базы данных создается директория с именем `export_*`, где `*` — это числовая часть идентификатора выгрузки. В данной директории размещаются таблицы, содержащие консистентный снапшот выгружаемых данных на момент начала выгрузки. После успешного завершения операции резервного копирования директория `export_*` вместе с содержимым удаляется.

{% endnote %}

## Коллекции резервных копий {#backup-collections}

Коллекции резервных копий обеспечивают инкрементальное резервное копирование и восстановление на момент времени для производственных нагрузок. Концептуальную информацию и детали архитектуры см. в [Коллекциях резервных копий](../concepts/datamodel/backup-collection.md).

### Когда использовать коллекции резервных копий

Коллекции резервных копий рекомендуются для:

- **Производственных сред**, требующих регулярного расписания резервного копирования
- **Больших наборов данных**, где инкрементальные изменения значительно меньше общего объёма данных
- **Требований восстановления на момент времени**

Для более простых сценариев (разовые миграции, среды разработки, небольшие базы данных) рассмотрите использование [export/import](#s3) или [dump/restore](#files).

### Настройка производственного резервного копирования

Типичная настройка производственного резервного копирования включает:

1. **Планирование стратегии резервного копирования**: Определите частоту резервного копирования (ежедневное полное, ежечасное инкрементальное), период хранения и требования к внешнему хранилищу.

2. **Создание коллекции резервных копий**: Определите, какие таблицы включить, используя SQL-оператор [`CREATE BACKUP COLLECTION`](../yql/reference/syntax/create-backup-collection.md).

3. **Настройка внешнего планирования**: {{ ydb-short-name }} не предоставляет встроенного планирования. Используйте cron или аналогичные инструменты для выполнения команд резервного копирования.

4. **Настройка экспорта во внешнее хранилище**: Для аварийного восстановления регулярно экспортируйте коллекции резервных копий в S3 или файловую систему.

5. **Мониторинг и обслуживание**: Отслеживайте операции резервного копирования, проверяйте целостность цепочек и управляйте хранением.

### Создание коллекций резервных копий

Создайте коллекцию с помощью SQL:

```sql
CREATE BACKUP COLLECTION `production_backups`
    ( TABLE `/Root/mydb/orders`, TABLE `/Root/mydb/customers` )
WITH ( STORAGE = 'cluster', INCREMENTAL_BACKUP_ENABLED = 'true' );
```

### Создание резервных копий

**Полная резервная копия** (требуется первой, затем периодически):

```sql
BACKUP `production_backups`;
```

Используйте команду [`BACKUP`](../yql/reference/syntax/backup.md) для запуска операций резервного копирования.

**Инкрементальная резервная копия** (после начальной полной резервной копии):

```sql
BACKUP `production_backups` INCREMENTAL;
```

{% note warning %}

**Не идемпотентно**: Каждая команда `BACKUP` создаёт новую резервную копию. Если вы повторите команду после тайм-аута, исходная резервная копия могла завершиться успешно, и повтор создаст дополнительную резервную копию. Перед повтором проверьте, был ли создан новый каталог резервной копии: `ydb scheme ls .backups/collections/<имя_коллекции>/`. Для инкрементальных резервных копий также можно проверить статус операции с помощью `ydb operation list incbackup`.

{% endnote %}

**Пример расписания** (реализуется через внешний планировщик):

- Воскресенье 2:00: Полная резервная копия
- Понедельник-Суббота 2:00: Инкрементальная резервная копия

{% note info %}

**Несколько коллекций**: Вы можете запускать резервное копирование разных коллекций одновременно. Операции резервного копирования выполняются асинхронно и не блокируют друг друга или обычные операции с базой данных. Однако для кластеров с ограниченными ресурсами или очень больших резервных копий рекомендуется распределять операции резервного копирования по времени для снижения пиковой нагрузки на ресурсы.

{% endnote %}

### Мониторинг операций

Операции резервного копирования выполняются асинхронно. Отслеживайте прогресс с помощью:

```bash
# Список операций резервного копирования
ydb operation list incbackup

# Проверка статуса конкретной операции
ydb operation get <operation-id>
```

Просмотр структуры резервных копий:

```bash
# Список всех коллекций
ydb scheme ls .backups/collections/

# Просмотр резервных копий в коллекции
ydb scheme ls .backups/collections/production_backups/
```

{% note warning %}

Отмена операций резервного копирования пока не поддерживается. Команда `ydb operation cancel` вернёт ошибку для операций резервного копирования.

{% endnote %}

### Восстановление из резервных копий

Для восстановления данных используйте команду [`RESTORE`](../yql/reference/syntax/restore-backup-collection.md):

```sql
RESTORE `production_backups`;
```

#### Аварийное восстановление из внешнего хранилища {#disaster-recovery}

Если вы экспортировали резервные копии во внешнее хранилище, сначала импортируйте их:

```bash
# Импорт из файловой системы
ydb tools restore -i /path/to/backup -p .backups/collections/production_backups

# Или импорт из S3
ydb import s3 --s3-endpoint storage.example.com \
  --bucket my-backups \
  --item src=production_backups,dst=.backups/collections/production_backups
```

Затем выполните команду RESTORE.

### Хранение и очистка

{% note warning %}

Перед удалением резервных копий изучите зависимости цепочки:

- **Полные резервные копии** необходимы для всех последующих инкрементальных
- **Инкрементальные резервные копии** зависят от полной резервной копии и всех предыдущих инкрементальных
- Удаление любой резервной копии в цепочке делает последующие инкрементальные резервные копии невосстановимыми

YDB не предоставляет встроенной проверки целостности цепочки. Вручную отслеживайте, какие резервные копии принадлежат какой цепочке.

{% endnote %}

#### Безопасный подход к очистке {#safe-cleanup}

1. Создайте новую полную резервную копию
2. Убедитесь, что новая резервная копия завершена
3. Экспортируйте старые цепочки резервных копий во внешнее хранилище при необходимости
4. Удалите старые цепочки резервных копий (полная резервная копия + все её инкрементальные вместе)

```bash
# Удаление старой цепочки резервных копий
ydb scheme rmdir -r .backups/collections/production_backups/20250208141425Z_full/
ydb scheme rmdir -r .backups/collections/production_backups/20250209141519Z_incremental/
```

### Экспорт во внешнее хранилище

Для аварийного восстановления экспортируйте коллекции резервных копий во внешнее хранилище:

#### В S3-совместимое хранилище {#export-s3}

```bash
ydb export s3 --s3-endpoint storage.example.com \
  --bucket my-backups \
  --item src=.backups/collections/production_backups,dst=production_backups
```

#### В файловую систему {#export-filesystem}

```bash
ydb tools dump -p .backups/collections/production_backups \
  -o /path/to/backup/production_backups
```

### Лучшие практики

Подробные рекомендации по лучшим практикам работы с коллекциями резервных копий см. в [Рецептах для коллекций резервных копий](../recipes/backup-collections/index.md):

- [Экспорт во внешнее хранилище](../recipes/backup-collections/exporting-to-external-storage.md) — аварийное восстановление с S3 или файловой системой
- [Обслуживание и очистка](../recipes/backup-collections/maintenance-and-cleanup.md) — управление хранилищем и цепочками резервных копий
- [Проверка и тестирование](../recipes/backup-collections/validation-and-testing.md) — проверка целостности резервных копий

{% include [_includes/backup_and_recovery/cli_overlay.md](_includes/backup_and_recovery/cli_overlay.md) %}

{% include [_includes/backup_and_recovery/others_overlay.md](_includes/backup_and_recovery/others_overlay.md) %}
