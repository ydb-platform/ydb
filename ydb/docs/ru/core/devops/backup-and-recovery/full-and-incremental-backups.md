# Полное и инкрементальное резервное копирование

{% include [feature_enterprise.md](../../_includes/feature_enterprise.md) %}

{% note warning %}

Этот функционал находится в активной разработке. Пожалуйста, учитывайте существующие [ограничения](../../concepts/datamodel/backup-collection.md#limitations) и обращайтесь к документации за самой актуальной информацией.

{% endnote %}

Типичная настройка резервного копирования в рабочей среде включает следующие шаги:

1. **Планирование стратегии**: Определение периодичности (ежедневное полное, ежечасное инкрементальное), срока хранения и требований к внешнему хранилищу.

2. **Создание коллекции резервных копий**: Определение списка таблиц с помощью SQL-инструкции [`CREATE BACKUP COLLECTION`](../../yql/reference/syntax/create-backup-collection.md).

3. **Настройка расписания**: В {{ ydb-short-name }} нет встроенного планировщика. Используйте cron или аналогичные инструменты для запуска команд резервного копирования.

4. **Настройка экспорта во внешнее хранилище**: Для обеспечения отказоустойчивости регулярно экспортируйте коллекции резервных копий в S3 или файловую систему.

5. **Мониторинг и обслуживание**: Отслеживание операций резервного копирования, проверка целостности цепочек и управление сроками хранения.

## Создание коллекций резервных копий

Создайте коллекцию с помощью YQL:

```sql
CREATE BACKUP COLLECTION `production_backups`
    ( TABLE `/Root/mydb/orders`, TABLE `/Root/mydb/customers` )
WITH ( STORAGE = 'cluster', INCREMENTAL_BACKUP_ENABLED = 'true' );
```

## Полные резервные копии

Полная резервная копия создает законченный снимок всех данных в коллекции на определенный момент времени. Полные копии являются самодостаточными и могут быть восстановлены независимо, без использования предыдущих копий.

### Когда использовать полные копии

- **Первая копия**: Перед использованием инкрементального копирования необходимо создать полную резервную копию. Первая копия в любой коллекции всегда является полной.
- **Периодические полные копии**: Даже при использовании инкрементального копирования планируйте периодическое создание полных копий (например, еженедельно или ежемесячно), чтобы сократить цепочки зависимостей и упростить восстановление.
- **Небольшие наборы данных**: Для маленьких баз данных, где затраты на управление цепочками инкрементальных копий превышают выгоду от них.

### Создание полной резервной копии

1. Убедитесь, что вы создали коллекцию резервных копий (см. раздел [Создание коллекций резервных копий](#creating-backup-collections)).

2. Выполните команду резервного копирования:

```sql
BACKUP `production_backups`;
```

Эта команда создает полную резервную копию всех таблиц в указанной коллекции. Вы можете отслеживать прогресс создания полной копии, наблюдая за выполнением соответствующей SQL-операции. После завершения SQL-операции резервное копирование считается законченным.

### Восстановление из резервной копии

Для восстановления данных из коллекции используйте команду [`RESTORE`](../../yql/reference/syntax/restore-backup-collection.md) в YQL. Восстановление можно выполнить из любой полной копии или из цепочки инкрементальных копий (полная + инкрементальные).

#### Восстановление последней копии

```sql
RESTORE `production_backups`;
```

По умолчанию эта команда восстанавливает самую свежую копию в коллекции. Операция восстановления возвращает данные ровно в те же места (пути и имена таблиц), где они находились при создании резервной копии. Для успешного восстановления по целевым путям не должно существовать таблиц.

## Инкрементальные резервные копии

Если ваши таблицы слишком велики для ежедневного полного копирования, вы можете делать полные копии реже (например, раз в неделю), а в промежутках создавать ежедневные инкрементальные копии. Инкрементальные копии экономят место и создаются быстрее полных для больших таблиц.

Инкрементальная копия сохраняет только те изменения (вставки, обновления, удаления), которые произошли с момента создания последней резервной копии в коллекции. Такие копии меньше и создаются быстрее полных, но они зависят от предыдущих копий в цепочке и не могут быть восстановлены самостоятельно.

### Когда использовать инкрементальные копии

- **Регулярное копирование**: Используйте инкрементальные копии для частого резервного копирования (например, каждый час или день), чтобы минимизировать использование хранилища и время работы, сохраняя при этом актуальные точки восстановления.
- **Большие наборы данных**: Для огромных баз данных, где создание полных копий требует много времени или ресурсов, инкрементальное копирование обеспечивает более эффективную стратегию.
- **Рабочие среды**: В системах с постоянными изменениями данных инкрементальное копирование позволяет поддерживать множество точек восстановления без накладных расходов, характерных для полных копий.

{% note info "Предварительные условия" %}

Перед созданием инкрементальных копий в коллекции должна быть хотя бы одна полная копия. Первая резервная копия в любой коллекции всегда полная.

{% endnote %}

### Создание инкрементальной резервной копии

1. Убедитесь, что вы создали коллекцию с включенной поддержкой инкрементального копирования (см. раздел [Создание коллекций резервных копий](#creating-backup-collections)).

2. Убедитесь, что в коллекции есть хотя бы одна полная копия. Если это ваша первая копия, сначала создайте полную (см. раздел [Создание полной резервной копии](#creating-a-full-backup)).

3. Выполните команду инкрементального резервного копирования:

```sql
BACKUP `production_backups` INCREMENTAL;
```

Эта команда создает инкрементальную копию, содержащую только изменения с момента последнего резервного копирования в коллекции. Операция выполняется асинхронно и не блокирует обычную работу с базой данных.

### Восстановление из резервной копии

Для восстановления данных из коллекции используйте команду [`RESTORE`](../../yql/reference/syntax/restore-backup-collection.md) в YQL. Восстановление можно выполнить из любой полной копии или из цепочки инкрементальных копий (полная + инкрементальные).

#### Восстановление последней копии

```sql
RESTORE `production_backups`;
```

По умолчанию восстанавливается самая последняя копия в коллекции.

## Экспорт резервных копий во внешнее хранилище {#s3export}

{% note warning %}

По умолчанию резервные копии, созданные с помощью коллекций, хранятся во внутреннем хранилище кластера. Хотя это обеспечивает защиту от сбоев дисков или узлов внутри кластера, такие копии остаются в том же домене отказа, что и основные данные. В случае катастрофического сбоя или полной потери кластера и рабочие данные, и внутренние резервные копии могут стать недоступными.

**Для защиты от таких сценариев рекомендуется регулярно экспортировать важные резервные копии во внешнее хранилище, например, S3-совместимое объектное хранилище.** Это обеспечивает дополнительный уровень защиты и позволяет выполнить аварийное восстановление даже при полной потере кластера.

{% endnote %}

Чтобы экспортировать резервную копию из коллекции в S3, используйте команду `ydb export s3`. Синтаксис и параметры описаны в [документации по экспорту в S3](../../reference/ydb-cli/export-import/export-s3.md).

Для успешного восстановления в будущем важно экспортировать все копии в цепочке независимо и сохранять их порядок.

## Мониторинг операций {#incbackup-monitoring}

Операции инкрементального резервного копирования выполняются асинхронно. Отслеживайте прогресс с помощью:

### Список операций резервного копирования

```bash
ydb operation list incbackup
┌───────────────────────────────────────┬───────┬─────────┬──────────┐
│ id                                    │ ready │ status  │ progress │
├───────────────────────────────────────┼───────┼─────────┼──────────┤
│ ydb://incbackup/11?id=562949953466346 │ true  │ SUCCESS │ Done     │
├╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴╴╴┴╴╴╴╴╴╴╴╴╴╴┤
│ Created by: root                                                   │
│ Create time: 2025-12-26T13:05:24Z                                  │
│ End time: 2025-12-26T13:05:25Z                                     │
└────────────────────────────────────────────────────────────────────┘
```

Просмотр структуры резервных копий:

```bash
# Список всех коллекций
ydb scheme ls .backups/collections/

# Просмотр копий в коллекции
ydb scheme ls .backups/collections/production_backups/
```

{% note warning %}

Отмена операций резервного копирования пока не поддерживается. Команда `ydb operation cancel` вернет ошибку для таких операций.

{% endnote %}

## Ротация и очистка

{% note warning %}

Перед удалением резервных копий разберитесь в зависимостях цепочки:

- **Полные копии** необходимы для всех последующих инкрементальных копий.
- **Инкрементальные копии** зависят от полной копии и всех предшествующих инкрементальных копий.
- Удаление любой копии в цепочке делает невозможным восстановление из последующих инкрементальных копий.

В {{ ydb-short-name }} нет встроенной проверки целостности цепочек. Отслеживайте принадлежность копий к цепочкам вручную.

{% endnote %}

### Безопасный подход к очистке {#safe-cleanup}

1. Создайте новую полную резервную копию.
2. Убедитесь, что новая копия успешно создана.
3. При необходимости экспортируйте старые цепочки во внешнее хранилище.
4. Удалите старые цепочки (полную копию и все её инкрементальные копии вместе) с помощью [CLI](../../reference/ydb-cli/commands/dir.md#rmdir).

```bash
ydb scheme rmdir -r .backups/collections/production_backups/path_to_old_full_backup
ydb scheme rmdir -r .backups/collections/production_backups/path_to_old_incremental_backup
```
