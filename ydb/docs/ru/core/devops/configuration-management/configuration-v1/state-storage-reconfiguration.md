# Конфигурирование подсистем распространения метаданных State Storage, Board, Scheme Board

Применяется если нужно изменить [конфигурацию подсистем распространения метаданных](../../../reference/configuration/domains_config.md) состоящую из [State Storage](../../../concepts/glossary.md#state-storage), [Board](../../../concepts/glossary.md#board), [Scheme Board](../../../concepts/glossary.md#scheme-board), на кластере {{ ydb-short-name }}.

{% include [warning-configuration-error](../configuration-v1/_includes/warning-configuration-error.md) %}

Для изменения конфигурации подсистем распространения метаданных в кластере {{ ydb-short-name }} необходимо выполнить следующие шаги.

1. Внести требуемые изменения в секции `domains_config` конфигурационного файла `config.yaml` на каждом узле кластера {{ ydb-short-name }}:

  Неправильная [конфигурация подсистем распространения метаданных](../../../reference/configuration/domains_config.md#domains-state) может привести к отказу кластера.
  Правила конфигурирования перечислены в следующем разделе.

2. С помощью процедуры [rolling-restart](../../../maintenance/manual/node_restarting.md) перезапустите все узлы кластера, включая динамические. Обратите внимание, что перед рестартом очередного хоста необходима задержка чтобы предыдущий рестартуемый хост вернулся в строй.

## Правила конфигурирования подсистем распространения метаданных

  Неправильная [конфигурация подсистем распространения метаданных](../../../reference/configuration/domains_config.md) может привести к недоступности кластера.
  Перечисленные ниже правила применяются как для параметра `state_storage` так и для раздельной конфигурации `explicit_state_storage_config`, `explicit_state_storage_board_config`, `explicit_scheme_board_config`
  Изменение конфигурации производится в несколько шагов. Сначала добавляется новая группа колец состоящая из правильно выбранных узлов (в соответствии с моделью отказа), а затем старая группа колец удаляется, но чтобы избежать недоступности кластера делать это нужно строго соблюдая последовательность шагов описанных ниже.
  
  1. Чтобы изменить конфигурацию подсистем распространения метаданных без недоступности кластера необходимо производить это путем добавления и удаления групп колец.
  1. Добавлять и удалять можно только группы колец с параметром `WriteOnly: true`.
  1. В новой конфигурации всегда должна присутствовать хотя бы одна группа колец из предыдущей конфигурации без параметра `WriteOnly`. Такая группа колец должна идти первой в списке.
  1. Если в разных группах колец используются одни и те же узлы кластера, добавьте параметр `ring_group_actor_id_offset:1` к группе колец. Значение должно быть уникальным среди групп колец. Этот параметр сделает уникальными идентификаторы реплик в данной группе колец, они не будут совпадать с идентификаторами из других групп, и это позволит разместить на одном узле кластера несколько реплик одного типа.
  1. Переход к новой конфигурации выполняется за 4 последовательных шага. На каждом шаге подготавливается новая конфигурация и применяется к кластеру. Только что созданные или готовые к удалению группы колец помечаются флагом `WriteOnly: true`. Это необходимо чтобы запросы на чтение обрабатывались уже развернутой группой колец, пока новая конфигурация распространится на необходимое количество узлов, создадутся новые реплики или удалятся старые. Поэтому, между шагами необходимо делать паузу как минимум в `1 минуту`.
    - Добавляем новую группу колец с параметром `WriteOnly: true` соответствующую целевой конфигурации.
    - Снимаем флаг `WriteOnly`.
    - Выставляем флаг `WriteOnly: true` на группу колец соответствующую старой конфигурации, новую группу колец переносим в начало списка групп колец.
    - Удаляем старую группу колец

## Пример

  Рассмотрим на примере текущей конфигурации:

  ```yaml
  config:
    domains_config:
      explicit_scheme_board_config:
        ring:
          nto_select: 5
          node: [1,2,3,4,5,6,7,8]
  ```

  и целевой конфигурации:

  ```yaml
  config:
    domains_config:
      explicit_scheme_board_config:
        ring:
          nto_select: 5
          node: [10,20,30,40,5,6,7,8]
  ```

  Мы хотим перенести часть реплик на другие узлы кластера.

**Шаг 1**
На первом шаге первая группа колец должна соответствовать текущей конфигурации. Добавляем новую группу колец, которая соответствует целевой конфигурации и помечаем ее WriteOnly: true. Поскольку в новой конфигурации задействованы те же узлы кластера что и в старой необходимо добавить параметр `ring_group_actor_id_offset: 1`. Значение этого параметра должно быть уникальным среди всех групп колец в текущей конфигурации. Значение параметра по умолчанию 0. Это позволит репликам одного типа запущенных на одном узле кластера получить разные идентификаторы, что позволит им работать независимо друг от друга.

```yaml
config:
  domains_config:
    explicit_scheme_board_config:
      ring_groups:
      - ring:
        nto_select: 5
        node: [1,2,3,4,5,6,7,8]
      - ring:
        nto_select: 5
        node: [10,20,30,40,5,6,7,8]
        write_only: true
        ring_group_actor_id_offset: 1
```

**Шаг 2**
Снимаем флаг `WriteOnly`.

```yaml
config:
  domains_config:
    explicit_scheme_board_config:
      ring_groups:
      - ring:
        nto_select: 5
        node: [1,2,3,4,5,6,7,8]
      - ring:
        nto_select: 5
        node: [10,20,30,40,5,6,7,8]
        ring_group_actor_id_offset: 1
```

**Шаг 3**
Делаем новую группу колец первой в списке. На старую конфигурацию выставляем флаг `WriteOnly: true`

```yaml
config:
  domains_config:
    explicit_scheme_board_config:
      ring_groups:
      - ring:
        nto_select: 5
        node: [10,20,30,40,5,6,7,8]
        ring_group_actor_id_offset: 1
      - ring:
        nto_select: 5
        node: [1,2,3,4,5,6,7,8]
        write_only: true
```

**Шаг 4**
Применяем на кластере целевую конфигурацию:

```yaml
config:
  domains_config:
    explicit_scheme_board_config:
      ring_groups:
      - ring:
        nto_select: 5
        node: [10,20,30,40,5,6,7,8]
        ring_group_actor_id_offset: 1
```
