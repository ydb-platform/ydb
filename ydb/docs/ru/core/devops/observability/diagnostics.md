# Диагностика изолированного кластера

Кластеры, находящиеся за барьерами, могут быть недоступны для прямого наблюдения за их состоянием. Для диагностики проблем во внутреннем состоянии изолированного (недоступного для прямого наблюдения) кластера можно использовать функцию записи внутреннего состояния в файл.

## Сбор диагностической информации

Для сбора диагностической информации используйте команду:

```bash
ydb [global options...] admin cluster diagnostics collect \
  --duration 200 \
  --period 15 \
  --output diagnostics.tar.bz2
```

### Параметры команды

* `--duration` — количество секунд, в течение которых будет собираться информация о кластере.
* `--period` — интервал в секундах между сборами метрик.
* `--output` — путь и имя файла в формате `.tar.bz2`, в который будет записана вся собранная информация о кластере.

Команда записывает в указанный файл внутреннее состояние узлов кластера на протяжении заданного времени. Каждые `period` секунд производится сбор метрик с каждого узла кластера и запись в файл.

## Содержимое архива

Полученный файл является архивом и содержит следующие текстовые разделы:

* Метрики, собранные с узлов кластера.
* Файл с информацией о кластере.

Все данные записаны в формате JSON в человекочитаемом виде.

### Информация о кластере

Информация о кластере включает:

* Отчет Health Check.
* Запросы к таблицам раздела кластера `/Root/.sys` и их ответы.
* Текущую конфигурацию подсистем кластера.
* Текущее состояние узлов кластера.

## Визуализация данных

Для визуализации собранных данных используйте утилиту:

```bash
tools/cluster_diagnostics_view/cluster_diagnostics_view.py \
  --results-file=diagnostics.tar.bz2 \
  --solomon-token-file=token.txt \
  --cluster=some_external_cluster \
  --output=view.html
```

### Параметры утилиты

* `--results-file` — путь и имя файла с результатами диагностики.
* `--solomon-token-file` — путь и имя файла с токеном для доступа к Solomon.
* `--cluster` — имя кластера, под которым данные метрик будут загружены в мониторинг.
* `--output` — путь и имя файла для вывода результатов в формате HTML.

В результате будет создан файл `view.html` с визуализацией данных и ссылками на дашборды метрик, собранных с кластера на предыдущем этапе.

