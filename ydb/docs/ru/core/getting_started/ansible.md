# Установка {{ ydb-short-name }} с помощью Ansible

В статье изложен процесс установки и настройки YDB с помощью Ansible на одной виртуальной машине (ВМ). ВМ может быть создана в ручном режиме через web-консоль любого облачного провайдера или с помощью Terraform. Мы рекомендуем ознакомиться со статьёй, в которой описан подход создания ВМ в Яндекс Облаке с помощью Terraform. Особенность подхода в том, что Terraform генерирует инвентаризационный (hosts) файл для подключения Ansible.  

Перед началом установки и настройки Ansible кратко опишем работу YDB, это позволит лучше понять суть задач, которые будет выполнять Ansible на ВМ.  

## Как работает YDB { #how-ydb-works }

В YDB процессы обработки и хранения данных разделены. Это значит, что за обработку данных могут отвечать одни выделенные машины, а за хранения данных другие выделенные машины. Такой подход обеспечивает отказоустойчивость всей системы хранения и обработки данных. В нашем примере мы будем использовать схему совмещения двух процессов на одной ВМ – это позволит продемонстрировать полноценный процесс установки и запуска YDB при минимальных расходах ресурсов.

Процесс отвечающий за обработку данных называется статической нодой, а процесс отвечающий за хранения данных называется динамической нодой. Ноды обмениваются данными по сети, используя протокол gRPC(s). Более детально процесс работы YDB изложен в статье [{#T}](../concepts/index.md). Можно сказать, что статические и динамические ноды – это один и тот же запущенный процесс YDB с разными конфигурационными файлами и инлайн параметрами запуска. Приведём фрагмент systemd сервиса для обоих нод, где присутствуют индивидуальные параметры конфигурирования и запуска:

#|
|| Статическая нода | Динамическая нода ||
|| ```bash
ExecStart={{ ydb_dir }}/release/{{ ydb_version }}/bin/ydbd server \
    --log-level 3 --syslog --tcp --yaml-config  {{ ydb_dir }}/cfg/static_config.yaml \
    --grpc-port {{ grpc_port }} \
    --ic-port {{ ic_port }} \
    --mon-port {{ mon_port }} \
    --node static
```|
```bash
ExecStart={{ ydb_dir }}/release/{{ ydb_version }}/bin/ydbd server \
    --yaml-config  {{ ydb_dir }}/cfg/dynamic_config.yaml \
    --grpc-port {{ grpc_port | int +1 }} \
    --ic-port {{ ic_port | int +1 }}  \
    --mon-port {{ mon_port | int +1 }}  \
    --tenant /{{ ydb_domain }}/{{ ydb_dbname }} \
    --node-broker grpc://{{ inner_net }}:{{ grpc_port }}
```||
|#

В приведенном примере используются переменные (`{{ grpc_port }}`, `{{ ic_port }}` и т.д.), а не фиксированные значения. Работу этого механизма мы опишем позже. После запуска процессов, взаимодействовать с YDB можно с помощью YDB CLI, API (будет использовано в Ansible), SDK (C++, C#, Go, Java, Node.js, PHP, Python и Rust) и web-консоли, доступной на порту 8765 (monport).

  
## Установка Ansible { #ansible-install }

Для работы Ansible требует Python 3+. Перед установкой Ansible убедитесь, что у вас установлен Python версии 3 и пакетный менеджер pip:

{% list tabs %}

- Windows
    1. Проверка версии Python:
        * Откройте командную строку (Cmd) или PowerShell и введите:
            ```cmd
            python --version
            ```
            Если Python не установлен или его версия ниже 3, установите Python версии 3+ с официального сайта [Python.org](https://www.python.org/downloads/).
    2. Установка и обновление пакетного менеджера `pip`:
        * Если Python установлен, то `pip` обычно устанавливается автоматически. Проверить, что он установлен можно следующей командой:
            ```cmd
            pip --version
            ```
        * Обновить pip до последней версии можно командой:
            ```cmd
            python -m pip install --upgrade pip
            ``` 
    3. Установка Ansible:
        * Устанавливается Ansible командой:
            ```cmd
            pip install ansible
            ```    

- Linux
    1. В дистрибутивах Ubuntu 20-22 идёт предустановленный Python версий 3.6-3.9 и pip3. Их обновлять не надо, можно сразу переходить к шагу установки Ansible. Если у вас Ubuntu 18 или иной дистрибутив, то проверка версию Python можно так:
        * Откройте терминал и введите:
            ```bash
            python3 --version
            ```
        * Если Python не установлен или версии ниже 3.6 – установите более актуальную версию:
            ```bash
            sudo apt-get install software-properties-common
            sudo add-apt-repository ppa:deadsnakes/ppa
            udo apt-get update
            sudo apt-get install python3
            ```
    2. Проверка версии pip3:
        * Проверить версию pip3 можно командой:
            ```bash
            pip3 --version
            ```
        * Обновить pip3 до последней актуальной версии можно командой:
            ```bash
            pip3 install --upgrade pip
            ```   
    3. Установка Ansible:
        * Ansible устанавливается командой:
            ```bash
            pip3 install ansible
            ```     

- macOS
    1. Откройте Lauchpad и введите в поисковую строку terminal.   

{% endlist %}

## Настройка Ansible { #ansible-install }

Для подключения к серверу Ansible использует SSH-ключ и имя пользователя. Есть несколько способов указать ансиблу нужный SSH-ключ и имя пользователя:
1. Добавить строку  `Private_key_file = <path to ssh-key>` в файл `ansible.cfg`, который может располагаться в корне проекта, рядом с плейбуком;
2. Добавить параметры `ansible_ssh_private_key=<path to ssh-key>` и `ansible_ssh_user=<user name>` прямо в инвентаризационный файл для каждого хоста.

В нашем случае инвентаризационный файл (hosts) формирует Terraform и в нём уже указаны все нужные параметры для запуска Ansible:
```txt
158.160.99.189 ansible_ssh_user=ubuntu ansible_ssh_private_key_file=~/yandex ansible_ssh_common_args='-o StrictHostKeyChecking=no'
```

Дополнительным параметром 