# Плагин-источник данных Grafana для интеграции с YDB

## Совместимость

- Grafana версии `v9.2` и выше.

- Рабочий и доступный экземпляр YDB.

## Установка

Для получения подробных инструкций по установке плагина, см. [документацию Grafana](https://grafana.com/docs/grafana/latest/plugins/installation/).

## Настройка источника данных

### Пользователь YDB для источника данных

Настройте аккаунт пользователя YDB с возможностью чтения [(подробнее об уровнях доступа)](../cluster/access.md) и доступом до баз данных и таблиц, к которым потребуется делать запросы. Обратите внимани, что Grafana не валидирует запросы с точки зрения их безопасности. Запросы могут содержать в себе любой SQL, включая модифицирующие данные инструкции.

### Протокол доступа к данным

Плагин поддерживает протоколы `GRPCS` и `GRPC`. При использовании `grpcs` необходимо указать TLS/SSL сертификат.

### Ручная настройка

После установки плагина следуйте [инструкциям](https://grafana.com/docs/grafana/latest/datasources/add-a-data-source/), чтобы добавить новый источник данных YDB.

### Настройка с помощью файла конфигурации

Источник данных можно настроить с помощью файла конфигурации. Для получения подробных инструкций о подготовке источников данных через файлы конфигурации, см. [документацию Grafana](https://grafana.com/docs/grafana/latest/administration/provisioning/#data-sources).

Плагин поддерживает ряд различных [типов аутентификации](../reference/ydb-sdk/auth.md).

Пример для настройки источника данных с использованием аутентификации через логин/пароль:

```yaml
apiVersion: 1
datasources:
  - name: YDB
    type: ydbtech-ydb-datasource
    jsonData:
      authKind: "UserPassword",
      endpoint: 'grpcs://endpoint',
      dbLocation: 'location',
      user: 'username',
    secureJsonData:
      password: 'userpassword',
      certificate: 'certificate',
```

Поддерживаемые поля для создания соединения:

```typescript
    jsonData:
      authKind: "Anonymous" | "ServiceAccountKey" | "AccessToken" | "UserPassword" | "MetaData";
      endpoint: string;
      dbLocation: string;
      user?: string;
    secureJsonData:
      serviceAccAuthAccessKey?: string;
      accessToken?: string;
      password?: string;
      certificate?: string;
```

## Написание запросов

Для запроса данных из баз YDB поддерживает [YQL диалект](../yql/reference/index.md).
Запросы могут содержать макросы, которые упрощают синтаксис и дают возможность динамически изменять параменты.
Редактор запросов позволяет получать данные в следующих представлениях: временные серии, таблицы и логи.

### Временные серии

Визуализировать данные как временнные серии возможно при условии наличия в результатах запроса одного поля с типами `Date`, `Datetime` или `Timestamp` и как минимум одного поля с типом `number`.
Визуализацию в виду временных серий можно выбрать с помощью настроек. Grafana интерпретирует `timestamp` строки без временной зоны как UTC. Все остальные колонки интерпретируются как значения.

#### Многострочные временные серии

Чтобы создать многострочную временную серию, результаты запроса должны содержать в себе как минимум три поля в следующем порядке:

- field 1: временное поле
- field 2: значение для группировки
- field 3+: метрики

Например:

```sql
SELECT `timestamp`, `requestTime`, AVG(`responseStatus`) AS `avgRespStatus`
FROM `/database/endpoint/my-logs`
GROUP BY `requestTime`, `timestamp`
ORDER BY `timestamp`
```

### Таблицы

Табличное представление доступно для любого валидного YQL запроса.

### Визуализация логов

Для визуализации данных в виде логов запрос должен возвращать временное и строковые значения. Выбрать тип визуализации можно с помощью настроек.

По умолчанию только первое встреченное текстовое поле трактуется как строка лога, но это поведение может быть изменено с помощью конструктора запросов.

### Макросы

Чтобы упростить синтаксис и получить возможность динамически изменять параметры (например, значение временного диапазона), запрос может содержать в себе макросы.

Пример запроса с макросом, который позволяет использовать временной фильтр Grafana.

```sql
SELECT `timeCol`
FROM `/database/endpoint/my-logs`
WHERE $__timeFilter(`timeCol`)
```

| Макрос                                        | Описание                                                                                                                      | Пример вывода                                                                                  |
| -------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| _$\_\_timeFilter(columnName)_                | Заменяется условием, которое фильтрует данные в указанной колонке на основании временного диапазона, заданного на панели в микросекундах  | `foo >= CAST(1636717526371000 AS TIMESTAMP) AND foo <=  CAST(1668253526371000 AS TIMESTAMP)' )` |
| _$\_\_fromTimestamp_                         | Заменяется временем начала диапазона, заданного на панели в формате Timestamp                                                      | `CAST(1636717526371000 AS TIMESTAMP)`                                                           |
| _$\_\_toTimestamp_                           | Заменяется временем окончания диапазона, заданного на панели в формате Timestamp                                                        | `CAST(1636717526371000 AS TIMESTAMP)`                                                           |
| _$\_\_varFallback(condition, \$templateVar)_ | Заменяется первым параметром в том случае, если второй парамент не определен.                              | `condition` или `templateVarValue`                                                               |

### Шаблоны и переменные Templates and variables

[Инструкция](https://grafana.com/docs/grafana/latest/variables/variable-types/add-query-variable/) по добавлению новой переменной.
После создания переменная может быть использована в запрсе к YDB с помощью [специального синтаксиса](https://grafana.com/docs/grafana/latest/variables/syntax/).
Для более подробной информации о переменных, см. [документацию Grafana](https://grafana.com/docs/grafana/latest/variables/).

## Дополнительная информация

- Добавить [Аннотации](https://grafana.com/docs/grafana/latest/dashboards/annotations/).
- Настроить и использовать [Шаблоны и переменные](https://grafana.com/docs/grafana/latest/variables/).
- Добавить [Трансформации](https://grafana.com/docs/grafana/latest/panels/transformations/).
- Настроить [Уведомления](https://grafana.com/docs/grafana/latest/alerting/).
