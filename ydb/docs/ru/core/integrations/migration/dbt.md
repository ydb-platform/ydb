# Интеграция {{ dbt-name }} с YDB

## Введение

[{{ dbt-name }}](https://www.getdbt.com) — это популярный инструмент для трансформации и управления данными, который позволяет:

- Надежно и единообразно настраивать пайплайны трансформаций с помощью выражений SELECT, отражающих бизнес-логику.
- Внедрять практики контроля версий и CI/CD для кода трансформаций.
- Тестировать данные и обнаруживать аномалии для обеспечения качества данных.
- Генерировать документацию и визуализировать зависимости между данными.

Коннектор [dbt-ydb](https://github.com/ydb-platform/dbt-ydb) позволяет подключаться к YDB из dbt и использовать возможности dbt для управления трансформациями ваших данных внутри YDB. На данный момент коннектор dbt-ydb находится в стадии разработки и имеет некоторые существенные ограничения. В будущих версиях эти ограничения будут сняты.

## Возможности

### Модели и их материализация

Ключевое понятие dbt — [модель данных](https://docs.getdbt.com/docs/build/sql-models). По своей сути, это SQL-выражение, в котором могут быть использованы все источники данных внутри вашего хранилища, включая другие модели. Существуют разные подходы к физическому созданию модели (ее материализации). Каждый подход определяет, как именно будет выполнен запрос — через создание новой таблицы, обновление существующей или просто формирование представления.

dbt-ydb коннектор поддерживает следующие подходы к материализации:

- Представление (view) - сохраняется как view внутри YDB.
- Таблица - сохраняется как таблица внутри YDB и пересоздается при каждом обновлении моделей силами dbt.
- [Инкрементальное представление](https://docs.getdbt.com/docs/build/incremental-models-overview) - создается как таблица внутри YDB, но при обновлении не пересоздается, а обновляется изменившимися и новыми строками. Коннектор, в данный момент, обеспечивает поддержку [стратегии](https://docs.getdbt.com/docs/build/incremental-strategy#merge) MERGE.

Еще один тип материализации, [эфимерное представление](https://docs.getdbt.com/docs/build/materializations#ephemeral), в данный момент не поддерживается коннектором.

### Снепшоты

Механизм [снепшотов](https://docs.getdbt.com/docs/build/snapshots), в данный момент не поддерживаются dbt-ydb.

### Сиды

dbt-ydb коннектор поддерживает возможность dbt определять [сиды](https://docs.getdbt.com/docs/build/seeds) для загрузки справочных и тестовых данных из CSV файлов в ваш проект и их использование в других моделях.

### Тестирование данных

dbt-ydb поддерживает стандартные [тесты данных dbt](https://docs.getdbt.com/docs/build/data-tests#generic-data-tests), а также [специфичные тесты](https://docs.getdbt.com/docs/build/data-tests#singular-data-tests) в рамках возможностей [YDB YQL](https://ydb.tech/docs/ru/yql/reference/).

### Генерация документации

dbt-ydb поддерживает создание [документации](https://docs.getdbt.com/docs/build/documentation) из проектов dbt для YDB.

## Подготовка к использованию

Для начала работы с dbt на YDB вам понадобятся:

- Python 3.10+.
- dbt Core (1.8+).
  Внимание! dbt Fusion (2.0) в данный момент не поддерживается.
- Существующий кластер {{ ydb-short-name }}, однонодовая инсталляция из [быстрого старта](../../quickstart.md) будет достаточной.

Для установки dbt-ydb выполните:

```bash
pip install dbt-ydb
```

## Запуск тестового примера

Вместе с коннектором dbt-ydb поставляется [пример](https://github.com/ydb-platform/dbt-ydb/tree/main/examples/jaffle_shop), который можно использовать для быстрой проверки возможностей dbt для YDB:

1. Клонирование репозитория

```bash
git clone https://github.com/ydb-platform/dbt-ydb.git
cd dbt-ydb/examples/jaffle_shop
```

2. Настройка профиля подключения к вашей YDB в файле profiles.yml. Способы подключения и аутентификации представлены [здесь](https://github.com/ydb-platform/dbt-ydb?tab=readme-ov-file#profile-configuration). Для однонодовой инсталляции из [быстрого старта](../../quickstart.md) файл будет выглядеть следующим образом.

```text
profile_name:
  target: dev
  outputs:
    dev:
      type: ydb
      host: localhost # YDB host
      port: 2136 # YDB port
      database: /local # YDB database
      schema: jaffle_shop
```

3. Проверка подключения

```bash
dbt debug
```

4. Подготовка тестовых данных (seeds)

```bash
dbt seed
```

Эта команда загрузит CSV-файлы из data/ в raw_* таблицы YDB.

5. Запуск моделей

```bash
dbt run
```

Будут созданы таблицы и view на основе SQL-моделей из папки models/.

6. Тестирование данных в моделях

```bash
dbt test
```

Проверит качество данных по заданным правилам.

7. Генерация документации

```bash
dbt docs generate
dbt docs serve
```

Документация по проекту доступна в браузере: [http://localhost:8080](http://localhost:8080)

## Дальнейшие шаги

Используйте официальную документацию [dbt](https://docs.getdbt.com/docs/introduction), а также публичный репозиторий коннектора [dbt-ydb](https://github.com/ydb-platform/dbt-ydb) для поиска дополнительной информации.