# Интеграция {{dbt}} с {{ydb}}

## Введение

[{{dbt}}](https://www.getdbt.com) — это инструмент для трансформации и управления данными, который позволяет:

- Настраивать пайплайны трансформаций с помощью выражений SELECT, отражающих бизнес-логику.
- Внедрять практики контроля версий и CI/CD для кода трансформаций.
- Тестировать данные и обнаруживать аномалии для обеспечения качества данных.
- Генерировать документацию и визуализировать зависимости между данными.

Коннектор [{{dbt-ydb}}](https://github.com/ydb-platform/dbt-ydb) позволяет подключаться к {{ydb}} из {{dbt}} и использовать dbt для управления трансформациями ваших данных внутри {{ydb}}.

{% note warning %}

Коннектор {{dbt-ydb}} находится в стадии Preview и, в настоящий момент, не обеспечивает поддержку всех возможностей {{dbt}}. Ниже приводится список возможностей и ограничений.

{% endnote %}

## Возможности

### Модели и их материализация

Ключевое понятие {{dbt}} — [модель данных](https://docs.getdbt.com/docs/build/sql-models). По своей сути, это SQL-выражение, в котором могут быть использованы все источники данных внутри вашего хранилища, включая другие модели. Существуют разные подходы к физическому созданию модели (ее материализации) внутри YDB, которые поддерживает коннектор {{dbt-ydb}}:

- Представление (view) - сохраняется как view внутри {{ydb}}.
- Таблица - сохраняется как таблица внутри {{ydb}} и пересоздается при каждом обновлении модели силами {{dbt}}.
- [Инкрементальное представление](https://docs.getdbt.com/docs/build/incremental-models-overview) - создается как таблица внутри {{ydb}}, но при обновлении не пересоздается, а обновляется изменившимися и новыми строками. Коннектор, в данный момент, обеспечивает поддержку [стратегии](https://docs.getdbt.com/docs/build/incremental-strategy#merge) MERGE.

{% note info %}

Еще один тип материализации, [эфимерное представление](https://docs.getdbt.com/docs/build/materializations#ephemeral), в данный момент не поддерживается коннектором.

{% endnote %}

### Снепшоты

Механизм [снепшотов](https://docs.getdbt.com/docs/build/snapshots), в данный момент не поддерживаются {{dbt-ydb}}.

### Тестовые/справочные данные, создаваемые из файлов CSV (сиды)

{{dbt-ydb}} коннектор поддерживает возможность {{dbt}} определять [сиды](https://docs.getdbt.com/docs/build/seeds) для загрузки справочных и тестовых данных из CSV файлов в ваш проект и их использование в других моделях.

### Тестирование данных

{{dbt-ydb}} поддерживает стандартные [тесты данных dbt](https://docs.getdbt.com/docs/build/data-tests#generic-data-tests), а также [специфичные тесты](https://docs.getdbt.com/docs/build/data-tests#singular-data-tests) в рамках возможностей [YDB YQL](https://ydb.tech/docs/ru/yql/reference/).

### Генерация документации

{{dbt-ydb}} поддерживает создание [документации](https://docs.getdbt.com/docs/build/documentation) из проектов {{dbt}} для {{ydb}}.

## Подготовка к использованию

Для начала работы с {{dbt}} на {{ydb}} вам понадобятся:

- Python 3.10+.
- dbt Core (1.8+).
  Внимание! dbt Fusion (2.0) в данный момент не поддерживается.
- Существующий кластер {{ ydb-short-name }}, однонодовая инсталляция из [быстрого старта](../../quickstart.md) будет достаточной.

Для установки {{dbt-ydb}} выполните:

```bash
pip install dbt-ydb
```

## Запуск тестового примера

Вместе с коннектором {{dbt-ydb}} поставляется [пример](https://github.com/ydb-platform/dbt-ydb/tree/main/examples/jaffle_shop), который можно использовать для быстрой проверки возможностей {{dbt}} для {{ydb}}:

1. Клонирование репозитория

```bash
git clone https://github.com/ydb-platform/dbt-ydb.git
cd dbt-ydb/examples/jaffle_shop
```

2. Настройка профиля подключения к вашей {{ydb}} в файле profiles.yml. Способы подключения и аутентификации представлены [здесь](https://github.com/ydb-platform/dbt-ydb?tab=readme-ov-file#profile-configuration). Для однонодовой инсталляции из [быстрого старта](../../quickstart.md) файл будет выглядеть следующим образом.

```text
profile_name:
  target: dev
  outputs:
    dev:
      type: ydb
      host: localhost # YDB host
      port: 2136 # YDB port
      database: /local # YDB database
      schema: jaffle_shop
```

3. Проверка подключения

```bash
dbt debug
```

4. Подготовка тестовых данных (через seeds)

```bash
dbt seed
```

Эта команда загрузит CSV-файлы из data/ в raw_* таблицы YDB.

5. Запуск моделей

```bash
dbt run
```

Будут созданы таблицы и представления на основе примеров моделей проекта.

6. Тестирование данных в моделях

```bash
dbt test
```

Выполнит стандартные тесты данных описанные в тестовом примере - проверки на null, на допустимые значения списка и другие.

7. Генерация документации и старт локального веб-сервера для ее просмотра

```bash
dbt docs generate
dbt docs serve --port 8080
```

Документация по проекту доступна в браузере: [http://localhost:8080](http://localhost:8080)

## Дальнейшие шаги

Официальную документацию {{dbt}} можно найти по [ссылке](https://docs.getdbt.com/docs).
Дополнительно вы можете изучить исходные коды коннектора, а также поучаствовать в его развитии через публичный репозиторий [{{dbt-ydb}}](https://github.com/ydb-platform/dbt-ydb).