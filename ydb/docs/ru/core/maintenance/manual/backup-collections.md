# Операции с коллекциями резервных копий {#backup-collections-operations}

Данное руководство охватывает все практические операции для создания, управления и восстановления из коллекций резервных копий. Для получения концептуальной информации см. [Концепции коллекций резервных копий](../../concepts/backup-collections.md).

## Создание коллекций резервных копий {#creating-collections}

### Справочник по синтаксису SQL {#sql-syntax-reference}

```sql
-- Синтаксис CREATE BACKUP COLLECTION
CREATE BACKUP COLLECTION `collection_name`
    ( TABLE `table_path` [, TABLE `table_path` ...] )
WITH ( STORAGE = 'cluster', INCREMENTAL_BACKUP_ENABLED = 'true' );

-- Синтаксис BACKUP
BACKUP `collection_name` [INCREMENTAL];

-- Синтаксис DROP BACKUP COLLECTION
DROP BACKUP COLLECTION `collection_name`;
```

Для подробного синтаксиса см. [справочную документацию YQL](../../yql/reference/syntax/index.md).

### Базовое создание коллекции {#basic-collection-creation}

Создайте коллекцию резервных копий с помощью SQL команд. Коллекция определяет, какие таблицы включить и настройки хранения:

```sql
CREATE BACKUP COLLECTION `shop_backups`
    ( TABLE `/Root/shop/orders`, TABLE `/Root/shop/products` )
WITH ( STORAGE = 'cluster', INCREMENTAL_BACKUP_ENABLED = 'true' );
```

### Планирование коллекции {#collection-planning}

Перед созданием коллекции рассмотрите:

- **Выбор таблиц**: Включите связанные таблицы, которые должны резервироваться согласованно.
- **Требования к хранению**: Оцените размер резервной копии и рост.
- **Частота резервного копирования**: Планируйте расписания полного и инкрементального резервного копирования.
- **Политика хранения**: Определите, как долго хранить цепочки резервных копий.

### Соглашения об именах {#naming-conventions}

Используйте описательные имена, которые указывают:

- Имя приложения или сервиса.
- Окружение (prod, staging, test).
- Цель или область применения.

Примеры:

- `production_user_data`
- `staging_analytics`
- `daily_transaction_backups`

## Создание резервных копий {#taking-backups}

### Начальная полная резервная копия {#initial-full-backup}

После создания коллекции сделайте начальную полную резервную копию:

```sql
BACKUP `shop_backups`;
```

Первая резервная копия без ключевого слова `INCREMENTAL` создает полную резервную копию, содержащую все данные из указанных таблиц.

### Инкрементальные резервные копии {#incremental-backups}

Для последующих резервных копий используйте инкрементальный режим:

```sql
BACKUP `shop_backups` INCREMENTAL;
```

### Рекомендации по времени резервного копирования {#backup-timing-recommendations}

Реализуйте регулярные расписания резервного копирования в соответствии с вашими требованиями. Обратите внимание, что планирование должно быть реализовано внешними средствами с использованием cron или аналогичных инструментов.

**Ежедневные полные резервные копии:**

```sql
-- Пример: Запуск ежедневно в 2 утра (требует внешнего планирования)
BACKUP `shop_backups`;
```

**Часовые инкрементальные с еженедельными полными резервными копиями:**

```sql
-- Пример: Воскресенье: Полная резервная копия (требует внешнего планирования)
BACKUP `shop_backups`;

-- Пример: Понедельник-Суббота: Инкрементальные резервные копии (требует внешнего планирования)
BACKUP `shop_backups` INCREMENTAL;
```

### Важные замечания по планированию {#scheduling-important-notes}

- **Требуется внешнее планирование**: YDB не предоставляет встроенного планирования. Используйте cron или аналогичные инструменты.
- **Фоновые операции**: Резервные копии выполняются асинхронно и не блокируют операции базы данных.
- **Несколько коллекций**: Можно выполнять резервное копирование разных коллекций независимо.

Примечание: Планирование резервного копирования должно быть реализовано с использованием внешних инструментов, таких как cron, поскольку YDB не предоставляет встроенного планирования.

## Мониторинг операций резервного копирования {#monitoring}

### Мониторинг операций резервного копирования {#monitoring-backup-operations}

```bash
# Проверка статуса операций резервного копирования
ydb operation list incbackup

# Получение подробностей о конкретной операции
ydb operation get <operation-id>

# Отмена выполняющейся операции при необходимости
ydb operation cancel <operation-id>

# Просмотр коллекций резервных копий
ydb scheme ls .backups/collections/

# Список резервных копий в коллекции
ydb scheme ls .backups/collections/production_backups/

# Получение метаданных резервной копии
ydb scheme describe .backups/collections/production_backups/backup_20240315_120000/
```

### Проверка статуса операций {#checking-operation-status}

Все операции резервного копирования выполняются в фоновом режиме. Отслеживайте их прогресс с помощью:

```bash
# Список всех операций резервного копирования
ydb operation list incbackup

# Проверка статуса конкретной операции
ydb operation get <operation-id>
```

### Просмотр структуры резервных копий {#viewing-backup-structure}

Просматривайте резервные копии через схему базы данных:

```bash
# Список всех коллекций
ydb scheme ls .backups/collections/

# Просмотр структуры конкретной коллекции
ydb scheme ls .backups/collections/shop_backups/

# Проверка временных меток резервных копий
ydb scheme ls .backups/collections/shop_backups/ | sort
```

### Мониторинг цепочек резервных копий {#monitoring-backup-chains}

Проверка целостности цепочки резервных копий:

```bash
# Список резервных копий в хронологическом порядке
ydb scheme ls .backups/collections/shop_backups/ | sort

# Проверка содержимого отдельной резервной копии
ydb scheme describe .backups/collections/shop_backups/backup_20240315/
```

## Управление коллекциями резервных копий {#managing-collections}

### Информация о коллекции {#collection-information}

Поскольку коллекции управляются через SQL, просматривайте их с помощью команд схемы:

```bash
# Просмотр всех коллекций
ydb scheme ls .backups/collections/

# Просмотр содержимого каталога коллекции
ydb scheme describe .backups/collections/shop_backups/
```

### Мониторинг состояния коллекции

Проверка работоспособности и состояния ваших коллекций:

1. **Проверка существования последних резервных копий**.
2. **Проверка полноты цепочки резервных копий**.
3. **Мониторинг использования хранилища**.
4. **Валидация доступности резервных копий**.

### Управление жизненным циклом коллекции

**Контрольный список создания:**

- [ ] Определить список таблиц.
- [ ] Выбрать подходящее имя.
- [ ] Настроить параметры хранения.
- [ ] Включить инкрементальные резервные копии.
- [ ] Документировать расписание резервного копирования.

**Текущее обслуживание:**

- [ ] Мониторинг успешности резервного копирования.
- [ ] Управление политиками хранения.
- [ ] Обновление документации.
- [ ] Проверка влияния на производительность.

## Хранение и очистка {#retention-cleanup}

### Рассмотрения цепочки резервных копий

Перед удалением резервных копий понимайте зависимости цепочки:

- **Полные резервные копии**: Требуются для всех последующих инкрементальных.
- **Инкрементальные резервные копии**: Зависят от всех предыдущих резервных копий в цепочке.
- **Разрывы цепочки**: Удаление промежуточных резервных копий нарушает цепочку.

### Стратегии ручной очистки

**Безопасный подход к очистке:**

1. Создать новую полную резервную копию.
2. Проверить завершение новой резервной копии.
3. Удалить старые цепочки резервных копий (полная резервная копия + все её инкрементальные).
4. Никогда не удалять частичные цепочки.

**Пример рабочего процесса очистки:**

```bash
# 1. Создание новой полной резервной копии
ydb yql -s "BACKUP \`shop_backups\`;"

# 2. Ожидание завершения и проверка
ydb operation list incbackup

# 3. Просмотр структуры резервных копий
ydb scheme ls .backups/collections/shop_backups/ | sort

# 4. Удаление старых каталогов резервных копий (только целые цепочки)
ydb scheme rmdir -r .backups/collections/shop_backups/backup_20240301/
ydb scheme rmdir -r .backups/collections/shop_backups/backup_20240302/
# ... (удалить все связанные инкрементальные)
```

### Политики хранения

Реализуйте политики хранения на основе:

- **Бизнес-требований**: Как долго данные должны храниться.
- **Стоимости хранения**: Баланс между хранением и использованием хранилища.
- **Потребностей восстановления**: Типичные сценарии восстановления и временные рамки.
- **Соответствия требованиям**: Правовые или регулятивные требования.

**Пример политики хранения:**

- Хранить ежедневные резервные копии в течение 30 дней.
- Хранить еженедельные резервные копии в течение 12 недель.
- Хранить месячные резервные копии в течение 12 месяцев.
- Хранить годовые резервные копии в течение 7 лет.

## Валидация и проверка резервных копий {#validation}

### Предварительная валидация резервного копирования

Перед созданием резервных копий:

1. **Проверка доступности таблиц**: Убедитесь, что все таблицы доступны.
2. **Проверка места хранения**: Подтвердите наличие достаточного места для хранения.
3. **Валидация разрешений**: Проверьте разрешения на операции резервного копирования.
4. **Тестирование подключения**: Убедитесь в стабильности подключения к базе данных.

### Пост-валидация резервного копирования

После завершения резервного копирования:

1. **Проверка успешности операции**: Проверьте статус операции.
2. **Валидация структуры резервной копии**: Просмотрите каталоги резервных копий.
3. **Проверка размера резервной копии**: Сравните с ожидаемым размером.
4. **Тестирование целостности цепочки**: Проверьте зависимости резервных копий.

### Процедуры тестирования резервных копий

Регулярно тестируйте восстановление резервных копий:

1. **Тестовая среда**: Используйте отдельную тестовую среду.
2. **Выборочное восстановление**: Восстанавливайте подмножество данных.
3. **Тест полного восстановления**: Периодически тестируйте полное восстановление.
4. **Тестирование производительности**: Измеряйте время восстановления и ресурсы.

## Устранение распространенных проблем {#troubleshooting}

### Сбои операций резервного копирования {#backup-operation-failures}

**Распространенные причины и решения:**

- **Недостаточно места для хранения**: Проверьте доступное место для хранения.
- **Отказ в доступе**: Проверьте разрешения пользователя для таблиц и хранилища резервных копий.
- **Конфликты блокировки таблиц**: Избегайте одновременных изменений схемы во время резервного копирования.
- **Проблемы с сетью**: Проверьте подключение к базе данных во время резервного копирования.

### Проблемы с цепочкой резервных копий

**Разорванные цепочки:**

- Определите отсутствующие резервные копии в последовательности.
- Рассмотрите создание новой полной резервной копии для начала свежей цепочки.
- Документируйте разрывы цепочки для будущих ссылок.

**Несогласованные резервные копии:**

- Проверьте одновременные операции во время резервного копирования.
- Проверьте согласованность таблиц в точках резервного копирования.
- Просмотрите журналы резервного копирования на предмет ошибок или предупреждений.

### Проблемы производительности

**Медленные операции резервного копирования:**

- Мониторьте системные ресурсы во время резервного копирования.
- Рассмотрите корректировку времени резервного копирования.
- Просмотрите размеры таблиц и распределение данных.
- Проверьте производительность бэкенда хранения.

**Высокое использование хранилища:**

- Просмотрите политики хранения.
- Очистите старые цепочки резервных копий.
- Мониторьте размеры инкрементальных резервных копий.
- Рассмотрите корректировку частоты резервного копирования.

## Восстановление и реставрация {#recovery}

### Планирование восстановления

Перед восстановлением из резервных копий:

1. **Оценка требований восстановления**: Определите целевую точку восстановления.
2. **Планирование процесса восстановления**: Определите шаги и временные рамки восстановления.
3. **Подготовка целевой среды**: Убедитесь, что целевая база данных готова.
4. **Координация с заинтересованными сторонами**: Сообщите временные рамки восстановления.

### Восстановление экспорт/импорт

Для полного аварийного восстановления используйте операции экспорта/импорта:

```bash
# Экспорт коллекции резервных копий из источника
ydb tools dump -p .backups/collections/shop_backups -o shop_backups_export

# Импорт в целевую базу данных
ydb tools restore -i shop_backups_export -d /Root/restored_db
```

### Восстановление на момент времени

Для восстановления до определенного момента времени:

1. **Определение целевой резервной копии**: Найдите подходящую точку резервной копии.
2. **Экспорт цепочки резервных копий**: Экспортируйте полную резервную копию и необходимые инкрементальные.
3. **Восстановление по порядку**: Примените резервные копии в хронологическом порядке.
4. **Проверка восстановления**: Валидируйте целостность восстановленных данных.

## Сводка лучших практик {#best-practices}

### Стратегия резервного копирования

- **Регулярное расписание**: Установите согласованное время резервного копирования.
- **Управление длиной цепочки**: Периодически создавайте новые полные резервные копии, чтобы избежать чрезмерно длинных инкрементальных цепочек.
- **Множественные коллекции**: Отдельные коллекции для разных приложений.
- **Документирование**: Ведите документацию процедур резервного копирования.

### Мониторинг и обслуживание

- **Ручная валидация**: Периодически тестируйте восстановление резервных копий.
- **Отслеживание производительности**: Мониторьте продолжительность резервного копирования и использование ресурсов.
- **Мониторинг хранилища**: Отслеживайте рост хранилища резервных копий.

### Безопасность и соответствие

- **Контроль доступа**: Ограничьте разрешения на операции резервного копирования.
- **Ведение журнала аудита**: Записывайте действия резервного копирования и восстановления.
- **Защита данных**: Обеспечьте правильную защиту резервных копий.
- **Соответствие**: Следуйте организационным политикам хранения данных.

## См. также {#see-also}

- [Концепции коллекций резервных копий](../../concepts/backup-collections.md) - Общая архитектура и дизайн.
- [Распространенные рецепты](../../recipes/backup-collections.md) - Практические примеры использования.
