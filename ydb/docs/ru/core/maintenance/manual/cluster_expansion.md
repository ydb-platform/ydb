# Расширение кластера

Вы можете расширить кластер {{ ydb-short-name }}, добавив новые узлы в конфигурацию кластера. Ниже приведены необходимые действия по расширению кластера {{ ydb-short-name }}, установленного вручную на виртуальные машины или физические сервера. Расширение кластера в среде Kubernetes осуществляется путём корректировки настроек контроллера {{ ydb-short-name }} для Kubernetes.

Расширение кластера {{ ydb-short-name }} не требует приостановки доступа пользователей к базам данных. При расширении кластера выполняется перезапуск его компонент для применения изменений в конфигурации, что, в свою очередь, может привести к необходимости повтора выполняемых на кластере транзакций. Повторы транзакций выполняются автоматически за счет использования приложениями возможностей SDK {{ ydb-short-name }} по контролю ошибок и повтору операций.

## Подготовка новых серверов {#add-host}

В случае размещения новых статических или динамических узлов кластера на новых серверах, не входивших ранее в состав расширяемого кластера {{ ydb-short-name }}, на каждом новом сервере необходимо выполнить установку программного обеспечения {{ ydb-short-name }} в соответствии с процедурами, описанными в [инструкции по развертыванию кластеров](../../deploy/manual/deploy-ydb-on-premises.md). В частности, необходимо:

1. создать учетную запись и группу в операционной системе для работы сервиса {{ ydb-short-name }};
1. установить программное обеспечение {{ ydb-short-name }};
1. подготовить и разместить на сервере соответствующий ему ключ и сертификат TLS;
1. скопировать на сервер актуальный конфигурационный файл кластера {{ ydb-short-name }}.

Используемые на новых серверах сертификаты TLS должны соответствовать [требованиям к заполнению полей](../../deploy/manual/deploy-ydb-on-premises.md#tls-certificates), и быть подписаны доверенным центром регистрации, используемым на уже существующих серверах расширяемого кластера {{ ydb-short-name }}.

## Добавление динамических узлов {#add-dynamic-node}

Добавление динамических узлов позволяет увеличить доступные вычислительные ресурсы (процессорные ядра и оперативную память) для выполнения пользовательских запросов кластером {{ ydb-short-name }}.

Для добавления динамического узла в кластер достаточно запустить процесс, обслуживающий этот узел, передав ему в параметрах командной строки путь к конфигурационному файлу кластера, имя обслуживаемой базы данных и адреса любых трех статических узлов кластера кластера {{ ydb-short-name }}, как показано в [инструкции по развертыванию кластеров](../../deploy/manual/deploy-ydb-on-premises.md#start-dynnode).

После успешного добавления динамического узла в кластер информация о нем будет доступна на [странице мониторинга кластера во встроенном UI](../../reference/embedded-ui/ydb-monitoring.md).

Для вывода динамического узла из кластера достаточно выполнить остановку процесса динамического узла.

## Добавление статических узлов {#add-static-node}

Добавление статических узлов позволяет увеличить пропускную способность при выполнении операций ввода-вывода и увеличить доступную емкость для хранения данных в кластере {{ ydb-short-name }}.

Для добавления статических узлов в кластер необходимо выполнить следующую последовательность действий:

1. Отформатировать диски, которые будут использоваться для хранения данных {{ ydb-short-name }}, с использованием [процедуры, описанной для этапа развертывания кластера](../../deploy/manual/deploy-ydb-on-premises.md#prepare-disks).

1. Скорректировать [конфигурационный файл кластера](../../deploy/manual/deploy-ydb-on-premises.md#config):
    * включить в конфигурацию описание добавляемых узлов (в секции `hosts`) и используемых на них дисков (в секции `host_configs`);
    * установить номер изменения конфигурации в виде параметра `storage_config_generation: K` на верхнем уровне, где `K` - целое число, номер изменения (при первоначальной установке значение `K=0` или не указано, при первом расширении кластера `K=1`, при втором `K=2`, и так далее).

1. Скопировать доработанный конфигурационный файл кластера на все существующие и на все добавляемые сервера кластера, заместив им старую версию конфигурационного файла.

1. Выполнить последовательный перезапуск всех существующих статических узлов кластера, с ожиданием инициализации и восстановления работы каждого перезапускаемого узла.

1. Выполнить последовательный перезапуск всех существующих динамических узлов кластера.

1. Запустить процессы, обслуживающие новые статические узлы кластера, на соответствующих серверах.

1. Убедиться в том, что новые статические узлы отображаются на [странице мониторинга кластера во встроенном UI](../../reference/embedded-ui/ydb-monitoring.md).

1. Получить токен аутентификации для выполнения административных команд с помощью {{ ydb-short-name }} CLI, например:

    ```bash
    ydb -e grpcs://<node1.ydb.tech>:2135 -d /Root --ca-file ca.crt \
        --user root auth get-token --force >token-file
    ```

    В примере команды выше используются следующие параметры:
    * `node1.ydb.tech` - FQDN любого из серверов, на которых размещены статические узлы кластера;
    * `2135` - номер порта grpcs сервиса статических узлов;
    * `ca.crt` - имя файла с сертификатом центра регистрации;
    * `root` - логин пользователя с административными правами;
    * `token-file` - имя файла, в который сохраняется токен аутентификации для последующего использования.

    При выполнении приведенной выше команды {{ ydb-short-name }} CLI запросит пароль для аутентификации указанного пользователя.

1. Разрешить кластеру {{ ydb-short-name }} использовать диски на новых статических узлах для хранения данных, выполнив следующую команду на любом из узлов кластера:

    ```bash
    export LD_LIBRARY_PATH=/opt/ydb/lib
    /opt/ydb/bin/ydbd -f ydbd-token-file --ca-file ca.crt -s grpcs://`hostname -f`:2135 \
        admin blobstorage config init --yaml-file  /opt/ydb/cfg/config.yaml
    echo $?
    ```

    В примере команды выше используются следующие параметры:
    * `ydbd-token-file` - имя файла ранее полученного токена аутентификации;
    * `2135` - номер порта grpcs сервиса статических узлов;
    * `ca.crt` - имя файла с сертификатом центра регистрации.

    Если при выполнении приведенной выше команды возвращается ошибка сверки номера конфигурации, это означает, что при корректировке конфигурационного файла кластера было неверно установлено поле `storage_config_generation`. Текст ошибки содержит ожидаемое значение номера конфигурации, которое можно использовать для корректировки файла настроек кластера. Пример сообщения об ошибке сверки номера конфигурации:

    ```protobuf
    ErrorDescription: "ItemConfigGeneration mismatch ItemConfigGenerationProvided# 0 ItemConfigGenerationExpected# 1"
    ```

2. Добавить дополнительные группы хранения в одну или несколько баз данных, выполнив команды следующего вида на любом из узлов кластера:

    ```bash
    export LD_LIBRARY_PATH=/opt/ydb/lib
    /opt/ydb/bin/ydbd -f ydbd-token-file --ca-file ca.crt -s grpcs://`hostname -f`:2135 \
        admin database /Root/testdb pools add ssd:1
    echo $?
    ```

    В примере команды выше используются следующие параметры:
    * `ydbd-token-file` - имя файла ранее полученного токена аутентификации;
    * `2135` - номер порта grpcs сервиса статических узлов;
    * `ca.crt` - имя файла с сертификатом центра регистрации;
    * `/Root/testdb` - полный путь к базе данных;
    * `ssd:1` - имя пула хранения и количество выделяемых групп хранения.

3. Убедиться, что добавленные группы хранения отображаются [странице мониторинга кластера во встроенном UI](../../reference/embedded-ui/ydb-monitoring.md).

Вывод статических узлов из кластера {{ ydb-short-name }} производится в соответствии с [документированной процедурой декомиссии](../../devops/manual/decommissioning.md).

В случае повреждения и невозможности ремонта сервера, на котором работает статический узел кластера, необходимо разместить недоступный статический узел на новом сервере, содержащем аналогичное или большее количество и объем дисков.
