# Декомиссия групп с использованием виртуальных групп

Физические [группы хранения](../../concepts/glossary.md#storage-group) являются ограниченным ресурсом в [кластере](../../concepts/glossary.md#cluster): их количество определяется размером кластера, и их нельзя удалить, пока в них хранятся данные. Это может привести к ситуации, когда для создания новой [базы данных](../../concepts/glossary.md#database) или расширения существующей не хватает групп, а освободить ресурсы нельзя, поскольку старые группы содержат данные.

Декомиссия [группы хранения](../../concepts/glossary.md#storage-group) позволяет освободить ресурсы физической группы, сохраняя при этом все данные. В процессе декомиссии создаётся [виртуальная группа хранения](../../concepts/glossary.md#virtual-storage-groups), которая начинает обслуживать декомиссуемую группу и копирует из неё все данные. После завершения копирования [VDisk](../../concepts/glossary.md#vdisk)'и декомиссуемой группы удаляются, а ресурсы освобождаются.

Процесс декомиссии состоит из следующих этапов:

1. Создание [виртуальной группы хранения](../../concepts/glossary.md#virtual-storage-groups) и блокировка записи на диски физической группы.
2. Копирование данных из физической группы в виртуальную. На время инициализации виртуальной группы (обычно доли секунды) работа с группой может быть кратковременно приостановлена, запросы в этот момент ставятся в очередь.
3. Удаление физических [VDisk](../../concepts/glossary.md#vdisk)'ов и освобождение ресурсов.

## Предварительные требования

Перед началом декомиссии групп необходимо выполнить следующие подготовительные шаги:

### 1. Развернутый кластер

Убедитесь, что у вас есть развернутый [кластер](../../concepts/glossary.md#cluster) {{ ydb-short-name }}. Инструкции по развертыванию доступны в разделе [Первоначальное развёртывание](../../devops/deployment-options/manual/initial-deployment.md).

### 2. Наличие данных в кластере

Для тестирования декомиссии необходимо наличие данных в кластере. Если данных нет, можно загрузить тестовые данные с помощью утилиты `ydb workload tpcc`:

```bash
ydb workload tpcc --path tpcc/10wh init -w 100
ydb workload tpcc --path tpcc/10wh import -w 100
ydb workload tpcc --path tpcc/10wh run -w 100
```

Подробнее о работе с тестовой нагрузкой см. в [документации по ydb workload tpcc](../../reference/ydb-cli/workload-tpcc.md).

### 3. Проверка состояния хранилища

Проверьте состояние хранилища через веб-интерфейс мониторинга кластера. Откройте страницу мониторинга хранилища (например, `https://<cluster-address>:8765/monitoring/cluster/storage`) и убедитесь, что данные успешно загружены.

### 4. Установка {{ ydb-short-name }} DSTool

Для выполнения декомиссии необходимо установить утилиту `ydb-dstool`. Инструкции по установке доступны в [документации по установке {{ ydb-short-name }} DSTool](../../reference/ydb-dstool/install.md).

### 5. Получение токена аутентификации

Сгенерируйте токен аутентификации для доступа к кластеру:

```bash
ydb -e grpc://<cluster-endpoint> -d '/Root' --user root auth get-token -f > ~/ydb_token
```

Замените `<cluster-endpoint>` на адрес вашего кластера.

## Выбор группы для декомиссии

Перед запуском декомиссии необходимо выбрать группу (group ID), которую вы хотите декомиссировать. Это можно сделать через веб-интерфейс мониторинга кластера или с помощью команды:

```bash
ydb-dstool -e <cluster-endpoint> \
  --ca-file <path-to-ca-cert> \
  --token-file ~/ydb_token \
  group list --virtual-groups-only
```

В выводе команды найдите нужную группу и запомните её `GroupId`.

## Запуск декомиссии

Для запуска декомиссии выполните команду `ydb-dstool` с параметром `group decommit`:

```bash
ydb-dstool -e grpcs://<cluster-endpoint>:2135 \
  --ca-file <path-to-ca-cert> \
  --token-file ~/ydb_token \
  group decommit \
  --group-ids <GROUP_ID> \
  --database=/Root/<database-name> \
  --wait
```

### Параметры команды

* `-e <endpoint>` — адрес кластера (например, `grpcs://static-node-1.ydb-cluster.com:2135`);
* `--ca-file <path>` — путь к файлу сертификата CA для TLS-соединения;
* `--token-file <path>` — путь к файлу с токеном аутентификации;
* `--group-ids <GROUP_ID>` — идентификатор группы для декомиссии (можно указать несколько групп через пробел);
* `--database=<DB>` — путь к [базе данных](../../concepts/glossary.md#database) или домену, в котором выполняется декомиссия (например, `/Root/database`);
* `--wait` — дождаться запуска декомиссии; в случае возникновения ошибки запуска ошибка выводится на экран, декомиссия отменяется автоматически (только при указании этой опции).

### Дополнительные параметры

При необходимости можно указать [пулы хранения](../../concepts/glossary.md#storage-pool) для размещения [каналов](../../concepts/glossary.md#channel) виртуальной группы:

* `--log-channel-sp=POOL_NAME` — название пула, в котором будет размещён канал 0 виртуальной группы;
* `--snapshot-channel-sp=POOL_NAME` — название пула, в котором будет размещён канал 1 виртуальной группы; если не указан, то используется значение из `--log-channel-sp`;
* `--data-channel-sp=POOL_NAME[*COUNT]` — название пула, в котором размещаются каналы данных; если указан параметр COUNT (после знака "звёздочка"), то создаётся COUNT каналов данных в указанном пуле.

Если ни `--log-channel-sp`, ни `--snapshot-channel-sp`, ни `--data-channel-sp` не указаны, то автоматически находится [пул хранения](../../concepts/glossary.md#storage-pool), которому принадлежит декомиссуемая группа, и в нём заводится нулевой и первый канал виртуальной группы, а также N каналов данных, где N — число оставшихся физических групп в этом пуле.

### Пример команды

```bash
ydb-dstool -e grpcs://static-node-1.ydb-cluster.com:2135 \
  --ca-file /home/ubuntu/ansible-11-nov-244/3-nodes-mirror-3-dc/files/TLS/certs/ca.crt \
  --token-file ~/ydb_token \
  group decommit \
  --group-ids 2181038080 \
  --database=/Root/database \
  --wait
```

## Проверка статуса декомиссии

После запуска декомиссии можно проверить её статус с помощью команды:

```bash
ydb-dstool -e grpcs://<cluster-endpoint>:2135 \
  --ca-file <path-to-ca-cert> \
  --token-file ~/ydb_token \
  group list --virtual-groups-only
```

В выводе команды для декомиссуемых групп появляется дополнительное поле `DecommitStatus`, которое может принимать одно из следующих значений:

* `NONE` — декомиссия для указанной группы не производится;
* `PENDING` — ожидается декомиссия группы, но ещё не выполняется (создаётся виртуальная группа);
* `IN_PROGRESS` — производится декомиссия группы (все записи уже попадают в виртуальную группу, чтения — в виртуальную группу и в старую группу);
* `DONE` — декомиссия завершена полностью.

### Пример вывода команды

```
┌────────────┬──────────────┬───────────────┬────────────┬────────────────┬─────────────────┬──────────────┬───────────────────┬──────────────────┬───────────────────┬─────────────┬────────────────┐
│ GroupId    │ BoxId:PoolId │ PoolName      │ Generation │ ErasureSpecies │ OperatingStatus │ VDisks_TOTAL │ VirtualGroupState │ VirtualGroupName │ BlobDepotId       │ ErrorReason │ DecommitStatus │
├────────────┼──────────────┼───────────────┼────────────┼────────────────┼─────────────────┼──────────────┼───────────────────┼──────────────────┼───────────────────┼─────────────┼────────────────┤
│ 2181038080 │ [1:1]        │ /Root:ssd     │ 2          │ block-4-2      │ FULL            │ 8            │ WORKING           │                  │ 72075186224038160 │             │ IN_PROGRESS    │
│ 2181038081 │ [1:1]        │ /Root:ssd     │ 2          │ block-4-2      │ FULL            │ 8            │ WORKING           │                  │ 72075186224038161 │             │ IN_PROGRESS    │
│ 4261412864 │ [1:2]        │ /Root:virtual │ 0          │ none           │ DISINTEGRATED   │ 0            │ WORKING           │ vg1              │ 72075186224037888 │             │ NONE           │
└────────────┴──────────────┴───────────────┴────────────┴────────────────┴─────────────────┴──────────────┴───────────────────┴──────────────────┴───────────────────┴─────────────┴────────────────┘
```