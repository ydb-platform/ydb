# Декомиссия групп с использованием виртуальных групп

## Описание работы
Физические [группы хранения](../../concepts/glossary.md#storage-group) являются ограниченным ресурсом в [кластере](../../concepts/glossary.md#cluster): их количество определяется размером кластера, и их нельзя удалить, пока в них хранятся данные. Это может привести к ситуации, когда для создания новой [базы данных](../../concepts/glossary.md#database) или расширения существующей не хватает групп, а освободить пространство на физических дисках нельзя, поскольку старые группы содержат данные.

Декомиссия группы хранения позволяет освободить ресурсы физической группы, сохраняя при этом все данные. В процессе декомиссии создаётся [виртуальная группа хранения](../../concepts/glossary.md#virtual-storage-groups), которая начинает принимать запросы вместо физической и начинается процесс копирования данных. После завершения копирования [VDisk](../../concepts/glossary.md#vdisk)'и декомиссуемой группы удаляются, а ресурсы [PDisk](../../concepts/glossary.md#pdisk)'ов освобождаются.

## Этапы процесса декомиссии

### Инициализация виртуальной группы хранения и блокировка записи в декомиссуемую физическую группу

**Что происходит:**
- Создается виртуальная группа
- Блокируется запись новых данных в физическую группу
- Все новые записи начинают идти в виртуальную группу

**Статус:** `DecommitStatus: PENDING` → `IN_PROGRESS`

**Время:** Обычно доли секунды (может быть кратковременная пауза для клиентов)

### Копирование метаданных

**Что происходит:**
- Копируются метаданные всех блобов (информация о том, какие данные есть, но не сами данные)

**Статус:** `DecommitStatus: IN_PROGRESS`

**Время:** Обычно секунды

### Копирование данных

**Что происходит:**
- Читаются данные из физической группы
- Записываются в другие физические группы через виртуальную группу
- Данные распределяются по нескольким группам для балансировки

**Статус:** `DecommitStatus: IN_PROGRESS`

**Время:** Зависит от объема данных (может быть часы для больших групп)

### Завершение и удаление дисков

**Что происходит:**
- Все данные скопированы
- Удаляются VDisk из физической группы
- Освобождаются ресурсы [PDisk](../../concepts/glossary.md#pdisk)
- Группа помечается как декомиссированная

**Статус:** `DecommitStatus: IN_PROGRESS` → `DONE`

**Время:** Минуты (удаление VDisk)

## Предварительные требования

Инструкция по декомиссии групп работает при выполнении следующих условий:

1. Развернутый [кластер](../../concepts/glossary.md#cluster) {{ ydb-short-name }}. Инструкции по развертыванию доступны в разделе [Первоначальное развёртывание](../../devops/deployment-options/manual/initial-deployment.md).
2. Установленная утилита `ydb-dstool`. Инструкции по установке доступны в [документации по установке {{ ydb-short-name }} DSTool](../../reference/ydb-dstool/install.md).
3. Сгенерированный токен аутентификации для доступа к кластеру:

```bash
{{ ydb-cli }} -e grpc://<cluster-endpoint> -d '<db_path>' --user <user> auth get-token -f > ~/ydb_token
```

Замените `<cluster-endpoint>` на адрес вашего кластера, `<db_path>` - путь к базе данных, `<user>` на имя пользователя для авторизации.

{% note info %}

Декомиссию можно проводить даже на пустом кластере, наличие данных не обязательно. Однако если в кластере есть данные, это позволит проверить их консистентность после декомиссии. При необходимости можно загрузить тестовые данные с помощью утилиты `ydb workload tpcc`:

```bash
ydb workload tpcc --path tpcc/10wh init -w 100
ydb workload tpcc --path tpcc/10wh import -w 100
ydb workload tpcc --path tpcc/10wh run -w 100
```

Подробнее о работе с тестовой нагрузкой см. в [документации по ydb workload tpcc](../../reference/ydb-cli/workload-tpcc.md).

{% endnote %}

## Запуск декомиссии

### Выбор группы для декомиссии

Перед запуском декомиссии необходимо выбрать группу (group ID), которую вы хотите декомиссировать. Выбирать можно любую группу, однако рекомендуется выбирать менее занятую группу — это поможет завершить процесс декомиссии быстрее. Это можно сделать через веб-интерфейс кластера или с помощью CLI:

{% list tabs %}

- UI (Веб-интерфейс)
  1. Откройте веб-интерфейс управления кластером `https://<cluster-endpoint>:8765`
  2. Откройте вкладку `Storage`
  2. Выберите нужную вам группу и сохраните `Group ID`

- CLI
  1. Выполните команду получения списка групп хранения
   ```bash
  ydb-dstool -e <cluster-endpoint> \
    --ca-file <path-to-ca-cert> \
    --token-file ~/ydb_token \
    group list
  ```
  2. В выводе команды найдите нужную группу и сохраните её `Group ID`.

{% endlist %}

### Команда для запуска

Для запуска декомиссии выполните команду `ydb-dstool` с параметром `group decommit`:

```bash
ydb-dstool -e grpcs://<cluster-endpoint>:2135 \
  --ca-file <path-to-ca-cert> \
  --token-file ~/ydb_token \
  group decommit \
  --group-ids <GROUP_ID> \
  --database /Root/<database-name> \
  --wait
```

### Параметры команды

* `-e <endpoint>` — адрес кластера (например, `grpcs://static-node-1.ydb-cluster.com:2135`);
* `--ca-file <path>` — путь к файлу сертификата CA для TLS-соединения;
* `--token-file <path>` — путь к файлу с токеном аутентификации;
* `--group-ids <GROUP_ID>` — идентификатор группы для декомиссии (можно указать несколько групп через пробел);
* `--database=<DB>` — путь к [базе данных](../../concepts/glossary.md#database) или домену, в котором выполняется декомиссия (например, `/Root/database`);
* `--wait` — дождаться запуска декомиссии; в случае возникновения ошибки запуска ошибка выводится на экран, декомиссия отменяется автоматически (только при указании этой опции).

### Дополнительные параметры

При необходимости можно указать [пулы хранения](../../concepts/glossary.md#storage-pool) для размещения [каналов](../../concepts/glossary.md#channel) виртуальной группы:

* `--log-channel-sp=POOL_NAME` — название пула, в котором будет размещён канал 0 виртуальной группы;
* `--snapshot-channel-sp=POOL_NAME` — название пула, в котором будет размещён канал 1 виртуальной группы; если не указан, то используется значение из `--log-channel-sp`;
* `--data-channel-sp=POOL_NAME[*COUNT]` — название пула, в котором размещаются каналы данных; если указан параметр COUNT (после знака "звёздочка"), то создаётся COUNT каналов данных в указанном пуле.

Если ни `--log-channel-sp`, ни `--snapshot-channel-sp`, ни `--data-channel-sp` не указаны, то автоматически находится [пул хранения](../../concepts/glossary.md#storage-pool), которому принадлежит декомиссуемая группа, и в нём заводится нулевой и первый канал виртуальной группы, а также N каналов данных, где N — число оставшихся физических групп в этом пуле.

### Пример команды

```bash
ydb-dstool -e grpcs://static-node-1.ydb-cluster.com:2135 \
  --ca-file /home/ubuntu/ansible-11-nov-244/3-nodes-mirror-3-dc/files/TLS/certs/ca.crt \
  --token-file ~/ydb_token \
  group decommit \
  --group-ids 2181038081 \
  --database=/Root/database \
  --wait
```

## Проверка статуса декомиссии

После запуска декомиссии можно проверить её статус с помощью команды:

```bash
ydb-dstool -e grpcs://<cluster-endpoint>:2135 \
  --ca-file <path-to-ca-cert> \
  --token-file ~/ydb_token \
  group list --columns GroupId PoolName \
  ErasureSpecies OperatingStatus VDisks_TOTAL BlobDepotId DecommitStatus
```

В выводе команды для декомиссуемых групп появляется дополнительное поле `DecommitStatus`, которое может принимать одно из следующих значений:

* `NONE` — декомиссия для указанной группы не производится;
* `PENDING` — ожидается декомиссия группы, но ещё не выполняется (создаётся виртуальная группа);
* `IN_PROGRESS` — производится декомиссия группы (все записи уже попадают в виртуальную группу, чтения — в виртуальную группу и в старую группу);
* `DONE` — декомиссия завершена полностью (физическая группа превратилась в виртуальную).

### Пример вывода команды

```
┌────────────┬────────────────────┬────────────────┬─────────────────┬──────────────┬───────────────────┬────────────────┐
│ GroupId    │ PoolName           │ ErasureSpecies │ OperatingStatus │ VDisks_TOTAL │ BlobDepotId       │ DecommitStatus │
├────────────┼────────────────────┼────────────────┼─────────────────┼──────────────┼───────────────────┼────────────────┤
│ 2181038080 │ /Root/database:ssd │ mirror-3-dc    │ FULL            │ 9            │ 0                 │ NONE           │
│ 2181038081 │ /Root/database:ssd │ mirror-3-dc    │ FULL            │ 0            │ 72075186224038889 │ DONE           │
│ 2181038082 │ /Root/database:ssd │ mirror-3-dc    │ FULL            │ 9            │ 0                 │ NONE           │
│ 2181038083 │ /Root/database:ssd │ mirror-3-dc    │ FULL            │ 9            │ 0                 │ NONE           │
│ 2181038084 │ /Root/database:ssd │ mirror-3-dc    │ FULL            │ 9            │ 0                 │ NONE           │
│ 2181038085 │ /Root/database:ssd │ mirror-3-dc    │ FULL            │ 9            │ 0                 │ NONE           │
│ 2181038086 │ /Root/database:ssd │ mirror-3-dc    │ FULL            │ 9            │ 0                 │ NONE           │
│ 2181038087 │ /Root/database:ssd │ mirror-3-dc    │ FULL            │ 9            │ 0                 │ NONE           │
└────────────┴────────────────────┴────────────────┴─────────────────┴──────────────┴───────────────────┴────────────────┘
```

Обратите внимание, что в приведённом выше примере вывода для группы `2181038081` изменилось количество VDisks (оно стало равно 0), появилась id виртуальной группы в поле `BlobDepotId`, а статус декомиссии (`DecommitStatus`) изменился на `DONE`. Это отражает успешное завершение процедуры декомиссии для данной группы.