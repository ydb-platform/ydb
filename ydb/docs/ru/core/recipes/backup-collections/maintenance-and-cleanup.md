# Обслуживание и очистка резервных копий

Управление жизненным циклом резервных копий и очистка старых резервных копий для контроля использования хранилища.

## Определение цепочек резервных копий

Каталоги резервных копий именуются с временными метками и суффиксами (`_full` или `_incremental`). Инкрементальные резервные копии принадлежат последней полной резервной копии, которая предшествует им хронологически.

```bash
# Список резервных копий, отсортированный по времени
ydb scheme ls .backups/collections/production_backups/ | sort
```

Пример вывода:
```
20250208141425Z_full        # Цепочка 1: полная резервная копия
20250209141519Z_incremental # Цепочка 1: инкрементальная (принадлежит полной 20250208)
20250210141612Z_incremental # Цепочка 1: инкрементальная (принадлежит полной 20250208)
20250215120000Z_full        # Цепочка 2: новая полная резервная копия начинает новую цепочку
20250216140000Z_incremental # Цепочка 2: инкрементальная (принадлежит полной 20250215)
```

Когда вы создаёте новую полную резервную копию, она начинает новую цепочку. Все инкрементальные копии, созданные после этой полной копии (до следующей полной), принадлежат этой цепочке.

## Ручная очистка

Удаляйте старые цепочки резервных копий, когда они больше не нужны:

```bash
# Удаление старых каталогов резервных копий
ydb scheme rmdir -r .backups/collections/production_backups/20250821141425Z_full/

# Всегда удаляйте полные цепи, никогда не удаляйте частичные цепи
# Пример: Удаление старой полной резервной копии и всех её инкрементальных копий
ydb scheme rmdir -r .backups/collections/production_backups/20250821141425Z_full/
ydb scheme rmdir -r .backups/collections/production_backups/20250821141451Z_incremental/
ydb scheme rmdir -r .backups/collections/production_backups/20250822070000Z_incremental/
```

{% note warning %}

Никогда не удаляйте отдельные резервные копии из середины цепочки. Удаление полной резервной копии делает все её инкрементальные копии невосстановимыми. Всегда удаляйте полные цепочки целиком.

{% endnote %}

## Удаление коллекции

Удалите всю коллекцию резервных копий, когда она больше не нужна:

```sql
-- Удаление коллекции, когда она больше не нужна (удаляет коллекцию и все резервные копии)
DROP BACKUP COLLECTION old_collection_name;
```

## Безопасный процесс очистки

1. Создайте новую полную резервную копию
2. Убедитесь, что новая резервная копия завершена
3. Экспортируйте старые цепочки резервных копий во внешнее хранилище при необходимости
4. Удалите старые цепочки резервных копий (полную копию + все её инкрементальные копии вместе)

## Советы по управлению хранилищем

- **Отслеживайте рост хранилища**: регулярно контролируйте использование хранилища резервных копий
- **Установите политики хранения**: определите, как долго хранить цепочки резервных копий
- **Периодически начинайте новые цепочки**: создавайте новые полные резервные копии еженедельно или раз в две недели для ограничения длины цепочки
- **Экспортируйте перед удалением**: всегда экспортируйте во внешнее хранилище перед удалением резервных копий из кластера

## Следующие шаги

- [Проверка и тестирование резервных копий](validation-and-testing.md)
- [Экспорт резервных копий во внешнее хранилище](exporting-to-external-storage.md)
