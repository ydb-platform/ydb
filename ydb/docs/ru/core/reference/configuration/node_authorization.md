# Авторизация узлов баз данных

Функция авторизации узлов обеспечивает проверку подлинности узлов баз данных при их регистрации в состав кластера {{ ydb-short-name }}. Использование авторизации узлов рекомендовано для всех кластеров {{ ydb-short-name }}, поскольку позволяет избежать ситуаций несанкционированного доступа к данным через включение в кластер контролируемых злоумышленником узлов.

Далее описаны действия, необходимые для включения функции авторизации узлов.

## Включение TLS для трафика gRPC и подготовка сертификатов узлов

Перед включением функции авторизации узлов необходимо [настроить шифрование трафика gRPC](./tls.md#grpc) с использованием протокола TLS.

При подготовке сертификатов узлов для кластера, в котором планируется использовать функцию авторизации узлов, необходимо обеспечить единые правила заполнения поля "Subject" сертификатов. При проверке сертификата в процессе регистрации узла {{ ydb-short-name }} убеждается в наличии у подключающегося узла доверенного сертификата, и проверяет заполнение поля "Subject" на соответствие  требованиям, устанавливаемым в статической конфигурации {{ ydb-short-name }}. Поле "Subject" может состоять из нескольких компонентов (например `O` - организация, `OU` - подразделение в составе организации, `C` - страна, `CN` - имя собственное субъекта), и проверки могут быть настроены в отношении одного или нескольких компонентов.

Предлагаемый [пример скрипта](https://github.com/ydb-platform/ydb/blob/main/ydb/deploy/tls_cert_gen/) для генерации самоподписанных сертификатов узлов {{ ydb-short-name }} обеспечивает заполнение поля "Subject" значением `O=YDB` для всех сертификатов узлов. Приведенные далее примеры настроек подготовлены для сертификатов с именно таким заполнением поля "Subject".

В параметры командной строки для [запуска узлов баз данных](../../devops/manual/initial-deployment.md#start-dynnode) необходимо добавить опции, устанавливающие пути к файлам сертификатов доверенных центров сертификации, сертификата узла и ключа узла. Состав дополнительно передаваемых опций указан в таблице ниже.

| **Опция командной строки** | **Описание** |
|----------------------------|--------------|
| `--grpc-ca`                | Путь к файлу сертификатов доверенных центров сертификации `ca.crt` |
| `--grpc-cert`              | Путь к файлу сертификата узла `node.crt` |
| `--grpc-key`               | Путь к файлу секретного ключа узла `node.key` |

Пример команды запуска узла базы данных, дополненной опциями с указанием путей к ключам и сертификатам TLS для протокола gRPC:

```bash
/opt/ydb/bin/ydbd server --yaml-config  /opt/ydb/cfg/config.yaml --tenant /Root/testdb \
    --grpcs-port 2136 --grpc-ca /opt/ydb/certs/ca.crt \
    --grpc-cert /opt/ydb/certs/node.crt --grpc-key /opt/ydb/certs/node.key \
    --ic-port 19002 --ca /opt/ydb/certs/ca.crt \
    --mon-port 8766 --mon-cert /opt/ydb/certs/web.pem \
    --node-broker grpcs://<ydb1>:2135 \
    --node-broker grpcs://<ydb2>:2135 \
    --node-broker grpcs://<ydb3>:2135
```

## Включение режима авторизации узлов

Для включения обязательной авторизации узлов баз данных в файл [статической конфигурации кластера](./index.md) необходимо добавить следующие блоки настроек:

1. На корневом уровне конфигурации добавьте блок `client_certificate_authorization`, в котором укажите требования к заполнению поля "Subject" доверенных сертификатов подключаемых узлов, например:

    ```yaml
    client_certificate_authorization:
      request_client_certificate: true
      client_certificate_definitions:
        - member_groups: ["registerNode@cert"]
          subject_terms:
          - short_name: "O"
            values: ["YDB"]
    ```

    В случае успешной проверки сертификата и при условии соответствия заполнения компонентов поля "Subject" сертификата установленным в блоке `subject_terms` требованиям, подключению будут присвоены субъекты доступа, перечисленные в параметре `member_groups`. Для отделения таких субъектов доступа от других разновидностей групп и учетных записей к их наименованию добавляется суффикс `@cert`.

1. В блок `domains_config / security_config` добавьте элемент `register_dynamic_node_allowed_sids`, в котором укажите список субъектов доступа, для которых разрешена регистрация узлов баз данных. По техническим причинам в этом списке также должен присутствовать субъект доступа `root@builtin`. Пример:

    ```yaml
    domains_config:
        ...
        security_config:
            enforce_user_token_requirement: true
            monitoring_allowed_sids:
            ...
            administration_allowed_sids:
            ...
            viewer_allowed_sids:
            ...
            register_dynamic_node_allowed_sids:
            - "root@builtin" # требуется по техническим причинам
            - "registerNode@cert"
    ```
