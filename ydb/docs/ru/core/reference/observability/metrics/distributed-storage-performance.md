# Метрики производительности распределённого хранилища

Распределённое хранилище {{ ydb-short-name }} обладает определённой пропускной способностью, ограниченной ресурсами физических устройств в кластере, и может обеспечивать низкое время отклика, если нагрузка не превышает эту пропускную способность. Метрики производительности отображают количество доступных ресурсов физических устройств и позволяют оценить уровень их потребления. По значениям метрик производительности можно отслеживать, выполнены ли необходимые условия для гарантии низкого времени отклика распределённого хранилища, а именно, что средний поток нагрузки не превышает предельно допустимый, и что отсутствуют краткосрочные всплески нагрузки.

### Модель стоимости запроса

Стоимость запроса — это оценка времени в условных единицах, которое затратит физическое устройство на выполнение этой операции. Стоимость запроса вычисляется по простой модели физического устройства. Мы предполагаем, что физическое устройство может одновременно выполнять только один запрос на чтение или на запись. На выполнение операции уходит определённое время работы устройства, соотвественно, суммарное время выполнения запросов за определнённый промежуток времени не может превышать величину этого промежутка. 

Стоимость запроса вычисляется по линейной формуле:

$$
cost(operation) = A + operation.size() \times B
$$

Физический смысл линейной зависимости таков: коэффициент $A$ — это время, необходимое физическому устройству для получения доступа к данным, коэффициент $B$ — это время, необходимое для чтения или записи одного байта.

Коэффициенты $A$ и $B$ зависят от типа запроса и типа устройства и были измерены экспериментально для каждого типа устройства и каждого типа запроса.

В системе {{ ydb-short-name }} все физические устройства делятся на три типа: HDD, SATA SSD (далее SSD) и NVMe SSD (далее NVMe). HDD — это вращающиеся жёсткие диски, которые отличаются высоким временем доступа к данным. Типы SSD и NVMe различаются интерфейсом: NVMe обеспечивает более высокую скорость выполнения операций.

Операции делятся на три типа: чтение, запись и huge-запись. Разделение записи на обычную и huge-запись обусловлено спецификой записи данных VDisk'ом.

Помимо пользовательских запросов, нагрузку на распределенное хранилище создают фоновые процессы компакшена, скраббинга и дефрагментации, а также внутренняя коммуникация между VDisk'ами. Процесс компакшена может создавать особенно высокую нагрузку при достаточно большом потоке записей маленьких блобов.

### Доступное время диска {#diskTimeAvailable}

Планировщик PDisk управляет порядком выполнения запросов PDisk'ом от его клиентов-VDisk'ов. PDisk честно делит время устройства между своими VDisk'ами, то есть каждому из $N$ VDisk'ов гарантируется $1/N$ секунд работы физического устройства каждую секунду. 
Доступное время диска - это оценка времени работы физического устройства, которое планировщик PDisk выделит данному VDisk'у. Доступное время диска измеряется в тех же условных единицах, что и стоимость запроса. На основе информации о количестве VDisk'ов-соседей для каждого VDisk'а, которое мы обозначим как $N$, и настраиваемого параметра `DiskTimeAvailableScale` вычисляется доступное время диска по формуле
$$
    DiskTimeAvailable = \dfrac{1000000000}{N} \cdot \dfrac{DiskTimeAvailableScale}{1000} 
$$

### Обнаружение всплесков нагрузки {#burstDetection}

Всплеск - это резкое краткосрочное повышение нагрузки на VDisk, которое может приводить к деградации времени отклика операций. Значения сенсоров с нод кластера собираются через определенные промежутки времени, например, раз в 15 секунд, что делает невозможным надежное обнаружение краткосрочных событий с помощью одних только метрик стоимости запросов и доступного времени диска. Для обнаружения всплесков нагрузки используется модифицированный [алгоритм Token Bucket](https://ru.wikipedia.org/wiki/%D0%90%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC_%D1%82%D0%B5%D0%BA%D1%83%D1%89%D0%B5%D0%B3%D0%BE_%D0%B2%D0%B5%D0%B4%D1%80%D0%B0), в нашей модификации в ведре может быть отрицательное количество токенов, и такое состояние мы будем называть underflow. К каждому VDisk'у привязан отдельный объект Token Bucket. Минимальное ожидаемое время отклика, при котором повышение нагрузки считается всплеском, определяется настраиваемым параметром `BurstThresholdNs`. Ведро будет перехдить в состояние underflow, если расчетная длительность обработки всплеска запросов в наносекундах превысит значение `BurstThresholdNs`.

### Метрики производительности
Метрики производительности вычисляются на основе следующих сенсоров VDisk'а:
| Название сенсора      | описание                                                                                                              | единицы измерения |
|-----------------------|-----------------------------------------------------------------------------------------------------------------------|-------------------|
| `DiskTimeAvailable`   | Доступное время диска.                                                                                                | условные единицы  |
| `UserDiskCost`        | Суммарная стоимость запросов, полученных VDisk'ом из DS Proxy.                                                        | условные единицы  |
| `InternalDiskCost`    | Суммарная стоимость запросов, полученных VDisk'ом от другого VDisk'а группы, например, в рамках процесса репликации.  | условные единицы  |
| `CompactionDiskCost`  | Суммарная стоимость запросов, отправленных VDisk'ом в рамках системного процесса компакшена.                          | условные единицы  |
| `DefragDiskCost`      | Суммарная стоимость запросов, отправленных VDisk'ом в рамках системного процесса дефрагментации.                      | условные единицы  |
| `ScrubDiskCost`       | Суммарная стоимость запросов, отправленных VDisk'ом в рамках системного процесса скраббинга.                          | условные единицы  |
| `BurstDetector_redMs` | Время в миллисекундах, на протяжении которого Token Bucket находился в состоянии underflow.                           | мс                |

`DiskTimeAvailable` и стоимость запроса являются оценками доступной и потребленной пропускной способности, соответственно, а не реально измеренным временем, поэтому измеряются обе эти величины в условных единицах, которые по своему физическому смыслу близки к наносекундам.

Метрики производительности выведены на [специальный дашборд Grafana](grafana-dashboards.md#ds-performance).

### Условия гарантий распределённого хранилища {#requirements}
Распределённое хранилище {{ ydb-short-name }} может обеспечивать низкое время отклика только при соблюдении следующих условий:

1. `DiskTimeAvailable >= UserDiskCost + InternalDiskCost + CompactionDiskCost + DefragDiskCost + ScrubDiskCost` — средний поток нагрузки не превышает предельно допустимый.
2. `BurstDetector_redMs = 0` — отсутствуют краткосрочные пики нагрузки, приводящие к образованию очередей запросов.

### Настройка метрик производительности

Поскольку коэффициенты для формулы стоимости запроса измерялись на конкретных физических устройствах с кластеров для разработчиков, а производительность других устройств может отличаться, метрики могут потребовать дополнительной настройки для использования их в качестве источника гарантий распределённого хранилища. Параметрами для калибровки метрик производительности можно управлять через [динамическую конфигурацию кластера](../../../maintenance/manual/dynamic-config.md) и механизм Immediate Controls без рестарта процессов {{ ydb-short-name }}.

| Название параметра                | Описание                                                                                                  | единицы измерения | Значение по умолчанию |
|-----------------------------------|-----------------------------------------------------------------------------------------------------------|-------------------|-----------------------|
| `disk_time_available_scale_hdd`   | [Параметр `DiskTimeAvailableScale`](#diskTimeAvailable) для VDisk'ов, запущенных поверх HDD-устройств.    | условные единицы  | `1000`                |
| `disk_time_available_scale_ssd`   | [Параметр `DiskTimeAvailableScale`](#diskTimeAvailable) для VDisk'ов, запущенных поверх SSD-устройств.    | условные единицы  | `1000`                |
| `disk_time_available_scale_nvme`  | [Параметр `DiskTimeAvailableScale`](#diskTimeAvailable) для VDisk'ов, запущенных поверх NVMe-устройств.   | условные единицы  | `1000`                |
| `burst_threshold_ns_hdd`          | [Параметр `BurstThresholdNs`](#burstDetection) для VDisk'ов, запущенных поверх HDD-устройств.              | нс                | `200000000`           |
| `burst_threshold_ns_ssd`          | [Параметр `BurstThresholdNs`](#burstDetection) для VDisk'ов, запущенных поверх SSD-устройств.              | нс                | `50000000`            |
| `burst_threshold_ns_nvme`         | [Параметр `BurstThresholdNs`](#burstDetection) для VDisk'ов, запущенных поверх NVMe-устройств.             | нс                | `32000000`            |

#### Примеры конфигурации метрик
Если в кластере {{ ydb-short-name }} используются NVMe-устройства и этот кластер обеспечивает на 10% более высокую производительность, чем эталон, то необходимо добавить следующую секцию в настройки `immediate_controls_config` динамической конфигурации кластера:
```
vdisk_controls:
  disk_time_available_scale_nvme: 1100
```

Если в кластере {{ ydb-short-name }} используются HDD-устройства и в условиях поданной нагрузки максимально допустимое время отклика составляет 500 мс, то необходимо добавить следующую секцию в настройки `immediate_controls_config` динамической конфигурации кластера:
```
vdisk_controls:
  burst_threshold_ns_hdd: 500000000
```

### Как сравнить производительность кластера {{ ydb-short-name }} с эталоном

Чтобы сравнить производительность распределённого хранилища на кластере {{ ydb-short-name }} с эталонной, необходимо загрузить его запросами до такого состояния, когда VDisk'и не могут обрабатывать поток входящих запросов. В этот момент запросы начинают выстраиваться в очередь, и время отклика VDisk'ов резко возрастает. В момент, предшествующий перегрузке необходимо посчитать величину $D$:
$$
D = \frac{UserDiskCost + InternalDiskCost + CompactionDiskCost + DefragDiskCost + ScrubDiskCost}{DiskTimeAvailable}
$$
Далее надо задать параметр `disk_time_available_scale_<тип используемых устройств>` конфигурации равным рассчитанному значению $D$, умноженному на 1000 и округленному. Предполагается, что физические устройства на пользовательском кластере по производительности сравнимы с эталоном, поэтому по умолчанию параметр `disk_time_available_scale_<тип используемых устройств>` равен 1000.

Создать подобную нагрузку можно, например, с помощью [Storage LoadActor](../../../contributor/load-actors-storage.md).
