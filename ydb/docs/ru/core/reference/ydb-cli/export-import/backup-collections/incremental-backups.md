# Инкрементальные резервные копии

Инкрементальные резервные копии позволяют создавать быстрые и экономичные бэкапы, сохраняя только изменения с момента предыдущего бэкапа.

## Основные принципы

### Что такое инкрементальный бэкап

Инкрементальная резервная копия содержит только те данные, которые изменились с момента создания предыдущего бэкапа в цепочке. Это существенно сокращает:

- Время создания бэкапа
- Объем используемого дискового пространства
- Нагрузку на систему

### Цепочка бэкапов

```
Полный бэкап → Инкрементальный 1 → Инкрементальный 2 → Инкрементальный 3
    (День 1)         (День 2)            (День 3)            (День 4)
```

Для восстановления на День 4 потребуются все бэкапы: полный + инкрементальные 1, 2, 3.

## Создание инкрементальных бэкапов

### Базовый синтаксис

```sql
-- Создание инкрементального бэкапа
BACKUP `collection_name` INCREMENTAL;
```

### Предварительные условия

1. **Коллекция должна существовать**
2. **Должен быть создан хотя бы один полный бэкап**
3. **Предыдущая операция должна быть завершена**

### Пример создания цепочки

```sql
-- День 1: Создание коллекции и полного бэкапа
CREATE BACKUP COLLECTION `daily_backup`
    ( TABLE `/Root/shop/orders`
    , TABLE `/Root/shop/products`
    )
WITH ( STORAGE = 'cluster' );

BACKUP `daily_backup`;

```sql
-- День 2: Первый инкрементальный бэкап
BACKUP `daily_backup` INCREMENTAL;
```

```sql
-- День 3: Второй инкрементальный бэкап
BACKUP `daily_backup` INCREMENTAL;
```

## Мониторинг операций

### Отслеживание прогресса

```bash
# Список всех операций инкрементального резервного копирования
{{ ydb-cli }} operation list incbackup
```

```bash
# Получение статуса конкретной операции
{{ ydb-cli }} operation get "ydb://incbackup/N?id=<operation-id>"
```

```bash
# Получение ID последней операции для автоматизации
OPERATION_ID=$({{ ydb-cli }} operation list incbackup --format proto-json-base64 | jq -r '.operations[0].id')
{{ ydb-cli }} operation get "$OPERATION_ID"
```

## Практические сценарии

### Сценарий 1: Ежедневные бэкапы

```bash
#!/bin/bash
# daily_backup.sh - Скрипт для ежедневного инкрементального бэкапа

COLLECTION_NAME="prod_daily_backup"
LOG_FILE="/var/log/ydb_backup.log"

echo "$(date): Запуск инкрементального бэкапа" >> $LOG_FILE

# Создание инкрементального бэкапа
{{ ydb-cli }} yql -s "BACKUP \`${COLLECTION_NAME}\` INCREMENTAL;"

# Отслеживание операции
sleep 5
OPERATION_ID=$({{ ydb-cli }} operation list incbackup --format proto-json-base64 | jq -r '.operations[0].id')

if [ ! -z "$OPERATION_ID" ]; then
    echo "$(date): Операция запущена: $OPERATION_ID" >> $LOG_FILE
    {{ ydb-cli }} operation get "$OPERATION_ID" >> $LOG_FILE
fi
```

### Сценарий 2: Недельный цикл с полным бэкапом по воскресеньям

```bash
#!/bin/bash
# weekly_backup_cycle.sh

COLLECTION_NAME="weekly_backup"

# Определяем день недели (1=понедельник, 7=воскресенье)
DAY_OF_WEEK=$(date +%u)

if [ $DAY_OF_WEEK -eq 7 ]; then
    # Воскресенье - полный бэкап
    echo "Создание полного бэкапа: $(date)"
    {{ ydb-cli }} yql -s "BACKUP \`${COLLECTION_NAME}\`;"
else
    # Остальные дни - инкрементальный
    echo "Создание инкрементального бэкапа: $(date)"
    {{ ydb-cli }} yql -s "BACKUP \`${COLLECTION_NAME}\` INCREMENTAL;"
fi

## Преимущества и ограничения

### Преимущества

1. **Скорость**: Инкрементальные бэкапы создаются значительно быстрее
2. **Экономия места**: Требуют меньше дискового пространства
3. **Меньшая нагрузка**: Снижают влияние на производительность системы
4. **Частота**: Можно создавать чаще без существенных затрат ресурсов

### Ограничения

1. **Зависимость от цепочки**: Для восстановления нужны все бэкапы в цепочке
2. **Максимальная длина**: Не более 100 инкрементальных бэкапов в цепочке
3. **Последовательность**: Нельзя удалить промежуточный бэкап без нарушения целостности
4. **Время восстановления**: Может быть больше из-за необходимости обработки цепочки

## Лучшие практики

### Планирование частоты

- **Полные бэкапы**: Еженедельно (например, по воскресеньям)
- **Инкрементальные**: Ежедневно или несколько раз в день
- **Критичные системы**: Каждые несколько часов

### Мониторинг цепочки

```bash
# Подсчет количества инкрементальных бэкапов в цепочке
INCREMENTAL_COUNT=$({{ ydb-cli }} operation list incbackup --format proto-json-base64 | jq '.operations | length')
echo "Количество инкрементальных операций: $INCREMENTAL_COUNT"

if [ $INCREMENTAL_COUNT -gt 80 ]; then
    echo "ВНИМАНИЕ: Цепочка приближается к максимальной длине (100)"
    echo "Рекомендуется создать новый полный бэкап"
fi
```

### Очистка операций

```bash
# Скрипт для очистки завершенных операций
cleanup_completed_operations() {
    echo "Очищаем завершенные операции резервного копирования..."
    {{ ydb-cli }} operation list incbackup --format proto-json-base64 | \
    jq -r '.operations[] | select(.ready==true and .status=="SUCCESS") | .id' | \
    while read operation_id; do
        echo "Удаляем операцию: $operation_id"
        {{ ydb-cli }} operation forget "$operation_id"
    done
}
```

## См. также

- [SQL API](sql-api.md) - Справочник команд резервного копирования
- [Создание коллекций](create-collection.md) - Создание и настройка коллекций
- [Восстановление](restore-from-collection.md) - Процедуры восстановления из бэкапов
- [Управление операциями](manage-collections.md) - Мониторинг и управление операциями
