# Операции с коллекциями резервных копий

В этом разделе рассматриваются все операции по созданию, управлению и восстановлению из [коллекций резервных копий](../../../concepts/backup/collections.md). Полный справочник по синтаксису команд см. в [Синтаксис коллекций резервных копий YQL](../../../yql/reference/syntax/backup-collections.md).

## Создание коллекций {#creating-collections}

### Создание коллекции с помощью SQL

Используйте SQL API для создания новой коллекции резервных копий. Подробный синтаксис см. в [SQL API CREATE BACKUP COLLECTION](sql-api.md#create-backup-collection).

**Базовый пример:**

```sql
CREATE BACKUP COLLECTION `shop_backups`
    ( TABLE `/Root/test1/orders`, TABLE `/Root/test1/products` )
WITH ( STORAGE = 'cluster', INCREMENTAL_BACKUP_ENABLED = 'true' );
```

## Создание резервных копий {#taking-backups}

### Начальная полная резервная копия

После создания коллекции создайте начальную полную резервную копию:

```sql
BACKUP `shop_backups`;
```

Первая резервная копия без ключевого слова `INCREMENTAL` создает полную резервную копию, содержащую все данные из указанных таблиц.

### Инкрементальные резервные копии

После создания полной резервной копии можно создавать инкрементальные резервные копии:

```sql
BACKUP `shop_backups` INCREMENTAL;
```

**Лучшие практики:**

- Создавайте инкрементальные резервные копии по регулярному расписанию (ежедневно, ежечасно и т.д.).
- Держите цепочки резервных копий разумно короткими (рекомендуется 7-14 инкрементальных резервных копий).
- Отслеживайте завершение создания резервных копий и целостность цепочки.

Подробные рекомендации и управление цепочками см. в [Правилах целостности цепочки](concepts.md#chain-validity-rules).

## Мониторинг операций {#monitoring-operations}

Все операции резервного копирования выполняются в фоновом режиме и могут отслеживаться с помощью команды [operation list](../../operation-list.md):

```bash
ydb operation list incbackup
```

Эта команда показывает все операции инкрементального резервного копирования и их текущий статус.

### Планирование резервного копирования

Для автоматизированных резервных копий можно планировать SQL команды:

```sql
-- Пример ежедневного расписания
-- Полная резервная копия каждое воскресенье
BACKUP `shop_backups`;

-- Инкрементальные резервные копии с понедельника по субботу
BACKUP `shop_backups` INCREMENTAL;
```

## Управление коллекциями {#managing-collections}

### Просмотр коллекций в схеме

Коллекции резервных копий отображаются как директории в схеме базы данных. Их можно просматривать с помощью стандартной навигации по схеме:

```bash
ydb scheme ls .backups/collections/
```

Это показывает все коллекции резервных копий как директории в пути `.backups/collections/`.

### Просмотр информации о коллекции

Поскольку коллекции управляются через SQL, их можно просматривать в схеме:

```bash
# Просмотр всех коллекций
ydb scheme ls .backups/collections/

# Просмотр структуры конкретной коллекции
ydb scheme ls .backups/collections/shop_backups/
```

### Статус коллекции и мониторинг

Проверка статуса коллекции и резервных копий:

```bash
# Просмотр содержимого директории коллекции
ydb scheme ls .backups/collections/shop_backups/

# Проверка недавних резервных копий
ydb scheme ls .backups/collections/shop_backups/ | sort
```

## Хранение и очистка {#retention-cleanup}

### Ручная очистка с помощью SQL

Очистка старых резервных копий с сохранением целостности цепочки с помощью SQL команд:

```bash
# Сначала просмотрите структуру резервных копий
ydb scheme ls .backups/collections/shop_backups/

# Удалите конкретные директории резервных копий с помощью rmdir
ydb scheme rmdir -r .backups/collections/shop_backups/backup_20240315/

# Для очистки на основе таблиц используйте DROP TABLE
ydb scheme describe .backups/collections/shop_backups/backup_20240315/
```

Для очистки на основе SQL:

```sql
-- Удаление конкретных таблиц резервных копий (синтаксис может отличаться)
-- Осторожно: Убедитесь, что не нарушаете цепочки резервных копий
DROP TABLE `.backups/collections/shop_backups/backup_20240315/table_name`;
```

### CLI операции для резервных копий

Используйте команды операций YDB, где доступно:

```bash
# Список операций (может включать операции резервного копирования)
ydb operation list incbackup

# Проверка статуса конкретной операции
ydb operation get <operation-id>
```

**Важные соображения по хранению:**

{% note warning %}

Правила целостности цепочки и критические предупреждения об удалении см. в [Правилах целостности цепочки](concepts.md#chain-validity-rules).

{% endnote %}

- Всегда проверяйте зависимости цепочки перед удалением.
- Используйте просмотр схемы для понимания структуры резервных копий.
- Тестируйте процедуры очистки в непроизводственных средах.

## Проверка и валидация {#verification-validation}

### Проверка с помощью CLI операций

Используйте команды операций YDB для проверки статуса резервных копий:

```bash
# Список всех операций (включая операции резервного копирования)
ydb operation list incbackup

# Проверка статуса конкретной операции резервного копирования
ydb operation get <operation-id>

# Список операций восстановления
ydb operation list restore
```

### Валидация на основе схемы

Проверка существования и структуры резервных копий через просмотр схемы:

```bash
# Проверка существования коллекции
ydb scheme ls .backups/collections/shop_backups/

# Проверка временных меток и структуры резервных копий
ydb scheme describe .backups/collections/shop_backups/

# Список содержимого резервных копий
ydb scheme ls .backups/collections/shop_backups/ | sort
```

### Валидация перед восстановлением

Перед критическими восстановлениями всегда проверяйте:

1. **Полноту цепочки резервных копий**
2. **Готовность целевой среды**
3. **Необходимые разрешения и доступ**

## Операции восстановления {#restore-operations}

### Экспорт и импорт резервных копий

Экспорт резервных копий из исходной базы данных:

```bash
ydb tools dump -p .backups/collections/shop_backups -o shop_backups_export
```

**Сначала создайте коллекцию в целевой базе данных:**

```sql
-- Создайте структуру коллекции для получения восстановленных данных
CREATE BACKUP COLLECTION `restored_shop_backups`
    ( TABLE `/Root/restored_db/orders`, TABLE `/Root/restored_db/products` )
WITH ( STORAGE = 'cluster', INCREMENTAL_BACKUP_ENABLED = 'true' );
```

Импорт в целевую базу данных (применяет резервные копии в хронологическом порядке):

```bash
# Вариант 1: Восстановление всей коллекции (рекомендуется)
ydb tools restore -i shop_backups_export -d /Root/restored_db

# Вариант 2: Восстановление до конкретной точки
# Сначала импортируйте полную резервную копию
ydb tools restore -i shop_backups_export/full_backup_20240315 -d /Root/restored_db
# Затем примените инкрементальные до желаемой точки
ydb tools restore -i shop_backups_export/incremental_20240316 -d /Root/restored_db
```

### SQL восстановление

После импорта используйте SQL для восстановления:

```sql
RESTORE `restored_shop_backups`;
```

### Валидация

Проверьте восстановленные данные с помощью подсчета строк, примеров запросов и проверки схемы.

## Следующие шаги

- [Изучите полный синтаксис SQL API](sql-api.md).
- [Понимание концепций коллекций резервных копий](concepts.md).
