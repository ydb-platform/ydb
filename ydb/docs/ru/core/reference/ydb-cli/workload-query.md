# Пользовательская нагрузка

## Общее описание {#description_common}

Позволяет провести нагрузочное тестирование по заданному пользовательскому сценарию.
Сценарий тестирования представляет собой директорию, называемую `suite`, которая содержит набор поддиректорий: `init`, `import` и `run`, соответствующих командам `{{ ydb-cli }} cli`.
Директория `init` может иметь произвольную структуру и содержит sql-запросы создания и настройки объектов в базе данных, таких как таблицы или индексы.
Директория `import` содержит данные для загрузки в таблицы. Каждой таблице соответствует поддиректория в директории `import`.
Директория `run` может иметь произвольную структуру и содержит sql-запросы для нагрузочного тестирования.
Пример директории `suite` на [GitHub](https://github.com/ydb-platform/ydb/tree/main/ydb/tests/functional/tpc/data/e1).
Более подробное описание поддиректорий `init`, `import` и `run` см. в описании соответствующих команд.
Пользователь указывает путь к директории `suite` с помощью опции `--suite-path` в каждой команде.

Процесс нагрузочного тестирования состоит из следующих этапов:

### Подготовка стенда

Состоит из двух команд: `init` и `import`.

#### Команда `init` {#description_init}

Действует следующим образом:

* Если задан `suite` и в нем присутствует директория `init`, производится сканирование директории `init` с учетом её вложенных директорий поиском в глубину с лексиографическим упорядочиванием файлы и поддиректории на каждом уровне.
* Выбираются файлы с расширениями `sql` и `yql`.
* Содержимое каждого файла считывается и последовательно исполняется как SQL-запрос.
* После этого выполняет запросы, заданные напрямую из командной строки с помощью параметра `--query`.
* Если какой либо из запросов приводит к ошибке, то выполнение команды прекращается.

Предполагается, что на этом этапе выполняются относительно "лёгкие" запросы, например, создание таблиц и индексов. Не рекомендуется включать в состав файлов в директории `init` скрипты с наполнением таблиц данными. Эти операции следует перенести на фазу `import`.
Также в команде `init` присутствует опция `--clear`, позволяющая очистить директорию базы данных, используемую для нагрузочного тестирования перед новой инициализацией.
В запросах могут быть использованы макросы:

* `{db}` - Абсолютный путь в базе данных к директории тестирования. Представляет собой комбинацию значений опций `--database` и `--path`.

#### Команда `import` {#description_import}

Действует следующим образом:

* Если задан `suite` и в нем присутствует директория `import`, она выполняет последовательный обход ее поддиректорий.
* Предполагается, что каждая поддиректория соответствует таблице в базе данных.
* В поддиректории используются файлы в поддерживаемых форматах данных, а именно `csv`, `tsv`, `csv.gz`, `tsv.gz` и `parquet`.
* Выполняется загрузка данных из файлов в соответствующие таблицы. Загрузка идет во много потоков, причем параллелится как загрузка разных файлов, так и частей одного файла. порядок загрузки не гарантируется.

Процесс загрузки может продолжаться длительное время и быть по какой-то причине прерван. Для того чтобы иметь возможность продолжить загрузку с момента остановки, может быть применен механизм состояния. При помощи опции `--state` можно указать путь к файлу состояния. Если файл состояния существует, то он будет использован для продолжения загрузки. Если файла состояния нет, то он будет создан в процессе загрузки. Также он может быть очищен с помощью опции `--clear-state`.

### Запуск нагрузочного тестирования {#description_run}

Запуск нагрузочного тестирования предсавлен командой run, которая действует следующим образом:

* Если в `suite` присутствует директория `run`, команда выполняет обход её и всех её вложенных директорий поиском в глубину, на каждом уровне упорядочивая файлы и поддиректории по алфавиту. В случае отсутствия директории `run`, выполнение прекращается.
* Выбирает файлы с расширениями `sql` и `yql` и включает их в список SQL-запросов.
* После этого добавляет в список запросы, заданные напрямую из командной строки с помощью параметра `--query`.
* В зависимости от опций либо выполняет все запросы последовательно, каждый запрос заданное число раз либо параллельно в несколько потоков с перемешиванием запросов.
* Ошибки в запросах будут учтены в статистике, но не приводят к остановке тестирования.

Для каждого запроса из файла может быть задан канонический (ожидаемый) результат. Если ответ на запрос не соответствует каноническому, это будет отражено в статистике и в выводе команды. Также будет приведены отличия.
Канонический результат задается с помощью файла с тем же именем и дополнительным расширением `.result`. Это файлы CSV с заголовками и некоторым дополнительным синтаксисом:

* Если запрос имеет более одного набора результатов, файл результатов должен содержать соответствующее количество наборов данных, разделенных пустыми строками.
    Например, запрос

    ```sql
    SELECT COUNT(*) AS count FROM table_1;
    SELECT MIN(col1) AS min, MAX(col1) AS max FROM table_2;
    ```

    Может иметь следующий файл результатов:

    ```csv
    count
    10

    min,max
    4,5
    ```

* Последняя строка может быть задана как `...`, что означает, что результат запроса может иметь больше строк, чем в каноническом результате, но первые строки результата должны соответствовать каноническим.
* По умолчанию числа с плавающей точкой сравниваются с относительной точностью `1e-3` процента, но в каноническом результате вы можете указать любую абсолютную или относительную точность для каждого значения, например: `1.5+-0.01`, `2.4e+10+-1%`.

Для запросов, заданных опцией `--query`, канонический результат не может быть задан.
Канонический результат не будет использоваться, если не установлен флаг `--check-canonical`.

### Очистка {#description_clean}

Команда `clean` выполняет удаление объектов, использованных для нагрузочного тестирования. Для этого шага требуется только путь в базе данных. По сути, команда `clean` выполняет рекурсивное удаление объектов по указанному пути.

## Детальное описание параметров команд

### Общие параметры команд

Все команды поддерживают общий параметр `--path`, который задает путь в базе данных для объектов нагрузочного тестирования, все создаваемые объекты будут созданы по этому пути. Также путь будет учтен при выполнении теста и очистке.
Например, пусть вызваны следующая команды:

```bash
{{ ydb-cli }} workload query --path user_path init --query 'CREATE TABLE case1/my_table(Id Int32 NOT NULL, Value Utf8, PRIMARY KEY (Id))'
{{ ydb-cli }} workload query --path user_path import --suite-path ~/user-suite'
```

Они создадут и заполнят таблицу `user_path/case1/my_table`, команда

```bash
{{ ydb-cli }} workload query --path user_path run --query 'SELECT count(*) FROM case1/my_table'
```

выполнит запрос к таблице, а команда

```bash
{{ ydb-cli }} workload query --path user_path clean
```

удалит всю директорию `user_path`.

#### Доступные параметры { #common_options }

| Имя                | Описание       | Значение по умолчанию |
|--------------------|----------------|-----------------------|
|  `--path` или `-p` | Путь к таблице | Корень базы данных    |

### Инициализация нагрузочного теста { #init }

Инициализация нагрузочного теста выполняется при помощи команды:

```bash
{{ ydb-cli }} workload query [--path <путь/в/бд>] init [--suite-path <~/локальный/путь/к/suite>] [--query <запрос1>] [--query <запрос2>] [--dry-run] [--clear]
```

#### Доступные параметры { #init_options }

| Имя                                 | Описание                                                                         | Значение по умолчанию |
|-------------------------------------|----------------------------------------------------------------------------------|-----------------------|
| `--suite-path <путь>`               | Путь к `suite`-директории. См. [описание](./workload-query.md).                  |                       |
| `--query <запрос>` или `-q <запрос>` | DDL-запрос для выполнения. Может быть использован несколько раз.                 |                       |
| `--clear`                           | Если по указанному пути создаваемая таблица уже существует, она будет предварительно удалена              |                       |
| `--dry-run`                         | Не выполнять инициализационные запросы, а только распечатать их                  |                       |

Получить интерактивную справку по синтаксису команды и описанию её параметров можно через опцию `--help`:

```bash
{{ ydb-cli }} workload query init --help
```

### Загрузка данных в таблицу { #load }

Загрузка данных в таблицы выполняется при помощи команды:

```bash
{{ ydb-cli }} workload query [--path <путь/в/бд>] import --suite-path <~/локальный/путь/к/suite> [--state <путь/к/файлу/состояния>] [--clear-state] [--dry-run] [--file-output-path <путь/к/файлу>] [--upload-threads <число_нитей>] [--max-in-flight <число_запросов>] [--bulk-size <размер_пакета>]
```

В качестве исходных допускается указывать файлы следующих форматов: `csv`, `tsv`, `csv.gz`, `tsv.gz` и `parquet`.

#### Доступные параметры { #load_files_options }

| Имя | Описание | Значение по умолчанию |
|-|-|-|
| `--suite-path <путь>` | Путь к `suite`-директории. См. [описание] (#description_common). | |
| `--state <путь>` | Путь к файлу состояния загрузки. Если загрузка была прервана по какой-то причине, при новом запуске загрузка будет продолжена с того же места. См. [описание] (#description_import). | |
| `--clear-state` | Актуально, если задан параметр `--state`. Очистить файл состояния и начать загрузку сначала. | |
| `--dry-run` | Не выполнять загрузку данных в базу данных | |

{% include [load_options](./_includes/workload/load_options.md) %}

### Запуск нагрузочного теста { #run }

Нагрузка выполняется при помощи команды:

```bash
{{ ydb-cli }} workload query [--path <путь/в/бд>] run [--suite-path <~/локальный/путь/к/suite>] [--query <запрос1>] [--query <запрос2>] [--dry-run] [--iterations <число_итераций>] [--check-canonical] [--retries <число_перезапросов>] [--include <имена_запросов>] [--exclude <имена_запросов>] [--global-timeout <время>] [--request-timeout <время>] [--threads <число_нитей>] [--verbose] [--json <путь>] [--plan <путь>] [--csv <путь>] [--ministat <путь>] [--output <путь>]
```

В течение теста на экран выводится статистика по нагрузке для каждого запроса и агрегированная статистика по всем запросам.

Получить интерактивную справку по синтаксису команды и описанию её параметров можно через опцию `--help`:

```bash
{{ ydb-cli }} workload query run --help
```

{% include [run_options](./_includes/workload/run_options.md) %}

#### Опции, специфичные для Query { #run_query_options }

| Имя                                 | Описание                                                        | Значение по умолчанию |
|-------------------------------------|-----------------------------------------------------------------|-----------------------|
| `--suite-path <путь>`               | Путь к `suite`-директории. См. [описание](./workload-query.md). |                       |
| `--query <запрос>` или `-q <запрос>` | Запрос для выполнения. Может быть использован несколько раз.    |                       |

### Очистка данных теста { #cleanup }

Очистка выполняется при помощи команды:

```bash
{{ ydb-cli }} workload query [--path <путь/в/бд>] clean
```

Выполняет рекурсивное удаление объектов базы данных по указанному в параметре `--path` пути.
