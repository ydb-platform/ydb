# Нагрузка топиков

Простой вид нагрузки, использующий [топики](../../concepts/topic.md) YDB в качестве очередей сообщений.

В процессе работы пишется и читается большое число сообщений в целях измерения показателей производительности.

Для соответствия реальной нагрузке можно изменять различные входные параметры: число сообщений, размер сообщений, целевую скорость записи, число писателей и читателей.

В процессе работы на консоль выдаются результаты, включающие число и скорость сообщений, временные показатели.

## Виды нагрузки {#workload-types}

Данный нагрузочный тест содержит 3 вида нагрузки:

* [write](#run-write) — генерация сообщений и их запись в топик в асинхронном режиме;
* [read](#run-read) — асинхронное чтение сообщений из топика;
* [full](#run-full) — одновременное асинхронное чтение и запись сообщений.

## Инициализация нагрузочного теста {#init}

Для начала работы необходимо создать топик:

```bash
{{ ydb-cli }} workload topic init [init options...]
```

* `init options` — [параметры инициализации](#init-options).

Посмотреть описание команды для создания топика:

```bash
{{ ydb-cli }} workload topic init --help
```

### Доступные параметры {#init-options}

Имя параметра | Короткое имя | Описание параметра
---|---|---
`--partitions <значение>` | `-p <значение>` | Количество партиций топика. Значение по умолчанию: 128.
`--consumers <значение>` | `-c <значение>` | Количество читателей топика. Значение по умолчанию: 1.

В результате выполнения команды будет создан топик с фиксированным именем `workload-topic` и указанным числом партиций и читателей.

### Примеры инициализации нагрузки {#init-topic-examples}

Пример команды создания топика с 256 партициями и 2 читателями:

```bash
{{ ydb-cli }} workload topic init --partitions 256 --consumers 2
```

## Удаление топика {#clean}

После завершения работы можно удалить топик:

```bash
{{ ydb-cli }} workload topic clean
```

В результате выполнения команды будет удален топик `workload-topic`.

### Пример использования clean {#clean-topic-examples}

```bash
{{ ydb-cli }} workload topic clean
```

## Запуск нагрузочного теста {#run}

Для запуска нагрузки необходимо выполнить команду:

```bash
{{ ydb-cli }} workload topic run [workload type...] [specific workload options...]
```

* `workload type` — [виды нагрузки](#workload-types).
* `global workload options` — [общие параметры для всех видов нагрузки](#global-workload-options).
* `specific workload options` — параметры конкретного вида нагрузки.

Посмотреть описание команды для запуска нагрузки:

```bash
{{ ydb-cli }} workload topic run --help
```

### Общие параметры для всех видов нагрузки {#global-workload-options}

Имя параметра | Короткое имя | Описание параметра
---|---|---
`--seconds <значение>` | `-s <значение>` | Продолжительность теста (секунд). Значение по умолчанию: 10.
`--window <значение>` | `-w <значение>` | Длительность окна сбора статистики (секунд). Значение по умолчанию: 1.
`--quiet` | `-q` | Выводит только итоговый результат теста.
`--print-timestamp` | - | Печатать время вместе со статистикой каждого временного окна.

## Нагрузка на запись {#run-write}

Данный вид нагрузки генерирует и вставляет сообщения в топик в асинхронном режиме.

Для запуска данного вида нагрузки необходимо выполнить команду:

```bash
{{ ydb-cli }} workload topic run write [global workload options...] [specific workload options...]
```

Посмотреть описание команды для запуска нагрузки на запись:

```bash
{{ ydb-cli }} workload topic run write --help
```

### Параметры нагрузки на запись {#run-write-options}

Имя параметра | Короткое имя | Описание параметра
---|---|---
`--threads <значение>` | `-t <значение>` | Количество потоков писателя. Значение по умолчанию: `1`.
`--message-size <значение>` | `-m <значение>` | Размер сообщения (байт). Возможно задание в Кбайт, Мбайт, Гбайт путем добавления суффиксов соответственно: `K`, `M`, `G`. Значение по умолчанию: `10K`.
`--message-rate <значение>` | - | Целевая суммарная скорость записи (сообщений в секунду). 0 - нет ограничения. Значение по умолчанию: `0`.
`--byte-rate <значение>` | - | Целевая суммарная скорость записи (байт в секунду). 0 - нет ограничения. Возможно задание в Кбайт/с, Мбайт/с, Гбайт/с путем добавления суффиксов соответственно: `K`,`M`,`G`. Значение по умолчанию: `0`.
`--codec <значение>` | - | Кодек, используемый для сжатия сообщений на клиенте перед отправкой на сервер. Возможные варианты: `RAW` - без сжатия, `GZIP`, `ZSTD`. Сжатие увеличивает затраты CPU на клиенте при записи и чтении сообщений, но обычно позволяет уменьшить объем передаваемых по сети и хранимых данных. При последующем чтении сообщений подписчиками они автоматически разжимаются использованным при записи кодеком, не требуя указания каких-либо специальных опций. Значение по умолчанию: `RAW`.

Внимание, параметры `--byte-rate` и `--message-rate` являются взаимоисключающими.

### Примеры запуска нагрузки на запись {#run-write-examples}

Пример команды записи в 100 потоков писателей с целевой скоростью 80 Мбайт/с и длительностью 300 секунд:

```bash
{{ ydb-cli }} workload topic run write --threads 100 --seconds 300 --byte-rate 80M
```

### Вывод нагрузки на запись {#run-write-output}

В процессе работы печатается статистика за промежуточные временные окна и в конце итоговая статистика за всё время работы. Пример вывода:

```text
Window  Write speed     Write time      Inflight
#       msg/s   MB/s    P99(ms)         max msg
1       20      0       1079            72
2       8025    78      1415            78
3       7987    78      1431            79
4       7888    77      1471            101
5       8126    79      1815            116
6       7018    68      1447            79
7       8938    87      2511            159
8       7055    68      1463            78
9       7062    69      1455            79
10      9912    96      3679            250
Window  Write speed     Write time      Inflight
#       msg/s   MB/s    P99(ms)         max msg
Total   7203    70      3023            250
```

Имя колонки  | Описание колонки
---|---
`Window`|Порядковый номер временного окна сбора статистики.
`Write speed`|Скорость записи сообщений (сообщений/с и Мбайт/с).
`Write time`|99 перцентиль времени записи сообщения (мс).
`Inflight`|Максимальное число сообщений, ожидающих подтверждения по всем партициям (сообщений).

## Нагрузка на чтение {#run-read}

Данный вид нагрузки асинхронно читает сообщения из топика.

Для запуска данного вида нагрузки необходимо выполнить команду:

```bash
{{ ydb-cli }} workload topic run read [global workload options...] [specific workload options...]
```

Посмотреть описание команды для запуска нагрузки на чтение:

```bash
{{ ydb-cli }} workload topic run read --help
```

### Параметры нагрузки на чтение {#run-read-options}

Имя параметра | Короткое имя | Описание параметра
---|---|---
`--consumers <значение>` | `-c <значение>` | Количество читателей. Значение по умолчанию: `1`.
`--threads <значение>` | `-t <значение>` | Количество потоков читателя. Значение по умолчанию: `1`.

### Примеры запуска нагрузки на чтение {#run-read-examples}

Пример команды чтения с помощью 2 читателей, каждый из который имеет 100 потоков:

```bash
{{ ydb-cli }} workload topic run read --consumers 2 --threads 100
```

### Вывод нагрузки на чтение {#run-read-output}

В процессе работы печатается статистика за промежуточные временные окна и в конце итоговая статистика за всё время работы. Пример вывода:

```text
Window  Lag     Lag time        Read speed      Full time
#       max msg P99(ms)         msg/s   MB/s    P99(ms)
1       0       0               48193   471     0
2       30176   0               66578   650     0
3       30176   0               68999   674     0
4       30176   0               66907   653     0
5       27835   0               67628   661     0
6       30176   0               67938   664     0
7       30176   0               71628   700     0
8       20338   0               61367   599     0
9       30176   0               61770   603     0
10      30176   0               58291   569     0
Window  Lag     Lag time        Read speed      Full time
#       max msg P99(ms)         msg/s   MB/s    P99(ms)
Total   30176   0               80267   784     0
```

Имя колонки  | Описание колонки
---|---
`Window`|Порядковый номер временного окна сбора статистики.
`Lag`|Максимальная задержка сообщений по всем партициям (сообщений). Число сообщений, ожидающих чтения.
`Lag time`|99 перцентиль времени задержки сообщений (мс).
`Read`|Скорость чтения сообщений читателем (сообщений/с и Мбайт/с).
`Full time`|99 перцентиль времени полной обработки сообщения, от записи писателем до чтения читателем (мс).

## Нагрузка на чтение/запись {#run-full}

Данный вид нагрузки одновременно асинхронно пишет и читает сообщения.

Для запуска данного вида нагрузки необходимо выполнить команду:

```bash
{{ ydb-cli }} workload topic run full [global workload options...] [specific workload options...]
```

Выполнение данной команды эквивалентно одновременному запуску двух процессов нагрузки на чтение и запись.

Посмотреть описание команды для запуска нагрузки на чтение/запись:

```bash
{{ ydb-cli }} workload topic run full --help
```

### Параметры нагрузки на чтение/запись {#run-full-options}

Имя параметра | Короткое имя | Описание параметра
---|---|---
`--producer-threads <значение>` | `-p <значение>` | Количество потоков писателя. Значение по умолчанию: `1`.
`--message-size <значение>` | `-m <значение>` | Размер сообщения (байт). Возможно задание в Кбайт, Мбайт, Гбайт путем добавления суффиксов соответственно: `K`, `M`, `G`. Значение по умолчанию: `10K`.
`--message-rate <значение>` | - | Целевая суммарная скорость записи (сообщений в секунду). 0 - нет ограничения. Значение по умолчанию: `0`.
`--byte-rate <значение>` | - | Целевая суммарная скорость записи (байт в секунду). 0 - нет ограничения. Возможно задание в Кбайт/с, Мбайт/с, Гбайт/с путем добавления суффиксов соответственно: `K`,`M`,`G`. Значение по умолчанию: `0`.
`--codec <значение>` | - | Кодек, используемый для сжатия сообщений на клиенте перед отправкой на сервер. Возможные варианты: `RAW` - без сжатия, `GZIP`, `ZSTD`. Сжатие увеличивает затраты CPU на клиенте при записи и чтении сообщений, но обычно позволяет уменьшить объем передаваемых по сети и хранимых данных. При последующем чтении сообщений подписчиками они автоматически разжимаются использованным при записи кодеком, не требуя указания каких-либо специальных опций. Значение по умолчанию: `RAW`.
`--consumers <значение>` | `-c <значение>` | Количество читателей. Значение по умолчанию: `1`.
`--consumer-threads <значение>` | `-t <значение>` | Количество потоков читателя. Значение по умолчанию: `1`.

Внимание, параметры `--byte-rate` и `--message-rate` являются взаимоисключающими.

### Примеры запуска нагрузки на чтение/запись {#run-full-examples}

Пример команды чтения/записи с помощью 2 читателей в 50 потоков, 100 писателей с целевой скоростью 80 Мбайт/с и длительностью 300 секунд:

```bash
{{ ydb-cli }}  workload topic run full --producer-threads 100 --consumers 2 --consumer-threads 50 --byte-rate 80M --seconds 300
```

### Вывод нагрузки на чтение/запись {#run-full-output}

В процессе работы печатается статистика за промежуточные временные окна и в конце итоговая статистика за всё время работы. Пример вывода:

```text
Window  Write speed     Write time      Inflight        Lag     Lag time        Read speed      Full time
#       msg/s   MB/s    P99(ms)         max msg         max msg P99(ms)         msg/s   MB/s    P99(ms)
1       39      0       1215            4               0       0               30703   300     29716
2       1091    10      2143            8               2076    20607           40156   392     30941
3       1552    15      2991            12              7224    21887           41040   401     31886
4       1733    16      3711            15              10036   22783           38488   376     32577
5       1900    18      4319            15              10668   23551           34784   340     33372
6       2793    27      5247            21              9461    24575           33267   325     34893
7       2904    28      6015            22              12150   25727           34423   336     35507
8       2191    21      5087            21              12150   26623           29393   287     36407
9       1952    19      2543            10              7627    27391           33284   325     37814
10      1992    19      2655            9               10104   28671           29101   284     38797
Window  Write speed     Write time      Inflight        Lag     Lag time        Read speed      Full time
#       msg/s   MB/s    P99(ms)         max msg         max msg P99(ms)         msg/s   MB/s    P99(ms)
Total   1814    17      5247            22              12150   28671           44827   438     40252
```

Имя колонки  | Описание колонки
---|---
`Window`|Порядковый номер временного окна сбора статистики.
`Write speed`|Скорость записи сообщений (сообщений/с и Мбайт/с).
`Write time`|99 перцентиль времени записи сообщения (мс).
`Inflight`|Максимальное число сообщений, ожидающих подтверждения по всем партициям (сообщений).
`Lag`|Максимальная задержка сообщений по всем партициям (сообщений). Число сообщений, ожидающих чтения.
`Lag time`|99 перцентиль времени задержки сообщений (мс).
`Read`|Скорость чтения сообщений читателем (сообщений/с и Мбайт/с).
`Full time`|99 перцентиль времени полной обработки сообщения, от записи писателем до чтения читателем (мс).
