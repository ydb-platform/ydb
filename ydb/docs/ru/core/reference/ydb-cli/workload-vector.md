# Нагрузка Vector

Данный вид нагрузки предназначен для оценки производительности и полноты точного и приближённого [векторного поиска](../../concepts/vector_search.md).

Поддерживается тестирование базовых [векторных индексов](../../yql/reference/syntax/create_table/vector_index.md) и векторных индексов [с фильтрацией](../../yql/reference/syntax/create_table/vector_index.md#filtered).

Тест выполняет запросы векторного поиска и оценивает их скорость и полноту. Можно выбирать различные индексы и параметры поиска, чтобы понять, как они влияют на результат.

## Инициализация тестового окружения

Тест использует одну или две заранее созданных таблицы с векторной колонкой: основную таблицу и таблицу запросов. Они должны содержать обучающую и тестовую выборки, соответственно.

Если таблица запросов не задана, тестовая выборка формируется случайным выбором из основной таблицы.

Также требуется заранее созданный векторный индекс. Его имя передаётся в параметрах запуска теста.

Пример создания таблицы и загрузки данных приведён в рецепте [Векторный индекс с загрузкой внешнего набора данных](../../recipes/vector-search/vector-index-with-prepared-dataset.md).

Примеры создания векторных индексов доступны на странице документации [Векторные индексы](../../dev/vector-indexes.md#types).

## Алгоритм тестирования

1. Формируется тестовая выборка:
   - Если в опциях командной строки задана таблица с тестовой выборкой, из неё выбираются первые `targets` записей по порядку первичного ключа.
   - В противном случае выбираются случайные `targets` записей из основной таблицы.
2. Производится оценка полноты:
   - Для каждого элемента тестовой выборки запускается по два запроса.
   - Первый запрос — [точный векторный поиск](../../concepts/vector_search.md#vector-search-exact) (полный перебор) по близости к векторной колонке, формируя эталонное множество результатов `R_exact`.
   - Второй запрос — [приближённый векторный поиск](../../concepts/vector_search.md#vector-search-index) на основе векторного индекса, получая множество результатов `R_approx`.
   - Если выбран индекс с фильтрацией, то оба поиска проводятся только среди записей с соответствующими значениями колонок фильтров.
   - Вычисляется полнота приближённого поиска на основании точных результатов по формуле $\frac{|R_{approx} \bigcap R_{exact}|}{R_{exact}}$ (здесь `|A|` — число элементов в множестве A, а `A ∩ B` — пересечение множеств A и B).
3. Производится оценка скорости:
   - В течение заданного времени и в заданное число параллельных потоков запускаются запросы поиска по индексу.
   - Каждый запрос запускается для случайного элемента тестовой выборки.
   - Время и параллелизм задаются в [общих параметрах](commands/workload/index.md#global_workload_options).
   - Вычисляется средняя производительность (RPS) и время ответа на разных квантилях.

## Запуск нагрузочного теста {#run-select}

Общий вид команды:

```bash
{{ ydb-cli }} [global options...] workload vector run select [global workload options...] [options...]
```

* `global workload options` — [общие параметры для всех видов нагрузки](commands/workload/index.md#global_workload_options).
* `global options` — [глобальные параметры](commands/global-options.md).
* `options` — параметры команды.

### Опции команды

Посмотреть описание команды:

```bash
{{ ydb-cli }} workload vector run select --help
```

Имя параметра              | Описание параметра                                       | Значение по умолчанию
---|---|---
`--table`                  | Имя тестируемой таблицы.                                 | `vector_index_workload`
`--index`                  | Имя тестируемого индекса.                                | `index`
`--query-table`            | Имя таблицы с тестовой выборкой.                         | не задано
`--targets`                | Размер тестовой выборки.                                 | `100`
`--limit`                  | Максимальное число записей в результатах одного запроса. | `5`
`--kmeans-tree-clusters`   | Число кластеров поиска ([KMeansTreeSearchTopSize](../../yql/reference/syntax/select/vector_index.md#kmeanstreesearchtopsize)). | `1`
`--recall`                 | Включить замер полноты поиска по индексу.                | нет
`--recall-threads`         | Число параллельных запросов для оценки полноты.          | `10`
`--non-indexed`            | Взять настройки поиска из индекса, но искать без индекса, полным перебором. | нет

{% note warning %}

Обратите внимание на параметр `--kmeans-tree-clusters` — его увеличение значительно повышает полноту поиска ценой его замедления. Попробуйте значения в пределах от 1 до числа кластеров, указанного при создании индекса.

{% endnote %}

### Пример запуска

```bash
{{ ydb-cli }} -e grpc://hostname:2135 -d /Root/testdb workload vector run select --table wikipedia --index idx_vector --limit 20 \
    --query-table wikipedia_sample --limit 20 --targets 100 --kmeans-tree-clusters 10 --recall
```

### Примечания

- Нагрузка генерирует SQL-запросы выборки до `limit` ближайших строк по векторному расстоянию из таблицы `table` по индексу `index`.
- Указывать названия колонок (векторной, фильтра, первичного ключа) и функцию расстояния не нужно — они извлекаются автоматически из определения индекса.
- В качестве тестовой выборки используется заданное опцией `targets` число векторов — либо случайных из `table`, либо первых по порядку первичного ключа из `query-table`.
- Случайный выбор тестовых векторов из таблицы `table` работает только в том случае, если первичный ключ таблицы — целочисленный.
- Если используется `query-table`, в обеих таблицах имена векторной колонки и колонки фильтра должны совпадать.
- Оценка полноты поиска (`recall`) проводится отдельным этапом перед тестированием производительности и показывает среднюю долю совпадения результатов поиска по индексу и полным перебором (от 0 до 1).

### Подготовка тестовой выборки из большой таблицы

{% note warning %}

Данный этап необходим только в случае отсутствия готовой тестовой выборки и если первичный ключ основной таблицы не является целочисленным, так как в этом случае формирование случайной выборки на лету во время теста не работает.

{% endnote %}

В этом случае тестовую выборку можно подготовить, выбрав случайные строки из основной таблицы. Ниже приведён пример создания таблицы для хранения тестовой выборки:

```yql
CREATE TABLE vector_index_sample (
    id Uint64 NOT NULL,
    prefix Uint64 NOT NULL,
    embedding String NOT NULL,
    PRIMARY KEY (id)
);
```

Наполнение таблицы случайной выборкой приблизительно 1000 строк из большой таблицы:

```yql
INSERT INTO vector_index_sample
SELECT id, prefix, embedding FROM large_table
WHERE RandomNumber(id) < 0xFFFFFFFFFFFFFFFF / <число_строк_в_таблице> * 1000;
```

{% note tip %}

Приблизительное число строк в таблице можно посмотреть в [статистике таблицы](commands/scheme-describe.md), не выполняя `SELECT COUNT(*)`.

{% endnote %}
