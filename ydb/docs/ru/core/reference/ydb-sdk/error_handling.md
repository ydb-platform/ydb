# Обработка ошибок

При использовании {{ ydb-short-name }} SDK возникают ситуации, в которых необходимо обрабатывать ошибки.

Ошибки можно разделить на три категории:

* {% include [retryable](./_includes/tooltips/retryable.md) %}

* {% include [non-retryable](./_includes/tooltips/nonretryable.md) %}

* {% include [conditionally-retryable](./_includes/tooltips/condretryable.md) %}


## Обработка временных сбоев (retryable errors) {#handling-retryable-errors}

{{ ydb-short-name }} SDK предоставляет [встроенный механизм обработки временных сбоев](../../recipes/ydb-sdk/retry.md). По умолчанию в SDK используется рекомендованная политика повторов, которую можно изменить в соответствии с требованиями клиентского приложения. {{ ydb-short-name }} возвращает коды завершения, позволяющие определить, уместна ли повторная попытка и какой выбрать интервал.

Операции следует повторять только в том случае, если ошибки являются временными сбоями. Не пытайтесь повторно выполнять недопустимые операции, такие как вставка в таблицу строки с существующим значением первичного ключа или вставка данных, не соответствующих схеме таблицы.

Крайне важно оптимизировать число повторных попыток и интервал между ними. Чрезмерное количество повторных попыток и слишком короткий интервал создают избыточную нагрузку. Недостаточное количество повторных попыток не позволит завершить выполнение операции.

Встроенные в SDK {{ ydb-short-name }} retryer'ы используют следующие стратегии задержек повторного выполнения запросов в зависимости от статуса завершения запроса:

* **Немедленный повтор.** Повторные попытки совершаются немедленно.
* **Короткая экспоненциальная задержка.** Первоначальный интервал составляет несколько миллисекунд. Для каждой последующей попытки интервал увеличивается по экспоненциальному закону.
* **Большая экспоненциальная задержка.** Первоначальный интервал составляет несколько секунд. Для каждой последующей попытки интервал увеличивается по экспоненциальному закону.

При выборе интервала вручную обычно используются следующие стратегии:

* **Экспоненциальная задержка.** Для каждой последующей попытки интервал увеличивается по экспоненциальному закону.
* **Интервалы с приращениями.** Для каждой последующей попытки интервал увеличивается с определёнными приращениями.
* **Постоянные интервалы.** Повторные попытки совершаются через одинаковые интервалы.
* **Немедленный повтор.** Повторные попытки совершаются немедленно.
* **Случайный выбор.** Повторные попытки совершаются через случайно выбранный интервал времени.

При выборе интервала и числа повторных попыток учитывайте [статусы завершения](#status-codes) {{ ydb-short-name }}.

Не используйте бесконечные повторные попытки — это может привести к избыточной нагрузке.

Не выполняйте немедленный повтор более одного раза.

Примеры кода смотрите в разделе [{#T}](../../recipes/ydb-sdk/retry.md).

## Статусы завершения {#status-codes}

Когда возникает ошибка, {{ ydb-short-name }} SDK возвращает объект ошибки, который включает статусы завершения. Возвращаемый статус завершения может исходить от [сервера {{ ydb-short-name }}](./ydb-status-codes.md), [транспорта gRPC](./grpc-status-codes.md) или самого SDK.

Статусы завершения в диапазоне 400000–400999 — это статусы завершения, полученные от сервера {{ ydb-short-name }}. Смотрите [{#T}](./ydb-status-codes.md).

Статусы завершения в диапазоне 401000–401999 относятся к кодам, специфичным для SDK. Для получения дополнительной информации об этих статусах, относящихся к конкретному SDK, обратитесь к соответствующей документации SDK.

Для получения дополнительной информации о статусах завершения gRPC см. [документацию gRPC](https://grpc.io/docs/guides/status-codes/).

## Журналирование ошибок {#log-errors}

При использовании SDK рекомендуется записывать в журнал все ошибки и исключения:

* Журналируйте количество предпринимаемых повторных попыток. Увеличение числа регулярных повторных попыток часто указывает на наличие проблем.
* Журналируйте все ошибки, в том числе их типы, коды завершения и причины возникновения.
* Журналируйте общее время выполнения операций, включая операции, завершившиеся после повторного выполнения.

## Смотрите также

- [{#T}](./grpc-status-codes.md)
- [{#T}](./ydb-status-codes.md)
- [{#T}](../../faq/errors.md)
