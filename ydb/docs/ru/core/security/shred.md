# Очистка данных с диска

{% include [feature_certified.md](../_includes/feature_certified.md) %}

{{ ydb-short-name }} при обработке запросов на изменение или удаление данных может оставлять копии этих данных на диске, но помеченных как «удалённые». То есть получить эти данные путём пользовательских запросов к {{ ydb-short-name }} уже невозможно. Однако эти данные могут быть прочитаны за рамками {{ ydb-short-name }}, например, штатными функциями ОС по чтению диска или другими приложениями, получившими доступ к диску. Для минимизации риска прочтения ранее удалённой из базы данных информации {{ ydb-short-name }} предоставляет опциональную возможность запустить специализированную процедуру многократной перезаписи «удалённых» данных специальными битовыми последовательностями. Процедура представляет собой фоновый процесс и для его включения необходимо заполнить секцию конфигурации [data_erasure_config](../reference/configuration/shred_config.md).

## Инструменты контроля процесса очистки

Процесс очистки данных может занимать продолжительное время. Текущий прогресс и состояние текущей итерации очистки данных можно получить путём анализа логов и опроса некоторых метрик.

### Логи

Процесс очистки поставляет логи на разных уровнях детализации.

Как сказано в [статье](../reference/configuration/shred_config.md), описывающей настройку процесса очистки, существует несколько уровней, на которых происходит очистка удалённых данных:

* Уровень кластера — очистка запускается для всех существующих баз данных;
* Уровень базы данных — очистка запускается для всех внутренних структур (таблеток) одной базы данных.

Каждый из этих уровней можно отличить друг от друга по префиксам:

* Логи с префиксом `[RootShredManager]` относятся к уровню кластера. По ним можно узнать, в каких базах была запущена очистка, какие базы закончили процесс очистки, для каких баз сработал таймаут и запустился ли процесс очистки в слое хранения.
* Логи с префиксом `[TenantShredManager]` относятся к уровню базы. По ним можно узнать, для каких таблеток запустился процесс очистки, а для каких уже закончился, срабатывал ли таймаут при выполнении очистки.

Подробное описание процесса настройки логирования описано в статье о [логировании](../devops/observability/logging.md) в {{ ydb-short-name }}. Для получения логов процесса очистки требуется настроить уровень логирования для компонента `FLAT_TX_SCHEMESHARD`.

#### Логирование уровня кластера

В результате успешного выполнения одной итерации очистки данных будет сгенерирован следующий набор сообщений уровня кластера:

{% note info %}

Сообщения на уровне кластера посылает таблетка корневого [SchemeShard](../concepts/glossary.md#scheme-shard), поэтому увидеть эти логи можно только на том узле, на котором запущена эта таблетка. При рестартах узла таблетка может оказаться на другом узле.

{% endnote %}

  1. `[RootShredManager] Created: Timeout# 15, Rate# 0, InflightLimit# 15, ShredInterval# 604800,`
  `ShredBSCInterval# 600, CurrentWakeupInterval# 604800, IsManualStartup# false`
  выводится при старте узла {{ ydb-short-name }}, на котором запущена таблетка корневого SchemeShard. Строка лога показывает, с какими текущими настройками будет запускаться очистка на уровне кластера. Уровень логирования `NOTICE`.
  1. `[RootShredManager] Start: Status# 0` — сигнализирует о запуске процесса очистки с текущим [статусом](#статус-операции). Уровень логирования `NOTICE`.
  1. `[RootShredManager] ScheduleShredWakeup: Interval# 604800, Timestamp# 01-01-2025` — выводится в момент планирования следующей итерации очистки. Следующий запуск процесса очистки будет выполнен через `Interval# 604800` секунд начиная с момента `Timestamp# 01-01-2025`. Уровень логирования `NOTICE`.
  1. `[RootShredManager] WakeupToRunShred: Timestamp# 01-01-2025` — выводится в момент, когда пришло время выполнить очередную итерацию очистки. Уровень логирования `DEBUG`.
  1. `TTxRunShred Execute at schemeshard: 22222222` — выводится при выполнении транзакции запуска очередной итерации очистки. `schemeshard: 22222222` — идентификатор таблетки корневого SchemeShard. Уровень логирования `DEBUG`.
  1. `[RootShredManager] Clear operation queue and active pipes` — сигнализирует об очистке очередей выполнения процесса очистки. Уровень логирования `TRACE`.
  1. `[RootShredManager] Clear WaitingShredTenants: Size# 5` — сигнализирует об очистке контейнера, содержащего информацию о базах данных, в которых ещё не завершена очистка. Уровень логирования `TRACE`.
  1. `[RootShredManager] [Enqueue] Enqueued pathId# 12345 at schemeshard 22222222` — выводится при добавлении базы данных в очередь очистки. База данных характеризуется идентификатором пути `pathId# 12345`. `pathId` — идентификатор узла объекта схемы внутри указанного SchemeShard. По `pathId` можно восстановить путь до базы, открыв вкладку *Describe* в [Embedded UI](../reference/embedded-ui/ydb-monitoring.md). Уровень логирования `TRACE`.
  1. `[RootShredManager] Run: Queue.Size# 2, WaitingShredTenants.size# 2, Status# 1` — запуск очередной итерации очистки для данных на уровне кластера с текущим [статусом](#статус-операции). Уровень логирования `NOTICE`.
      * `Queue.Size` — количество баз, для которых была запущена очистка;
      * `WaitingShredTenants.size` — количество баз, для которых очистка ещё не завершена.
  1. `TTxRunShred Complete at schemeshard: 22222222, NeedSendRequestToBSC# false` — выводится при завершении транзакции запуска очередной итерации очистки.
  1. `[RootShredManager] [Start] Shred for pathId# 12345, tenant schemeshard# 5555555,`
  `next wakeup# 5, rate# 1, in queue# 2, running# 1 at schemeshard 2222222`
  выводится при запуске очистки в конкретной базе данных. Уровень логирования `NOTICE`.
  1. `[RootShredManager] [Finished] Shred completed for pathId# 12345 in# 900 ms, next wakeup# 5,`
  `rate# 1, in queue# 0 tenants, running# 0 tenants at schemeshard 2222222`
  выводится при завершении очистки в конкретной базе данных. Можно увидеть время, за которое была выполнена очистка (`pathId# 12345 in# 900 ms`), количество баз данных, ожидающих очистки (`in queue# 0 tenants`). Уровень логирования `INFO`.
  1. `[RootShredManager] Shred in tenants is completed. Send request to BS controller` — означает завершение очистки внутренних структур во всех базах данных кластера. Старт запуска процедуры очистки в слое хранения. Уровень логирования `INFO`.
  1. `TTxCompleteShredBSC: Progress data shred in BSC 88.88%` — очистка в слое хранения завершена на 88%. Уровень логирования `NOTICE`.
  1. `[RootShredManager] Complete: Generation# 5, duration# 6400 s` — завершение очередной (`Generation# 5`) итерации очистки данных, длящейся в общей сложности 6400 секунд. Уровень логирования `NOTICE`.
  1. `[RootShredManager] Stop` — выводится в результате остановки процесса очистки. Уровень логирования `NOTICE`.

#### Логирование уровня базы данных

В результате успешного выполнения одной итерации очистки данных будет сгенерирован следующий набор сообщений уровня базы данных:

{% note info %}

Сообщения на уровне базы данных посылает таблетка SchemeShard конкретной базы данных, поэтому увидеть эти логи можно только на том узле, на котором запущена эта таблетка. При рестартах узла таблетка может оказаться на другом узле.

{% endnote %}

  1. `[TenantShredManager] Created: Timeout# 15, Rate# 2, InflightLimit# 15` — выводится при старте узла {{ ydb-short-name }}, на котором запущена таблетка SchemeShard, обслуживающая конкретную базу данных. Строка лога показывает, с какими текущими настройками будет запускаться очистка на уровне базы данных. Уровень логирования `NOTICE`.
  1. `[TenantShredManager] Start: Status# 1` — сигнализирует о запуске процесса очистки с текущим [статусом](#статус-операции). Уровень логирования `NOTICE`.
  1. `Handle TEvTenantShredRequest, at schemeshard: 55555555` — обработка запроса от таблетки корневого SchemeShard на выполнение очистки внутренних структур конкретной базы данных. Уровень логирования `DEBUG`.
  1. `TTxRunTenantShred Execute at schemestard: 55555555` — выводится при выполнении транзакции запуска очередной итерации очистки внутренних структур конкретной базы данных. Уровень логирования `DEBUG`.
  1. `[TenantShredManager] Clear operation queue and active pipes` — сигнализирует об очистке очередей выполнения процесса очистки. Уровень логирования `TRACE`.
  1. `[TenantShredManager] Clear WaitingShredShards: Size# 50` — сигнализирует об очистке контейнера, содержащего информацию о таблетках, в которых ещё не завершена очистка. Уровень логирования `TRACE`.
  1. `[TenantShredManager] [Enqueue] Enqueued shard# 987654321 at schemeshard 55555555` — выводится при добавлении таблетки в очередь очистки. Уровень логирования `TRACE`.
  1. `[TenantShredManager] Run: Queue.Size# 50, WaitingShredShards.size# 50, Status# 2` — запуск новой очистки для таблеток базы данных. Уровень логирования `NOTICE`.
      * `Queue.Size` — количество таблеток, для которых была запущена очистка;
      * `WaitingShredShards.size` — количество таблеток, для которых очистка ещё не завершена.
  1. `[TenantShredManager] [Start] Shred for pathId# 2, datashard# 7777777, next wakeup# 5,`
  `rate# 15, in queue# 50 shards, running# 28 shards at schemeshard 12345`
  старт очистки в конкретной таблетке базы данных. Уровень логирования `INFO`.
  1. `[TenantShredManager] [Finished] Shred is completed for pathId# 2, datashard# 777777777,`
  `shardIdx# 12312313" in# 600 ms, next wakeup in# 3600, rate# 50, in queue# 50 shards, running# 0 shards at schemeshard 12345`
  выводится при завершении очистки в таблетке базы данных. Уровень логирования `INFO`.
  1. `[TenantShredManager] Shred in shards is completed. Send response to root schemeshard` — выводится при завершении очистки всех таблеток конкретной базы данных. Уровень логирования `NOTICE`.
  1. `[TenantShredManager] Complete: Generation# 5` — завершение очистки таблеток в базе данных. Уровень логирования `NOTICE`.

#### Статус операции

В тексте логов очистки данных встречается информация о статусе операции, например `Status# 1`. Цифровые значения статусов нужно интерпретировать следующим образом:

#|
|| **Статус** | **Описание** ||
|| 0 | Статус не определён. Виден при первом запуске кластера ||
|| 1 | Операция завершена ||
|| 2 | Выполняется очистка внутренних структур (таблеток) базы данных ||
|| 3 | Выполняется очистка в слое хранения ||
|#

### Метрики

В {{ ydb-short-name }} имеются [метрики](../reference/observability/metrics/index.md#shred), по которым также можно понять, на какой стадии находится процесс очистки.

Метрики позволяют контролировать прогресс выполнения очистки данных: в скольких базах данных завершена итерация очистки, для скольких баз очистка ещё выполняется, сколько таблеток в конкретной базе данных уже завершили очистку.

По метрикам можно прогнозировать время выполнения очистки и время, когда данные будут удалены.
