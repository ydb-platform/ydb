# Диагностика проблем с производительностью

Решение проблем с производительностью баз данных требует комплексного подхода, который включает в себя оптимизацию запросов, правильную конфигурацию аппаратных ресурсов, а также грамотную архитектуру базы данных и использующих её приложений. Регулярный мониторинг и обслуживание базы данных являются необходимыми условиями для диагностики и решения таких проблем.

## Инструменты для диагностики проблем с производительностью

Для диагностики проблем с производительностью {{ ydb-short-name }} используются следующие инструменты:

- [{{ ydb-short-name }} метрики](../../reference/observability/metrics/index.md).

    Диагностика большинства проблем с производительностью включает анализ [дашбордов в Grafana](../../reference/observability/metrics/grafana-dashboards.md), которые используют метрики {{ ydb-short-name }}, собираемые с помощью Prometheus. Описание установки Grafana и Prometheus см. в разделе [{#T}](../../devops/manual/monitoring.md);

- [Логи {{ ydb-short-name }}](../../devops/manual/logging.md);
- [Трассировка](../../reference/observability/tracing/setup.md);
- [{{ ydb-short-name }} CLI](../../reference/ydb-cli/index.md);
- [Встроенный UI](../../reference/embedded-ui/index.md);
- [Планы запросов](../../dev/query-plans-optimization.md);
- Сторонние инструменты мониторинга.

## Классификация проблем с производительностью {{ ydb-short-name }}

Проблемы с производительностью {{ ydb-short-name }} можно разделить на несколько категорий. Данный раздел документации предоставляет общее описание этих категорий, начиная с самого низкого уровня системы и поднимаясь до уровня клиента. Сами инструкции по диагностике проблем [см. ниже](#instructions).

### Проблемы с инфраструктурой

- **[Сетевые проблемы](infrastructure/network.md)**. Перегрузка сети внутри датацентра и особенно между датацентрами, может значительно повлиять на производительность {{ ydb-short-name }}.

- **[Сбои в работе датацентров](infrastructure/dc-outage.md)**. Нарушения работы датацентров могут привести к недоступности сервиса или данных. Для решения данной проблемы кластер {{ ydb-short-name }} можно настроить на работу в трёх датацентрах или зонах доступности. Однако при этом также необходимо учитывать вопрос производительности.

- **[Сервисные работы и учения датацентров](infrastructure/dc-drills.md)**. Плановые сервисные работы или учения для подготовки персонала к потенциальным чрезвычайным ситуациям и сбоям также могут влиять на производительность выполнения запросов. В зависимости от масштаба сервисных работ или сценария учений серверы {{ ydb-short-name }} могут стать недоступными, что повлечёт за собой те же последствия, что и сбой в работе датацентра.

- **[Аппаратные неисправности серверов](infrastructure/hardware.md)**. Неисправный процессор, модули памяти или сетевые карты значительно влияют на производительность базы данных или приводят к полной недоступности сервера.

### Проблемы с нехваткой аппаратных ресурсов

Такие проблемы возникают, когда нагрузка на базу данных требует больше аппаратных ресурсов — таких как процессор, память, дисковое пространство или пропускная способность сети — чем было выделено. В некоторых случаях неоптимальное выделение ресурсов, например неправильная настройка [контрольных групп (cgroups)](https://ru.wikipedia.org/wiki/Контрольная_группа_(Linux)) или [пулов ресурсов акторной системы](../../concepts/glossary.md#actor-system-pool), может привести к нехватке аппаратных ресурсов для {{ ydb-short-name }} и увеличить задержки запросов, даже если для сервера баз данных было выделено достаточно аппаратных ресурсов.

- **[Недостаточное быстродействие процессора](hardware/cpu-bottleneck.md)**. Высокая нагрузка на процессор может привести к медленному выполнению запросов и увеличению задержек. В условиях ограниченного ресурса процессора база данных может с трудом справляться со сложными запросами или интенсивным потоком транзакционных запросов.

- **[Недостаточное дисковое пространство](hardware/disk-space.md)**. Нехватка места на диске может привести к невозможности сохранения новых данных, когда база переходит в режим только для чтения. Эта проблема может также приводить к замедлению работы, когда система пытается освободить дисковое пространство, активнее приводя данные к более компактному виду в фоне.

- **[Недостаточный объём памяти (RAM)](hardware/insufficient-memory.md)**. Обработка запросов требует памяти для временного хранения промежуточных данных. Недостаток свободной памяти может негативно повлиять на производительность базы данных.

- **[Недостаточная пропускная способность](hardware/io-bandwidth.md)**. Высокая скорость операций чтения/записи может перегрузить дисковую систему и приводить к увеличению задержек доступа к данным. Когда [распределённое хранилище](../../concepts/glossary.md#distributed-storage) не может читать или записывать данные с достаточной скоростью, запросы к базе данных, требующие доступа к диску, могут замедляться.

### Проблемы на уровне операционной системы

- **[Расхождение системного времени на серверах](system/system-clock-drift.md)**. Увеличение расхождения системного времени на серверах {{ ydb-short-name }} приводит к росту задержек распределённых транзакций. Большая разница во времени приводит к невозможности выполнения распределённых транзакций.

### Проблемы на уровне конфигурации {{ ydb-short-name }}

- **[Обновления {{ ydb-short-name }}](ydb/ydb-updates.md)**. Следует учитывать два основных аспекта: рестарт всех узлов {{ ydb-short-name }} в относительно короткий промежуток времени и отличия в поведении разных версий {{ ydb-short-name }}.

- Ошибки конфигурации пулов ресурсов акторной системы.

### Проблемы, связанные со схемами таблиц

- **[{#T}](./schemas/overloaded-shards.md)**. Таблетки data shard, обслуживающие строчные таблицы, могут быть перегружены по нескольким причинам. Такая перегрузка приводит к росту задержек при выполнении запросов, выполняемых этими таблетками.

- **[{#T}](./schemas/splits-merges.md)**. {{ ydb-short-name }} поддерживает автоматическое разделение и слияние таблеток data shard, что позволяет легко адаптироваться к изменениям в рабочих нагрузках. Однако эти операции не являются бесплатными и могут оказать кратковременное негативное влияние на задержки запросов.

### Проблемы, связанные с клиентскими приложениями

- **Проблемы с запросами**. Неэффективные запросы к базе данных могут выполняться значительно медленнее.

- **Проблемы использования SDK**. Проблемы, связанные с неоптимальным или неправильным использованием {{ ydb-short-name }} SDK.

## Инструкции {#instructions}

При диагностике проблем с производительностью {{ ydb-short-name }} следует рассматривать каждую потенциальную причину проблемы как гипотезу. Систематично проанализируйте список гипотез и проверьте, применимы ли они к вашей ситуации. Каждая статья содержит описание проблемы, шаги по диагностике и рекомендации по решению проблемы, если гипотеза подтвердилась.

Если что-либо поменялось в системе, и время изменения совпадает с временем возникновения проблемы, связанные с изменением потенциальные причины следует рассмотреть в первую очередь. В ином случае рассмотрите возможные причины проблем с производительностью в приведённом ниже порядке, основанном на частотности проблем в крупных кластерах {{ ydb-short-name }}:

1. Перегруженные [шарды](schemas/overloaded-shards.md) и [ошибки `overloaded`](./queries/overloaded-errors.md);
1. [Разделение и слияние партиций таблиц](schemas/splits-merges.md);
1. [Частые переезды таблеток между узлами](ydb/tablets-moved.md);
1. Недостаточные аппаратные ресурсы:

    - [{#T}](hardware/io-bandwidth.md);
    - [{#T}](hardware/disk-space.md);
    - [{#T}](hardware/cpu-bottleneck.md);
    - [{#T}](hardware/insufficient-memory.md);

1. [{#T}](infrastructure/hardware.md) и [{#T}](infrastructure/dc-outage.md);
1. [{#T}](infrastructure/network.md);
1. [{#T}](ydb/ydb-updates.md);
1. [{#T}](system/system-clock-drift.md);
1. [{#T}](queries/transaction-lock-invalidation.md);
1. [{#T}](infrastructure/dc-drills.md).
