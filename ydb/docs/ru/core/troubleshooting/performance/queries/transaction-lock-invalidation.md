# Инвалидация блокировок транзакций

{{ ydb-short-name }} использует [optimistic concurrency control](https://en.wikipedia.org/wiki/Optimistic_concurrency_control) для обнаружения конфликтов с другими выполняющимися транзакциями. Если проверка блокировок в стадии коммита обнаруживает конфликтующие изменения, транзакция откатывается и должна быть выполнена заново. В этом случае {{ ydb-short-name }} возвращает ошибку `transaction locks invalidated`. Повторное выполнение значительного количества транзакций может замедлить ваше приложение.

{% note info %}

{{ ydb-short-name }} SDK предоставляет встроенный механизм обработки временных ошибок. Подробнее см. [{#T}](../../../reference/ydb-sdk/error_handling.md).

{% endnote %}


## Диагностика

<!-- The include is added to allow partial overrides in overlays  -->
{% include notitle [#](_includes/transaction-lock-invalidation.md) %}

## Рекомендации

Примите во внимание следующие рекомендации:

- Чем дольше длится транзакция, тем выше вероятность возникновения ошибки `transaction locks invalidated`.

    По возможности избегайте [интерактивных транзакций](../../../concepts/glossary.md#interactive-transaction). Лучшим подходом является использование одного YQL-запроса с командами `BEGIN;` и `COMMIT;` для выбора данных, обновления данных и выполнения коммита транзакции.

    Если без интерактивных транзакций не обойтись, выполняйте коммит транзакции в последнем запросе.

- Проанализируйте диапазон первичных ключей, в которых происходят конфликтующие изменения, и попытайтесь изменить логику приложения, чтобы уменьшить количество конфликтов.

    Например, если одна строка с общим балансовым значением часто обновляется, разделите эту строку на сто строк и рассчитайте общий баланс как сумму этих строк. Это значительно сократит количество ошибок `transaction locks invalidated`.
