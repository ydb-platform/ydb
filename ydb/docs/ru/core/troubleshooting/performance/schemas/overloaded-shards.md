# Перегруженные таблетки data shard

Таблетки [data shard](../../../concepts/glossary.md#data-shard), обслуживающие [строковые таблицы](../../../concepts/datamodel/table.md#row-oriented-tables), могут быть перегружены по следующим причинам:

* Таблица создана без указания параметра [AUTO_PARTITIONING_BY_LOAD](../../../concepts/datamodel/table.md#AUTO_PARTITIONING_BY_LOAD).

    В этом случае {{ ydb-short-name }} не разбивает перегруженные таблетки data shard.

    Таблетки data shard являются однопоточными и обрабатывают запросы последовательно. Каждая таблетка data shard может принимать на выполнение до 10000 операций. Принятые запросы ожидают своей очереди на выполнение. Таким образом, чем длиннее очередь, тем выше задержка.

    Если таблетка data shard уже содержит 10000 операций в своей очереди, новые запросы будут возвращать ошибку «overloaded». Повторите такие запросы, используя экспоненциально растущий перерыв, см. [{#T}](../queries/overloaded-errors.md).

* Таблица создана с параметром [AUTO_PARTITIONING_MAX_PARTITIONS_COUNT](../../../concepts/datamodel/table.md#AUTO_PARTITIONING_MAX_PARTITIONS_COUNT) и уже достигла лимита на число партиций.

* Неэффективный [первичный ключ](../../../concepts/glossary.md#primary-key), который вызывает дисбаланс в распределении запросов по таблеткам data shard. Типичным примером является использование монотонно увеличивающегося первичного ключа при загрузке данных, что может привести к перегрузке «последней» партиции. {% if feature_serial %}Например, это может произойти с автоматически увеличивающимся первичным ключом, использующим тип данных [Serial](../../../yql/reference/types/serial.md).{% endif %}

## Диагностика

<!-- The include is added to allow partial overrides in overlays  -->
{% include notitle [#](_includes/overloaded-shards-diagnostics.md) %}

## Рекомендации

### Для конфигурации таблиц {#table-config}

Рассмотрите следующие решения для устранения перегрузки таблеток data shard:

* Если в проблемной таблице не включено партиционирование по нагрузке, включите его.

    {% note tip %}

    Партиционирование по нагрузке отключено, если на вкладке **Diagnostics > Info** во **Встроенном UI** или в выводе команды `ydb scheme describe` отображается строка `Partitioning by load: false`.

    {% endnote %}

* Если количество партиций в таблице достигло максимального лимита, увеличьте максимальный лимит партиций таблицы.

    {% note tip %}

    Чтобы определить количество партиций в таблице, см. значение `PartCount` на вкладке **Diagnostics > Info** во **Встроенном UI**.

    {% endnote %}

Обе операции можно выполнить с помощью запроса [`ALTER TABLE ... SET`](../../../yql/reference/syntax/alter_table/set.md).

### Для несбалансированного первичного ключа {#pk-recommendations}

Рассмотрите возможность изменения первичного ключа, чтобы равномерно распределить нагрузку по партициям таблицы. Вы не можете изменить первичный ключ существующей таблицы. Для этого вам нужно будет создать новую таблицу с изменённым первичным ключом, а затем перенести данные в новую таблицу.

{% note info %}

Также рассмотрите возможность изменения логики вашего приложения для генерации значений первичного ключа для новых строк. Например, используйте хэши значений вместо самих значений.

{% endnote %}
