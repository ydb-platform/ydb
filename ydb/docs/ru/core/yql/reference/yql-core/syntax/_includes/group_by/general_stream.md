## GROUP BY ... HOP

Сгруппировать таблицу по значениям указанных столбцов или выражений, а также окну времени.

Если GROUP BY присутствует в запросе, то при выборке столбцов (между `SELECT STREAM ... FROM`) допустимы **только** следующие конструкции:

1. Столбцы, по которым производится группировка (присутствующие в аргументе `GROUP BY`).
2. Агрегатные функции (см. следующий раздел). Столбцы, по которым **не** идет группировка, можно включать только в качестве аргументов агрегатной функции.
3. Функции, выдающие начальное и конечное время текущего окна (`HOP_START` и `HOP_END`)
4. Произвольные вычисления, комбинирующие пункты 1-3.

Имеется возможность выполнять группировку по результату вычисления произвольного выражения от исходных столбцов. В этом случае для получения доступа к результату этого выражения рекомендуется присваивать ему имя с помощью `AS`, см. второй пример.

Агрегатные функции автоматически пропускают `NULL` в своих аргументах.

Среди столбцов, по которым производится группировка, должна присутствовать конструкция `HOP`, определяющая характеристики окна времени для группировки.
``` yql
HOP(time_extractor, hop, interval, delay)
```
Реализованный вариант окна времени называется **hopping window**. Это окно, продвигающееся вперёд дискретными интервалами (параметр `hop`). Общая длительность окна задаётся параметром `interval`. Для определения времени каждого входного события используется параметр `time_extractor`. Это выражение, зависящее только от входных значений столбцов стрима, должно иметь тип `Timestamp`. Оно указывает, откуда именно во входных событиях доставать значение времени.

В каждом потоке, определяемом значениями всех столбцов группировки, окно продвигается независимо от других потоков. Продвижение окна полностью зависит от самого позднего события потока. Поскольку записи в потоках слегка перемешиваются во времени, добавлен параметр `delay`, позволяющий отложить закрытие окна на указанную величину. События, приходящие до текущего окна, игнорируются.

Параметры `interval` и `delay` следует задавать кратными параметру `hop`. Некратные интервалы будут округлены в меньшую сторону.

Для задания `hop`, `interval` и `delay` используется строковое выражение, соответствующее стандарту [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601). Это формат, который используется для конструирования встроенного типа `Interval` [из строки](../../../builtins/basic.md#data-type-literals).

Функции без параметров `HOP_START` и `HOP_END` возвращают значение типа `Timestamp` и соответствуют началу и концу текущего окна.

Известное в других системах **tumbling window** является частным случаем **hopping window**, когда `interval` == `hop`.

### Примеры

``` yql
SELECT STREAM
    key,
    COUNT(*)
FROM my_stream
GROUP BY
    HOP(CAST(subkey AS Timestamp), "PT10S", "PT1M", "PT30S"),
    key;
-- hop = 10 секунд
-- interval = 1 минута
-- delay = 30 секунд
```

``` yql
SELECT STREAM
    double_key,
    HOP_END() as time,
    COUNT(*) as count
FROM my_stream
GROUP BY
    key + key AS double_key,
    HOP(ts, "PT1М", "PT1M", "PT1M");
```
