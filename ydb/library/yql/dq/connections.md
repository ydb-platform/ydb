# Intro
SQL-запрос преобразуется во внутреннее представление в виде DQ-графа.

DQ-граф состоит из стадий (_DqStage_), соединённых рёбрами (коннекшинами типа _DqConnection_).

Каждая стадия исполняется в виде некоторого количества тасков (_DqTask_). Например, читающая таблицу стадия может
исполняться в N тасков, где N - это количество шардов таблицы.

# Виды коннекшинов

## DqCnUnionAll
* _NodeType_: **UnionAll**
* _PlanNodeType_: **Connection**

Объединяет результаты всех тасков одной стадии (producer stage) и отдаёт их как единый результат в единственный таск
другой стадии (consumer stage).
```
 +--------------------------------------+
 |  DqStage_1: DqTask_1, ..., DqTask_N  |
 +----------------+--------------+------+
                  |      ...     |
                  +--------+-----+ DqCnUnionAll
                           |
                           V
 +--------------------------------------+
 |           DqStage_2: DqTask_1        |
 +--------------------------------------+
```

## DqCnMerge (In Development)
* _NodeType_: **Merge**
* _PlanNodeType_: **Connection**

Частный случай DqUnionAll, когда результаты первой стадии отсортированы по заданному набору колонок. Результат так же
отсортирован.


## DqCnMap
* _NodeType_: **Map**
* _PlanNodeType_: **Connection**

Реализует связи тасков стадий 1-к-1. Т.е. producer stage и consumer stage должны иметь одинаковое количество тасков.
```
 +--------------------------------------+
 |  DqStage_1: DqTask_1, ..., DqTask_N  |
 +----------------+--------------+------+
                  |              |
                  |      ...     | DqCnMap
                  |              |
                  V              V
 +--------------------------------------+
 |  DqStage_2: DqTask_1, ..., DqTask_N  |
 +--------------------------------------+
```

## DqCnBroadcast
* NodeType: **Broadcast**
* PlanNodeType: **Connection**

Рассылает результат единственного таска одной стадии (producer stage) на все таски другой (consumer stage).
```
 +--------------------------------------+
 |           DqStage_1: DqTask_1        |
 +-------------------------+------------+
                           |
                  +--------+-----+ DqCnBroadcast
                  |      ...     |
                  V              V
 +--------------------------------------+
 |  DqStage_2: DqTask_1, ..., DqTask_N  |
 +--------------------------------------+
```

## DqCnHashShuffle
* _NodeType_: **HashShuffle**
* _PlanNodeType_: **Connection**
* _KeyColumns_: список колонок, по которым идёт перемешивание

Рассылает результаты с тасков одной стадии (producer stage) на таски другой (consumer stage) по некоторому правилу для
заданных колонок. Правило жётско описано в коде, но вот список колонок указывается в каждом коннекшине независимо.

Типичным использованием является hash-partitioning для full outer join и для агрегаций.
```
 +--------------------------------------+
 |  DqStage_1: DqTask_1, ..., DqTask_N  |
 +----------------+--------------+------+
                  |\            /|
                  | \     ...  / | DqCnHashShuffle
                  |  \        /  |
                  V   V      V   V
 +--------------------------------------+
 |  DqStage_2: DqTask_1, ..., DqTask_M  |
 +--------------------------------------+
```

## DqCnResult
* _NodeType_: **Result**
* _PlanNodeType_: --

Вспомогательный вид коннекшина, в который передаётся результат выполнения всего запроса.

## DqCnValue
Вспомогательный вид коннекшина, который реализует переход из векторного в скалярный контекст. По нему происходит
разбиение запроса на фазы исполнения.

Не должно попадать в explain.


# KQP Specific Connections

## KqpCnMapShard
* _NodeType_: **Map**
* _PlanNodeType_: **Connection**

Используется только для inplace-update под прагмой. В этом случае обе стадии выполняются на одном шарде и последовательно.

## KqpCnShuffleShard
Задумывалось для межшардового взаимодействия. Нигде не используется.
