services:

  fq-connector-go:
    build: ./connector.d
    container_name: fq-tests-join-fq-connector-go
    ports:
      - 2130
    depends_on:
      clickhouse:
        condition: service_healthy
      postgresql:
        condition: service_healthy

  clickhouse:
    build: ./clickhouse.d
    container_name: fq-tests-join-clickhouse
    environment:
      CLICKHOUSE_ALWAYS_RUN_INITDB_SCRIPTS: 1
      CLICKHOUSE_DB: db
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
      CLICKHOUSE_PASSWORD: password
      CLICKHOUSE_USER: user
    ports:
      - 9000
      - 8123

  postgresql:
    command:
      - postgres
      - -c
      - log_statement=all
      - -c
      - log_connections=on
      - -c
      - log_disconnections=on
    container_name: fq-tests-join-postgresql
    environment:
      POSTGRES_DB: db
      POSTGRES_PASSWORD: password
      POSTGRES_USER: user
    image: mirror.gcr.io/library/postgres:15-bullseye@sha256:2e89ed90224245851ea2b01e0b20c4b893e69141eb36e7a1cece7fb9e19f21f0
    ports:
      - 5432
    healthcheck:
      test: ["CMD", "pg_isready", "-q", "-h", "localhost", "-p", "5432", "-U", "${POSTGRES_USER}", "-d", "${POSTGRES_DB}"]
      interval: 10s
      timeout: 50s
      retries: 5
      start_period: 30s

version: "2.4"

