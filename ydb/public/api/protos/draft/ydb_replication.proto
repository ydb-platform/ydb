syntax = "proto3";
option cc_enable_arenas = true;

import "ydb/public/api/protos/annotations/validation.proto";
import "ydb/public/api/protos/ydb_issue_message.proto";
import "ydb/public/api/protos/ydb_operation.proto";
import "ydb/public/api/protos/ydb_scheme.proto";

import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";

package Ydb.Replication;
option java_package = "com.yandex.ydb.replication";

message DescribeReplicationRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    // Replication path.
    string path = 2 [(required) = true];
    // Include statistics.
    bool include_stats = 3;
}

message DescribeReplicationResponse {
    // Result of request will be inside operation.
    Ydb.Operations.Operation operation = 1;
}

message ConnectionParams {
    message StaticCredentials {
        string user = 1;
        string password_secret_name = 2;
    }

    message OAuth {
        string token_secret_name = 1;
    }

    string endpoint = 1;
    string database = 2;
    bool enable_ssl = 5;
    string connection_string = 6;

    oneof credentials {
        StaticCredentials static_credentials = 3;
        OAuth oauth = 4;
    }
}

message ConsistencyLevelRow {
}

message ConsistencyLevelGlobal {
    google.protobuf.Duration commit_interval = 1;
}

message DescribeReplicationResult {
    message Stats {
        optional google.protobuf.Duration lag = 1;
        optional float initial_scan_progress = 2;
    }

    message Item {
        string source_path = 1;
        string destination_path = 2;
        optional string source_changefeed_name = 3;
        uint64 id = 4;
        Stats stats = 5;
    }

    message RunningState {
        Stats stats = 1;
    }

    message ErrorState {
        repeated Ydb.Issue.IssueMessage issues = 1;
    }

    message DoneState {
    }

    message PausedState {
    }

    // Description of scheme object.
    Ydb.Scheme.Entry self = 1;

    ConnectionParams connection_params = 2;
    oneof consistency_level {
        ConsistencyLevelRow row_consistency = 7;
        ConsistencyLevelGlobal global_consistency = 8;
    }
    repeated Item items = 3;
    oneof state {
        RunningState running = 4;
        ErrorState error = 5;
        DoneState done = 6;
        PausedState paused = 9;
    }
}

message DescribeTransferRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    // Replication path.
    string path = 2 [(required) = true];
    // Include detailed statistics for each worker.
    optional bool include_stats = 3;
}

message DescribeTransferResponse {
    // Result of request will be inside operation.
    Ydb.Operations.Operation operation = 1;
}

// Message representing sliding window statistics by several windows.
message MultipleWindowsStat {
    // Average per minute.
    google.protobuf.Duration per_minute = 1;
    // Average per hour.
    google.protobuf.Duration per_hour = 2;
}

message DescribeTransferResult {
    message RunningState {
    }

    message ErrorState {
        repeated Ydb.Issue.IssueMessage issues = 1;
    }

    message DoneState {
    }

    message PausedState {
    }

    message Stats {
        enum WorkState {
            // No reported state.
            STATE_UNSPECIFIED = 0;
            // Reading data from topic.
            STATE_READ = 1;
            // Decompressing read data.
            STATE_DECOMPRESS = 2;
            // Rrocessing data with lambda.
            STATE_PROCESS = 3;
            // Writing data to table.
            STATE_WRITE = 4;
        }

        message WorkerStats {
            // unique worker identifier
            string worker_id = 1;
            // last reported work state
            WorkState state = 2;
            // timestamp of last state change
            google.protobuf.Timestamp last_state_change = 3;
            // partition of the topic that worker is reading
            int64 partition_id = 4;
            // current read offset in partition
            int64 read_offset = 5;
            // how long this worker is being run for
            google.protobuf.Duration uptime = 6;
            // total cumulative number of worker restarts
            int64 restart_count = 7;
            // worker restarts per time, sliding window
            MultipleWindowsStat restarts = 8;
            // topic read speed in sliding window, bytes
            MultipleWindowsStat read_bytes = 9;
            // topic read speed in sliding window, messages
            MultipleWindowsStat read_messages = 10;
            // table write speed in sliding window, bytes
            MultipleWindowsStat write_bytes = 11;
            // table write speed in sliding window, rows
            MultipleWindowsStat write_rows = 12;

            // cpu usage time on decompression, microseconds
            MultipleWindowsStat decompression_cpu_time = 13;
            // cpu usage time on processing, microseconds
            MultipleWindowsStat processing_cpu_time = 14;
        }

        // detailed stats of every worker, only included if DescribeTransferRequest.include_stats flag = true in request
        repeated WorkerStats workers_stats = 1;
        // minimal uptime of all current workers
        google.protobuf.Duration min_worker_uptime = 2;

        // topic read speed in sliding window, overall for transfer, bytes
        MultipleWindowsStat read_bytes = 3;
        // topic read speed in sliding window, overall for transfer, messages
        MultipleWindowsStat read_messages = 4;
        // table write speed in sliding window, overall for transfer, bytes
        MultipleWindowsStat write_bytes = 5;
        // table write speed in sliding window, overall for transfer, rows
        MultipleWindowsStat write_rows = 6;

        // cpu usage time on decompression, overall for transfer, microseconds
        MultipleWindowsStat decompression_cpu_time = 7;
        // cpu usage time on processing, overall for transfer, microseconds
        MultipleWindowsStat processing_cpu_time = 8;
        // moment when stats collection was last started (or reset)
        google.protobuf.Timestamp stats_collection_start = 9;
    }

    // Description of scheme object.
    Ydb.Scheme.Entry self = 1;

    ConnectionParams connection_params = 2;

    oneof state {
        RunningState running = 3;
        ErrorState error = 4;
        DoneState done = 5;
        PausedState paused = 6;
    }

    string source_path = 7;
    string destination_path = 8;
    string transformation_lambda = 9;
    string consumer_name = 10;

    message BatchSettings {
        optional uint64 size_bytes = 1;
        google.protobuf.Duration flush_interval = 2;
    }

    optional BatchSettings batch_settings = 11;
    optional Stats stats = 12;
}
