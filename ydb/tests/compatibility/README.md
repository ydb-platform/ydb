# Тесты совместимости

Тесты совместимости позволяют обнаруживать ошибки, которые возникают при апгрейде и даунгрейде YDB. 

## Механика работы тестов

Тестовая обвязка скачивает YDB последней стабильной версии. После этого тестам доступны два бинарных файла: текущий (собранный из текущего среза исходников) и предыдущий. Таким образом, в этих тестах можно использовать тестовый кластер не только с одной версией YDB, но и с двумя. Текущая версия условно называется **current/target**, а предыдущая — **initial**.

## Как написать тест

1. Выбрать подходящую [фикстуру](#фикстуры)
2. Сделать новый файл с тестом (либо же выбрать имеющийся, если он подходит по области)
3. Закодировать тест. Как первый шаг, можно скопировать пример из [test_example.py](test_example.py)

## Фикстуры

Для упрощения написания тестов было создано несколько тестовых фикстур, которые предоставляют типовые сценарии тестирования. Фикстуры содержат в себе общую логику, которую можно переиспользовать в тестах. Все фикстуры поднимают кластер `MIRROR_3_DC` и предоставляют его для тестирования.

Примеры использования фикстур можно посмотреть в [test_example.py](test_example.py)

### MixedClusterFixture

Фикстура поднимает кластер, который состоит из нод версий current и init. Позволяет протестировать работу в режиме, когда часть нод у нас уже обновилась, а часть еще нет.

Имеет параметризацию (то есть каждый написанный такой тест превращается в несколько):
- поднимается смешанный кластер init+current
- поднимается кластер исключительно на версии init
- поднимается кластер исключительно на версии current

Последние два нужны, чтобы отвечать на вопрос "а работает ли такой сценарий в принципе, когда кластер состоит из нод одной версии". Если получается так, что тест init+current не проходит, а в отсутствие разных версий тест завершается успешно, то это сильный сигнал к тому, что где-то поломана совместимость.

#### Для чего использовать

Для проверки совместимости версий в рамках исполнения запросов, которые требуют взаимодействия между нодами кластера.

### RestartToAnotherVersionFixture

Фикстура сначала поднимает кластер в одной комбинации (например, все ноды init), а потом позволяет остановить кластер и поднять кластер с другими версиями (например, все ноды current).

Имеет параметризацию (то есть каждый написанный такой тест превращается в несколько):
- обновление init → current
- обновление current → init
- обновление current → current

Список не исчерпывающий, полный можно посмотреть в коде фикстуры.

В самом тесте для смены версий необходимо вызвать `self.change_cluster_version()`, и версия изменится.

#### Для чего использовать

Данная фикстура позволяет протестировать, например, несовместимости по данным (как и при апгрейде, так и при даунгрейде), например, что новая версия не пишет чего-то, что старая версия не может прочитать.

### RollingUpgradeAndDowngradeFixture

Фикстура позволяет протестировать сценарий роллинг-апгрейда и даунгрейда. Реализует сценарий "имеется кластер init версии, он понодно заменяется на current версию, потом обратно на init".

Сама фикстура сначала поднимает кластер версии init, потом заменяет ноды на версию current, а потом обратно понодно заменяет на init, эмулируя откат.

Шаг апгрейда/даунгрейда (замена версии ноды на другую) вызывается из теста следующим образом:

```python
for _ in self.roll():
    pass  # do something with cluster between upgrade/downgrade steps
```

На каждой итерации цикла тестовое окружение заменяет одну ноду на другую версию.

Схематично можно изобразить следующим образом (I — init, C — current, каждый столбец — это версия ноды кластера, каждая строка — текущее состояние кластера в теле цикла):

```
IIIIIIIII
CIIIIIIII
CCIIIIIII
...
CCCCCCCCI
CCCCCCCCC
ICCCCCCCC
IICCCCCCC
...
IIIIIIIIC
IIIIIIIII
```

#### Для чего использовать

Это наиболее приближенный к реальности сценарий. Его, например, можно использовать для тестирования, в котором необходимо, чтобы все таблетки со 100% гарантией в рамках работы кластера переехали с одной версии на другую.
