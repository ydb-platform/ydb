# Тесты совместимости 

Одна из мажорных проблем в новых стабильных ветках состоит в том, что в рамках апгрейда YDB со старой версии возникают несовеместимости между новой и старой версией. Данные тесты призваны протестировать этот сценарий. Механика тестов следующая: тесты скачивают YDB последней стабильной версии для main, а для стабильной ветки скачивается предыдущая стабильная версия. Таким образом, если текущий бранч main, то на текущий момент скачивается 25-1, а если текущий бранч 25-1, то скачивается 24-4. 

После чего у нас есть два бинарных файла: текущий (собранный из текущего среза сорцов) и предыдущий. Таким образом, в этих тестах можно использовать тестовый кластер не только с одной версией YDB, а с двумя. Текущая версия условно называется **current**, а предыдущая **last**.

Для упрощения написания тестов было сделано несколько тестовых фикстур, которые предоставляют типовые сценарии тестирования. Все фикстуры поднимают кластер `MIRROR_3_DC` и предоставляют его для тестирования. 

Примеры использования фикстур можно посмотреть в (test_example.py)[test_example.py]

## MixedClusterFixture
Фикстура поднимает кластер который состоит из current и last нод. позволяет протестировать работу в режиме, когда часть нод у нас уже обновилась, а часть еще нет. 

Имеет параметризацию (то есть каждый написанный такой тест превращается в несколько):
- поднимается смешанный кластер last+current
- поднимается кластер исключительно на версии last
- поднимается кластер исключительно на версии current

Последние два нужны чтобы отвечать на вопрос "а работает ли у такой сценарий в принципе, когда кластер состоит из нод одной вресии". Если получается так, что тест last+current не проходит, а в отсутствие разных версий тест завершается успешно, то это сильный сигнал к тому, что где-то поломана совместимость. 

## RestartToAnotherVersionFixture
Фикстура сначала поднимает кластер в одной комбинации (например, все ноды last), а потом позволяет остановить кластер и поднять кластер с другими версиями (например, все ноды current). Данная фикстура позволяет протестировать, например, несовместимости по данным (как и при апгрейде, так и при даунгрейде)

Имеет параметризацию (то есть каждый написанный такой тест превращается в несколько):
- обновление last -> current
- обновление current -> last
- обновление current -> current

Список не исчерпывающий.

В самом тесте для смены версий необходимо вызвать `self.change_cluster_version()` и версия изменится. 

## RollingUpgradeAndDowngradeFixture
Фикстура позволяет протестировать сценарий роллинг апгрейда. Позволяет реализовать сценарий "имеется кластер одной версии, он понодно заменяется на другую версию, потом обратно". 

Сама фикстура сначала поднимает кластер версии last, потом заменяет ноды на версию current, а потом оборатно понодно заменяет на last эмулируя откат. 

Шаг апгрейда/даунгрейда (замена версии ноды на другую) вызывается вручную следующим образом: 

```python
        for _ in self.roll():
            pass  # do something with cluster
```