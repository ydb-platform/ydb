(
(let $1 (Configure! world (DataSource '"config") '"DqEngine" '"force"))
(let $2 (DataSource '"dq" '"$all"))
(let $3 (Configure! $1 $2 '"Attr" '"maxtasksperstage" '"2"))
(let $4 (Configure! $3 $2 '"Attr" '"watermarksmode" '"default"))
(let $5 (Configure! $4 $2 '"Attr" '"computeactortype" '"sync"))
(let $6 (Configure! $5 (DataSource '"pq" '"$all") '"Attr" '"consumer" '"test_client"))
(let $7 (DataSource '"pq" '"pq"))
(let $8 '('('"PartitionsCount" '"1")))
(let $9 (DataType 'String))
(let $10 '('"k" (OptionalType $9)))
(let $11 (DataType 'Uint64))
(let $12 (OptionalType $11))
(let $13 '('"t" $12))
(let $14 (StructType $10 $13 '('"v" $12)))
(let $15 (PqTopic '"pq" '"local" '"test_topic_input" $8 '() $14))
(let $16 '('"k" '"t" '"v"))
(let $17 '('"Endpoint" '"<pq_pq_endpoint>"))
(let $18 '('"SharedReading" '0))
(let $19 '('"UseSsl" '"1"))
(let $20 '('('"Consumer" '"test_client") $17 $18 '('"ReconnectPeriod" '"") '('"Format" '"json_each_row") '('"ReadGroup" '"fqrun") $19 '('"WatermarksEnable" '"1") '('"WatermarksGranularityUs" '"11000000") '('"WatermarksLateArrivalDelayUs" '"8000000") '('"WatermarksLateEventsPolicy" '"adjust")))
(let $21 (SecureParam '"cluster:default_pq"))
(let $22 (DqPqTopicSource $6 $15 $16 $20 $21 '"" $14 '"\x1A0\b\x03\x12\x19\x12\x17_yql_sys_tsp_write_time\x1A\x11\n\x0F\n\x02\b3\x12\t!\x00\x12z\x00\x00\x00\x00\x00"))
(let $23 (DqStage '((DqSource $7 $22)) (lambda '($27) (block '(
  (let $28 '('('"data.datetime.formatname" '"POSIX") '('"data.timestamp.formatname" '"POSIX") '('"watermarkgranularity" '"PT11S")))
  (let $29 '('('"format" '"json_each_row") '('"formatSettings" $28) '('"settings" '($18))))
  (let $30 (DqSourceWideWrap $27 $7 $14 $29))
  (return (NarrowMap $30 (lambda '($31 $32 $33) (AsStruct '('"k" $31) '('"t" $32) '('"v" $33)))))
))) '('('"_logical_id" '0))))
(let $24 (DataSink '"pq" '"pq"))
(let $25 (PqTopic '"pq" '"local" '"test_topic_output" $8 '() (StructType '('"Data" $9))))
(let $26 (DqPqTopicSink $25 '($17 $19) $21))
(return (Commit! (DqQuery! $6 '((DqStage '((DqCnHashShuffle (TDqOutput $23 '0) '('"k"))) (lambda '($34) (block '(
  (let $35 '('"strict"))
  (let $36 (lambda '($47) $47))
  (let $37 (MultiHoppingCore (FromFlow $34) (lambda '($38) (Member $38 '"k")) (lambda '($39) (FlatMap (Member (SafeCast $39 (StructType $13)) '"t") (lambda '($40) (block '(
    (let $41 '($11 '"" '"1"))
    (let $42 (CallableType '() '((OptionalType (DataType 'Timestamp))) $41))
    (let $43 (Udf '"DateTime2.FromMilliseconds" (Void) (VoidType) '"" $42 (VoidType) '"" '('('"blocks") $35)))
    (return (Apply $43 $40))
  ))))) (Interval '"5000") (Interval '"10000") (Interval '"5000000") 'true (lambda '($44) (AsStruct '('Sum0 (Member $44 '"v")))) (lambda '($45 $46) (AsStruct '('Sum0 (AggrAdd (Member $45 '"v") (Member $46 'Sum0))))) $36 $36 (lambda '($48 $49) (AsStruct '('Sum0 (AggrAdd (Member $48 'Sum0) (Member $49 'Sum0))))) (lambda '($50 $51 $52) (AsStruct '('Sum0 (Member $51 'Sum0)) '('"group0" $52) '('"k" $50))) '"1" '"group0"))
  (return (FlatMap (ExtractMembers $37 '('Sum0 '"k")) (lambda '($53) (block '(
    (let $54 (ResourceType '"Yson2.Node"))
    (let $55 '($54 '"" '"1"))
    (let $56 (CallableType '() '((DataType 'Yson)) $55))
    (let $57 '($35))
    (let $58 (Udf '"Yson2.SerializeText" (Void) (VoidType) '"" $56 (VoidType) '"" $57))
    (let $59 (StructType $10 '('"sum" $12)))
    (let $60 (TupleType (TupleType $59) (StructType) (TupleType)))
    (let $61 (CallableType '() '($54) '($59)))
    (let $62 (Udf '"Yson2.From" (Void) $60 '"" $61 (VoidType) '"" $57))
    (return (Just (AsStruct '('"column0" (Apply $58 (Apply $62 (AsStruct '('"k" (Member $53 '"k")) '('"sum" (Member $53 'Sum0)))))))))
  )))))
))) '('('"_logical_id" '0)) '((DqSink '0 $24 $26))))) $24))
)
