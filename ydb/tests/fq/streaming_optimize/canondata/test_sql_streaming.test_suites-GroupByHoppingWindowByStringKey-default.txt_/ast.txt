(
(let $1 (Configure! world (DataSource '"config") '"DqEngine" '"force"))
(let $2 (DataSource '"dq" '"$all"))
(let $3 (Configure! $1 $2 '"Attr" '"maxtasksperstage" '"2"))
(let $4 (Configure! $3 $2 '"Attr" '"watermarksmode" '"default"))
(let $5 (Configure! $4 $2 '"Attr" '"computeactortype" '"async"))
(let $6 (Configure! $5 (DataSource '"pq" '"$all") '"Attr" '"consumer" '"test_client"))
(let $7 (DataSource '"pq" '"pq"))
(let $8 '('('"PartitionsCount" '"1")))
(let $9 (DataType 'String))
(let $10 '('"k" (OptionalType $9)))
(let $11 (OptionalType (DataType 'Uint64)))
(let $12 '('"v" $11))
(let $13 (PqTopic '"pq" '"local" '"test_topic_input" $8 '('('"system" '_yql_sys_tsp_write_time)) (StructType $10 $12)))
(let $14 '('"Endpoint" '"<pq_pq_endpoint>"))
(let $15 '('"SharedReading" '"1"))
(let $16 '('"UseSsl" '"1"))
(let $17 '('('"Consumer" '"test_client") $14 $15 '('"ReconnectPeriod" '"") '('"Format" '"json_each_row") '('"ReadGroup" '"fqrun") $16 '('"WatermarksEnable" '"1") '('"WatermarksGranularityUs" '"1000000") '('"WatermarksLateArrivalDelayUs" '"5000000")))
(let $18 (SecureParam '"cluster:default_pq"))
(let $19 '('_yql_sys_tsp_write_time (DataType 'Timestamp)))
(let $20 (StructType $19 $10 $12))
(let $21 (DqPqTopicSource $6 $13 '('"k" '"v") $17 $18 '"" $20))
(let $22 (DqStage '((DqSource $7 $21)) (lambda '($26) (block '(
  (let $27 '('('"format" '"json_each_row") '('"metadataColumns" '('_yql_sys_tsp_write_time)) '('"formatSettings" '('('"data.datetime.formatname" '"POSIX") '('"data.timestamp.formatname" '"POSIX"))) '('"settings" '($15))))
  (let $28 (DqSourceWideWrap $26 $7 $20 $27))
  (return (NarrowMap $28 (lambda '($29 $30 $31) (AsStruct '('_yql_sys_tsp_write_time $29) '('"k" $30) '('"v" $31)))))
))) '('('"_logical_id" '0))))
(let $23 (DataSink '"pq" '"pq"))
(let $24 (PqTopic '"pq" '"local" '"test_topic_output" $8 '() (StructType '('"Data" $9))))
(let $25 (DqPqTopicSink $24 '($14 $16) $18))
(return (Commit! (DqQuery! $6 '((DqStage '((DqCnHashShuffle (TDqOutput $22 '0) '('"k"))) (lambda '($32) (block '(
  (let $33 (lambda '($40) $40))
  (let $34 (MultiHoppingCore (FromFlow $32) (lambda '($35) (Member $35 '"k")) (lambda '($36) (Just (Member (SafeCast $36 (StructType $19)) '_yql_sys_tsp_write_time))) (Interval '"5000") (Interval '"10000") (Interval '"5000000") 'true (lambda '($37) (AsStruct '('Sum0 (Member $37 '"v")))) (lambda '($38 $39) (AsStruct '('Sum0 (AggrAdd (Member $38 '"v") (Member $39 'Sum0))))) $33 $33 (lambda '($41 $42) (AsStruct '('Sum0 (AggrAdd (Member $41 'Sum0) (Member $42 'Sum0))))) (lambda '($43 $44 $45) (AsStruct '('Sum0 (Member $44 'Sum0)) '('"group0" $45) '('"k" $43))) '"1"))
  (return (FlatMap (ExtractMembers $34 '('Sum0 '"k")) (lambda '($46) (block '(
    (let $47 (ResourceType '"Yson2.Node"))
    (let $48 '($47 '"" '"1"))
    (let $49 (CallableType '() '((DataType 'Yson)) $48))
    (let $50 '('('"strict")))
    (let $51 (Udf '"Yson2.SerializeText" (Void) (VoidType) '"" $49 (VoidType) '"" $50))
    (let $52 (StructType $10 '('"sum" $11)))
    (let $53 (TupleType (TupleType $52) (StructType) (TupleType)))
    (let $54 (CallableType '() '($47) '($52)))
    (let $55 (Udf '"Yson2.From" (Void) $53 '"" $54 (VoidType) '"" $50))
    (return (Just (AsStruct '('"column0" (Apply $51 (Apply $55 (AsStruct '('"k" (Member $46 '"k")) '('"sum" (Member $46 'Sum0)))))))))
  )))))
))) '('('"_logical_id" '0)) '((DqSink '0 $23 $25))))) $23))
)
