# Стресс-тесты и стресс-утилиты

**Стресс-тесты** — это тесты, которые устроены следующим образом:
- Поднимается кластер YDB.
- На кластер подаётся нагрузка.
- Проверяется, что кластер YDB не упал.

Чем могут быть полезны тесты такого типа:
- Проверяется, что не возникает ошибок типа VERIFY во время работы кластера.
- При прогоне с санитайзерами (asan, msan, tsan) возможно найти проблемы, так как задействовано много логики.
- Код, подающий нагрузку, может быть переиспользован в тестах совместимости и в тестах nemesis.

## Как писать тесты такого типа

Тест должен быть поделен на две части:
- Утилита, которая подаёт нагрузку.
- Тест, который поднимает кластер и использует утилиту для подачи нагрузки. Тест должен запускать и останавливать нагрузку спустя некоторое время (например, через 2 минуты).

## Создание утилиты для подачи нагрузки

Утилита должна уметь запускаться со следующими аргументами
```
    parser.add_argument("--endpoint", default="localhost:2135", help="An endpoint to be used")
    parser.add_argument("--database", default="Root/test", help="A database to connect")
    parser.add_argument("--path", default="olap_workload", help="A path prefix for tables")
    parser.add_argument("--duration", default=10 ** 9, type=lambda x: int(x), help="A duration of workload in seconds.")
```

При написании самой нагрузки необходимо задействовать как можно больше логики в текущей функциональной области. Например, если требуется написать нагрузку для чтения-записи таблиц, то необходимо использовать разные типы, разные индексы, ALTER TABLE и т.п. Тем самым покрывается большой кусок логики YDB, что позволяет выявить больше проблем. 

## Примеры

Пример реализованной нагрузки можно посмотреть [здесь](olap_workload/__main__.py).

Пример самого теста находится [здесь](olap_workload/tests/test_workload.py).

Рекомендуемая структура директорий:
- `<stress_test_name>/__main__.py` — утилита, которая создаёт нагрузку.
- `<stress_test_name>/tests` — директория для тестов, которые используют эту нагрузку.
