syntax = "proto3";

package NYql.NFmr.NProto;

enum EOperationStatus {
    OPERATION_UNKNOWN = 0;
    OPERATION_ACCEPTED = 1;
    OPERATION_IN_PROGRESS = 2;
    OPERATION_FAILED = 3;
    OPERATION_COMPLETED = 4;
    OPERATION_ABORTED = 5;
    OPERATION_NOT_FOUND = 6;
}

enum ETaskStatus {
    TASK_UNKNOWN = 0;
    TASK_ACCEPTED = 1;
    TASK_IN_PROGRESS = 2;
    TASK_FAILED = 3;
    TASK_COMPLETED = 4;
}

enum ETaskType {
    TASK_TYPE_UNKNOWN = 0;
    TASK_TYPE_DOWNLOAD = 1;
    TASK_TYPE_UPLOAD = 2;
    TASK_TYPE_MERGE = 3;
    TASK_TYPE_MAP = 4;
    TASK_TYPE_DISTRIBUTED_UPLOAD = 5;
    TASK_TYPE_SORTED_MERGE = 6;
}

enum EFmrComponent {
    COMPONENT_UNKNOWN = 0;
    COMPONENT_COORDINATOR = 1;
    COMPONENT_WORKER = 2;
    COMPONENT_JOB = 3;
}

enum EFmrReason {
    REASON_UNKNOWN = 0;
    REASON_RESTART_OPERATION = 1;
    REASON_RESTART_QUERY = 2;
    REASON_UDF_TERMINATE = 3;
}

enum ESortOrder {
    ASCENDING = 0;
    DESCENDING = 1;
}

message TFmrError {
    EFmrComponent Component = 1;
    EFmrReason Reason = 2;
    string ErrorMessage = 3;
    optional uint32 WorkerId = 4;
    optional string TaskId = 5;
    optional string OperationId = 6;
    optional string JobId = 7;
}

message TYtTableRef {
    string RichPath = 1;
    optional string FilePath = 2;
}

message TYtTableTaskRef {
    repeated string RichPath = 1;
    repeated string FilePath = 2;
}

message TFmrTableId {
    string Id = 1;
}

message TFmrTableRef {
    TFmrTableId FmrTableId = 1;
    repeated string Columns = 2;
    optional string ColumnGroups = 3;
    repeated ESortOrder SortOrder = 4;
    repeated string SortColumns = 5;
}

message TTableRange {
    string PartId = 1;
    uint64 MinChunk = 2;
    uint64 MaxChunk = 3;
}

message TFmrTableInputRef {
    string TableId = 1;
    repeated TTableRange TableRanges = 2;
    repeated string Columns = 3;
    optional string ColumnGroups = 4;
    optional bool   IsFirstRowInclusive = 5;
    optional string FirstRowKeys = 6;
    optional string LastRowKeys = 7;
}

message TSortingColumns {
    repeated string Columns = 1;
    repeated ESortOrder SortOrder = 2;
}

message TFmrTableOutputRef {
    string TableId = 1;
    string PartId = 2;
    optional string ColumnGroups = 3;
    optional TSortingColumns SortingColumns = 4;
}

message TTableStats {
    uint64 Chunks = 1;
    uint64 Rows = 2;
    uint64 DataWeight = 3;
}

message TSortedChunkStats {
    bool IsSorted = 1;
    string FirstRowKeys = 2;
    string LastRowKeys = 3;
}

message TChunkStats {
    uint64 Rows = 1;
    uint64 DataWeight = 2;
    TSortedChunkStats SortedChunkStats = 3;
}

message TTableChunkStats {
    string PartId = 1;
    repeated TChunkStats PartIdChunkStats = 2;
}

message TStatisticsObject {
    TFmrTableOutputRef FmrTableOutputRef = 1;
    TTableChunkStats TableChunkStats = 2;
}

message TStatistics {
    repeated TStatisticsObject OutputTables = 1;
    optional TTaskResult TaskResult = 2;
}

message TOperationTableRef {
    oneof OperationTableRef {
        TYtTableRef YtTableRef = 1;
        TFmrTableRef FmrTableRef = 2;
    }
}

message TTaskTableRef {
    oneof TaskTableRef {
        TYtTableTaskRef YtTableTaskRef = 1;
        TFmrTableInputRef FmrTableInputRef = 2;
    }
}

message TTaskTableInputRef {
    repeated TTaskTableRef Inputs = 1;
}

message TUploadOperationParams {
    TFmrTableRef Input = 1;
    TYtTableRef Output = 2;
}

message TSortedUploadOperationParams {
    TFmrTableRef Input = 1;
    TYtTableRef Output = 2;
    string SessionId = 3;
    repeated string Cookies = 4;
    uint32 SessionType = 5;
    string PartitionId = 6;
    bool IsOrdered = 7;
}

message TSortedUploadTaskParams {
    TFmrTableInputRef Input = 1;
    TYtTableRef Output = 2;
    string CookieYson = 3;
    uint32 SessionType = 4;
    uint64 Order = 5;
}

message TUploadTaskParams {
    TFmrTableInputRef Input = 1;
    TYtTableRef Output = 2;
}

message TDownloadOperationParams {
    TYtTableRef Input = 1;
    TFmrTableRef Output = 2;
}

message TDownloadTaskParams {
    TYtTableTaskRef Input = 1;
    TFmrTableOutputRef Output = 2;
}

message TMergeOperationParams {
    repeated TOperationTableRef Input = 1;
    TFmrTableRef Output = 2;
}

message TSortedMergeOperationParams {
    repeated TOperationTableRef Input = 1;
    TFmrTableRef Output = 2;
}

message TSortedMergeTaskParams {
    TTaskTableInputRef Input = 1;
    TFmrTableOutputRef Output = 2;
}

message TMergeTaskParams {
    TTaskTableInputRef Input = 1;
    TFmrTableOutputRef Output = 2;
}

message TMapOperationParams {
    repeated TOperationTableRef Input = 1;
    repeated TFmrTableRef Output = 2;
    bytes SerializedMapJobState = 3;
    bool IsOrdered = 4;
}

message TMapTaskParams {
    TTaskTableInputRef Input = 1;
    repeated TFmrTableOutputRef Output = 2;
    bytes SerializedMapJobState = 3;
    bool IsOrdered = 4;
}

message TOperationParams {
    oneof TOperationParams {
        TUploadOperationParams UploadOperationParams = 1;
        TDownloadOperationParams DownloadOperationParams = 2;
        TMergeOperationParams MergeOperationParams = 3;
        TMapOperationParams MapOperationParams = 4;
        TSortedUploadOperationParams SortedUploadOperationParams = 5;
        TSortedMergeOperationParams SortedMergeOperationParams = 6;
    }
}

message TTaskParams {
    oneof TTaskParams {
        TUploadTaskParams UploadTaskParams = 1;
        TDownloadTaskParams DownloadTaskParams = 2;
        TMergeTaskParams MergeTaskParams = 3;
        TMapTaskParams MapTaskParams = 4;
        TSortedUploadTaskParams SortedUploadTaskParams = 5;
        TSortedMergeTaskParams SortedMergeTaskParams = 6;
    }
}

message TClusterConnection {
    string TransactionId = 1;
    string YtServerName = 2;
    optional string Token = 3;
}

message TFileInfo {
    string LocalPath = 1;
    string Md5Key = 2;
    string Alias = 3;
}

message TYtResourceInfo {
    string RichPath = 1;
    string YtServerName = 2;
    string Token = 3;
    string LocalPath = 4;
}

message TFmrResourceOperationInfo {
    TFmrTableRef FmrTable = 1;
    string Alias = 2;
}

message TFmrResourceTaskInfo {
    repeated TFmrTableInputRef FmrResourceTasks = 1;
    string LocalPath = 2;
    string Alias = 3;
}

message TTask {
    ETaskType TaskType = 1;
    string TaskId = 2;
    TTaskParams TaskParams = 3;
    string SessionId = 4;
    optional uint32 NumRetries = 5;
    map<string, TClusterConnection> ClusterConnections = 6;
    optional string JobSettings = 7;
    repeated TFileInfo Files = 8;
    repeated TYtResourceInfo YtResources = 9;
    repeated TFmrResourceTaskInfo FmrResources = 10;
    optional string JobEnvironmentDir = 11;
}

message TTaskUploadResult {
}

message TTaskDownloadResult {
}

message TTaskMergeResult {
}

message TTaskMapResult {
}

message TTaskSortedUploadResult {
    string FragmentResult = 1;
    uint64 FragmentOrder = 2;
}

message TTaskResult {
    oneof TTaskResult {
        TTaskUploadResult TaskUploadResult = 1;
        TTaskDownloadResult TaskDownloadResult = 2;
        TTaskMergeResult TaskMergeResult = 3;
        TTaskMapResult TaskMapResult = 4;
        TTaskSortedUploadResult TaskSortedUploadResult = 5;
    }
}

message TTaskState {
    ETaskStatus TaskStatus = 1;
    string TaskId = 2;
    optional TFmrError TaskErrorMessage = 3;
    TStatistics Stats = 4;
}
