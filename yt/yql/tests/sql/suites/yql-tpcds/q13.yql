/* dqfile can not */
/* hybridfile can not - missing langver support */
PRAGMA YqlSelect = 'force';
PRAGMA AnsiImplicitCrossJoin;

SELECT
    Avg(ss_quantity) AS avg_ss_q,
    Avg(ss_ext_sales_price) AS avg_ss_s,
    Avg(ss_ext_wholesale_cost) AS avg_ss_w,
    Sum(ss_ext_wholesale_cost) AS sum_ss_w
FROM
    plato.store_sales
,
    plato.store
,
    plato.customer_demographics
,
    plato.household_demographics
,
    plato.customer_address
,
    plato.date_dim
WHERE
    s_store_sk == ss_store_sk
    AND ss_sold_date_sk == d_date_sk AND d_year == 2001
    AND (
        (
            ss_hdemo_sk == hd_demo_sk
            AND cd_demo_sk == ss_cdemo_sk
            AND cd_marital_status == 'D'
            AND cd_education_status == '2 yr Degree'
            AND ss_sales_price BETWEEN 100.00 AND 150.00
            AND hd_dep_count == 3
        )
        OR (
            ss_hdemo_sk == hd_demo_sk
            AND cd_demo_sk == ss_cdemo_sk
            AND cd_marital_status == 'S'
            AND cd_education_status == 'Secondary'
            AND ss_sales_price BETWEEN 50.00 AND 100.00
            AND hd_dep_count == 1
        )
        OR (
            ss_hdemo_sk == hd_demo_sk
            AND cd_demo_sk == ss_cdemo_sk
            AND cd_marital_status == 'W'
            AND cd_education_status == 'Advanced Degree'
            AND ss_sales_price BETWEEN 150.00 AND 200.00
            AND hd_dep_count == 1
        )
    )
    AND (
        (
            ss_addr_sk == ca_address_sk
            AND ca_country == 'United States'
            AND ca_state IN ('CO', 'IL', 'MN')
            AND ss_net_profit BETWEEN 100 AND 200
        )
        OR (
            ss_addr_sk == ca_address_sk
            AND ca_country == 'United States'
            AND ca_state IN ('OH', 'MT', 'NM')
            AND ss_net_profit BETWEEN 150 AND 300
        )
        OR (
            ss_addr_sk == ca_address_sk
            AND ca_country == 'United States'
            AND ca_state IN ('TX', 'MO', 'MI')
            AND ss_net_profit BETWEEN 50 AND 250
        )
    )
;
