/* dqfile can not */
/* hybridfile can not - missing langver support */
PRAGMA YqlSelect = 'force';
PRAGMA AnsiImplicitCrossJoin;

$nantonull = ($n) -> {
    RETURN CASE
        WHEN Math::IsNaN($n) THEN NULL
        ELSE $n
    END;
};

SELECT
    i_item_id,
    i_item_desc,
    s_state,
    Count(ss_quantity) AS store_sales_quantitycount,
    Avg(ss_quantity) AS store_sales_quantityave,
    $nantonull(STDDEV_SAMPLE(ss_quantity)) AS store_sales_quantitystdev,
    $nantonull(STDDEV_SAMPLE(ss_quantity)) / Avg(ss_quantity) AS store_sales_quantitycov,
    Count(sr_return_quantity) AS store_returns_quantitycount,
    Avg(sr_return_quantity) AS store_returns_quantityave,
    $nantonull(STDDEV_SAMPLE(sr_return_quantity)) AS store_returns_quantitystdev,
    $nantonull(STDDEV_SAMPLE(sr_return_quantity)) / Avg(sr_return_quantity) AS store_returns_quantitycov,
    Count(cs_quantity) AS catalog_sales_quantitycount,
    Avg(cs_quantity) AS catalog_sales_quantityave,
    $nantonull(STDDEV_SAMPLE(cs_quantity)) AS catalog_sales_quantitystdev,
    $nantonull(STDDEV_SAMPLE(cs_quantity)) / Avg(cs_quantity) AS catalog_sales_quantitycov
FROM
    plato.store_sales
,
    plato.store_returns
,
    plato.catalog_sales
,
    plato.date_dim AS d1
,
    plato.date_dim AS d2
,
    plato.date_dim AS d3
,
    plato.store
,
    plato.item
WHERE
    d1.d_quarter_name == '1998Q1'
    AND d1.d_date_sk == ss_sold_date_sk
    AND i_item_sk == ss_item_sk
    AND s_store_sk == ss_store_sk
    AND ss_customer_sk == sr_customer_sk
    AND ss_item_sk == sr_item_sk
    AND ss_ticket_number == sr_ticket_number
    AND sr_returned_date_sk == d2.d_date_sk
    AND d2.d_quarter_name IN ('1998Q1', '1998Q2', '1998Q3')
    AND sr_customer_sk == cs_bill_customer_sk
    AND sr_item_sk == cs_item_sk
    AND cs_sold_date_sk == d3.d_date_sk
    AND d3.d_quarter_name IN ('1998Q1', '1998Q2', '1998Q3')
GROUP BY
    i_item_id,
    i_item_desc,
    s_state
ORDER BY
    i_item_id,
    i_item_desc,
    s_state
LIMIT 100;
