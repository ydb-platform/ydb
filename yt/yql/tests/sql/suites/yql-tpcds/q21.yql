/* dqfile can not */
/* hybridfile can not - missing langver support */
PRAGMA YqlSelect = 'force';
PRAGMA AnsiImplicitCrossJoin;

SELECT
    *
FROM (
    SELECT
        w_warehouse_name,
        i_item_id,
        Sum(
            CASE
                WHEN (CAST(d_date AS Date) < CAST('1998-04-08' AS Date)) THEN inv_quantity_on_hand
                ELSE 0
            END
        ) AS inv_before,
        Sum(
            CASE
                WHEN (CAST(d_date AS Date) >= CAST('1998-04-08' AS Date)) THEN inv_quantity_on_hand
                ELSE 0
            END
        ) AS inv_after
    FROM
        plato.inventory
    ,
        plato.warehouse
    ,
        plato.item
    ,
        plato.date_dim
    WHERE
        i_current_price BETWEEN 0.99 AND 1.49
        AND i_item_sk == inv_item_sk
        AND inv_warehouse_sk == w_warehouse_sk
        AND inv_date_sk == d_date_sk
        AND d_date BETWEEN (CAST('1998-04-08' AS Date) - DateTime::IntervalFromDays(20)) AND (CAST('1998-04-08' AS Date) + DateTime::IntervalFromDays(20))
    GROUP BY
        w_warehouse_name,
        i_item_id
) AS x
WHERE
    (
        CASE
            WHEN inv_before > 0 THEN inv_after / inv_before
            ELSE NULL
        END
    ) BETWEEN (2.0 / 3.0) AND (3.0 / 2.0)
ORDER BY
    w_warehouse_name,
    i_item_id
LIMIT 100;
