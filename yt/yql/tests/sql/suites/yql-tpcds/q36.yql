/* dqfile can not */
/* hybridfile can not - missing langver support */
/* custom error: Window and aggregation functions are not allowed in this context */
PRAGMA YqlSelect = 'force';
PRAGMA AnsiImplicitCrossJoin;

SELECT
    Sum(ss_net_profit) / Sum(ss_ext_sales_price) AS gross_margin,
    i_category,
    i_class,
    Grouping(i_category) + Grouping(i_class) AS lochierarchy,
    Rank() OVER (
        PARTITION BY
            Grouping(i_category) + Grouping(i_class),
            CASE
                WHEN Grouping(i_class) == 0 THEN i_category
            END
        ORDER BY
            Sum(ss_net_profit) / Sum(ss_ext_sales_price) ASC
    ) AS rank_within_parent
FROM
    plato.store_sales
,
    plato.date_dim AS d1
,
    plato.item
,
    plato.store
WHERE
    d1.d_year == 2000
    AND d1.d_date_sk == ss_sold_date_sk
    AND i_item_sk == ss_item_sk
    AND s_store_sk == ss_store_sk
    AND s_state IN (
        'TN', 'TN', 'TN', 'TN',
        'TN', 'TN', 'TN', 'TN'
    )
GROUP BY
    ROLLUP (i_category, i_class)
ORDER BY
    lochierarchy DESC,
    CASE
        WHEN lochierarchy == 0 THEN i_category
    END,
    rank_within_parent
LIMIT 100;
