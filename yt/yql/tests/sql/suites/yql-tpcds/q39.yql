/* dqfile can not */
/* hybridfile can not - missing langver support */
PRAGMA YqlSelect = 'force';
PRAGMA AnsiImplicitCrossJoin;

$inv = (
    SELECT
        w_warehouse_name,
        w_warehouse_sk,
        i_item_sk,
        d_moy,
        stdev,
        mean,
        CASE mean
            WHEN 0 THEN NULL
            ELSE stdev / mean
        END AS cov
    FROM (
        SELECT
            w_warehouse_name,
            w_warehouse_sk,
            i_item_sk,
            d_moy,
            stddev_samp(inv_quantity_on_hand) AS stdev,
            Avg(inv_quantity_on_hand) AS mean
        FROM
            plato.inventory
        ,
            plato.item
        ,
            plato.warehouse
        ,
            plato.date_dim
        WHERE
            inv_item_sk == i_item_sk
            AND inv_warehouse_sk == w_warehouse_sk
            AND inv_date_sk == d_date_sk
            AND d_year == 1998
        GROUP BY
            w_warehouse_name,
            w_warehouse_sk,
            i_item_sk,
            d_moy
    ) AS foo
    WHERE
        CASE mean
            WHEN 0 THEN 0
            ELSE stdev / mean
        END > 1
);

SELECT
    inv1.w_warehouse_sk AS inv1_w_warehouse_sk,
    inv1.i_item_sk AS inv1_i_item_sk,
    inv1.d_moy AS inv1_d_moy,
    inv1.mean AS inv1_mean,
    inv1.cov AS inv1_cov,
    inv2.w_warehouse_sk AS inv2_w_warehouse_sk,
    inv2.i_item_sk AS inv2_i_item_sk,
    inv2.d_moy AS inv2_d_moy,
    inv2.mean AS inv2_mean,
    inv2.cov AS inv2_cov
FROM
    $inv AS inv1
,
    $inv AS inv2
WHERE
    inv1.i_item_sk == inv2.i_item_sk
    AND inv1.w_warehouse_sk == inv2.w_warehouse_sk
    AND inv1.d_moy == 4
    AND inv2.d_moy == 4 + 1
ORDER BY
    inv1_w_warehouse_sk,
    inv1_i_item_sk,
    inv1_d_moy,
    inv1_mean,
    inv1_cov,
    inv2_d_moy,
    inv2_mean,
    inv2_cov
;

$inv = (
    SELECT
        w_warehouse_name,
        w_warehouse_sk,
        i_item_sk,
        d_moy,
        stdev,
        mean,
        CASE mean
            WHEN 0 THEN NULL
            ELSE stdev / mean
        END AS cov
    FROM (
        SELECT
            w_warehouse_name,
            w_warehouse_sk,
            i_item_sk,
            d_moy,
            STDDEV_SAMP(inv_quantity_on_hand) AS stdev,
            Avg(inv_quantity_on_hand) AS mean
        FROM
            plato.inventory
        ,
            plato.item
        ,
            plato.warehouse
        ,
            plato.date_dim
        WHERE
            inv_item_sk == i_item_sk
            AND inv_warehouse_sk == w_warehouse_sk
            AND inv_date_sk == d_date_sk
            AND d_year == 1998
        GROUP BY
            w_warehouse_name,
            w_warehouse_sk,
            i_item_sk,
            d_moy
    ) AS foo
    WHERE
        CASE mean
            WHEN 0 THEN 0
            ELSE stdev / mean
        END > 1
);

SELECT
    inv1.w_warehouse_sk AS inv1_w_warehouse_sk,
    inv1.i_item_sk AS inv1_i_item_sk,
    inv1.d_moy AS inv1_d_moy,
    inv1.mean AS inv1_mean,
    inv1.cov AS inv1_cov,
    inv2.w_warehouse_sk AS inv2_w_warehouse_sk,
    inv2.i_item_sk AS inv2_i_item_sk,
    inv2.d_moy AS inv2_d_moy,
    inv2.mean AS inv2_mean,
    inv2.cov AS inv2_cov
FROM
    $inv AS inv1
,
    $inv AS inv2
WHERE
    inv1.i_item_sk == inv2.i_item_sk
    AND inv1.w_warehouse_sk == inv2.w_warehouse_sk
    AND inv1.d_moy == 4
    AND inv2.d_moy == 4 + 1
    AND inv1.cov > 1.5
ORDER BY
    inv1_w_warehouse_sk,
    inv1_i_item_sk,
    inv1_d_moy,
    inv1_mean,
    inv1_cov,
    inv2_d_moy,
    inv2_mean,
    inv2_cov
;
