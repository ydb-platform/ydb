/* dqfile can not */
/* hybridfile can not - missing langver support */
/* custom error: Unknown alias: household_demographics */
PRAGMA YqlSelect = 'force';
PRAGMA AnsiImplicitCrossJoin;

SELECT
    c_last_name,
    c_first_name,
    ca_city,
    bought_city,
    ss_ticket_number,
    amt,
    profit
FROM (
    SELECT
        ss_ticket_number,
        ss_customer_sk,
        ca_city AS bought_city,
        Sum(ss_coupon_amt) AS amt,
        Sum(ss_net_profit) AS profit
    FROM
        plato.store_sales
    ,
        plato.date_dim
    ,
        plato.store
    ,
        plato.household_demographics
    ,
        plato.customer_address
    WHERE
        store_sales.ss_sold_date_sk == date_dim.d_date_sk
        AND store_sales.ss_store_sk == store.s_store_sk
        AND store_sales.ss_hdemo_sk == household_demographics.hd_demo_sk
        AND store_sales.ss_addr_sk == customer_address.ca_address_sk
        AND (
            household_demographics.hd_dep_count == 5
            OR household_demographics.hd_vehicle_count == 3
        )
        AND date_dim.d_dow IN (6, 0)
        AND date_dim.d_year IN (1999, 1999 + 1, 1999 + 2)
        AND store.s_city IN ('Midway', 'Fairview', 'Fairview', 'Midway', 'Fairview')
    GROUP BY
        ss_ticket_number,
        ss_customer_sk,
        ss_addr_sk,
        ca_city
) AS dn
,
    plato.customer
,
    plato.customer_address AS current_addr
WHERE
    ss_customer_sk == c_customer_sk
    AND customer.c_current_addr_sk == current_addr.ca_address_sk
    AND current_addr.ca_city != bought_city
ORDER BY
    c_last_name,
    c_first_name,
    ca_city,
    bought_city,
    ss_ticket_number
LIMIT 100;
