/* dqfile can not */
/* hybridfile can not - missing langver support */
/* custom error: No such column: ws_order_number */
PRAGMA YqlSelect = 'force';
PRAGMA AnsiImplicitCrossJoin;

$ws_wh = (
    SELECT
        ws1.ws_order_number,
        ws1.ws_warehouse_sk AS wh1,
        ws2.ws_warehouse_sk AS wh2
    FROM
        plato.web_sales AS ws1
    ,
        plato.web_sales AS ws2
    WHERE
        ws1.ws_order_number == ws2.ws_order_number
        AND ws1.ws_warehouse_sk != ws2.ws_warehouse_sk
);

SELECT
    Count(DISTINCT ws_order_number) AS `order count`,
    Sum(ws_ext_ship_cost) AS `total shipping cost`,
    Sum(ws_net_profit) AS `total net profit`
FROM
    plato.web_sales AS ws1
,
    plato.date_dim
,
    plato.customer_address
,
    plato.web_site
WHERE
    d_date BETWEEN CAST('1999-5-01' AS Date) AND (
        CAST('1999-5-01' AS Date) + DateTime::IntervalFromDays(60)
    )
    AND ws1.ws_ship_date_sk == d_date_sk
    AND ws1.ws_ship_addr_sk == ca_address_sk
    AND ca_state == 'TX'
    AND ws1.ws_web_site_sk == web_site_sk
    AND web_company_name == 'pri'
    AND ws1.ws_order_number IN (
        SELECT
            ws_order_number
        FROM
            $ws_wh AS ws_wh
    )
    AND ws1.ws_order_number IN (
        SELECT
            wr_order_number
        FROM
            plato.web_returns
        ,
            $ws_wh AS ws_wh
        WHERE
            wr_order_number == ws_wh.ws_order_number
    )
ORDER BY
    Count(DISTINCT ws_order_number)
LIMIT 100;
