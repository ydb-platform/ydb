/* sort outputs */

use plato;

pragma Engine = "ytflow";

pragma Ytflow.Cluster = "plato";
pragma Ytflow.PipelinePath = "pipelines/test";

$joined_stream =
    select 
        left_arg.key as key,
        left_arg.kv_value as value,
        left_arg.key,
        right_arg.kv_value
    from InputKeyValueTable as left_arg
    inner join InputKeyValueTable as right_arg
    on left_arg.key = right_arg.key;

insert into Output
select 
    key,
    value,
    key || "_after" as key_after,
    `right_arg.kv_value` as kv_value
from $joined_stream
where value * 2 <= `right_arg.kv_value`;
