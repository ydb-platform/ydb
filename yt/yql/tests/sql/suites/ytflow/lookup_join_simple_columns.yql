/* sort outputs */

use plato;

pragma Engine = "ytflow";
pragma SimpleColumns;

pragma Ytflow.Cluster = "plato";
pragma Ytflow.PipelinePath = "pipelines/test";

$input_stream = 
    select 
        custom_key || "_before" as key_before,
        custom_key,
        value
    from Input
    where value > 2;

$joined_stream =
    select 
        custom_key,
        key,
        value,
        key_before,
        kv_value
    from $input_stream as left_arg
    inner join InputKeyValueTable as right_arg
    on left_arg.custom_key = right_arg.key;

insert into Output
select 
    custom_key,
    key,
    value,
    key_before,
    key || "_after" as key_after,
    kv_value
from $joined_stream
where value * 2 <= kv_value;
